<!doctype html> 
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ARTEFACT • Admin</title>
  <link rel="stylesheet" href="/app.css" />
  <style>
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 900px){.grid2{grid-template-columns:1fr}}
    .list{background:#0b1220;border:1px solid #233047;border-radius:10px;padding:12px;white-space:pre-wrap}
    .rowx{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#1f2937;font-size:12px;color:#93c5fd}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .muted{opacity:.8}
    .success{color:#22c55e}.danger{color:#ef4444}
    .pointer{cursor:pointer}
    .right{float:right}
    .lock{margin-left:8px}
    .search{width:100%;padding:8px;border-radius:8px;border:1px solid #233047;background:#0b1220;color:#e2e8f0}
    .user-row{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:6px 8px;border-radius:8px}
    .user-row:hover{background:#0f172a}
    .tag{font-size:11px;padding:2px 6px;border-radius:6px;background:#1f2937}
    .tag.red{background:#3b1113;color:#fecaca}
    .tag.green{background:#0f2e1b;color:#bbf7d0}
    .tight{margin:0;padding:0}
  </style>
</head>
<body>
  <header class="header">
    <div class="brand">ARTEFACT • Admin</div>
    <div id="who" class="muted">Status: unknown</div>
  </header>

  <main class="container">
    <!-- Admin Key -->
    <section class="card">
      <div class="label">Admin Key</div>
      <div class="rowx">
        <input id="admin-key" type="password" placeholder="x-admin-key" />
        <button id="btn-key-set">Set</button>
        <button id="btn-key-clear" class="secondary">Clear</button>
        <label class="rowx lock">
          <input type="checkbox" id="key-lock" />
          <span>Lock key</span>
        </label>
        <label class="rowx lock">
          <input type="checkbox" id="key-remember" />
          <span>Remember in this browser</span>
        </label>
        <span id="key-msg" class="muted"></span>
      </div>
    </section>

    <section class="grid2">
     <!-- LEFT: Controls -->
<div class="card">
  <div class="label">Controls</div>

  <div class="muted tight" id="sel-user-label">Selected user: —</div>

  <div class="rowx" style="margin-top:8px">
    <input id="gold-amount" type="number" min="-999999" step="1" placeholder="Gold amount (1g = 100s)" />
    <button id="btn-give">+ Give</button>
    <button id="btn-take" class="secondary">– Take</button>
  </div>

  <div class="rowx" style="margin-top:8px">
    <button id="btn-disable" class="danger">Disable account</button>
    <button id="btn-enable" class="secondary">Enable account</button>
  </div>

  <div id="ops-msg" class="muted" style="margin-top:6px"></div>

  <hr style="border:none;border-top:1px solid #233047;margin:10px 0" />

  <div class="label">Artefact Bonus Gold</div>
  <div class="rowx" style="margin-top:8px">
    <input id="bonus-gold" type="number" min="0" step="1" placeholder="Bonus gold" />
    <button id="btn-set-bonus">Set</button>
  </div>
  <div id="bonus-msg" class="muted" style="margin-top:6px"></div>
</div>


      <!-- RIGHT: Users + Inventory -->
      <div class="card">
        <div class="rowx" style="justify-content:space-between;">
          <div class="label">Users (active first, A–Z)</div>
          <button id="btn-refresh-users" class="secondary">Refresh</button>
        </div>

        <input id="search" class="search" placeholder="Search email…" />
        <div id="users" class="list" style="margin-top:8px;max-height:320px;overflow:auto;">—</div>

        <div class="card" style="margin-top:12px;">
          <div class="rowx" style="justify-content:space-between;">
            <div class="label">Inventory of selected user</div>
            <button id="btn-refresh-inv" class="secondary">Reload</button>
          </div>
          <div id="inv" class="list">Select a user from the list →</div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const $ = s => document.querySelector(s);
    let ADMIN_KEY = "";
    let LOCKED = false;
    let REMEMBER = false;
    let users = [];
    let selected = null;

    function msg(el, text, ok=true){ const e=$(el); e.textContent=text; e.className = ok ? "muted success" : "muted danger"; }
    function setWho(text){ $("#who").textContent = text; }

    // ---------- Persist key / lock
    function loadPrefs(){
      ADMIN_KEY = localStorage.getItem("admin.key") || "";
      LOCKED = localStorage.getItem("admin.lock") === "1";
      REMEMBER = localStorage.getItem("admin.remember") === "1";
      $("#admin-key").value = ADMIN_KEY;
      $("#key-lock").checked = LOCKED;
      $("#key-remember").checked = REMEMBER;
      applyLock();
    }
    function savePrefs(){
      if (REMEMBER) localStorage.setItem("admin.key", ADMIN_KEY);
      else localStorage.removeItem("admin.key");
      localStorage.setItem("admin.lock", LOCKED ? "1" : "0");
      localStorage.setItem("admin.remember", REMEMBER ? "1" : "0");
    }
    function applyLock(){
      $("#admin-key").disabled = LOCKED;
      $("#btn-key-set").disabled = LOCKED;
      $("#btn-key-clear").disabled = LOCKED;
    }

    // ---------- Fetch helper with header
    async function api(path, opts={}){
      const headers = { "Content-Type":"application/json", ...(opts.headers||{}) };
      if (ADMIN_KEY) headers["x-admin-key"] = ADMIN_KEY;
      const res = await fetch(path, { credentials:"include", ...opts, headers });
      let data = null;
      try{ data = await res.json(); }catch{}
      if (!res.ok) throw new Error((data && data.error) || `HTTP ${res.status}`);
      return data;
    }

    async function checkAdmin(){
      try{
        await api("/api/admin/ping");
        msg("#key-msg", "Admin OK");
      }catch(e){
        msg("#key-msg", "Key invalid or missing ("+e.message+")", false);
      }
    }

    // ---------- Users
    function renderUsers(){
      const q = $("#search").value.trim().toLowerCase();
      const box = $("#users"); box.innerHTML = "";
      let list = users.slice();
      // sort: active first, then email A–Z
      list.sort((a,b)=>{
        if (a.is_disabled !== b.is_disabled) return a.is_disabled ? 1 : -1;
        return a.email.localeCompare(b.email);
      });
      if (q) list = list.filter(u => u.email.toLowerCase().includes(q));
      if (!list.length){ box.textContent = "No users."; return; }
      for (const u of list){
        const row = document.createElement("div"); row.className = "user-row pointer";
        row.innerHTML = `
          <div>
            <span class="mono">#${u.id}</span>
            <span class="mono">${u.email}</span>
            ${u.is_disabled ? `<span class="tag red">disabled</span>` : `<span class="tag green">active</span>`}
          </div>
          <div class="muted">${u.gold}g ${u.silver}s</div>
        `;
        row.addEventListener("click", ()=> selectUser(u));
        box.appendChild(row);
      }
    }
    async function loadUsers(){
      $("#users").textContent = "Loading…";
      try{
        const r = await api("/api/admin/users");
        users = r.users || [];
        renderUsers();
      }catch(e){
        $("#users").textContent = e.message;
      }
    }

    function selectUser(u){
      selected = u;
      $("#sel-user-label").textContent = `Selected user: ${u.email} (id ${u.id})`;
      $("#ops-msg").textContent = "";
      loadInventory();
    }

    async function loadInventory(){
      const box = $("#inv");
      if (!selected){ box.textContent = "Select a user from the list →"; return; }
      box.textContent = "Loading…";
      try{
        const r = await api(`/api/admin/user/${selected.id}/inventory`);
        const lines = [];
        lines.push("ITEMS:");
        if (!(r.items||[]).length) lines.push("(none)");
        (r.items||[]).forEach(it=> lines.push(` • [T${it.tier}] ${it.name} x${it.qty}`));
        lines.push("");
        lines.push("RECIPES:");
        if (!(r.recipes||[]).length) lines.push("(none)");
        (r.recipes||[]).forEach(rc=> lines.push(` • [T${rc.tier}] ${rc.name} x${rc.qty}`));
        box.textContent = lines.join("\n");
      }catch(e){ box.textContent = e.message; }
    }

    // ---------- Controls
    async function changeGold(sign){
  if (!selected){ msg("#ops-msg", "Select a user first.", false); return; }
  const amount = parseInt($("#gold-amount").value || "0", 10) || 0;
  if (amount === 0){ msg("#ops-msg", "Enter non-zero gold amount.", false); return; }
  const gold = sign > 0 ? amount : -amount;
  try{
    const r = await api("/api/admin/adjust-balance", {
      method:"POST",
      body: JSON.stringify({ email: selected.email, gold })
    });
    msg("#ops-msg", `New balance: ${Math.floor(r.balance_silver/100)}g ${r.balance_silver%100}s`);
    await loadUsers();
    const found = users.find(x => x.id === selected.id);
    if (found) selected = found;
    await loadInventory();
  }catch(e){
    msg("#ops-msg", e.message, false);
  }
}

async function setDisabled(flag){
  if (!selected){ msg("#ops-msg","Select a user first.", false); return; }
  try{
    await api("/api/admin/disable-user", {
      method:"POST",
      body: JSON.stringify({ email: selected.email, disabled: flag })
    });
    msg("#ops-msg", flag ? "Account disabled." : "Account enabled.");
    await loadUsers();
    const found = users.find(x => x.id === selected.id);
    if (found) selected = found;
    $("#sel-user-label").textContent = `Selected user: ${selected.email} (id ${selected.id})`;
  }catch(e){
    msg("#ops-msg", e.message, false);
  }
}

async function setArtefactBonusGold(){
  const bonus_gold = parseInt((document.querySelector("#bonus-gold")?.value || "0"), 10) || 0;
  try{
    const r = await api("/api/admin/set-bonus-gold", {
      method:"POST",
      body: JSON.stringify({ code: "ARTEFACT", bonus_gold })
    });
    msg("#bonus-msg", `Artefact bonus set to ${r.bonus_gold} gold.`);
  }catch(e){
    msg("#bonus-msg", e.message, false);
  }
}

    // ---------- Events
$("#btn-key-set").addEventListener("click", async ()=>{
  ADMIN_KEY = $("#admin-key").value.trim();
  REMEMBER = $("#key-remember").checked;
  LOCKED = $("#key-lock").checked;
  savePrefs(); 
  applyLock();
  await checkAdmin();
  await loadUsers();
});

$("#btn-key-clear").addEventListener("click", ()=>{
  ADMIN_KEY = ""; 
  savePrefs(); 
  applyLock(); 
  msg("#key-msg","Cleared.");
});

$("#key-lock").addEventListener("change", ()=>{
  LOCKED = $("#key-lock").checked;
  savePrefs(); 
  applyLock();
});

$("#key-remember").addEventListener("change", ()=>{
  REMEMBER = $("#key-remember").checked;
  savePrefs();
});

$("#btn-refresh-users").addEventListener("click", loadUsers);
$("#btn-refresh-inv").addEventListener("click", loadInventory);
$("#search").addEventListener("input", renderUsers);

$("#btn-give").addEventListener("click", ()=> changeGold(+1));
$("#btn-take").addEventListener("click", ()=> changeGold(-1));
$("#btn-disable").addEventListener("click", ()=> setDisabled(true));
$("#btn-enable").addEventListener("click", ()=> setDisabled(false));
$("#btn-set-bonus").addEventListener("click", setArtefactBonusGold);


    // ---------- Init
    loadPrefs();
    (async ()=>{
      try{
        const me = await fetch("/api/me", {credentials:"include"}).then(r=>r.ok?r.json():null).catch(()=>null);
        if (me && me.user) setWho(`${me.user.email} • ${me.user.is_admin ? "ADMIN" : "USER"} • ${me.user.gold}g ${me.user.silver}s`);
        else setWho("Not logged in (key mode).");
      }catch{ setWho("Not logged in (key mode)."); }
      if (ADMIN_KEY){ await checkAdmin(); await loadUsers(); }
    })();
  </script>
</body>
</html>






