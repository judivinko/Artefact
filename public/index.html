<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ARTEFACT</title>
  <link rel="stylesheet" href="/app.css" />
  <style>
    /* --- layout & stil --- */
    .hidden{display:none}
    .badge{border:1px solid var(--line);padding:4px 8px;border-radius:999px;background:#071021;font-size:12px}
    .itemrow{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid #13223a}
    .itemrow:last-child{border-bottom:0}
    .list{max-height:360px;overflow:auto;border:1px solid var(--line);border-radius:10px}
    .chip{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#0d1b2a;cursor:pointer}
    .chip.active{background:#0e3a2f}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .toast{position:fixed;bottom:16px;right:16px;background:#0d1b2a;border:1px solid #233047;border-radius:8px;padding:10px 12px}
    .btn{cursor:pointer}
    .btn.muted{opacity:.9}
    .btn.secondary{background:#0d2a3a}
    .btn.danger{background:#3a0d14}
    .input{background:#0b1220;border:1px solid #233047;border-radius:8px;padding:8px 10px;color:#e5e7eb}
    .card{background:#0b1220;border:1px solid #233047;border-radius:12px;padding:12px;margin-top:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .tabbar{margin:6px 0 4px}
    .header{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid #233047}
    .brand{font-weight:700}
    .container{max-width:980px;margin:0 auto;padding:12px}
    .label{font-weight:600}
    .muted{opacity:.8}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
    img.icon{width:28px;height:28px;object-fit:contain;border-radius:6px;display:block}

    /* === HOME PAGE FIX: header, tekst, slotovi za slike === */
    .header.no-border { border-bottom: 0 !important; }

    #about p,
    #how p,
    #tips li { font-size:16px; line-height:1.6; }

    #how .label,
    #tips .label { font-size:20px; }

    /* Globalni limit za sve <img> (osim ikona) */
    img { max-width:512px; max-height:512px; width:auto; height:auto; }

    /* Posebna klasa za item previewe */
    .item-img{
      display:block;width:100%;max-width:512px;max-height:512px;
      object-fit:contain;border-radius:10px;margin-top:8px;
    }

    .img-slot{
      margin-top:10px;width:100%;min-height:96px;border:1px dashed #233047;
      border-radius:10px;display:flex;align-items:center;justify-content:center;
      font-size:12px;opacity:.85;
    }
    .img-slot:hover{ opacity:1 }
  </style>
</head>
<body>

<!-- ===== Header (auth controls / balance) ===== -->
<header class="header no-border">
  <div class="brand">ARTEFACT</div>
  <div class="row" style="gap:8px">
    <span id="balance" class="badge hidden">0g 0s</span>
    <button id="btn-open-register" class="btn secondary">Register</button>
    <button id="btn-open-login" class="btn">Log in</button>
    <button id="btn-logout" class="btn muted hidden">Log out</button>
  </div>
</header>

<!-- ===== Auth (Register + Login) ===== -->
<section id="auth" class="card hidden" style="margin-top:12px">
  <div id="card-register" style="display:none">
    <div class="label">Register</div>
    <input id="reg-email" class="input" placeholder="email@example.com" type="email" />
    <input id="reg-pass" class="input" placeholder="password (min 6)" type="password" style="margin-top:8px" />
    <button id="btn-register" class="btn" style="margin-top:8px">Register</button>
    <div id="reg-msg" class="muted" style="margin-top:6px"></div>
  </div>

  <div id="card-login" style="display:none">
    <div class="label">Log in</div>
    <input id="log-email" class="input" placeholder="email@example.com" type="email" />
    <input id="log-pass" class="input" placeholder="password" type="password" style="margin-top:8px" />
    <button id="btn-login" class="btn secondary" style="margin-top:8px">Log in</button>
    <div id="log-msg" class="muted" style="margin-top:6px"></div>
  </div>
</section>

<!-- ===== Main ===== -->
<main class="container">
  <section id="about" class="card" style="margin-top:16px">
    <div class="label" style="line-height:1.2;margin-bottom:6px">O igri</div>
    <p class="muted" style="max-width:820px">
      You collect materials, unlock recipes, and craft increasingly powerful items (T2 → T5).
      When you gather <b>10 different T5</b>, you can assemble an <b>ARTEFACT</b> that grants you a gold bonus.
    </p>
  </section>

  <section id="how" class="card">
    <div class="grid">
      <!-- 1) SHOP -->
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="label">1) Shop</div>
          <span class="badge">cijena: 1g</span>
        </div>
        <p class="muted">
          In the Shop, you buy <b>T1 materials</b>, and occasionally you also receive <b>recipes</b>.<br>
          Materials are ingredients for crafting, while recipes unlock higher tiers.
        </p>
        <img src="/t1_bronze.png" alt="T1 example"
             style="width:8em;height:8em;object-fit:contain;border-radius:10px;margin-top:8px;display:block"
             onerror="imgFallback(this)">
        <img src="/recipe.png" alt="Recipe example"
             style="width:8em;height:8em;object-fit:contain;border-radius:10px;margin-top:8px;display:block"
             onerror="imgFallback(this)">
      </div>

      <!-- 2) CRAFTING -->
      <div class="card">
        <div class="label">2) Crafting</div>
        <p class="muted">
          With a recipe and the required materials, you can craft <b>T2, T3, T4</b> and, finally, <b>T5</b> items.<br>
          Crafting can sometimes <i>fail</i> and yield <b>Scrap</b>, so combine carefully.
        </p>
        <img src="/t2_golden_ring.png" alt="T2"  style="width:8em;height:8em;object-fit:contain;border-radius:10px;margin-top:8px;display:block" onerror="imgFallback(this)">
        <img src="/t3_gate_of_might.png" alt="T3" style="width:8em;height:8em;object-fit:contain;border-radius:10px;margin-top:8px;display:block" onerror="imgFallback(this)">
        <img src="/t4_engine_core.png"  alt="T4"  style="width:8em;height:8em;object-fit:contain;border-radius:10px;margin-top:8px;display:block" onerror="imgFallback(this)">
        <img src="/t5_ancient_relic.png" alt="T5"  style="width:8em;height:8em;object-fit:contain;border-radius:10px;margin-top:8px;display:block" onerror="imgFallback(this)">
      </div>

      <!-- 3) MARKET -->
      <div class="card">
        <div class="label">3) Market</div>
        <p class="muted">
          You can <b>sell</b> surplus materials or recipes, and <b>buy</b> what you’re missing from others.<br>
          Through trading, you speed up your progress toward T5 sets.
        </p>
      </div>

      <!-- 4) ARTEFACT -->
      <div class="card">
        <div class="label">4) Artefact</div>
        <p class="muted">
          When you have <b>10 different T5</b>, you can craft an <b>ARTEFACT</b>.<br>
          It provides a permanent <b>gold bonus</b> to your account — the higher the bonus, the faster you progress.
        </p>
        <img src="/artefakt.png" alt="Artefact"
             style="width:8em;height:8em;object-fit:contain;border-radius:10px;margin-top:8px;display:block"
             onerror="imgFallback(this)">
      </div>
    </div>
  </section>

  <!-- ===== Tips ===== -->
  <section id="tips" class="card">
    <div class="label">Savjeti</div>
    <ul class="muted" style="margin:6px 0 0 18px;line-height:1.5">
      <li>Kupuj pametno u Shopu — recepti padaju povremeno, pa čuvaj gold za ključne trenutke.</li>
      <li>Craftaj po prioritetu recepata koje imaš i materijala koje možeš lako nadoknaditi.</li>
      <li>Market je najbolji način da popuniš rupe u setu i prodaš ono što ti ne treba.</li>
      <li>Ciljaj da skupiš 10 <i>različitih</i> T5 — duplikati ne vrijede za ARTEFACT.</li>
    </ul>
  </section>
</main>

<!-- ===== App (Shop / Craft / Market / Inventory) ===== -->
<section id="app" class="hidden">
  <div class="tabbar row">
    <div class="chip active" data-tab="shop">Shop</div>
    <div class="chip" data-tab="craft">Crafting</div>
    <div class="chip" data-tab="market">Market</div>
    <div class="chip" data-tab="inv">Inventory</div>
  </div>

  <!-- == SHOP == -->
  <div id="tab-shop" class="card">
    <div class="row" style="justify-content:space-between">
      <div class="label">Buy T1 (100s)</div>
      <span id="buysToNext" class="muted">Buys to next recipe: —</span>
    </div>
    <div style="margin:6px 0">
      <span id="shop-balance" class="badge hidden">0g 0s</span>
    </div>
    <div class="row">
      <button id="btn-buy-t1" class="btn">Buy</button>
      <div id="shop-msg" class="muted"></div>
    </div>
  </div>

  <!-- == CRAFTING == -->
  <div id="tab-craft" class="card hidden">
    <div class="row">
      <div class="label">Crafting</div>
      <button id="btn-artefact" class="btn right">
        <img src="/artefakt.png" alt="Artefact"
             style="width:20px;height:20px;object-fit:contain;vertical-align:-3px;margin-right:8px;border-radius:4px"
             onerror="imgFallback(this)">
        Craft ARTEFACT (10× distinct T5)
      </button>
    </div>
    <div style="margin-top:8px">Bonus gold: <span id="artefact-bonus">0</span></div>
    <div id="artefact-msg" class="muted" style="margin-top:4px"></div>

    <div class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="label">Recipes you own</div>
          <div class="row">
            <input id="filter-recipe" class="input" placeholder="filter by name..." style="width:220px"/>
            <button id="btn-refresh-rec" class="btn muted">Refresh</button>
          </div>
        </div>
        <div id="recipes" class="list">Loading…</div>
      </div>

      <div class="card">
        <div class="label">Details</div>
        <div id="rec-details" class="list">Select a recipe on the left.</div>
      </div>
    </div>
  </div>

  <!-- == MARKET == -->
  <div id="tab-market" class="card hidden">
    <div class="label">Marketplace</div>
    <div class="grid">
      <div class="card">
        <div class="label">Create Sale</div>
        <input id="inv-search" class="input" placeholder="Search your inventory..." />
        <div id="inv-list" class="list" style="margin-top:8px;max-height:300px">Loading…</div>
        <div class="row" style="margin-top:8px">
          <input id="price-g" class="input" style="width:100px" placeholder="Gold"/>
          <input id="price-s" class="input" style="width:120px" placeholder="Silver (0–99)"/>
          <input id="price-qty" class="input" style="width:100px" placeholder="Qty"/>
          <button id="btn-list" class="btn">List for sale</button>
        </div>
        <div id="list-msg" class="muted" style="margin-top:6px"></div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="label">Marketplace</div>
          <input id="market-q" class="input" placeholder="Search by name..." style="width:220px" />
        </div>
        <div id="market" class="list">Loading…</div>

        <div class="row" style="justify-content:space-between;margin-top:12px">
          <div class="label">My listings</div>
          <button id="btn-mine" class="btn muted">Reload</button>
        </div>
        <div id="mine" class="list">Loading…</div>
      </div>
    </div>
  </div>

  <!-- == INVENTORY == -->
  <div id="tab-inv" class="card hidden">
    <div class="label">Inventory</div>
    <div id="inv-full" class="list">Loading…</div>
  </div>
</section> <!-- /#app -->


<!-- ===== Toast + helpers ($,$$,api, safeCall) ===== -->
<div id="toast" class="toast hidden"></div>
<script>
  // dom helpers
  const $  = (s,root=document)=>root.querySelector(s);
  const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
  function toast(t){ const box=$("#toast"); box.textContent=t; box.classList.remove("hidden"); setTimeout(()=>box.classList.add("hidden"),1800); }

  // fetch helper (uvijek nosi cookie) + bogatiji error obj
  async function api(p,opts={}){
    const r = await fetch(p,{credentials:"include",headers:{"Content-Type":"application/json"},...opts});
    let data=null; try{data=await r.json()}catch{}
    if(!r.ok){
      const err = new Error((data&&data.error)||("HTTP "+r.status));
      err.status = r.status;
      err.data = data;
      throw err;
    }
    return data;
  }

  // sigurno pozivanje (ako fn ne postoji, ne ruši UI)
  async function safeCall(fnName, ...args){
    const fn = window[fnName];
    if (typeof fn === "function") {
      try { return await fn(...args); } catch (e) { console.warn(fnName, "failed:", e); }
    }
  }
</script>

<!-- ===== Ikone i utili (univerzalni fallback za slike) ===== -->
<script>
  const RECIPE_ICON = "/images/recipe.png";
  const FALLBACK_ITEM_ICON = "/images/t1_bronze.png";

  const esc = s => String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#39;");

  function fileNameFromCodeTier(code, tier){
    if(!code) return null;
    const m = String(code).match(/^T([1-6])_(.*)$/);
    if (m) return `t${m[1]}_${m[2].toLowerCase()}.png`;
    if ((tier|0)===1) return `t1_${String(code).toLowerCase()}.png`;
    return null;
  }

  // primarno /images/, fallback na / pa tek onda na FALLBACK
  function iconForByCode(code, tier){
    const file = fileNameFromCodeTier(code, tier);
    if (!file) return FALLBACK_ITEM_ICON;
    return `/images/${file}`;
  }

  // Bidirekcijski fallback: pokušaj i /images/FILE i /FILE, pa tek onda FALLBACK
  function imgFallback(el){
    const tried = el.getAttribute("data-fb") || ""; // memo što smo probali
    const src = el.getAttribute("src") || "";
    const fname = src.split("/").pop() || "";

    // ako je trenutno /images/FILE i nismo probali root → probaj /FILE
    if (src.startsWith("/images/") && !tried.includes("root")) {
      el.setAttribute("data-fb", tried ? tried + ",root" : "root");
      el.onerror = imgFallback;
      el.src = `/${fname}`;
      return;
    }

    // ako je trenutno root /FILE i nismo probali /images → probaj /images/FILE
    if (!src.startsWith("/images/") && !tried.includes("images")) {
      el.setAttribute("data-fb", tried ? tried + ",images" : "images");
      el.onerror = imgFallback;
      el.src = `/images/${fname}`;
      return;
    }

    // zadnji korak: fallback ikona
    el.onerror = null;
    el.src = FALLBACK_ITEM_ICON;
  }

  // Preusmjeri postojeće inline onerror handlere na imgFallback
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("img[onerror]").forEach(img => {
      img.setAttribute("onerror", "imgFallback(this)");
    });
  });
</script>

<!-- ===== Global state + Tabs (auto-enter Shop on login) ===== -->
<script>
  // --- global stanje ---
  let WHO = null;
  let INVENTORY_CACHE = { items: [], recipes: [] };
  window.CURRENT_RECIPE_ID = null;

  // --- landing vs app ---
  function showLanding(){
    $("#about")?.classList.remove("hidden");
    $("#how")?.classList.remove("hidden");
    $("#tips")?.classList.remove("hidden");
    $("#app")?.classList.add("hidden");
  }
  function showApp(){
    $("#app")?.classList.remove("hidden");
    $("#about")?.classList.add("hidden");
    $("#how")?.classList.add("hidden");
    $("#tips")?.classList.add("hidden");
  }

  // --- saldo ---
  function renderBalance(){
    const v = WHO?.balance_silver || 0;
    const g = Math.floor(v / 100);
    const s = v % 100;
    const el = document.getElementById("balance");
    if (el) el.textContent = `${g}g ${s}s`;
  }

  // --- prebacivanje tabova ---
  function setTab(tab){
    showApp();
    $$(".chip").forEach(c => c.classList.toggle("active", c.dataset.tab === tab));
    $("#tab-shop")?.classList.toggle("hidden", tab !== "shop");
    $("#tab-craft")?.classList.toggle("hidden", tab !== "craft");
    $("#tab-market")?.classList.toggle("hidden", tab !== "market");
    $("#tab-inv")?.classList.toggle("hidden", tab !== "inv");

    if (tab === "market") {
      safeCall("loadInventoryPanel");
      safeCall("loadMarket");
      safeCall("loadMine");
    }
    if (tab === "inv") {
      safeCall("loadInventoryFull");
    }
  }

  function enterGame(defaultTab="shop"){ setTab(defaultTab); }
  function exitGame(){ showLanding(); }

  document.addEventListener("DOMContentLoaded", () => {
    showLanding();
    $$(".chip").forEach(c => c.addEventListener("click", () => setTab(c.dataset.tab)));

    // OBSERVER: auto ulazak u Shop kada se pojavi balance
    const balanceEl = document.getElementById("balance");
    if (balanceEl) {
      let enteredOnce = false;
      const obs = new MutationObserver(() => {
        const loggedIn = !balanceEl.classList.contains("hidden");
        const appHidden = document.getElementById("app")?.classList.contains("hidden");
        if (loggedIn && appHidden && !enteredOnce) {
          enteredOnce = true;
          setTab("shop");
        }
      });
      obs.observe(balanceEl, { attributes: true, attributeFilter: ["class"] });
    }
  });
</script>

<!-- ===== AUTH (Frontend): loadMe, register, login, logout ===== -->
<script>
  function setLoggedInUI(){
    document.getElementById("btn-open-register")?.classList.add("hidden");
    document.getElementById("btn-open-login")?.classList.add("hidden");
    document.getElementById("balance")?.classList.remove("hidden");
    document.getElementById("btn-logout")?.classList.remove("hidden");
    if (typeof renderBalance === "function") renderBalance();
    document.getElementById("auth")?.classList.add("hidden");
    document.getElementById("app")?.classList.remove("hidden");
  }

  function setLoggedOutUI(){
    if (typeof WHO !== "undefined") WHO = null;
    document.getElementById("btn-open-register")?.classList.remove("hidden");
    document.getElementById("btn-open-login")?.classList.remove("hidden");
    document.getElementById("balance")?.classList.add("hidden");
    document.getElementById("btn-logout")?.classList.add("hidden");
    const bal = document.getElementById("balance");
    if (bal) bal.textContent = "0g 0s";
    document.getElementById("app")?.classList.add("hidden");
    document.getElementById("auth")?.classList.add("hidden");
    const cr = document.getElementById("card-register");
    const cl = document.getElementById("card-login");
    if (cr) cr.style.display = "none";
    if (cl) cl.style.display = "none";
    const rm = document.getElementById("reg-msg");
    const lm = document.getElementById("log-msg");
    if (rm) rm.textContent = "";
    if (lm) lm.textContent = "";
  }

  async function loadMe(){
    try{
      const r = await api("/api/me");
      if (!r || !r.user) throw new Error("no session");
      if (typeof WHO !== "undefined") WHO = r.user;
      setLoggedInUI();

      const b = document.getElementById("buysToNext");
      if (b) {
        b.textContent = (typeof WHO?.buys_to_next === "number")
          ? `Buys to next recipe: ${WHO.buys_to_next}`
          : "Buys to next recipe: —";
      }

      await safeCall("loadInventoryPanel");
      safeCall("loadRecipes");
      safeCall("loadMarket");
      safeCall("loadMine");
      safeCall("loadInventoryFull");

      setTab("shop");
      document.getElementById("app")?.scrollIntoView({behavior:"smooth", block:"start"});
    }catch{
      setLoggedOutUI();
    }
  }

  async function doRegister(){
    const msg = document.getElementById("reg-msg");
    try{
      const email = document.getElementById("reg-email")?.value.trim();
      const pass  = document.getElementById("reg-pass")?.value || "";
      if (!email || !pass) throw new Error("Enter email & password.");
      if (pass.length < 6) throw new Error("Password too short (min 6).");
      if (msg) msg.textContent = "…";
      await api("/api/register", { method:"POST", body: JSON.stringify({ email, password: pass }) });
      if (msg) msg.textContent = "OK — now log in.";
      const cr = document.getElementById("card-register");
      const cl = document.getElementById("card-login");
      if (cr) cr.style.display = "none";
      if (cl) cl.style.display = "block";
      document.getElementById("log-email")?.focus();
    }catch(e){
      if (msg) msg.textContent = e?.message || "Register failed.";
    }
  }

  async function doLogin(){
    const msg = document.getElementById("log-msg");
    try{
      const email = document.getElementById("log-email")?.value.trim();
      const pass  = document.getElementById("log-pass")?.value || "";
      if (!email || !pass) throw new Error("Enter email & password.");
      if (msg) msg.textContent = "…";
      await api("/api/login", { method:"POST", body: JSON.stringify({ email, password: pass }) });
      if (msg) msg.textContent = "OK";
      await loadMe();
    }catch(e){
      if (msg) msg.textContent = e?.message || "Login failed.";
    }
  }

  async function doLogout(){
    try { await api("/api/logout"); } catch {}
    setLoggedOutUI();
  }

  document.addEventListener("DOMContentLoaded", () => {
    // ubaci #auth odmah ispod headera
    const header = document.querySelector("header.header");
    const auth   = document.getElementById("auth");
    if (header && auth && auth.previousElementSibling !== header) {
      header.insertAdjacentElement("afterend", auth);
    }

    // gumbi u formama
    document.getElementById("btn-register")?.addEventListener("click", doRegister);
    document.getElementById("btn-login")?.addEventListener("click", doLogin);
    document.getElementById("btn-logout")?.addEventListener("click", doLogout);

    // enter tipke
    document.getElementById("reg-email")?.addEventListener("keydown", e=>{ if(e.key==="Enter") doRegister(); });
    document.getElementById("reg-pass") ?.addEventListener("keydown", e=>{ if(e.key==="Enter") doRegister(); });
    document.getElementById("log-email")?.addEventListener("keydown", e=>{ if(e.key==="Enter") doLogin(); });
    document.getElementById("log-pass") ?.addEventListener("keydown", e=>{ if(e.key==="Enter") doLogin(); });

    // HEADER gumbi → otvaraju auth sekciju
    document.getElementById("btn-open-register")?.addEventListener("click", () => {
      const auth = document.getElementById("auth");
      const cr = document.getElementById("card-register");
      const cl = document.getElementById("card-login");
      auth?.classList.remove("hidden");
      if (cr) cr.style.display = "block";
      if (cl) cl.style.display = "none";
      auth?.scrollIntoView({behavior:"smooth", block:"start"});
      document.getElementById("reg-email")?.focus();
    });

    document.getElementById("btn-open-login")?.addEventListener("click", () => {
      const auth = document.getElementById("auth");
      const cr = document.getElementById("card-register");
      const cl = document.getElementById("card-login");
      auth?.classList.remove("hidden");
      if (cl) cl.style.display = "block";
      if (cr) cr.style.display = "none";
      auth?.scrollIntoView({behavior:"smooth", block:"start"});
      document.getElementById("log-email")?.focus();
    });

    loadMe();
  });
</script>

<!-- == SHOP (Buy T1) == -->
<script>
function updateShopBalanceBadge(){
  const el = document.getElementById("shop-balance");
  if (!el) return;
  const s = (WHO?.balance_silver ?? 0) | 0;
  const g = Math.floor(s/100), ss = s%100;
  if (WHO) {
    el.textContent = `${g}g ${ss}s`;
    el.classList.remove("hidden");
  } else {
    el.textContent = "0g 0s";
    el.classList.add("hidden");
  }
}

function renderShopGotItem(obj){
  const msg = document.querySelector("#shop-msg");
  if(!msg) return;
  const icon = iconForByCode(obj.code, obj.tier);
  msg.innerHTML =
    `<div class="row" style="gap:10px;align-items:center">
      <img class="icon" src="${esc(icon)}" alt="" onerror="imgFallback(this)">
      <div>Got item: ${esc(obj.name)} <span class="badge">T${obj.tier}</span></div>
    </div>`;
}

function renderShopGotRecipe(rec){
  const msg = document.querySelector("#shop-msg");
  if(!msg) return;
  msg.innerHTML =
    `<div class="row" style="gap:10px;align-items:center">
      <img class="icon" src="${RECIPE_ICON}" alt="" onerror="imgFallback(this)">
      <div>Got recipe: ${esc(rec.name)} <span class="badge">T${rec.tier}</span></div>
    </div>`;
}

function updateBuysToNextFromWHO(){
  const b = document.querySelector("#buysToNext");
  if (!b) return;
  b.textContent = (typeof WHO?.buys_to_next === "number")
    ? `Buys to next recipe: ${WHO.buys_to_next}`
    : "Buys to next recipe: —";
}

async function refreshMeLight(){
  try{
    const r = await api("/api/me");
    if (r?.user) {
      WHO = r.user;
      renderBalance?.();
      updateShopBalanceBadge();
      updateBuysToNextFromWHO();
    }
  }catch{}
}

document.querySelector("#btn-buy-t1")?.addEventListener("click", async ()=>{
  const btn = document.querySelector("#btn-buy-t1");
  const prevTxt = btn?.textContent;
  const msg = document.querySelector("#shop-msg");

  try{
    if (msg) msg.textContent = "";
    if (btn){ btn.disabled = true; btn.textContent = "Buying…"; }

    const r = await api("/api/shop/buy-t1",{method:"POST",body:JSON.stringify({})});

    if (WHO) WHO.balance_silver = (r.balance_silver | 0);
    renderBalance?.();
    updateShopBalanceBadge();

    if (r.gotRecipe)      renderShopGotRecipe(r.gotRecipe);
    else if (r.gotItem)   renderShopGotItem(r.gotItem);
    else if (msg)         msg.textContent = "OK";

    await refreshMeLight();

    await (typeof loadInventoryPanel==="function" ? loadInventoryPanel() : Promise.resolve());
    if (typeof loadRecipes==="function")       loadRecipes();
    if (typeof loadInventoryFull==="function") loadInventoryFull();
    if (typeof loadMarket==="function")        loadMarket();
    if (typeof loadMine==="function")          loadMine();

  }catch(e){
    if (e?.status === 401 || /not logged in/i.test(String(e?.message||""))) {
      document.getElementById("auth")?.classList.remove("hidden");
      const login = document.getElementById("card-login");
      const reg   = document.getElementById("card-register");
      if (login) login.style.display = "block";
      if (reg)   reg.style.display   = "none";
    }
    if (msg) msg.textContent = e?.message || "Buy failed.";
    else alert(e?.message || "Buy failed.");
  }finally{
    if (btn){ btn.disabled = false; btn.textContent = prevTxt || "Buy"; }
  }
});

document.addEventListener("DOMContentLoaded", updateShopBalanceBadge);
</script>

<!-- ===== CRAFTING ===== -->
<script>
  function rowRecipe(r){
    return `
      <div class="itemrow">
        <div class="row" style="gap:10px;align-items:center">
          <img class="icon" src="${RECIPE_ICON}" alt="" onerror="imgFallback(this)">
          <div>
            <div class="label" style="text-transform:none;color:var(--text)">${esc(r.name)}</div>
            <div class="muted">T${r.tier} · x${r.qty}</div>
          </div>
        </div>
        <button class="btn muted" data-open="${esc(r.id)}">Open</button>
      </div>`;
  }

  async function loadRecipes(){
    const box = $("#recipes"); if (!box) return;
    box.textContent = "Loading…";
    try{
      const list = await api("/api/recipes/list");
      const q = ($("#filter-recipe")?.value || "").trim().toLowerCase();
      const rows = (list?.recipes || []).filter(x => !q || x.name.toLowerCase().includes(q));
      if (!rows.length){ box.textContent = "No recipes."; return; }
      box.innerHTML = rows.map(rowRecipe).join("");
      box.querySelectorAll("[data-open]").forEach(btn=>{
        btn.addEventListener("click",()=>openRecipe(btn.getAttribute("data-open")));
      });
    }catch(e){
      box.textContent = e?.message || "Failed to load recipes.";
    }
  }

  document.getElementById("btn-refresh-rec")?.addEventListener("click", loadRecipes);
  document.getElementById("filter-recipe")?.addEventListener("input", loadRecipes);

  function renderIngredients(details){
    const parts = (details.ingredients||[]).map(ing=>{
      const ok  = (ing.have|0) >= (ing.qty|0);
      const src = iconForByCode(ing.code, ing.tier);
      return `
        <div class="itemrow">
          <div class="row" style="gap:10px;align-items:center">
            <img class="icon" src="${esc(src)}" alt="" onerror="imgFallback(this)">
            <div>${esc(ing.name)} <span class="badge">T${ing.tier}</span></div>
          </div>
          <div class="${ok ? "" : "muted"}">${ing.have}/${ing.qty}</div>
        </div>`;
    }).join("");

    const canCraft = (details.ingredients||[]).every(ing => (ing.have|0) >= (ing.qty|0));
    const craftNote = canCraft ? "10% fail → Scrap (server checks ingredients)"
                               : "You are missing materials for this recipe.";

    return `
      <div class="itemrow"><div><b>${esc(details.recipe.name)}</b> <span class="badge">T${details.recipe.tier}</span></div></div>
      <div class="itemrow"><div class="muted">Ingredients</div></div>
      ${parts}
      <div class="itemrow">
        <button id="btn-craft" class="btn" ${canCraft ? "" : "disabled"}>${canCraft ? "Craft" : "Missing materials"}</button>
        <span class="muted" style="margin-left:8px">${craftNote}</span>
      </div>`;
  }

  async function openRecipe(recipeId){
    const box = $("#rec-details"); if (!box) return;
    box.textContent = "Loading…";
    try{
      const details = await api(`/api/recipes/ingredients/${encodeURIComponent(recipeId)}`);
      box.innerHTML = renderIngredients(details);
      window.CURRENT_RECIPE_ID = details.recipe.id;

      const btn = $("#btn-craft");
      btn?.addEventListener("click", async ()=>{
        if (btn.disabled) return;
        const prev = btn.textContent; btn.disabled = true; btn.textContent = "Crafting…";
        try{
          const r2 = await api("/api/craft/do",{method:"POST",body:JSON.stringify({recipe_id: details.recipe.id})});
          if (r2.crafted)      toast(`Crafted: ${r2.crafted.name} (T${r2.crafted.tier})`);
          else if (r2.scrap)   toast("Failed (got Scrap)");
          else                 toast("Done");
          await safeCall("loadInventoryPanel");
          await safeCall("loadRecipes");
          await safeCall("loadInventoryFull");
          await openRecipe(details.recipe.id);
        }catch(e){
          if (e?.data?.missing?.length) {
            toast("You are missing: " + e.data.missing.join(", "));
          } else {
            toast(e?.message || "Crafting failed.");
          }
        }finally{
          btn.disabled = false; btn.textContent = prev;
        }
      });
    }catch(e){
      box.textContent = e?.message || "Failed to load recipe.";
    }
  }

  async function refreshArtefactBonus(){
    try{
      const r = await api("/api/items/artefact/bonus");
      const bonus = (typeof r?.bonus_gold === "number") ? r.bonus_gold : (parseInt(r?.bonus_gold,10) || 0);
      const el = document.querySelector("#artefact-bonus");
      if (el) el.textContent = bonus;
    }catch(e){
      console.warn("refreshArtefactBonus failed:", e);
    }
  }
  (() => {
    const craft = document.querySelector("#tab-craft");
    if (!craft) return;
    const obs = new MutationObserver(() => {
      if (!craft.classList.contains("hidden")) refreshArtefactBonus();
    });
    obs.observe(craft, { attributes:true });
  })();

  const arteBtn = $("#btn-artefact");
  arteBtn?.addEventListener("click", async ()=>{
    if (arteBtn.disabled) return;
    const prev = arteBtn.textContent; arteBtn.disabled = true; arteBtn.textContent = "Crafting…";
    try{
      const r = await api("/api/craft/artefact",{method:"POST",body:JSON.stringify({})});
      const name  = r.crafted || "Artefact";
      const bonus = (typeof r?.bonus_gold === "number") ? r.bonus_gold : (parseInt(r?.bonus_gold,10) || 0);
      $("#artefact-bonus")?.textContent = bonus;
      $("#artefact-msg")?.textContent = `Crafted: ${name} (+${bonus} gold)`;
      await safeCall("loadInventoryPanel");
      await safeCall("loadInventoryFull");
      await safeCall("loadRecipes");
    }catch(e){
      $("#artefact-msg")?.textContent = e?.message || "Crafting failed.";
    }finally{
      arteBtn.disabled = false; arteBtn.textContent = prev;
    }
  });
</script>

<!-- ===== MARKET (inventory panel, market, mine, list) ===== -->
<script>
window.SEL_INV = null;

/* ===== INVENTORY PANEL (Create Sale, lijevi stupac) ===== */
async function loadInventoryPanel(){
  const box = document.querySelector("#inv-list"); if(!box) return;
  box.textContent = "Loading…";
  try{
    const r  = await api("/api/inventory"); // {items, recipes}
    const q  = (document.querySelector("#inv-search")?.value || "").trim().toLowerCase();
    const items   = (r.items||[]).filter(x => !q || x.name.toLowerCase().includes(q));
    const recipes = (r.recipes||[]).filter(x => !q || x.name.toLowerCase().includes(q));

    box.innerHTML = "";
    const add = (arr, kind) => {
      for (const it of arr){
        const icon = (kind==="item") ? iconForByCode(it.code, it.tier) : RECIPE_ICON;
        const row  = document.createElement("div");
        row.className = "itemrow";
        row.innerHTML = `
          <div class="row" style="gap:10px;align-items:center">
            <img class="icon" src="${esc(icon)}" alt="" onerror="imgFallback(this)">
            <div>${esc(it.name)} <span class="badge">T${it.tier}</span> <span class="muted">x${it.qty}</span></div>
          </div>
          <button class="btn muted">Pick</button>`;
        row.querySelector("button").addEventListener("click", ()=>{
          window.SEL_INV = { kind, id: it.id, name: it.name };
          const m = document.querySelector("#list-msg"); if (m) m.textContent = "Selected: "+it.name;
        });
        box.appendChild(row);
      }
    };
    add(items,"item");
    add(recipes,"recipe");
    if (!box.children.length) box.textContent = "Empty.";
  }catch(e){
    box.textContent = e?.message || "Failed.";
  }
}
document.querySelector("#inv-search")?.addEventListener("input", loadInventoryPanel);

/* ===== MARKETPLACE (desno, gornji blok) ===== */
async function loadMarket(){
  const box = document.querySelector("#market"); if(!box) return;
  box.textContent = "Loading…";
  try{
    const q = document.querySelector("#market-q")?.value?.trim() || "";
    const r = await api("/api/sales/live" + (q?("?q="+encodeURIComponent(q)):""));
    const rows = (r?.listings || []).filter(Boolean);
    if (!rows.length){ box.textContent="No listings."; return; }

    box.innerHTML = "";
    for (const s of rows){
      const priceS = s?.price_s | 0;
      const g  = Math.floor(priceS/100), ss = priceS%100;
      const ico = (s && s.kind==="item") ? iconForByCode(s.code, s.tier) : RECIPE_ICON;
      const title = s?.name || (s?.kind==="item" ? `Item #${s?.item_id??"-"}` : `Recipe #${s?.recipe_id??"-"}`);
      const row = document.createElement("div");
      row.className = "itemrow";
      row.innerHTML = `
        <div class="row" style="gap:10px;align-items:center">
          <img class="icon" src="${esc(ico)}" alt="" onerror="imgFallback(this)">
          <div>${esc(title)} <span class="badge">T${s?.tier ?? "-"}</span> <span class="muted">x${s?.qty ?? 1}</span></div>
        </div>
        <div class="row">
          <span class="badge">${g}g ${ss}s</span>
          <button class="btn">Buy</button>
        </div>`;
      const btn = row.querySelector("button");
      btn.addEventListener("click", async ()=>{
        if (btn.disabled) return;
        const prev = btn.textContent; btn.disabled = true; btn.textContent = "Buying…";
        try{
          await api("/api/sales/buy",{method:"POST",body:JSON.stringify({id:s.id})});
          toast("Purchased.");
          loadMarket(); loadMine(); loadInventoryPanel(); safeCall("loadInventoryFull"); safeCall("loadMe");
        }catch(e){
          alert(e.message);
        }finally{
          btn.disabled = false; btn.textContent = prev;
        }
      });
      box.appendChild(row);
    }
  }catch(e){
    box.textContent = e?.message || "Failed.";
  }
}
document.querySelector("#market-q")?.addEventListener("input", loadMarket);

/* ===== MOJI LISTINGS (desno, donji blok) ===== */
async function loadMine(){
  const box = document.querySelector("#mine"); if(!box) return;
  box.textContent = "Loading…";
  try{
    const r = await api("/api/sales/mine");
    const rows = (r?.listings || []).filter(Boolean);
    if (!rows.length){ box.textContent="No listings."; return; }

    box.innerHTML = "";
    for (const s of rows){
      const priceS = s?.price_s | 0;
      const g  = Math.floor(priceS/100), ss = priceS%100;
      const ico = (s && s.kind==="item") ? iconForByCode(s.code, s.tier) : RECIPE_ICON;
      const title = s?.name || (s?.kind==="item" ? `Item #${s?.item_id??"-"}` : `Recipe #${s?.recipe_id??"-"}`);

      const row = document.createElement("div");
      row.className = "itemrow";
      row.innerHTML = `
        <div class="row" style="gap:10px;align-items:center">
          <img class="icon" src="${esc(ico)}" alt="" onerror="imgFallback(this)">
          <div>${esc(title)} <span class="badge">T${s?.tier ?? "-"}</span> <span class="muted">x${s?.qty ?? 1}</span> <span class="badge">${esc(s?.status||"-")}</span></div>
        </div>
        <div class="row">
          <span class="badge">${g}g ${ss}s</span>
          ${s?.status==='live' ? '<button class="btn danger">Cancel</button>' : ''}
        </div>`;
      if (s?.status==='live'){
        const btn = row.querySelector("button");
        btn.addEventListener("click", async ()=>{
          if (btn.disabled) return;
          const prev = btn.textContent; btn.disabled = true; btn.textContent = "Cancel…";
          try{
            await api("/api/sales/cancel",{method:"POST",body:JSON.stringify({id:s.id})});
            loadMarket(); loadMine(); loadInventoryPanel();
          }catch(e){ alert(e.message); }
          finally{ btn.disabled = false; btn.textContent = prev; }
        });
      }
      box.appendChild(row);
    }
  }catch(e){
    box.textContent = e?.message || "Failed.";
  }
}
document.querySelector("#btn-mine")?.addEventListener("click", loadMine);

/* ===== LIST FOR SALE (gumb ispod Create Sale) ===== */
document.querySelector("#btn-list")?.addEventListener("click", async ()=>{
  try{
    const sel = window.SEL_INV;
    if (!sel){ alert("Pick an item/recipe first."); return; }

    const gold   = parseInt(document.querySelector("#price-g")?.value || "0", 10) || 0;
    let   silver = parseInt(document.querySelector("#price-s")?.value || "0", 10) || 0;
    const qty    = Math.max(1, parseInt(document.querySelector("#price-qty")?.value || "1", 10) || 1);
    if (silver < 0) silver = 0;
    if (silver > 99) silver = 99;

    await api("/api/sales/list", {
      method: "POST",
      body: JSON.stringify({ kind: sel.kind, id: sel.id, qty, gold, silver })
    });

    const msg = document.querySelector("#list-msg");
    if (msg) msg.textContent = "Listed.";
    window.SEL_INV = null;

    loadMarket(); loadMine(); loadInventoryPanel();
  }catch(e){
    alert(e?.message || "Listing failed.");
  }
});
</script>

<!-- ===== INVENTORY (full) ===== -->
<script>
  async function loadInventoryFull(){
    const box=$("#inv-full"); if(!box) return;
    box.textContent="Loading…";
    try{
      const r = await api("/api/inventory");
      const lines=[];
      for(const it of (r.items||[])){
        const icon = iconForByCode(it.code, it.tier);
        lines.push(`
          <div class="itemrow">
            <div class="row" style="gap:10px;align-items:center">
              <img class="icon" src="${esc(icon)}" alt="" onerror="imgFallback(this)">
              <div>${esc(it.name)} <span class="badge">T${it.tier}</span></div>
            </div>
            <div class="muted">x${it.qty}</div>
          </div>`);
      }
      for(const rc of (r.recipes||[])){
        lines.push(`
          <div class="itemrow">
            <div class="row" style="gap:10px;align-items:center">
              <img class="icon" src="${RECIPE_ICON}" alt="" onerror="imgFallback(this)">
              <div>${esc(rc.name)} <span class="badge">T${rc.tier}</span></div>
            </div>
            <div class="muted">x${rc.qty}</div>
          </div>`);
      }
      box.innerHTML = lines.join("") || "Empty.";
    }catch(e){
      box.textContent = e?.message || "Failed.";
    }
  }
</script>
</body>
</html>
