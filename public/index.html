<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ARTEFACT</title>

  <!-- Minimal fallback -->
  <style>html,body{background:#000;color:#e5e7eb;margin:0}</style>

  <!-- PayPal SDK lazy loader (isto) -->
  <script>
    (async function loadPayPalSDK(){
      try{
        const r = await fetch("/api/paypal/config", { credentials:"include" });
        const j = await r.json().catch(()=>null);
        if (!r.ok || !j?.ok || !j?.client_id) {
          console.warn("PayPal not configured:", j?.error || r.status);
          window.__PAYPAL_DISABLED__ = true;
          return;
        }
        const qs = new URLSearchParams({
          "client-id": j.client_id,
          "currency": j.currency || "USD",
          "intent": "capture",
          "components": "buttons"
        });
        const s = document.createElement("script");
        s.src = `https://www.paypal.com/sdk/js?${qs.toString()}`;
        s.async = true;
        s.onload = () => { window.__PAYPAL_READY__ = true; };
        document.head.appendChild(s);
        window.__PAYPAL_MIN_USD__ = j.min_usd || 1;
      }catch(e){
        console.warn("PayPal SDK load failed:", e);
        window.__PAYPAL_DISABLED__ = true;
      }
    })();
  </script>

  <link rel="stylesheet" href="/app.css" />
</head>
<body>
  <!-- ===== Header ===== -->
  <header class="header no-border">
    <div class="brand">ARTEFACT</div>
    <div class="row" style="gap:8px">
      <span id="balance" class="badge hidden">0g 0s</span>
      <button id="btn-open-paypal" class="btn secondary hidden">PayPal</button>
      <button id="btn-open-register" class="btn secondary">Register</button>
      <button id="btn-open-login" class="btn">Log in</button>
      <button id="btn-logout" class="btn muted hidden">Log out</button>
    </div>
  </header>

  <!-- ===== PayPal panel ===== -->
<section id="paypal-panel" class="card hidden">
  <div class="row" style="align-items:center; gap:8px; flex-wrap:wrap">
    <label for="pp-amount" class="label" style="margin:0">Amount (USD)</label>
    <input id="pp-amount" class="input" type="number" min="1" step="1" value="1" placeholder="USD" style="width:120px" />
    <label for="pp-bonus" class="label" style="margin:0">Bonus code</label>
    <input id="pp-bonus" class="input" type="text" maxlength="32" placeholder="optional" style="width:240px" />
  </div>
  <div class="row" style="margin-top:10px">
    <div id="paypal-button-container"></div>
  </div>
  <div id="pp-msg" class="muted" style="margin-top:8px"></div>
</section>


  <!-- ===== Auth ===== -->
  <section id="auth" class="card hidden" style="margin-top:12px">
    <div id="card-register" style="display:none">
      <div class="label">Register</div>
      <input id="reg-email" class="input" placeholder="email@example.com" type="email" />
      <input id="reg-pass" class="input" placeholder="password (min 6)" type="password" style="margin-top:8px" />
      <button id="btn-register" class="btn" style="margin-top:8px">Register</button>
      <div id="reg-msg" class="muted" style="margin-top:6px"></div>
    </div>
    <div id="card-login" style="display:none">
      <div class="label">Log in</div>
      <input id="log-email" class="input" placeholder="email@example.com" type="email" />
      <input id="log-pass" class="input" placeholder="password" type="password" style="margin-top:8px" />
      <button id="btn-login" class="btn secondary" style="margin-top:8px">Log in</button>
      <div id="log-msg" class="muted" style="margin-top:6px"></div>
    </div>
  </section>

  <!-- ===== App (tabs) ===== -->
  <section id="app">
    <div class="tabbar row">
      <div class="chip active" data-tab="shop">Shop</div>
      <div class="chip" data-tab="craft">Crafting</div>
      <div class="chip" data-tab="market">Market</div>
      <div class="chip" data-tab="inv">Inventory</div>
      <div class="chip" data-tab="bonus">Bonus</div>
    </div>

    <!-- SHOP -->
    <div id="tab-shop" class="card">
      <div class="row">
        <div class="label">Buy T1 (<span id="shop-price-inline">100</span>s)</div>
      </div>

      <div class="row">
        <span id="buysToNext" class="muted">Buys to next recipe: —</span>
      </div>

      <div style="margin:6px 0">
        <span id="shop-balance" class="badge hidden">0g 0s</span>
      </div>

      <div class="row">
        <button id="btn-buy-t1" class="btn">Buy</button>
        <div id="shop-msg" class="muted"></div>
      </div>

      <!-- Uvod -->
      <div id="shop-intro" class="card" style="margin-top:12px">
        <div class="label" style="line-height:1.2;margin-bottom:6px">GAME</div>
        <p class="muted" style="max-width:820px">
          You collect materials, unlock recipes, and craft increasingly powerful items (T2 → T5).
          When you gather <b>10 different T5</b>, you can assemble an <b>ARTEFACT</b> that grants you a gold bonus.
        </p>

        <div class="grid" style="margin-top:12px">
          <div class="card">
            <div class="row" style="justify-content:space-between;align-items:center">
              <div class="label">1) Shop</div>
              <span class="badge">Price: <span id="shop-price-badge">100s</span></span>
            </div>
            <p class="muted">
              In the Shop, you buy <b>T1 materials</b>, and occasionally you also receive <b>recipes</b>.<br>
              Materials are ingredients for crafting, while recipes unlock higher tiers.
            </p>
            <img src="/t1_bronze.png" alt="T1 example" class="img-landing" onerror="this.style.display='none'">
            <img src="/recipe.png" alt="Recipe example" class="img-landing" onerror="this.style.display='none'">
          </div>

          <div class="card">
            <div class="label">2) Crafting</div>
            <p class="muted">
              With a recipe and the required materials, you can craft <b>T2, T3, T4</b> and, finally, <b>T5</b> items.<br>
              Crafting can sometimes <i>fail</i> and yield <b>Scrap</b> —
              <span id="craft-fail-note" class="badge">10% fail</span>
            </p>
            <img src="/t2_golden_ring.png" alt="T2" class="img-landing" onerror="this.style.display='none'">
            <img src="/t3_gate_of_might.png" alt="T3" class="img-landing" onerror="this.style.display='none'">
            <img src="/t4_engine_core.png" alt="T4" class="img-landing" onerror="this.style.display='none'">
            <img src="/t5_ancient_relic.png" alt="T5" class="img-landing" onerror="this.style.display='none'">
          </div>

          <div class="card">
            <div class="label">3) Market</div>
            <p class="muted">
              You can <b>sell</b> surplus materials or recipes, and <b>buy</b> what you’re missing from others.<br>
              Through trading, you speed up your progress toward T5 sets. <br>
              <span id="market-fee-note" class="badge">Fee: 1%</span>
              <span id="market-min-note" class="badge hidden">Min: 90s</span>
            </p>
          </div>

          <div class="card">
            <div class="label">4) Artefact</div>
            <p class="muted">
              When you have <b>10 different T5</b>, you can craft an <b>ARTEFACT</b>.<br>
              It provides a permanent <b>gold bonus</b> — and unlocks the <b>Bonus</b> section.
            </p>
            <img src="/artefakt.png" alt="Artefact" class="img-landing" onerror="this.style.display='none'">
          </div>
        </div>

        <section class="card" style="margin-top:12px">
          <div class="label">Tips</div>
          <ul class="muted" style="margin:6px 0 0 18px;line-height:1.5">
            <li>Shop smart — recipes drop occasionally, so save your gold for key moments.</li>
            <li>Craft in order of priority—focus on the recipes you have and the materials you can easily replace</li>
            <li>The market is the best way to fill gaps in your set and sell what you don’t need.</li>
            <li>Aim to collect 10 <i>different</i> T5 items — duplicates don’t count toward the ARTEFAKT.</li>
          </ul>
        </section>
      </div>
    </div>

    <!-- CRAFTING -->
    <div id="tab-craft" class="card hidden">
      <div class="row">
        <div class="label">Crafting</div>
        <span id="craft-perk" class="badge muted" title="Crafting fail chance">10% fail</span>
        <button id="btn-artefact" class="btn right">
          <img src="/artefakt.png" alt="Artefact" class="img-cell" onerror="this.onerror=null;this.style.display='none'">
          Craft ARTEFACT (10× distinct T5)
        </button>
      </div>
      <div style="margin-top:8px">Bonus gold: <span id="artefact-bonus">0</span></div>
      <div id="artefact-msg" class="muted" style="margin-top:4px"></div>

      <div class="grid">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div class="label">Recipes you own</div>
            <div class="row">
              <input id="filter-recipe" class="input" placeholder="filter by name..." style="width:220px"/>
              <button id="btn-refresh-rec" class="btn muted">Refresh</button>
            </div>
          </div>
          <div id="recipes" class="list">Loading…</div>
        </div>

        <div class="card">
          <div class="label">Details</div>
          <div id="rec-details" class="list">Select a recipe on the left.</div>
        </div>
      </div>
    </div>

    <!-- MARKET -->
    <section id="tab-market" class="card hidden">
      <div class="label">Marketplace</div>
      <div class="grid">
        <!-- Create Sale + Inventory (panel) -->
        <div class="card">
          <div class="label">Create Sale</div>
          <input id="inv-search" class="input" placeholder="Search your inventory..." />
          <div id="inv-list" class="list" style="margin-top:8px;max-height:300px">Loading…</div>

          <div class="row" style="margin-top:8px">
            <input id="price-g"   class="input" style="width:100px" placeholder="Gold"/>
            <input id="price-s"   class="input" style="width:120px" placeholder="Silver (0–99)"/>
            <input id="price-qty" class="input" style="width:100px" placeholder="Qty"/>
            <button id="btn-list" class="btn">List for sale</button>
          </div>

          <div class="row muted" style="margin-top:6px; gap:8px">
            <span id="market-fee-inline" class="badge">Fee: 1%</span>
            <span id="market-min-inline" class="badge hidden">Min: 90s</span>
          </div>
          <div id="list-msg" class="muted" style="margin-top:6px"></div>
        </div>

        <!-- Marketplace + My listings -->
        <div class="card">
          <div class="row" style="gap:10px;align-items:center">
            <div class="label">Marketplace</div>
            <input id="market-q" class="input" placeholder="Search by name..." style="width:240px" />
          </div>
          <div id="market" class="list">Loading…</div>

          <div class="row" style="gap:10px;align-items:center;margin-top:12px">
            <div class="label">My listings</div>
            <input id="mine-q" class="input" placeholder="Search my listings..." style="width:240px" />
            <button id="btn-mine" class="btn muted">Reload</button>
          </div>
          <div id="mine" class="list">Loading…</div>
        </div>
      </div>
    </section>

    <!-- INVENTORY (FULL TAB) -->
    <section id="tab-inv" class="card hidden">
      <div class="label">Inventory</div>
      <div id="inv-full" class="list">Loading…</div>
    </section>

   <!-- BONUS -->
<div id="tab-bonus" class="card hidden">
  <div class="row" style="justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap">
    <div class="label">Bonus</div>

    <!-- *** NOVA SEKCIJA (EMAIL + GOLD + SEND) *** -->
    <div class="row" style="gap:8px; align-items:center; flex-wrap:wrap">
      <input id="transfer-email" class="input" type="email" placeholder="email@example.com" style="min-width:220px">
      <input id="transfer-gold" class="input" type="number" inputmode="numeric" placeholder="Gold" style="width:120px">
      <button id="btn-transfer" class="btn">Send</button>
    </div>
    <!-- *** KRAJ NOVIH ELEMENATA *** -->

    <span id="bonus-lock" class="badge hidden">Locked — craft ARTEFACT to unlock</span>
  </div>

  <div id="bonus-grid" class="grid" style="margin-top:8px">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="label">T2 Bonus</div>
        <button id="btn-claim-t2" class="btn" disabled>Claim</button>
      </div>
      <div class="muted" style="margin:4px 0 6px">Shop price 98s (was 100s)</div>
      <div id="bonus-t2" class="list" style="max-height:240px">Loading…</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="label">T3 Bonus</div>
        <button id="btn-claim-t3" class="btn" disabled>Claim</button>
      </div>
      <div class="muted" style="margin:4px 0 6px">Market fee 0% (was 1%)</div>
      <div id="bonus-t3" class="list" style="max-height:240px">Loading…</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="label">T4 Bonus</div>
        <button id="btn-claim-t4" class="btn" disabled>Claim</button>
      </div>
      <div class="muted" style="margin:4px 0 6px">Shop price 90s + Craft no-fail</div>
      <div id="bonus-t4" class="list" style="max-height:240px">Loading…</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="label">T5 Bonus</div>
        <button id="btn-claim-t5" class="btn" disabled>Claim</button>
      </div>
      <div class="muted" style="margin:4px 0 6px">Shop price 90s + Recipe drops T3+ + Craft no-fail</div>
      <div id="bonus-t5" class="list" style="max-height:240px">Loading…</div>
    </div>
  </div>
</div>


  <!-- ===== Helpers: $, $$, toast, api, safeCall (GLOBAL, PRIJE SVEGA) ===== -->
  <script>
    (function(){
      const w = window;

      w.$  = w.$  || ((s,root=document)=>root.querySelector(s));
      w.$$ = w.$$ || ((s,root=document)=>Array.from(root.querySelectorAll(s)));

      // Sigurni toast bez kolizije s #toast elementom
      w.showToast = w.showToast || function(t){
        const box = document.getElementById("toast");
        if (box && box.classList) {
          box.textContent = t;
          box.classList.remove("hidden");
          setTimeout(()=>box.classList.add("hidden"), 2600);
        } else {
          alert(t);
        }
      };
      // Ako je window.toast DOM element zbog id="toast", prepiši ga funkcijom
      try { if (typeof w.toast !== "function") w.toast = w.showToast; } catch(_) { w.toast = w.showToast; }

      // api helper (GET bez Content-Type; tolerira 204/loš JSON)
      w.api = w.api || (async function api(path, opts={}){
        const method = (opts.method || "GET").toUpperCase();
        const headers = Object.assign({}, opts.headers || {});
        const init = { credentials: "include", ...opts, method };
        if (method !== "GET" && method !== "HEAD") {
          headers["Content-Type"] = headers["Content-Type"] || "application/json";
        }
        init.headers = headers;

        if (init.body && typeof init.body === "object" && !(init.body instanceof FormData)) {
          init.body = JSON.stringify(init.body);
        }

        let res;
        try {
          res = await fetch(path, init);
        } catch (e) {
          const err = new Error("Network error"); err.cause = e; throw err;
        }

        let data = null;
        const text = await res.text().catch(()=>null);
        if (text && text.trim().length) {
          try { data = JSON.parse(text); } catch { data = { ok:false, error:"Invalid JSON" }; }
        } else {
          data = (res.status===204) ? { ok:true } : (data || {});
        }

        if (!res.ok) {
          const err = new Error((data && data.error) || ("HTTP " + res.status));
          err.status = res.status; err.data = data; throw err;
        }
        return data;
      });

      w.safeCall = w.safeCall || (async function(fnName, ...args){
        const fn = w[fnName];
        if (typeof fn === "function") {
          try { return await fn(...args); }
          catch (e) { console.warn(fnName, "failed:", e); }
        }
      });
    })();
  </script>

  <!-- ===== Icons & mapping ===== -->
  <script>
    const IMG_PREFIX = "/"; // promijeni u "/images/" ako su slike u /public/images
    const RECIPE_ICON = `${IMG_PREFIX}recipe.png`;
    const FALLBACK_ITEM_ICON = `${IMG_PREFIX}t1_bronze.png`;

    const esc = s => String(s)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");

    function fileNameFromCodeTier(code, tier){
      if(!code) return null;
      const m = String(code).match(/^T([1-6])_(.*)$/);
      if (m) return `t${m[1]}_${m[2].toLowerCase()}.png`;
      if ((tier|0)===1) return `t1_${String(code).toLowerCase()}.png`;
      return null;
    }
    function iconForByCode(code, tier){
      const file = fileNameFromCodeTier(code, tier);
      return file ? `${IMG_PREFIX}${file}` : FALLBACK_ITEM_ICON;
    }
  </script>

  <!-- ===== Global state + Tabs + PayPal panel ===== -->
  <script>
    let WHO = window.WHO || null;
    window.CURRENT_RECIPE_ID = null;
    window.refreshMeLight ||= async () => {};

    function showApp(){ $("#app")?.classList.remove("hidden"); }

    function renderBalance(){
      const v = WHO?.balance_silver || 0;
      const g = Math.floor(v/100), s = v%100;
      const el = $("#balance");
      if (el) {
        el.textContent = `${g}g ${s}s`;
        el.classList.add("pulse");
        setTimeout(()=> el.classList.remove("pulse"), 1300);
      }
    }

    function applyPerkIndicators(){
      const price = WHO?.perks?.shop_price_s ?? 100;
      $("#shop-price-badge") && ($("#shop-price-badge").textContent = `${price}s`);
      $("#shop-price-inline") && ($("#shop-price-inline").textContent = String(price));

      const noFail = !!WHO?.perks?.craft_no_fail;
      $("#craft-fail-note") && ($("#craft-fail-note").textContent = noFail ? "No fail" : "10% fail");
      $("#craft-perk") && ($("#craft-perk").textContent = noFail ? "No fail" : "10% fail");

      const fee = WHO?.perks?.auction_fee_bps===0 ? "0%" : "1%";
      $("#market-fee-note") && ($("#market-fee-note").textContent = `Fee: ${fee}`);
      $("#market-fee-inline") && ($("#market-fee-inline").textContent = `Fee: ${fee}`);

      const minNote = !!WHO?.perks?.min_list_price_s;
      $("#market-min-note")?.classList.toggle("hidden", !minNote);
      $("#market-min-inline")?.classList.toggle("hidden", !minNote);
    }

    async function setTab(tab){
      showApp();
      $$(".chip").forEach(c => c.classList.toggle("active", c.dataset.tab === tab));
      $("#tab-shop")  ?.classList.toggle("hidden", tab !== "shop");
      $("#tab-craft") ?.classList.toggle("hidden", tab !== "craft");
      $("#tab-market")?.classList.toggle("hidden", tab !== "market");
      $("#tab-inv")   ?.classList.toggle("hidden", tab !== "inv");
      $("#tab-bonus") ?.classList.toggle("hidden", tab !== "bonus");

      if (tab === "market") {
        safeCall("loadInventoryPanel");
        safeCall("loadMarket");
        safeCall("loadMine");
      }
      if (tab === "inv")   safeCall("loadInventoryFull");
      if (tab === "bonus") { try { await loadBonus(); } catch(e){ console.warn(e); } }
    }

    function initPayPalPanelButtons(){
      try{
        if (window.__PAYPAL_DISABLED__) return;
        const host = document.getElementById("paypal-button-container");
        if (!window.paypal || !host) return;
        if (host.dataset.rendered === "1") return;
        const minUsd = Number(window.__PAYPAL_MIN_USD__ || 10) || 10;
        window.paypal.Buttons({
          style: { layout:'horizontal', height:35, label:'paypal', color:'blue' },
          createOrder: function(_data, actions){
            const el = document.getElementById("pp-amount");
            let v = Math.max(minUsd, parseFloat(el?.value || String(minUsd)) || minUsd);
            v = Math.floor(v);
            if (el) el.value = String(v);
            return actions.order.create({
              purchase_units: [{ amount: { value: v.toFixed(2), currency_code: "USD" } }]
            });
          },
          onApprove: async function(data, actions){
            try{
              await actions.order.capture();
              const bonus_code = (document.getElementById("pp-bonus")?.value || "").trim();
              const r = await api("/api/paypal/confirm", {
                method:"POST",
                body: { orderId: data.orderID, bonus_code }
              });
              if (WHO) WHO.balance_silver = (r.balance_silver|0);
              window.WHO = WHO;
              renderBalance();
              await refreshMeLight();
              const msg = document.getElementById("pp-msg");
              if (msg){
                msg.innerHTML = `Thank you for your payment! Gold has been added.<br>Join our community: <a href="https://discord.gg/VABaCc65" target="_blank" rel="noopener">https://discord.gg/VABaCc65</a>`;
              } else {
                showToast(`Thank you for your payment! Join our community: https://discord.gg/VABaCc65`);
              }
            }catch(e){
              alert(e?.message || "Payment confirm failed.");
            }
          },
          onError: err => {
            console.error("PayPal error:", err);
            alert("PayPal error.");
          }
        }).render("#paypal-button-container");
        host.dataset.rendered = "1";
      }catch(e){
        console.warn("initPayPalPanelButtons failed:", e);
      }
    }

    function togglePaypalPanel(forceOpen){
      if (window.__PAYPAL_DISABLED__) return;
      const panel = document.getElementById("paypal-panel");
      if (!panel) return;
      const open = (typeof forceOpen === "boolean") ? forceOpen : panel.classList.contains("hidden");
      panel.classList.toggle("hidden", !open);
      if (open) initPayPalPanelButtons();
    }

    function setLoggedInUI(){
      $("#btn-open-register")?.classList.add("hidden");
      $("#btn-open-login")?.classList.add("hidden");
      $("#balance")?.classList.remove("hidden");
      $("#btn-logout")?.classList.remove("hidden");
      $("#auth")?.classList.add("hidden");
      $("#app")?.classList.remove("hidden");
      renderBalance?.();
      const ppBtn = document.getElementById("btn-open-paypal");
      if (ppBtn){
        ppBtn.classList.toggle("hidden", !!window.__PAYPAL_DISABLED__);
        if (!ppBtn.dataset.bound){
          ppBtn.addEventListener("click", ()=> togglePaypalPanel());
          ppBtn.dataset.bound = "1";
        }
      }
    }

    function setLoggedOutUI(){
      WHO = null;
      window.WHO = null;
      $("#btn-open-register")?.classList.remove("hidden");
      $("#btn-open-login")?.classList.remove("hidden");
      $("#balance")?.classList.add("hidden");
      $("#btn-logout")?.classList.add("hidden");
      const bal=$("#balance"); if (bal) bal.textContent="0g 0s";
      $("#app")?.classList.remove("hidden");
      $("#auth")?.classList.add("hidden");
      document.getElementById("paypal-panel")?.classList.add("hidden");
      document.getElementById("btn-open-paypal")?.classList.add("hidden");
    }

    async function loadMe(){
      try{
        const r = await api("/api/me");
        if (!r || !r.user) throw new Error("no session");
        WHO = r.user;
        window.WHO = WHO;
        setLoggedInUI();
        const b = $("#buysToNext");
        if (b) b.textContent = (typeof WHO?.buys_to_next === "number")
          ? `Buys to next recipe: ${WHO.buys_to_next}` : "Buys to next recipe: —";
        applyPerkIndicators();
        await safeCall("loadInventoryPanel");
        safeCall("loadRecipes");
        safeCall("loadMarket");
        safeCall("loadMine");
        safeCall("loadInventoryFull");
        setTab("shop");
      }catch{
        setLoggedOutUI();
        setTab("shop");
      }
    }

    function openAuth(mode){
      const auth = document.getElementById("auth");
      if (!auth) return;
      auth.classList.remove("hidden");
      const reg = document.getElementById("card-register");
      const log = document.getElementById("card-login");
      if (reg) reg.style.display = (mode === "register" ? "block" : "none");
      if (log) log.style.display = (mode === "login"    ? "block" : "none");
      if (mode === "register") document.getElementById("reg-email")?.focus();
      if (mode === "login")    document.getElementById("log-email")?.focus();
    }

    document.addEventListener("DOMContentLoaded", () => {
      const header = document.querySelector("header.header");
      const auth = document.getElementById("auth");
      if (header && auth && auth.previousElementSibling !== header) {
        header.insertAdjacentElement("afterend", auth);
      }

      document.getElementById("btn-open-register")?.addEventListener("click", () => openAuth("register"));
      document.getElementById("btn-open-login")?.addEventListener("click", () => openAuth("login"));

      document.getElementById("btn-register")?.addEventListener("click", doRegister);
      document.getElementById("btn-login")?.addEventListener("click", doLogin);
      document.getElementById("btn-logout")?.addEventListener("click", doLogout);

      document.getElementById("reg-email")?.addEventListener("keydown", e=>{ if(e.key==="Enter") doRegister(); });
      document.getElementById("reg-pass")?.addEventListener("keydown", e=>{ if(e.key==="Enter") doRegister(); });
      document.getElementById("log-email")?.addEventListener("keydown", e=>{ if(e.key==="Enter") doLogin(); });
      document.getElementById("log-pass") ?.addEventListener("keydown", e=>{ if(e.key==="Enter") doLogin(); });

      $$(".chip").forEach(c => c.addEventListener("click", ()=> setTab(c.dataset.tab)));

      loadMe();
    });

    async function doRegister(){
      const msg = $("#reg-msg");
      try{
        const email = $("#reg-email")?.value.trim();
        const pass = $("#reg-pass")?.value || "";
        if (!email || !pass) throw new Error("Enter email & password.");
        if (pass.length < 6) throw new Error("Password too short (min 6).");
        msg && (msg.textContent = "…");
        await api("/api/register", { method:"POST", body: { email, password: pass } });
        msg && (msg.textContent = "OK — now log in.");
        $("#card-register") && ($("#card-register").style.display="none");
        $("#card-login") && ($("#card-login").style.display="block");
        $("#log-email")?.focus();
      }catch(e){
        msg && (msg.textContent = e?.message || "Register failed.");
      }
    }

    async function doLogin(){
      const msg = $("#log-msg");
      try{
        const email = $("#log-email")?.value.trim();
        const pass = $("#log-pass")?.value || "";
        if (!email || !pass) throw new Error("Enter email & password.");
        msg && (msg.textContent = "…");
        await api("/api/login", { method:"POST", body: { email, password: pass } });
        msg && (msg.textContent = "OK");
        await loadMe();
      }catch(e){
        msg && (msg.textContent = e?.message || "Login failed.");
      }
    }

    async function doLogout(){
      try { await api("/api/logout"); } catch {}
      setLoggedOutUI();
    }
  </script>

  <!-- ===== Shop (Buy T1) ===== -->
  <script>
    function updateShopBalanceBadge(){
      const el = $("#shop-balance");
      if (!el) return;
      const s = WHO?.balance_silver | 0;
      const g = Math.floor(s/100), ss = s%100;
      if (WHO) {
        el.textContent = `${g}g ${ss}s`;
        el.classList.remove("hidden");
      } else {
        el.textContent = "0g 0s";
        el.classList.add("hidden");
      }
    }

    function renderShopGotItem(obj){
      const msg = $("#shop-msg"); if(!msg) return;
      const icon = iconForByCode(obj.code, obj.tier);
      msg.innerHTML = `
        <div class="row" style="gap:10px;align-items:center">
          <img class="img-cell" src="${esc(icon)}" alt="" onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
          <div>Got item: ${esc(obj.name)} <span class="badge">T${obj.tier}</span></div>
        </div>`;
    }
    function renderShopGotRecipe(rec){
      const msg = $("#shop-msg"); if(!msg) return;
      msg.innerHTML = `
        <div class="row" style="gap:10px;align-items:center">
          <img class="img-cell" src="${RECIPE_ICON}" alt="" onerror="this.onerror=null;this.src='${RECIPE_ICON}'">
          <div>Got recipe: ${esc(rec.name)} <span class="badge">T${rec.tier}</span></div>
        </div>`;
    }
    function updateBuysToNextFromWHO(){
      const b = $("#buysToNext"); if (!b) return;
      b.textContent = (typeof WHO?.buys_to_next === "number")
        ? `Buys to next recipe: ${WHO.buys_to_next}` : "Buys to next recipe: —";
    }
    async function refreshMeLight(){
      try{
        const r = await api("/api/me");
        if (r?.user) {
          WHO = r.user;
          window.WHO = WHO;
          renderBalance?.();
          updateShopBalanceBadge();
          updateBuysToNextFromWHO();
          applyPerkIndicators();
        }
      }catch{}
    }

    function setShopButtonsDisabled(flag){
      $("#btn-buy-t1")?.toggleAttribute("disabled", !!flag);
      $("#btn-buy10")?.toggleAttribute("disabled", !!flag);
      $("#btn-buy50")?.toggleAttribute("disabled", !!flag);
    }

    $("#btn-buy-t1")?.addEventListener("click", async ()=>{
      const btn = $("#btn-buy-t1");
      const prevTxt = btn?.textContent;
      const msg = $("#shop-msg");
      try{
        msg && (msg.textContent = "");
        setShopButtonsDisabled(true);
        if (btn){ btn.textContent = "Buying…"; }
        const r = await api("/api/shop/buy-t1",{method:"POST",body:{}});
        if (WHO) WHO.balance_silver = (r.balance_silver | 0);
        window.WHO = WHO;
        renderBalance?.();
        updateShopBalanceBadge();
        if (r.gotRecipe) renderShopGotRecipe(r.gotRecipe);
        else if (r.gotItem) renderShopGotItem(r.gotItem);
        else msg && (msg.textContent = "OK");
        await refreshMeLight();
        await safeCall("loadInventoryPanel");
        safeCall("loadRecipes");
        safeCall("loadInventoryFull");
        safeCall("loadMarket");
        safeCall("loadMine");
      }catch(e){
        if (e?.status===401 || /not logged in/i.test(String(e?.message||""))) {
          $("#auth")?.classList.remove("hidden");
          $("#card-login") && ($("#card-login").style.display="block");
          $("#card-register") && ($("#card-register").style.display="none");
        }
        if (msg) msg.textContent = e?.message || "Buy failed.";
      }finally{
        setShopButtonsDisabled(false);
        if (btn){ btn.textContent = prevTxt || "Buy"; }
      }
    });

    document.addEventListener("DOMContentLoaded", ()=>{
      const btn1 = $("#btn-buy-t1");
      if (btn1){
        let wrap = document.createElement("div");
        wrap.style.display = "flex";
        wrap.style.flexDirection = "column";
        wrap.style.alignItems = "flex-start";
        wrap.style.gap = "6px";

        btn1.parentNode.insertBefore(wrap, btn1);
        wrap.appendChild(btn1);

        let row = document.createElement("div");
        row.className = "row";
        row.style.gap = "8px";
        wrap.appendChild(row);
        row.appendChild(btn1);

        const btn10 = document.createElement("button");
        btn10.id = "btn-buy10";
        btn10.className = "btn secondary";
        btn10.textContent = "Buy ×10";
        btn10.addEventListener("click", ()=> shopBuyTimes(10));
        row.appendChild(btn10);

        const btn50 = document.createElement("button");
        btn50.id = "btn-buy50";
        btn50.className = "btn secondary";
        btn50.textContent = "Buy ×50";
        btn50.addEventListener("click", ()=> shopBuyTimes(50));
        row.appendChild(btn50);
      }
      updateShopBalanceBadge();
    });

    async function shopBuyTimes(times=1){
      const msg = $("#shop-msg");
      let ok=0, fail=0, lastErr=null;
      msg && (msg.textContent = "");
      setShopButtonsDisabled(true);
      try{
        for(let i=0;i<times;i++){
          try{
            const r = await api("/api/shop/buy-t1",{method:"POST",body:{}});
            if (WHO) WHO.balance_silver = (r.balance_silver | 0);
            window.WHO = WHO;
            ok++;
          }catch(e){
            fail++; lastErr = e?.message || "Failed";
            if (String(lastErr).toLowerCase().includes("insufficient")) break;
          }
        }
        renderBalance?.();
        updateShopBalanceBadge();
        await refreshMeLight();
        await safeCall("loadInventoryPanel");
        safeCall("loadRecipes");
        safeCall("loadInventoryFull");
        safeCall("loadMarket");
        safeCall("loadMine");
        if (msg) {
          let txt = `Bought: ${ok}`;
          if (fail) txt += `, failed: ${fail}`;
          if (lastErr) txt += ` (${lastErr})`;
          msg.textContent = txt;
        }
      }catch(e){
        if (msg) msg.textContent = e?.message || "Buy failed.";
      }finally{
        setShopButtonsDisabled(false);
      }
    }

    document.addEventListener("DOMContentLoaded", updateShopBalanceBadge);
  </script>

  <!-- ===== Crafting ===== -->
  <script>
    function rowRecipe(r){
      return `
        <div class="itemrow">
          <div class="row" style="gap:10px;align-items:center">
            <img class="img-cell" src="${RECIPE_ICON}" alt="" onerror="this.onerror=null;this.src='${RECIPE_ICON}'">
            <div>
              <div class="label" style="text-transform:none;color:var(--text)">${esc(r.name)}</div>
              <div class="muted">T${r.tier} · x${r.qty}</div>
            </div>
          </div>
          <button class="btn muted" data-open="${esc(r.id)}">Open</button>
        </div>`;
    }

    async function loadRecipes(){
      const box = $("#recipes"); if (!box) return;
      box.textContent = "Loading…";
      try{
        const list = await api("/api/recipes/list");
        const q = ($("#filter-recipe")?.value || "").trim().toLowerCase();
        const rows = (list?.recipes || []).filter(x => !q || x.name.toLowerCase().includes(q));
        if (!rows.length){ box.textContent = "No recipes."; return; }
        box.innerHTML = rows.map(rowRecipe).join("");
        box.querySelectorAll("[data-open]").forEach(btn=>{
          btn.addEventListener("click",()=>openRecipe(btn.getAttribute("data-open")));
        });
      }catch(e){
        box.textContent = e?.message || "Failed to load recipes.";
      }
    }
    $("#btn-refresh-rec")?.addEventListener("click", loadRecipes);
    $("#filter-recipe")?.addEventListener("input", loadRecipes);

    // Render + canCraft flag
    function renderIngredients(details){
      const parts = (details.ingredients||[]).map(ing=>{
        const ok = (ing.have|0) >= (ing.qty|0);
        const src = iconForByCode(ing.code, ing.tier);
        return `
          <div class="itemrow">
            <div class="row" style="gap:10px;align-items:center">
              <img class="img-cell" src="${esc(src)}" alt="" onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
              <div>${esc(ing.name)} <span class="badge">T${ing.tier}</span></div>
            </div>
            <div class="${ok ? "" : "muted"}">${(ing.have|0)}/${(ing.qty|0)}</div>
          </div>`;
      }).join("");

      const canCraft = (details.ingredients||[]).every(ing => (ing.have|0) >= (ing.qty|0));
      const craftNote = WHO?.perks?.craft_no_fail
        ? "No fail (server checks ingredients)"
        : (canCraft ? "10% fail → Scrap (server checks ingredients)" : "You are missing materials for this recipe.");

      return `
        <div class="itemrow"><div><b>${esc(details.recipe.name)}</b> <span class="badge">T${details.recipe.tier}</span></div></div>
        <div class="itemrow"><div class="muted">Ingredients</div></div>
        ${parts}
        <div class="itemrow">
          <button id="btn-craft" class="btn" data-can="${canCraft ? "1" : "0"}">Craft</button>
          <span class="muted" style="margin-left:8px">${craftNote}</span>
        </div>`;
    }

    async function openRecipe(recipeId){
      const box = $("#rec-details"); if (!box) return;
      box.textContent = "Loading…";
      try{
        const details = await api(`/api/recipes/ingredients/${encodeURIComponent(recipeId)}`);
        box.innerHTML = renderIngredients(details);
        window.CURRENT_RECIPE_ID = details.recipe.id;
        window.CURRENT_RECIPE_DETAILS = details;
      }catch(e){
        box.textContent = e?.message || "Failed to load recipe.";
      }
    }

    async function refreshArtefactBonus(){
      try{
        const r = await api("/api/inventory");
        const bonus = (typeof r?.artefactBonusGold === "number") ? r.artefactBonusGold : (parseInt(r?.artefactBonusGold,10) || 0);
        const el = document.getElementById("artefact-bonus");
        if (el) el.textContent = bonus;
      }catch(e){ console.warn("refreshArtefactBonus failed:", e); }
    }
    (() => {
      const craft = document.getElementById("tab-craft");
      if (!craft) return;
      const obs = new MutationObserver(() => {
        if (!craft.classList.contains("hidden")) refreshArtefactBonus();
      });
      obs.observe(craft, { attributes:true });
    })();

    const arteBtn = $("#btn-artefact");
    arteBtn?.addEventListener("click", async ()=>{
      if (arteBtn.disabled) return;
      const prev = arteBtn.textContent;
      arteBtn.disabled = true; arteBtn.textContent = "Crafting…";
      try{
        const r = await api("/api/craft/artefact",{method:"POST",body:{}});
        const name = r.crafted || "Artefact";
        const bonus = (typeof r?.bonus_gold === "number") ? r.bonus_gold : (parseInt(r?.bonus_gold,10) || 0);
        $("#artefact-bonus") && ($("#artefact-bonus").textContent = bonus);
        $("#artefact-msg") && ($("#artefact-msg").textContent = `Crafted: ${name} (+${bonus} gold)`);
        await safeCall("loadInventoryPanel");
        await safeCall("loadInventoryFull");
        await safeCall("loadRecipes");
        await safeCall("loadBonus");
        await refreshMeLight();
      }catch(e){
        $("#artefact-msg") && ($("#artefact-msg").textContent = e?.message || "Crafting failed.");
      } finally{
        arteBtn.disabled = false; arteBtn.textContent = prev;
      }
    });

    // Delegirani klik za Craft (otpornije na re-render)
    (function bindCraftOnce(){
      if (window.__CRAFT_BOUND__) return;
      window.__CRAFT_BOUND__ = true;
      document.addEventListener("click", async (e)=>{
        const t = e.target;
        if (!t || t.id !== "btn-craft") return;

        const details = window.CURRENT_RECIPE_DETAILS;
        if (!details || !details.recipe?.id){ showToast("Open a recipe first."); return; }

        const allowed = t.getAttribute("data-can") === "1";
        if (!allowed){
          try{
            const miss = (details.ingredients||[])
              .filter(ing => (ing.have|0) < (ing.qty|0))
              .map(ing => ing.name);
            showToast(miss.length ? ("You are missing: " + miss.join(", ")) : "Missing materials.");
          }catch{ showToast("Missing materials."); }
          return;
        }

        const prev = t.textContent;
        t.toggleAttribute("disabled", true);
        t.textContent = "Crafting…";
        try{
          const r2 = await api("/api/craft/do",{method:"POST",body:{recipe_id: details.recipe.id}});
          if (r2.crafted) showToast(`Crafted: ${r2.crafted.name} (T${r2.crafted.tier})`);
          else if (r2.scrap) showToast("Failed (got Scrap)");
          else showToast("Done");
          await safeCall("loadInventoryPanel");
          await safeCall("loadRecipes");
          await safeCall("loadInventoryFull");
          await openRecipe(details.recipe.id);
        }catch(e2){
          if (e2?.data?.missing?.length) showToast("You are missing: " + e2.data.missing.join(", "));
          else showToast(e2?.message || "Crafting failed.");
        }finally{
          t.toggleAttribute("disabled", false);
          t.textContent = prev;
        }
      });
    })();
  </script>

  <!-- ===== Market & Inventory (CLEAN) ===== -->
  <script>
  (() => {
    // ---------- UTIL (lokalni, bez api() helpera) ----------
    const $  = window.$  || (s => document.querySelector(s));
    const esc = window.esc || (s => String(s));
    const RECIPE_ICON = window.RECIPE_ICON || "/recipe.png";
    const FALLBACK_ITEM_ICON = window.FALLBACK_ITEM_ICON || "/t1_bronze.png";
    const iconForByCode = window.iconForByCode || ((_c,_t)=>FALLBACK_ITEM_ICON);

    const TIMEOUT_MS = 8000;

    // Siguran toast/alert
    const say = (msg) => {
      const fn = (typeof window.showToast === "function")
        ? window.showToast
        : (typeof window.toast === "function" ? window.toast : (m)=>window.alert(m));
      try { fn(msg); } catch { window.alert(String(msg)); }
    };

    function timeout(p, ms = TIMEOUT_MS){
      return Promise.race([
        p,
        new Promise((_,rej)=>setTimeout(()=>rej(new Error("Timeout")), ms))
      ]);
    }
    async function getJSON(url){
      const r = await timeout(fetch(url, { credentials:"include" }));
      if (!r.ok) {
        let msg = `HTTP ${r.status}`;
        try { const j = await r.json(); if (j?.error) msg = j.error; } catch {}
        const e = new Error(msg); e.status = r.status; throw e;
      }
      if (r.status === 204) return {};
      const text = await r.text();
      if (!text) return {};
      try { return JSON.parse(text); }
      catch { throw new Error("Invalid JSON"); }
    }
    async function postJSON(url, body){
      const r = await timeout(fetch(url, {
        method: "POST",
        credentials:"include",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body || {})
      }));
      let data = null; try { data = await r.json(); } catch {}
      if (!r.ok) {
        const e = new Error((data && data.error) || `HTTP ${r.status}`); e.status = r.status; e.data = data; throw e;
      }
      return data || {};
    }

    // ---------- SAFE LOAD ----------
    async function safeLoad(boxSel, loader){
      const box = $(boxSel); if (!box) return;
      box.setAttribute('data-loading','1');
      box.innerHTML = "";
      try{
        await loader(box);
      }catch(e){
        if (e && (e.status===401 || /401|unauthorized|not logged in/i.test(String(e.message||"")))) {
          $("#auth")?.classList.remove("hidden");
          $("#card-login") && ($("#card-login").style.display="block");
          $("#card-register") && ($("#card-register").style.display="none");
        }
        console.warn("safeLoad fail:", e);
      }finally{
        box.removeAttribute('data-loading');
      }
    }

    // ---------- INVENTORY (Create Sale panel) ----------
    async function loadInventoryPanel(){
      await safeLoad("#inv-list", async (box) => {
        const q = ($("#inv-search")?.value || "").trim().toLowerCase();
        const r = await getJSON("/api/inventory");

        const items = (r.items || [])
          .filter(x => x.code !== "ARTEFACT" && (x.tier|0) < 6)
          .filter(x => !q || (x.name || "").toLowerCase().includes(q));

        const recipes = (r.recipes || [])
          .filter(x => !q || (x.name || "").toLowerCase().includes(q));

        const frag = document.createDocumentFragment();
        const add = (arr, kind) => {
          for (const it of arr){
            const ico = (kind === "item") ? (iconForByCode(it.code, it.tier) || FALLBACK_ITEM_ICON) : RECIPE_ICON;
            const row = document.createElement("div");
            row.className = "itemrow";
            row.innerHTML = `
              <div class="row" style="gap:10px;align-items:center">
                <img class="img-cell" src="${esc(ico)}" alt="" onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
                <div>${esc(it.name)} <span class="badge">T${it.tier}</span> <span class="muted">x${it.qty}</span></div>
              </div>
              <button class="btn muted">Pick</button>`;
            row.querySelector("button").addEventListener("click", () => {
              window.SEL_INV = { kind, id: it.id, name: it.name };
              const m = $("#list-msg"); if (m) m.textContent = "Selected: " + it.name;
              $("#price-g")?.focus();
            });
            frag.appendChild(row);
          }
        };
        add(items, "item"); add(recipes, "recipe");
        box.innerHTML = "";
        if (!frag.childNodes.length) box.textContent = "Empty.";
        else box.appendChild(frag);
      });
    }

    // ---------- MARKET (live) ----------
    async function loadMarket(){
      await safeLoad("#market", async (box) => {
        const q = ($("#market-q")?.value || "").trim();
        const url = "/api/sales/live" + (q ? ("?q=" + encodeURIComponent(q)) : "");
        const r = await getJSON(url);

        const rows = (r?.listings || [])
          .filter(Boolean)
          .filter(s => !(s.kind === "item" && (s.code === "ARTEFACT" || (s.tier|0) >= 6)));

        if (!rows.length){ box.textContent = "No listings."; return; }

        const frag = document.createDocumentFragment();
        for (const s of rows){
          const priceS = s?.price_s | 0;
          const g = Math.floor(priceS/100), ss = priceS % 100;
          const ico = (s.kind === "item") ? (iconForByCode(s.code, s.tier) || FALLBACK_ITEM_ICON) : RECIPE_ICON;
          const mine = !!(window.WHO?.id && s?.seller_user_id === window.WHO.id);

          const row = document.createElement("div");
          row.className = "itemrow";
          row.innerHTML = `
            <div class="row" style="gap:10px;align-items:center">
              <img class="img-cell" src="${esc(ico)}" alt="" onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
              <div>${esc(s.name)} <span class="badge">T${s?.tier ?? "-"}</span> <span class="muted">x${s?.qty ?? 1}</span></div>
            </div>
            <div class="row">
              <span class="badge">${g}g ${ss}s</span>
              ${mine ? '<button class="btn muted" disabled>My</button>' : '<button class="btn">Buy</button>'}
            </div>`;

          const btn = row.querySelector("button.btn:not(.muted)");
          if (btn) {
            btn.addEventListener("click", async () => {
              if (!window.WHO?.id){ say("Please log in first."); return; }
              if (btn.disabled) return;
              const prev = btn.textContent; btn.disabled = true; btn.textContent = "Buying…";
              try {
                const res = await postJSON("/api/sales/buy", { id: s.id });
                const newBal = (typeof res?.buyer_balance_silver === "number")
                  ? res.buyer_balance_silver
                  : (typeof res?.balance_silver === "number")
                    ? res.balance_silver
                    : null;
                if (newBal != null && window.WHO) window.WHO.balance_silver = newBal|0;
                await (window.refreshMeLight?.() || Promise.resolve());
                await loadMarket(); await loadMine(); await loadInventoryPanel();
                say("Purchased.");
              } catch(err) {
                say(err?.data?.error || err?.message || "Purchase failed.");
              } finally {
                btn.disabled = false; btn.textContent = prev;
              }
            });
          }
          frag.appendChild(row);
        }
        box.innerHTML = "";
        box.appendChild(frag);
      });
    }

    // ---------- MY LISTINGS ----------
    async function loadMine(){
      await safeLoad("#mine", async (box) => {
        const rq = await getJSON("/api/sales/mine");
        const q = ($("#mine-q")?.value || "").trim().toLowerCase();

        let rows = (rq?.listings || [])
          .filter(Boolean)
          .filter(s => s?.status === "live" && !(s.kind === "item" && (s.code === "ARTEFACT" || (s.tier|0) >= 6)));

        if (q) rows = rows.filter(s => (s?.name || "").toLowerCase().includes(q));
        if (!rows.length){ box.textContent = "No live listings."; return; }

        const frag = document.createDocumentFragment();
        for (const s of rows){
          const priceS = s?.price_s | 0;
          const g = Math.floor(priceS/100), ss = priceS % 100;
          const ico = (s.kind === "item") ? (iconForByCode(s.code, s.tier) || FALLBACK_ITEM_ICON) : RECIPE_ICON;

          const row = document.createElement("div");
          row.className = "itemrow";
          row.innerHTML = `
            <div class="row" style="gap:10px;align-items:center">
              <img class="img-cell" src="${esc(ico)}" alt="" onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
              <div>${esc(s.name)} <span class="badge">T${s?.tier ?? "-"}</span> <span class="muted">x${s?.qty ?? 1}</span></div>
            </div>
            <div class="row">
              <span class="badge">${g}g ${ss}s</span>
              <button class="btn danger">Cancel</button>
            </div>`;

          row.querySelector("button.btn.danger").addEventListener("click", async () => {
            const btn = row.querySelector("button.btn.danger"); if (!btn || btn.disabled) return;
            const prev = btn.textContent; btn.disabled = true; btn.textContent = "Cancel…";
            try {
              await postJSON("/api/sales/cancel", { id: s.id });
              await loadMarket(); await loadMine(); await loadInventoryPanel();
              await (window.refreshMeLight?.() || Promise.resolve());
            } catch(err) {
              say(err?.message || "Cancel failed.");
            } finally {
              btn.disabled = false; btn.textContent = prev;
            }
          });

          frag.appendChild(row);
        }
        box.innerHTML = "";
        box.appendChild(frag);
      });
    }

    // ---------- LIST FOR SALE ----------
    async function handleList(){
      try{
        const sel = window.SEL_INV;
        if (!sel){ say("Pick an item/recipe first."); return; }
        const gold = Math.max(0, parseInt($("#price-g")?.value || "0", 10) || 0);
        let silver = Math.max(0, parseInt($("#price-s")?.value || "0", 10) || 0);
        const qty = Math.max(1, parseInt($("#price-qty")?.value || "1", 10) || 1);
        if (silver > 99) silver = 99;

        await postJSON("/api/sales/list", { kind: sel.kind, id: sel.id, qty, gold, silver });

        const m = $("#list-msg"); if (m) m.textContent = "Listed.";
        window.SEL_INV = null;
        await loadMarket(); await loadMine(); await loadInventoryPanel();
        await (window.refreshMeLight?.() || Promise.resolve());
        say("Listing created.");
      }catch(e){
        const msg = e?.data?.error || e?.message || "Listing failed.";
        const m = $("#list-msg"); if (m) m.textContent = msg; else say(msg);
      }
    }

    // ---------- INVENTORY (FULL TAB) ----------
    async function loadInventoryFull(){
      await safeLoad("#inv-full", async (box) => {
        const r = await getJSON("/api/inventory");
        const items   = Array.isArray(r.items)   ? r.items   : [];
        const recipes = Array.isArray(r.recipes) ? r.recipes : [];
        const out = [];

        for (const it of items){
          const ico = iconForByCode(it.code, it.tier) || FALLBACK_ITEM_ICON;
          out.push(`
            <div class="itemrow">
              <div class="row" style="gap:10px;align-items:center">
                <img class="img-cell" src="${esc(ico)}" alt="" onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
                <div>${esc(it.name)} <span class="badge">T${it.tier}</span></div>
              </div>
              <div class="muted">x${it.qty}</div>
            </div>`);
        }
        for (const rc of recipes){
          out.push(`
            <div class="itemrow">
              <div class="row" style="gap:10px;align-items:center">
                <img class="img-cell" src="${RECIPE_ICON}" alt="" onerror="this.onerror=null;this.src='${RECIPE_ICON}'">
                <div>${esc(rc.name)} <span class="badge">T${rc.tier}</span></div>
              </div>
              <div class="muted">x${rc.qty}</div>
            </div>`);
        }

        box.innerHTML = out.join("") || "Empty.";
      });
    }

    // ---------- EXPORT NA WINDOW ----------
    window.loadInventoryPanel = loadInventoryPanel;
    window.loadMarket        = loadMarket;
    window.loadMine          = loadMine;
    window.loadInventoryFull = loadInventoryFull;

    // ---------- BIND UI DOGAĐAJE ----------
    document.addEventListener("click", (e) => {
      const t = e.target;
      if (t && t.id === "btn-list") { e.preventDefault(); handleList(); }
    });
    const invSearch  = $("#inv-search");  if (invSearch)  invSearch.addEventListener("input", () => loadInventoryPanel());
    const marketQ    = $("#market-q");    if (marketQ)    marketQ.addEventListener("input",   () => loadMarket());
    const mineQ      = $("#mine-q");      if (mineQ)      mineQ.addEventListener("input",     () => loadMine());
    const mineBtn    = $("#btn-mine");    if (mineBtn)    mineBtn.addEventListener("click",   () => loadMine());

    // ---------- INIT ----------
    function init(){
      loadMarket();
      loadMine();
      loadInventoryPanel();
      loadInventoryFull();
    }
    if (document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", init, { once:true });
    } else {
      init();
    }
  })();
  </script>

  <!-- ===== BONUS (frontend) ===== -->
  <script>
    function withTimeout(promise, ms=8000){
      return new Promise((resolve, reject)=>{
        const t = setTimeout(()=> reject(new Error("Timeout")), ms);
        promise.then(v=>{clearTimeout(t); resolve(v);})
               .catch(e=>{clearTimeout(t); reject(e);});
      });
    }

    function tile(name, code, ok, tier){
      const ico = iconForByCode(code, tier) || FALLBACK_ITEM_ICON;
      return `
        <div class="tile ${ok?'ok':'miss'}">
          <img class="img-cell" src="${esc(ico)}" alt="" onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
          <div>${esc(name)}</div>
        </div>`;
    }

    async function loadBonus(){
      const lock = $("#bonus-lock");
      const boxes = {2:$("#bonus-t2"),3:$("#bonus-t3"),4:$("#bonus-t4"),5:$("#bonus-t5")};
      const btns  = {2:$("#btn-claim-t2"),3:$("#btn-claim-t3"),4:$("#btn-claim-t4"),5:$("#btn-claim-t5")};
      Object.values(btns).forEach(b=>{ if(b){ b.disabled = true; b.classList.add("muted"); } });
      Object.values(boxes).forEach(b=>{ if(b) b.textContent="Loading…"; });

      let cleared = false;
      setTimeout(()=>{
        if (cleared) return;
        Object.values(boxes).forEach(b=>{ if(b) b.textContent = "Still loading… check connection"; });
      }, 3000);

      try{
        const r = await withTimeout(api("/api/bonus/status"), 8000);
        cleared = true;
        const hasArt = !!r?.has_artefact;
        lock?.classList.toggle("hidden", hasArt);
        if (!hasArt) Object.values(btns).forEach(b=>{ b && (b.disabled=true); });

        function prettyNameFromCode(code){
          return String(code)
            .replace(/^T\d_/, "")
            .replaceAll("_"," ")
            .toLowerCase()
            .replace(/\b\w/g, c=>c.toUpperCase());
        }

        for (const t of [2,3,4,5]){
          const box = boxes[t]; if (!box) continue;
          const info = r.tiers?.[t];
          if (!info){ box.textContent="No data"; continue; }

          const tiles = [];
          for (const c of (info.owned||[]))   tiles.push(tile(prettyNameFromCode(c), c, true,  t));
          for (const c of (info.missing||[])) tiles.push(tile(prettyNameFromCode(c), c, false, t));
          box.innerHTML = tiles.join("") || "Empty.";

          const btn = btns[t];
          if (btn){
            const canClaim = hasArt && (info.missing?.length===0) && !info.claimed;
            btn.disabled = !canClaim;
            btn.textContent = info.claimed ? "Claimed" : "Claim";
            if (info.claimed) btn.classList.add("muted"); else btn.classList.remove("muted");
            btn.onclick = async ()=>{
              if (btn.disabled) return;
              const prev = btn.textContent;
              btn.disabled = true; btn.textContent = "Claiming…";
              try{
                await api("/api/bonus/claim",{method:"POST",body:{tier:t}});
                showToast(`T${t} bonus claimed.`);
                await loadBonus();
                await refreshMeLight();
              }catch(e){
                alert(e?.message || "Claim failed.");
              } finally{
                btn.textContent = prev;
              }
            };
          }
        }
      }catch(e){
        cleared = true;
        if (e?.status===401 || /not logged in/i.test(String(e?.message||""))) {
          $("#auth")?.classList.remove("hidden");
          $("#card-login") && ($("#card-login").style.display="block");
          $("#card-register") && ($("#card-register").style.display="none");
        }
        Object.values(boxes).forEach(b=>{ if(b) b.textContent = e?.message || "Failed."; });
      }
    }
  </script>
</body>
</html>


