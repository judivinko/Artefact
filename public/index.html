<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ARTEFACT</title>
  <link rel="stylesheet" href="/app.css"/>
  <style>
    :root{--bg:#0b1220;--panel:#101827;--muted:#93a4bd;--accent:#14b8a6;--chip:#1f2937}
    body{margin:0;background:var(--bg);color:#e5eefc;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu,Arial}
    .wrap{max-width:1100px;margin:20px auto;padding:0 12px}
    header{display:flex;align-items:center;justify-content:space-between;margin:10px 0}
    .brand{font-weight:800;letter-spacing:.5px}
    .pill{display:inline-flex;gap:6px;align-items:center;background:#0d2234;border:1px solid #223046;border-radius:999px;padding:6px 10px;font-size:12px}
    .btn{background:#16a34a;border:0;border-radius:10px;padding:10px 14px;color:#001b10;cursor:pointer;font-weight:700}
    .btn.secondary{background:#0b3759;color:#e5eefc}
    .btn.danger{background:#b91c1c;color:#fff}
    .btn.small{padding:6px 10px;border-radius:8px;font-size:13px}
    .tabbar{display:flex;gap:8px;margin:10px 0}
    .tab{border:1px solid #223046;background:#0e2134;border-radius:999px;padding:8px 12px;cursor:pointer}
    .tab.active{outline:2px solid #14b8a6}
    .card{background:var(--panel);border:1px solid #223046;border-radius:12px;padding:14px;margin:12px 0}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:980px){.grid2{grid-template-columns:1fr}}
    input,select{background:#0b1220;border:1px solid #223046;color:#e5eefc;border-radius:10px;padding:10px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #223046;padding:10px;text-align:left}
    .muted{color:var(--muted)}
    .right{float:right}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">ARTEFACT</div>
      <div id="who" class="pill">Not logged in</div>
    </header>

    <!-- Auth gate -->
    <div id="auth">
      <div class="card">
        <h3>Welcome</h3>
        <p class="muted">Please register or log in to continue.</p>
        <div class="grid2" style="margin-top:10px">
          <div class="card">
            <h4>Create account</h4>
            <div class="row">
              <input id="reg-email" placeholder="Email"/>
              <input id="reg-pass" type="password" placeholder="Password (min 6)"/>
              <button class="btn" id="btn-register">Register</button>
            </div>
            <div id="reg-msg" class="muted"></div>
          </div>
          <div class="card">
            <h4>Login</h4>
            <div class="row">
              <input id="log-email" placeholder="Email"/>
              <input id="log-pass" type="password" placeholder="Password"/>
              <button class="btn" id="btn-login">Login</button>
            </div>
            <div id="log-msg" class="muted"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- App -->
    <div id="app" style="display:none">
      <div class="row">
        <div id="balance" class="pill">—</div>
        <button id="btn-logout" class="btn small right">Logout</button>
      </div>

      <div class="tabbar">
        <div class="tab active" data-tab="shop">Shop</div>
        <div class="tab" data-tab="craft">Crafting</div>
        <div class="tab" data-tab="sales">Sales</div>
        <div class="tab" data-tab="inv">Inventory</div>
      </div>

      <!-- SHOP -->
      <section id="tab-shop" class="card">
        <h3>Shop (T1 only)</h3>
        <p class="muted">Each purchase costs <b>1 gold</b> (100s). You either get a random T1 material or a recipe drop (T2–T6 weighted).</p>
        <button class="btn" id="btn-buy-t1">Buy T1 Pack (1g)</button>
        <div id="shop-msg" class="muted" style="margin-top:8px"></div>
      </section>

      <!-- CRAFTING -->
      <section id="tab-craft" class="card">
        <div class="row" style="justify-content:space-between">
          <h3>Crafting</h3>
          <div class="row">
            <button class="btn secondary small" id="btn-craft-refresh">Refresh (hide missing)</button>
            <button class="btn small" id="btn-craft-artefact">Craft ARTEFACT (10× distinct T5)</button>
          </div>
        </div>
        <div class="grid2">
          <div class="card">
            <div class="row" style="justify-content:space-between">
              <div class="muted">Your recipes</div>
              <label><input type="checkbox" id="toggle-hide-missing" checked/> hide missing</label>
            </div>
            <div id="recipes">—</div>
          </div>
          <div class="card">
            <div class="muted">Recipe details</div>
            <div id="recipe-detail">Select a recipe →</div>
          </div>
        </div>
      </section>

      <!-- SALES -->
      <section id="tab-sales" class="card">
        <h3>Sales (fixed price)</h3>
        <div class="grid2">
          <!-- Left: create listing -->
          <div class="card">
            <div class="muted">Create listing</div>
            <div class="row">
              <select id="list-code"></select>
              <input id="list-qty" type="number" min="1" step="1" value="1" style="width:90px"/>
            </div>
            <div class="row" style="margin-top:6px">
              <input id="price-g" type="number" min="0" step="1" placeholder="Gold (0–)" style="width:140px"/>
              <input id="price-s" type="number" min="0" max="99" step="1" placeholder="Silver (0–99)" style="width:160px"/>
              <button id="btn-list" class="btn">List for sale</button>
            </div>
            <div id="list-msg" class="muted" style="margin-top:6px"></div>
          </div>

          <!-- Right: marketplace & my listings -->
          <div class="card">
            <div class="row" style="justify-content:space-between">
              <div class="muted">Marketplace</div>
              <input id="market-search" placeholder="Search name or code…" style="width:220px"/>
            </div>
            <table style="margin-top:8px">
              <thead><tr><th>Item</th><th>Qty</th><th>Price</th><th></th></tr></thead>
              <tbody id="market"></tbody>
            </table>

            <div class="card" style="margin-top:10px">
              <div class="muted">Your listings</div>
              <table style="margin-top:8px">
                <thead><tr><th>Item</th><th>Qty</th><th>Price</th><th>Status</th><th></th></tr></thead>
                <tbody id="mine"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- INVENTORY -->
      <section id="tab-inv" class="card">
        <h3>Inventory</h3>
        <div class="grid2">
          <div class="card">
            <div class="muted">Items</div>
            <table style="margin-top:8px">
              <thead><tr><th>Name</th><th>Tier</th><th>Qty</th></tr></thead>
              <tbody id="inv-items"></tbody>
            </table>
          </div>
          <div class="card">
            <div class="muted">Recipes</div>
            <table style="margin-top:8px">
              <thead><tr><th>Name</th><th>Tier</th><th>Qty</th></tr></thead>
              <tbody id="inv-recipes"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
const $ = s => document.querySelector(s);
const el = id => document.getElementById(id);

function goldStr(s){ return `${Math.floor(s/100)}g ${s%100}s`; }
async function api(path, opts={}) {
  const res = await fetch(path, {credentials:"include", headers:{"Content-Type":"application/json"}, ...opts});
  let data=null; try{ data=await res.json(); }catch{}
  if(!res.ok) throw new Error((data&&data.error) || `HTTP ${res.status}`);
  return data;
}

function setTab(name){
  document.querySelectorAll(".tab").forEach(t=> t.classList.toggle("active", t.dataset.tab===name));
  ["shop","craft","sales","inv"].forEach(x=> el("tab-"+x).style.display = (x===name)?"block":"none");
}

async function refreshMe(){
  try{
    const r=await api("/api/me");
    el("who").innerHTML = `${r.user.email} • <b>${r.user.gold}g ${r.user.silver}s</b>`;
    el("balance").textContent = `${r.user.gold}g ${r.user.silver}s`;
    $("#auth").style.display="none"; $("#app").style.display="block";
    // first loads
    loadInventory();
    loadRecipes();
    loadMarket(); loadMine(); loadListCodes();
  }catch{
    $("#auth").style.display="block"; $("#app").style.display="none";
  }
}

// ---------- Auth
el("btn-register").onclick = async ()=>{
  el("reg-msg").textContent = "";
  try{
    await api("/api/register",{method:"POST",body:JSON.stringify({email:el("reg-email").value.trim(),password:el("reg-pass").value})});
    el("reg-msg").textContent = "Registered. Now log in.";
  }catch(e){ el("reg-msg").textContent = e.message; }
};
el("btn-login").onclick = async ()=>{
  el("log-msg").textContent = "";
  try{
    await api("/api/login",{method:"POST",body:JSON.stringify({email:el("log-email").value.trim(),password:el("log-pass").value})});
    await refreshMe();
  }catch(e){ el("log-msg").textContent = e.message; }
};
el("btn-logout").onclick = async ()=>{ await api("/api/logout"); location.reload(); };

// ---------- Tabs
document.querySelectorAll(".tab").forEach(t=> t.onclick = ()=> setTab(t.dataset.tab));

// ---------- Shop
el("btn-buy-t1").onclick = async ()=>{
  el("shop-msg").textContent = "";
  try{
    const r=await api("/api/shop/buy-t1",{method:"POST"});
    if(r.result_type==="ITEM") el("shop-msg").textContent = `Got T1: ${r.addedItem.name}`;
    else el("shop-msg").textContent = `Got recipe: ${r.grantedRecipe.name} [T${r.grantedRecipe.tier}]`;
    await refreshMe();
  }catch(e){ el("shop-msg").textContent = e.message; }
};

// ---------- Crafting
let hideMissing=true, currentRecipe=null;
el("toggle-hide-missing").onchange = ()=>{ hideMissing=el("toggle-hide-missing").checked; renderRecipes(window._recipes||[]); };
el("btn-craft-refresh").onclick = async ()=> loadRecipes(true);
el("btn-craft-artefact").onclick = async ()=>{
  try{
    const r=await api("/api/craft/artefact",{method:"POST"});
    alert(r.msg||"Crafted artefact."); await loadInventory();
  }catch(e){ alert(e.message); }
};

async function loadRecipes(forceHide){
  try{
    const r=await api("/api/my/recipes");
    window._recipes = r.recipes||[];
    if(forceHide) hideMissing=true, el("toggle-hide-missing").checked=true;
    renderRecipes(window._recipes);
  }catch(e){ el("recipes").textContent=e.message; }
}
function renderRecipes(list){
  const box=el("recipes"); box.innerHTML="";
  if(!list.length){ box.textContent="No recipes."; return; }
  for(const r of list){
    const row=document.createElement("div"); row.className="row";
    row.style.cssText="justify-content:space-between;border-bottom:1px solid #223046;padding:6px 0;cursor:pointer";
    row.innerHTML=`<div>[T${r.tier}] ${r.name}</div><div class="muted">x${r.qty}</div>`;
    row.onclick = ()=> openRecipe(r.id);
    box.appendChild(row);
  }
}

async function openRecipe(id){
  currentRecipe=id;
  const box=el("recipe-detail"); box.textContent="Loading…";
  try{
    const r=await api(`/api/recipes/${id}`);
    let needMissing = r.ingredients.filter(x=>x.missing>0).length;
    if(hideMissing && needMissing>0){ box.innerHTML = `<div class="muted">You don't have ingredients. Toggle "hide missing" to show.</div>`; return; }

    const can = r.can_craft;
    const rows = r.ingredients.map(i=> `<tr><td>${i.name}</td><td>${i.have_qty}/${i.need_qty}</td></tr>`).join("");
    box.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div><b>${r.recipe.name}</b> [T${r.recipe.tier}]</div>
        <button class="btn small" id="btn-craft-do" ${can?"":"disabled"}>Craft</button>
      </div>
      <table style="margin-top:6px"><thead><tr><th>Ingredient</th><th>Have / Need</th></tr></thead>
      <tbody>${rows}</tbody></table>
    `;
    el("btn-craft-do").onclick = async ()=>{
      try{
        const x=await api(`/api/recipes/${id}/craft`,{method:"POST"});
        alert(x.msg || (x.crafted?"Crafted":"Failed"));
        await loadInventory(); await loadRecipes(); openRecipe(id);
      }catch(e){ alert(e.message); }
    };
  }catch(e){ box.textContent = e.message; }
}

// ---------- Inventory
async function loadInventory(){
  try{
    const r=await api("/api/my/inventory");
    // items
    const irows=(r.items||[]).map(i=> `<tr><td>${i.name}</td><td>T${i.tier}</td><td>${i.qty}</td></tr>`).join("");
    el("inv-items").innerHTML=irows||"<tr><td colspan=3 class='muted'>Empty</td></tr>";
    // recipes
    const rrows=(r.recipes||[]).map(x=> `<tr><td>${x.name}</td><td>T${x.tier}</td><td>${x.qty}</td></tr>`).join("");
    el("inv-recipes").innerHTML=rrows||"<tr><td colspan=3 class='muted'>Empty</td></tr>";

    // fill listing select (my inventory)
    const options=[
      ...(r.items||[]).map(i=>({code:i.code,name:`[T${i.tier}] ${i.name} x${i.qty}`})),
      ...(r.recipes||[]).map(rc=>({code:rc.code,name:`[T${rc.tier}] ${rc.name} x${rc.qty}`}))
    ].map(o=>`<option value="${o.code}">${o.name}</option>`).join("");
    el("list-code").innerHTML=options||"<option>(nothing)</option>";
  }catch(e){ /* ignore in header */ }
}
function loadListCodes(){ /* kept by loadInventory */ }

// ---------- Sales (marketplace)
el("market-search").addEventListener("input", ()=> loadMarket());

async function loadMarket(){
  const q = encodeURIComponent(el("market-search").value.trim());
  try{
    const r=await api(`/api/sales/live${q?`?q=${q}`:""}`);
    const rows=(r.listings||[]).map(a=>{
      const price=goldStr(a.start_price_s);
      return `<tr>
        <td>${a.name}</td><td>${a.qty}</td><td>${price}</td>
        <td><button class="btn small" data-buy="${a.id}">Buy</button></td>
      </tr>`;
    }).join("");
    el("market").innerHTML=rows||`<tr><td colspan=4 class="muted">No listings.</td></tr>`;
    document.querySelectorAll("[data-buy]").forEach(b=>{
      b.onclick = async ()=>{
        try{ await api(`/api/sales/${b.dataset.buy}/buy`,{method:"POST"}); await refreshMe(); loadMarket(); loadMine(); }
        catch(e){ alert(e.message); }
      }
    });
  }catch(e){ el("market").innerHTML=`<tr><td colspan=4>${e.message}</td></tr>`; }
}

async function loadMine(){
  try{
    const r=await api("/api/sales/mine");
    const rows=(r.listings||[]).map(a=>{
      const price=goldStr(a.start_price_s);
      const act = a.status==="live" ? `<button class="btn danger small" data-cancel="${a.id}">Cancel</button>` : "";
      return `<tr>
        <td>${a.name}</td><td>${a.qty}</td><td>${price}</td><td>${a.status}</td>
        <td>${act}</td>
      </tr>`;
    }).join("");
    el("mine").innerHTML=rows||`<tr><td colspan=5 class="muted">No listings.</td></tr>`;
    document.querySelectorAll("[data-cancel]").forEach(b=>{
      b.onclick = async ()=>{ try{ await api(`/api/sales/${b.dataset.cancel}/cancel`,{method:"POST"}); loadMine(); loadMarket(); }catch(e){ alert(e.message); } }
    });
  }catch(e){ el("mine").innerHTML=`<tr><td colspan=5>${e.message}</td></tr>`; }
}

el("btn-list").onclick = async ()=>{
  el("list-msg").textContent="";
  try{
    const code=el("list-code").value; const qty=parseInt(el("list-qty").value||"1",10);
    const price_gold=parseInt(el("price-g").value||"0",10)||0;
    const price_silver=parseInt(el("price-s").value||"0",10)||0;
    await api("/api/sales/create",{method:"POST",body:JSON.stringify({code,qty,price_gold,price_silver})});
    el("list-msg").textContent="Listed.";
    loadInventory(); loadMarket(); loadMine();
  }catch(e){ el("list-msg").textContent=e.message; }
};

// Init
refreshMe();
setTab("shop");
</script>
</body>
</html>
