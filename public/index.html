<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ARTEFACT</title>
  <link rel="stylesheet" href="/app.css" />
  <style>
    /* sitni dodaci samo za ovaj file */
    .hidden{display:none}
    .badge{border:1px solid var(--line);padding:4px 8px;border-radius:999px;background:#071021;font-size:12px}
    .itemrow{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid #13223a}
    .itemrow:last-child{border-bottom:0}
    .list{max-height:360px;overflow:auto;border:1px solid var(--line);border-radius:10px}
    .chip{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#0d1b2a;cursor:pointer}
    .chip.active{background:#0e3a2f}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .toast{position:fixed;bottom:16px;right:16px;background:#0d1b2a;border:1px solid #233047;border-radius:8px;padding:10px 12px}
    .btn{cursor:pointer}
    .btn.muted{opacity:.9}
    .btn.secondary{background:#0d2a3a}
    .btn.danger{background:#3a0d14}
    .input{background:#0b1220;border:1px solid #233047;border-radius:8px;padding:8px 10px;color:#e5e7eb}
    .card{background:#0b1220;border:1px solid #233047;border-radius:12px;padding:12px;margin-top:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .tabbar{margin:6px 0 4px}
    .header{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid #233047}
    .brand{font-weight:700}
    .container{max-width:980px;margin:0 auto;padding:12px}
    .label{font-weight:600}
    .muted{opacity:.8}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>

  <!-- Header (tko je logiran, balans, logout) -->
  <header class="header">
    <div class="brand">ARTEFACT</div>
    <div class="row">
      <span id="who" class="badge">–</span>
      <span id="balance" class="badge">0g 0s</span>
      <button id="btn-logout" class="btn muted hidden">Log out</button>
    </div>
  </header>

  <!-- Glavni sadržaj -->
  <main class="container">

    <!-- Auth -->
    <section id="auth" class="card">
      <div class="label">Login / Register</div>
      <div class="grid">
        <div class="card">
          <div class="label">Register</div>
          <input id="reg-email" class="input" placeholder="email@example.com" />
          <input id="reg-pass" class="input" type="password" placeholder="password (min 6)" style="margin-top:8px"/>
          <button id="btn-register" class="btn" style="margin-top:8px">Register</button>
          <div id="reg-msg" class="muted" style="margin-top:6px"></div>
        </div>
        <div class="card">
          <div class="label">Login</div>
          <input id="log-email" class="input" placeholder="email@example.com" />
          <input id="log-pass" class="input" type="password" placeholder="password" style="margin-top:8px"/>
          <button id="btn-login" class="btn secondary" style="margin-top:8px">Log in</button>
          <div id="log-msg" class="muted" style="margin-top:6px"></div>
        </div>
      </div>
    </section>

    <!-- App -->
    <section id="app" class="hidden">
      <div class="tabbar row">
        <div class="chip active" data-tab="shop">Shop</div>
        <div class="chip" data-tab="craft">Crafting</div>
        <div class="chip" data-tab="sales">Sales</div>
        <div class="chip" data-tab="inv">Inventory</div>
      </div>

     <!-- SHOP -->
<div id="tab-shop" class="card">
  <div class="row" style="justify-content:space-between">
    <div class="label">Buy T1 (100s)</div>
    <span id="buysToNext" class="muted">Buys to next recipe: —</span>
  </div>
  <div class="row">
    <button id="btn-buy-t1" class="btn">Buy</button>
    <div id="shop-msg" class="muted"></div>
  </div>
</div>

<script>
  // --- SHOP render s ikonicom ispred imena (minimalna integracija) ---
  const FALLBACK_ITEM_ICON = "/images/t1_bronze.png";
  const G = (typeof window !== "undefined") ? window : global;
  const esc = s => String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#39;");

  function itemMeta(code){
    const it = (G.ITEMS || {})[code] || {};
    return {
      name: it.name || code,
      icon: it.icon || FALLBACK_ITEM_ICON,
      tier: it.tier || 1
    };
  }

  function renderShopGotItem(code){
    const msg = document.getElementById("shop-msg");
    if(!msg) return;
    const m = itemMeta(code);
    msg.innerHTML = `
      <div class="row" style="gap:10px;align-items:center">
        <img class="icon" src="${esc(m.icon)}" alt="${esc(m.name)}"
             onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
        <div>Got item: ${esc(m.name)} <span class="badge">T${m.tier}</span></div>
      </div>`;
  }

  // Handler kupnje — koristi tvoju postojeću /api logiku; ništa drugo ne mijenjamo
  document.getElementById("btn-buy-t1")?.addEventListener("click", async ()=>{
    const btn = document.getElementById("btn-buy-t1");
    const msg = document.getElementById("shop-msg");
    try{
      btn.disabled = true;
      msg.textContent = "Processing…";

      // Ako ti je druga ruta, promijeni samo ovu liniju:
      const r = await api("/api/shop/buy-t1");

      const code = r?.item?.code || r?.code || r?.item;
      if (code) renderShopGotItem(code);
      else msg.textContent = "Bought.";

      if (typeof r?.buysToNext !== "undefined") {
        const span = document.getElementById("buysToNext");
        if (span) span.textContent = `Buys to next recipe: ${r.buysToNext}`;
      }
    }catch(e){
      console.error(e);
      msg.textContent = "Error.";
    }finally{
      btn.disabled = false;
    }
  });
</script>


    <!-- ! crafting -->
<!-- Crafting -->
<div id="tab-craft" class="card hidden">
  <div class="row">
    <div class="label">Crafting</div>
    <!-- Ikona ARTEFAKTA ispred gumba (atefakt.png u /public) -->
    <button id="btn-artefact" class="btn right">
      <img src="/atefakt.png" alt="Artefact" style="width:20px;height:20px;object-fit:contain;vertical-align:-3px;margin-right:8px;border-radius:4px"
           onerror="this.onerror=null;this.style.display='none'">
      Craft ARTEFACT (10× distinct T5)
    </button>
  </div>

  <!-- Artefact bonus + poruka (NE DIRAMO LOGIKU NI SADRŽAJ) -->
  <div style="margin-top:8px">
    Bonus gold: <span id="artefact-bonus">0</span>
  </div>
  <div id="artefact-msg" class="muted" style="margin-top:4px"></div>

  <div class="grid">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="label">Recipes you own</div>
        <div class="row">
          <input id="filter-recipe" class="input" placeholder="filter by name..." style="width:220px"/>
          <button id="btn-refresh-rec" class="btn muted">Refresh</button>
        </div>
      </div>
      <div id="recipes" class="list">Loading…</div>
    </div>

    <div class="card">
      <div class="label">Details</div>
      <div id="rec-details" class="list">Select a recipe on the left.</div>
    </div>
  </div>
</div>

<script>
  // --- CRAFTING: samo sličice ispred imena (bonus/poruke NE DIRAMO) ---
  const G = (typeof window !== "undefined") ? window : global;
  const FALLBACK_ITEM_ICON   = "/images/t1_bronze.png";
  const FALLBACK_RECIPE_ICON = "/images/recipe.png";
  const esc = s => String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#39;");

  // Kartica recepta u lijevom panelu — sličica + ime + tier
  function recipeCard(r){
    const icon = r.icon || FALLBACK_RECIPE_ICON;
    return `
      <div class="itemrow" data-recipe="${esc(r.code)}">
        <div class="row" style="gap:10px;align-items:center">
          <img src="${esc(icon)}" alt="${esc(r.name)}"
               style="width:28px;height:28px;object-fit:contain;border-radius:6px"
               onerror="this.onerror=null;this.src='${FALLBACK_RECIPE_ICON}'">
          <div>
            <div class="label" style="text-transform:none;color:var(--text)">${esc(r.name)}</div>
            <div class="muted">${esc(r.code)}</div>
          </div>
        </div>
        <span class="badge">T${r.tier}</span>
      </div>`;
  }

  // Lijevi panel: lista recepata
  function renderRecipesList(){
    const box = document.getElementById("recipes");
    if (!box) return;
    if (!G.RECIPES) { box.innerHTML = '<div class="muted" style="padding:8px">No recipes</div>'; return; }

    const q = (document.getElementById("filter-recipe")?.value || "").toLowerCase().trim();

    const list = Object.values(G.RECIPES)
      .filter(r => !q || r.name.toLowerCase().includes(q) || r.code.toLowerCase().includes(q))
      .sort((a,b)=> a.tier - b.tier || a.name.localeCompare(b.name));

    box.innerHTML = list.map(recipeCard).join("") || '<div class="muted" style="padding:8px">No results</div>';

    // klik → detalji desno
    box.querySelectorAll("[data-recipe]").forEach(el=>{
      el.addEventListener("click", ()=>{
        const code = el.getAttribute("data-recipe");
        const r = G.RECIPES?.[code];
        if (r) renderRecipeDetails(r);
      });
    });
  }

  // Desni panel “Details” — sličice uz Result i Parts
  function renderRecipeDetails(r){
    const box = document.getElementById("rec-details");
    if (!box) return;

    const resultItem = G.ITEMS?.[r.result] || {};
    const resultName = resultItem.name || r.result;
    const resultIcon = resultItem.icon || FALLBACK_ITEM_ICON;

    const partsHTML = (r.parts || []).map(code=>{
      const it  = G.ITEMS?.[code] || {};
      const nm  = it.name || code;
      const ic  = it.icon || FALLBACK_ITEM_ICON;
      const tr  = it.tier || "";
      return `
        <div class="row" style="gap:10px;align-items:center">
          <img src="${esc(ic)}" alt="${esc(nm)}"
               style="width:28px;height:28px;object-fit:contain;border-radius:6px"
               onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
          <div>
            <div>${esc(nm)} ${tr?`<span class="badge">T${tr}</span>`:""}</div>
            <div class="muted">${esc(code)}</div>
          </div>
        </div>`;
    }).join("");

    const icon = r.icon || FALLBACK_RECIPE_ICON;

    box.innerHTML = `
      <div class="row" style="gap:10px;align-items:center;margin-bottom:8px">
        <img src="${esc(icon)}" alt="${esc(r.name)}"
             style="width:28px;height:28px;object-fit:contain;border-radius:6px"
             onerror="this.onerror=null;this.src='${FALLBACK_RECIPE_ICON}'">
        <div>
          <div class="label" style="text-transform:none;color:var(--text)">${esc(r.name)}</div>
          <div class="muted">${esc(r.code)} · Tier T${r.tier}</div>
        </div>
      </div>

      <div class="card">
        <div class="label">Result</div>
        <div class="row" style="gap:10px;align-items:center;margin-top:6px">
          <img src="${esc(resultIcon)}" alt="${esc(resultName)}"
               style="width:28px;height:28px;object-fit:contain;border-radius:6px"
               onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
          <div>
            <div>${esc(resultName)}</div>
            <div class="muted">${esc(r.result)}</div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:10px">
        <div class="label">Parts</div>
        <div style="margin-top:6px;display:grid;grid-template-columns:1fr;gap:6px">
          ${partsHTML}
        </div>
      </div>
    `;
  }

  // Filter/refresh – samo render (tvoju backend logiku NE diramo)
  document.getElementById("filter-recipe")?.addEventListener("input", renderRecipesList);
  document.getElementById("btn-refresh-rec")?.addEventListener("click", renderRecipesList);

  // Inicijalni render (pretpostavka: Items & Recipes je već učitan)
  document.addEventListener("DOMContentLoaded", ()=>{
    try { renderRecipesList(); } catch(e){ console.error(e); }
  });
</script>



      <!-- ! market -->
<!-- Market -->
<div id="tab-market" class="card hidden">
  <div class="label">Marketplace</div>
  <div class="grid">
    <div class="card">
      <div class="label">Create Sale</div>
      <input id="inv-search" class="input" placeholder="Search your inventory..." />
      <div id="inv-list" class="list" style="margin-top:8px;max-height:300px">Loading…</div>
      <div class="row" style="margin-top:8px">
        <input id="price-g" class="input" style="width:100px" placeholder="Gold"/>
        <input id="price-s" class="input" style="width:120px" placeholder="Silver (0–99)"/>
        <input id="price-qty" class="input" style="width:100px" placeholder="Qty"/>
        <button id="btn-list" class="btn">List for sale</button>
      </div>
      <div id="list-msg" class="muted" style="margin-top:6px"></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="label">Marketplace</div>
        <input id="market-q" class="input" placeholder="Search by name..." style="width:220px" />
      </div>
      <div id="market" class="list">Loading…</div>

      <div class="row" style="justify-content:space-between;margin-top:12px">
        <div class="label">My listings</div>
        <button id="btn-mine" class="btn muted">Reload</button>
      </div>
      <div id="mine" class="list">Loading…</div>
    </div>
  </div>
</div>

<!-- Inventory -->
<div id="tab-inv" class="card hidden">
  <div class="label">Inventory</div>
  <div id="inv-full" class="list">Loading…</div>
</div>

<script>
  // --- ! market skripta: ikone ispred imena ---
  const G = (typeof window !== "undefined") ? window : global;
  const FALLBACK_ITEM_ICON = "/images/t1_bronze.png";
  const esc = s => String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#39;");

  function itemMeta(code){
    const it = (G.ITEMS || {})[code] || {};
    return {
      name: it.name || code,
      icon: it.icon || FALLBACK_ITEM_ICON,
      tier: it.tier || 1
    };
  }

  function rowWithIcon({code, name, icon, rightHTML = "", sub = "", tier}){
    return `
      <div class="itemrow" data-code="${esc(code)}">
        <div class="row" style="gap:10px;align-items:center">
          <img class="icon" src="${esc(icon)}" alt="${esc(name)}"
               onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
          <div>
            <div class="label" style="text-transform:none;color:var(--text)">${esc(name)}</div>
            <div class="muted">${sub ? esc(sub) : esc(code)}</div>
          </div>
        </div>
        ${rightHTML || (tier ? `<span class="badge">T${tier}</span>` : "")}
      </div>`;
  }

  // ---------- CREATE SALE ----------
  let _INV_CACHE = [];

  async function loadInvForSale(){
    const box = document.getElementById("inv-list");
    if(!box) return;
    box.textContent = "Loading…";
    try{
      const r = await api("/api/inventory"); // prilagodi rutu ako treba
      _INV_CACHE = Array.isArray(r) ? r : (r?.items || []);
      renderInvForSale();
    }catch(e){
      console.error(e);
      box.innerHTML = '<div class="muted" style="padding:8px">Error loading.</div>';
    }
  }

  function renderInvForSale(){
    const box = document.getElementById("inv-list");
    if(!box) return;
    const q = (document.getElementById("inv-search")?.value || "").toLowerCase().trim();

    const rows = (_INV_CACHE || [])
      .map(it => ({ ...it, ...itemMeta(it.code) }))
      .filter(it => !q || it.name.toLowerCase().includes(q) || it.code.toLowerCase().includes(q))
      .sort((a,b)=> a.tier - b.tier || a.name.localeCompare(b.name))
      .map(it => rowWithIcon({
        code: it.code,
        name: it.name,
        icon: it.icon,
        tier: it.tier,
        sub: `${it.code} · x${it.qty ?? 1}`,
        rightHTML: `<button class="btn" data-pick="${esc(it.code)}">Pick</button>`
      }))
      .join("");

    box.innerHTML = rows || '<div class="muted" style="padding:8px">Empty</div>';

    box.querySelectorAll("[data-pick]").forEach(btn=>{
      btn.addEventListener("click", () => {
        const code = btn.getAttribute("data-pick");
        if (typeof pickForSale === "function") pickForSale(code);
      });
    });
  }

  document.getElementById("inv-search")?.addEventListener("input", renderInvForSale);

  // ---------- MARKETPLACE ----------
  async function loadMarket(){
    const box = document.getElementById("market");
    if(!box) return;
    box.textContent = "Loading…";
    try{
      const r = await api("/api/market"); // prilagodi rutu
      renderMarket(Array.isArray(r) ? r : (r?.offers || []));
    }catch(e){
      console.error(e);
      box.innerHTML = '<div class="muted" style="padding:8px">Error loading.</div>';
    }
  }

  function renderMarket(offers){
    const box = document.getElementById("market");
    if(!box) return;
    const q = (document.getElementById("market-q")?.value || "").toLowerCase().trim();

    const rows = (offers || [])
      .map(o => ({ ...o, ...itemMeta(o.code) }))
      .filter(o => !q || o.name.toLowerCase().includes(q) || o.code.toLowerCase().includes(q))
      .sort((a,b)=> a.tier - b.tier || a.name.localeCompare(b.name))
      .map(o => rowWithIcon({
        code: o.code,
        name: o.name,
        icon: o.icon,
        tier: o.tier,
        sub: `${o.code} · x${o.qty ?? 1}`,
        rightHTML: `
          <div class="row" style="gap:10px;align-items:center">
            <span class="badge">${esc(o.price)}s</span>
            <button class="btn" data-buy="${esc(o.id ?? o.code)}">Buy</button>
          </div>`
      }))
      .join("");

    box.innerHTML = rows || '<div class="muted" style="padding:8px">No listings</div>';

    box.querySelectorAll("[data-buy]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.getAttribute("data-buy");
        if (typeof buyOffer === "function") buyOffer(id);
      });
    });
  }

  document.getElementById("market-q")?.addEventListener("input", loadMarket);

  // ---------- MY LISTINGS ----------
  async function loadMine(){
    const box = document.getElementById("mine");
    if(!box) return;
    box.textContent = "Loading…";
    try{
      const r = await api("/api/market/mine"); // prilagodi rutu
      const mine = Array.isArray(r) ? r : (r?.offers || []);
      const rows = (mine || [])
        .map(o => ({ ...o, ...itemMeta(o.code) }))
        .sort((a,b)=> a.tier - b.tier || a.name.localeCompare(b.name))
        .map(o => rowWithIcon({
          code: o.code,
          name: o.name,
          icon: o.icon,
          tier: o.tier,
          sub: `${o.code} · x${o.qty ?? 1}`,
          rightHTML: `
            <div class="row" style="gap:10px;align-items:center">
              <span class="badge">${esc(o.price)}s</span>
              <button class="btn muted" data-cancel="${esc(o.id ?? o.code)}">Cancel</button>
            </div>`
        }))
        .join("");

      box.innerHTML = rows || '<div class="muted" style="padding:8px">No listings</div>';

      box.querySelectorAll("[data-cancel]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-cancel");
          if (typeof cancelOffer === "function") cancelOffer(id);
        });
      });
    }catch(e){
      console.error(e);
      box.innerHTML = '<div class="muted" style="padding:8px">Error loading.</div>';
    }
  }

  document.getElementById("btn-mine")?.addEventListener("click", loadMine);

  // ---------- INIT ----------
  document.addEventListener("DOMContentLoaded", ()=>{
    loadInvForSale();
    loadMarket();
    loadMine();
  });
</script>


<!-- Inventory -->
<div id="tab-inv" class="card hidden">
  <div class="label">Inventory</div>
  <div id="inv-full" class="list">Loading…</div>
</div>

<script>
  // --- ! market skripta: ikone ispred imena ---
  const G = (typeof window !== "undefined") ? window : global;
  const FALLBACK_ITEM_ICON = "/images/t1_bronze.png";
  const esc = s => String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#39;");

  function itemMeta(code){
    const it = (G.ITEMS || {})[code] || {};
    return {
      name: it.name || code,
      icon: it.icon || FALLBACK_ITEM_ICON,
      tier: it.tier || 1
    };
  }

  function rowWithIcon({code, name, icon, rightHTML = "", sub = "", tier}){
    return `
      <div class="itemrow" data-code="${esc(code)}">
        <div class="row" style="gap:10px;align-items:center">
          <img class="icon" src="${esc(icon)}" alt="${esc(name)}"
               onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
          <div>
            <div class="label" style="text-transform:none;color:var(--text)">${esc(name)}</div>
            <div class="muted">${sub ? esc(sub) : esc(code)}</div>
          </div>
        </div>
        ${rightHTML || (tier ? `<span class="badge">T${tier}</span>` : "")}
      </div>`;
  }

  // ---------- CREATE SALE ----------
  let _INV_CACHE = [];

  async function loadInvForSale(){
    const box = document.getElementById("inv-list");
    if(!box) return;
    box.textContent = "Loading…";
    try{
      const r = await api("/api/inventory"); // prilagodi rutu ako treba
      _INV_CACHE = Array.isArray(r) ? r : (r?.items || []);
      renderInvForSale();
    }catch(e){
      console.error(e);
      box.innerHTML = '<div class="muted" style="padding:8px">Error loading.</div>';
    }
  }

  function renderInvForSale(){
    const box = document.getElementById("inv-list");
    if(!box) return;
    const q = (document.getElementById("inv-search")?.value || "").toLowerCase().trim();

    const rows = (_INV_CACHE || [])
      .map(it => ({ ...it, ...itemMeta(it.code) }))
      .filter(it => !q || it.name.toLowerCase().includes(q) || it.code.toLowerCase().includes(q))
      .sort((a,b)=> a.tier - b.tier || a.name.localeCompare(b.name))
      .map(it => rowWithIcon({
        code: it.code,
        name: it.name,
        icon: it.icon,
        tier: it.tier,
        sub: `${it.code} · x${it.qty ?? 1}`,
        rightHTML: `<button class="btn" data-pick="${esc(it.code)}">Pick</button>`
      }))
      .join("");

    box.innerHTML = rows || '<div class="muted" style="padding:8px">Empty</div>';

    box.querySelectorAll("[data-pick]").forEach(btn=>{
      btn.addEventListener("click", () => {
        const code = btn.getAttribute("data-pick");
        if (typeof pickForSale === "function") pickForSale(code);
      });
    });
  }

  document.getElementById("inv-search")?.addEventListener("input", renderInvForSale);

  // ---------- MARKETPLACE ----------
  async function loadMarket(){
    const box = document.getElementById("market");
    if(!box) return;
    box.textContent = "Loading…";
    try{
      const r = await api("/api/market"); // prilagodi rutu
      renderMarket(Array.isArray(r) ? r : (r?.offers || []));
    }catch(e){
      console.error(e);
      box.innerHTML = '<div class="muted" style="padding:8px">Error loading.</div>';
    }
  }

  function renderMarket(offers){
    const box = document.getElementById("market");
    if(!box) return;
    const q = (document.getElementById("market-q")?.value || "").toLowerCase().trim();

    const rows = (offers || [])
      .map(o => ({ ...o, ...itemMeta(o.code) }))
      .filter(o => !q || o.name.toLowerCase().includes(q) || o.code.toLowerCase().includes(q))
      .sort((a,b)=> a.tier - b.tier || a.name.localeCompare(b.name))
      .map(o => rowWithIcon({
        code: o.code,
        name: o.name,
        icon: o.icon,
        tier: o.tier,
        sub: `${o.code} · x${o.qty ?? 1}`,
        rightHTML: `
          <div class="row" style="gap:10px;align-items:center">
            <span class="badge">${esc(o.price)}s</span>
            <button class="btn" data-buy="${esc(o.id ?? o.code)}">Buy</button>
          </div>`
      }))
      .join("");

    box.innerHTML = rows || '<div class="muted" style="padding:8px">No listings</div>';

    box.querySelectorAll("[data-buy]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.getAttribute("data-buy");
        if (typeof buyOffer === "function") buyOffer(id);
      });
    });
  }

  document.getElementById("market-q")?.addEventListener("input", loadMarket);

  // ---------- MY LISTINGS ----------
  async function loadMine(){
    const box = document.getElementById("mine");
    if(!box) return;
    box.textContent = "Loading…";
    try{
      const r = await api("/api/market/mine"); // prilagodi rutu
      const mine = Array.isArray(r) ? r : (r?.offers || []);
      const rows = (mine || [])
        .map(o => ({ ...o, ...itemMeta(o.code) }))
        .sort((a,b)=> a.tier - b.tier || a.name.localeCompare(b.name))
        .map(o => rowWithIcon({
          code: o.code,
          name: o.name,
          icon: o.icon,
          tier: o.tier,
          sub: `${o.code} · x${o.qty ?? 1}`,
          rightHTML: `
            <div class="row" style="gap:10px;align-items:center">
              <span class="badge">${esc(o.price)}s</span>
              <button class="btn muted" data-cancel="${esc(o.id ?? o.code)}">Cancel</button>
            </div>`
        }))
        .join("");

      box.innerHTML = rows || '<div class="muted" style="padding:8px">No listings</div>';

      box.querySelectorAll("[data-cancel]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-cancel");
          if (typeof cancelOffer === "function") cancelOffer(id);
        });
      });
    }catch(e){
      console.error(e);
      box.innerHTML = '<div class="muted" style="padding:8px">Error loading.</div>';
    }
  }

  document.getElementById("btn-mine")?.addEventListener("click", loadMine);

  // ---------- INIT ----------
  document.addEventListener("DOMContentLoaded", ()=>{
    loadInvForSale();
    loadMarket();
    loadMine();
  });
</script>

      <!-- Inventory -->
      <div id="tab-inv" class="card hidden">
        <div class="label">Inventory</div>
        <div id="inv-full" class="list">Loading…</div>
      </div>
    </section>
  </main>

  <!-- RENDER: prikaži ikonice i imena za recepte (i detalje) -->
  <script>
    // Univerzalni global (radi i u browseru i u Node bundl scenariju)
    const G = (typeof window !== "undefined") ? window : global;

    // Fallback ikone (ako u objektu nedostaje icon)
    const FALLBACK_ITEM_ICON   = "/images/t1_bronze.png";
    const FALLBACK_RECIPE_ICON = "/images/recipe.png";

    // Mali helper za HTML-escape (sigurnije za imena)
    const esc = s => String(s)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");

    // Render jedne recept-karte (ikonica + IME recepta + tier)
    function recipeCard(r){
      const icon = r.icon || FALLBACK_RECIPE_ICON;
      return `
        <div class="itemrow" data-recipe="${esc(r.code)}">
          <div class="row" style="gap:10px">
            <img src="${esc(icon)}"
                 alt="${esc(r.name)}"
                 style="width:32px;height:32px;object-fit:contain;border-radius:6px"
                 onerror="this.onerror=null;this.src='${FALLBACK_RECIPE_ICON}'"/>
            <div>
              <div class="label">${esc(r.name)}</div>
              <div class="muted">${esc(r.code)}</div>
            </div>
          </div>
          <span class="badge">T${r.tier}</span>
        </div>
      `;
    }

    // Popuni listu recepata (lijevi panel “Recipes you own”)
    function renderRecipesList(){
      const box = document.getElementById("recipes");
      if (!G.RECIPES) { box.innerHTML = '<div class="muted" style="padding:8px">No recipes</div>'; return; }
      const q = (document.getElementById("filter-recipe")?.value || "").toLowerCase().trim();

      // sortiraj po TIER pa po IMENU (koristimo r.name — baš što tražiš)
      const list = Object.values(G.RECIPES)
        .filter(r => !q || r.name.toLowerCase().includes(q))
        .sort((a,b)=> a.tier - b.tier || a.name.localeCompare(b.name));

      box.innerHTML = list.map(recipeCard).join("") || '<div class="muted" style="padding:8px">No results</div>';

      // klik na recept = detalji desno
      box.querySelectorAll("[data-recipe]").forEach(el=>{
        el.addEventListener("click", ()=>{
          const code = el.getAttribute("data-recipe");
          const r = G.RECIPES[code];
          if (!r) return;
          renderRecipeDetails(r);
        });
      });
    }

    // Desni panel “Details” — IME recepta, rezultat i dijelovi po IMENIMA
    function renderRecipeDetails(r){
      const box = document.getElementById("rec-details");
      const resultName = G.ITEMS?.[r.result]?.name || r.result;
      const partsHTML = (r.parts || []).map(p=>{
        const nm = G.ITEMS?.[p]?.name || p;    // KORISTI IME ITEMA
        const ic = G.ITEMS?.[p]?.icon || FALLBACK_ITEM_ICON;
        return `
          <div class="row" style="gap:10px">
            <img src="${esc(ic)}"
                 alt="${esc(nm)}"
                 style="width:28px;height:28px;object-fit:contain;border-radius:6px"
                 onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'"/>
            <div>${esc(nm)} <span class="muted">(${esc(p)})</span></div>
          </div>`;
      }).join("");

      const icon = r.icon || FALLBACK_RECIPE_ICON;

      box.innerHTML = `
        <div class="row" style="gap:10px;margin-bottom:8px">
          <img src="${esc(icon)}"
               alt="${esc(r.name)}"
               style="width:40px;height:40px;object-fit:contain;border-radius:8px"
               onerror="this.onerror=null;this.src='${FALLBACK_RECIPE_ICON}'"/>
          <div>
            <div class="label">${esc(r.name)}</div>
            <div class="muted">${esc(r.code)} · Tier T${r.tier}</div>
          </div>
        </div>
        <div class="card">
          <div class="label">Result</div>
          <div class="row" style="gap:10px;margin-top:6px">
            <img src="${esc(G.ITEMS?.[r.result]?.icon || FALLBACK_ITEM_ICON)}"
                 alt="${esc(resultName)}"
                 style="width:28px;height:28px;object-fit:contain;border-radius:6px"
                 onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'"/>
            <div>${esc(resultName)} <span class="muted">(${esc(r.result)})</span></div>
          </div>
        </div>
        <div class="card" style="margin-top:10px">
          <div class="label">Parts</div>
          <div style="margin-top:6px;display:grid;grid-template-columns:1fr;gap:6px">
            ${partsHTML}
          </div>
        </div>
      `;
    }

    // Filter i refresh
    document.getElementById("filter-recipe")?.addEventListener("input", renderRecipesList);
    document.getElementById("btn-refresh-rec")?.addEventListener("click", renderRecipesList);

    // Prvi render kad je DOM spreman (podaci iz tvog fajla već moraju biti učitani)
    document.addEventListener("DOMContentLoaded", ()=>{
      try { renderRecipesList(); } catch(e){ console.error(e); }
    });
  </script>



  <!-- Toast -->
  <div id="toast" class="toast hidden"></div>

<script>
// ===== Helpers (toast, $, api) =====
const $  = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
function toast(t){ const box=$("#toast"); box.textContent=t; box.classList.remove("hidden"); setTimeout(()=>box.classList.add("hidden"),1800); }

const api = async (p,opts={})=>{
  const r = await fetch(p,{credentials:"include",headers:{"Content-Type":"application/json"},...opts});
  let data=null; try{data=await r.json()}catch{}
  if(!r.ok) throw new Error((data&&data.error)||("HTTP "+r.status));
  return data;
};

// ===== Global state =====
let WHO=null;                     // user objekt iz /api/me
let SEL_INV=null;                 // odabran item/recipe za listing {kind,id,name}
let INVENTORY_CACHE={items:[],recipes:[]};
window.CURRENT_RECIPE_ID=null;    // da “Details” ostane otvoren nakon refresh-a

// ===== Tabs =====
function setTab(tab){
  $$(".chip").forEach(c=>c.classList.toggle("active", c.dataset.tab===tab));
  $("#tab-shop").classList.toggle("hidden", tab!=="shop");
  $("#tab-craft").classList.toggle("hidden", tab!=="craft");
  $("#tab-sales").classList.toggle("hidden", tab!=="sales");
  $("#tab-inv").classList.toggle("hidden", tab!=="inv");
}
$$(".chip").forEach(c=>c.addEventListener("click",()=>setTab(c.dataset.tab)));

// ===== Auth: Register =====
$("#btn-register").addEventListener("click", async ()=>{
  $("#reg-msg").textContent="…";
  try{
    const email=$("#reg-email").value.trim(), pass=$("#reg-pass").value;
    const r = await api("/api/register",{method:"POST",body:JSON.stringify({email, password:pass})});
    $("#reg-msg").textContent="OK — now log in.";
  }catch(e){ $("#reg-msg").textContent=e.message; }
});

// ===== Auth: Login =====
$("#btn-login").addEventListener("click", async ()=>{
  $("#log-msg").textContent="…";
  try{
    const email=$("#log-email").value.trim(), pass=$("#log-pass").value;
    await api("/api/login",{method:"POST",body:JSON.stringify({email, password:pass})});
    $("#log-msg").textContent="OK";
    await loadMe();
    setTab("shop");
  }catch(e){ $("#log-msg").textContent=e.message; }
});

// ===== Auth: Logout =====
$("#btn-logout").addEventListener("click", async ()=>{
  try{ await api("/api/logout"); }catch{}
  WHO=null; $("#who").textContent="Not logged in"; $("#balance").textContent="0g 0s";
  $("#auth").classList.remove("hidden"); $("#app").classList.add("hidden");
});

// ===== /api/me + render balance =====
async function loadMe(){
  try{
    const r = await api("/api/me");
    WHO = r.user;
    $("#auth").classList.add("hidden");
    $("#app").classList.remove("hidden");
    $("#who").textContent = WHO.email;
    $("#btn-logout").classList.remove("hidden");
    renderBalance();
    $("#buysToNext").textContent = (typeof WHO.buys_to_next==="number")
      ? ("Buys to next recipe: "+WHO.buys_to_next)
      : "Buys to next recipe: —";

    await loadInventoryPanel();
    loadRecipes();
    loadMarket();
    loadMine();
    loadInventoryFull();
  }catch{
    $("#auth").classList.remove("hidden");
    $("#app").classList.add("hidden");
    $("#who").textContent = "Not logged in";
    $("#btn-logout").classList.add("hidden");
  }
}
function renderBalance(){
  if(!WHO) return;
  $("#balance").textContent = `${Math.floor(WHO.balance_silver/100)}g ${WHO.balance_silver%100}s`;
}

// ===== SHOP: Buy T1 =====
$("#btn-buy-t1").addEventListener("click", async ()=>{
  try{
    const r = await api("/api/shop/buy-t1",{method:"POST",body:JSON.stringify({})});
    WHO.balance_silver = r.balance_silver;
    renderBalance();
    if (r.gotRecipe){
      $("#shop-msg").textContent = `Got recipe: ${r.gotRecipe.name} (T${r.gotRecipe.tier})`;
    } else if (r.gotItem){
      $("#shop-msg").textContent = `Got item: ${r.gotItem.name} (T${r.gotItem.tier})`;
    } else {
      $("#shop-msg").textContent = "OK";
    }
    await loadMe();                    // refresh buys_to_next
    await loadInventoryPanel();
    loadRecipes();
    loadInventoryFull();
  }catch(e){ alert(e.message); }
});

// ===== Crafting: popis recepata =====
async function loadRecipes(){
  const box=$("#recipes"); 
  box.textContent="Loading…";
  try{
    const list = await api("/api/recipes/list");
    const q = $("#filter-recipe").value.trim().toLowerCase();
    const rows = (list.recipes||[]).filter(x=>!q||x.name.toLowerCase().includes(q));
    if (!rows.length){ 
      box.textContent="No recipes."; 
      return; 
    }
    box.innerHTML="";
    for (const rec of rows){
      const row=document.createElement("div"); 
      row.className="itemrow";
      row.innerHTML = `
        <div><b>${rec.name}</b> 
          <span class="badge">T${rec.tier}</span> 
          <span class="muted">x${rec.qty}</span>
        </div>
        <button class="btn muted">Open</button>`;
      row.querySelector("button").addEventListener("click",()=>openRecipe(rec.id));
      box.appendChild(row);
    }
  }catch(e){ 
    box.textContent=e.message; 
  }
}
$("#btn-refresh-rec").addEventListener("click", async ()=>{
  try{
    await loadRecipes();
    await loadInventoryPanel();
    await loadInventoryFull();
    if (window.CURRENT_RECIPE_ID) await openRecipe(window.CURRENT_RECIPE_ID);
  }catch(e){ 
    alert(e.message||"Refresh failed"); 
  }
});
$("#filter-recipe").addEventListener("input", loadRecipes);

// ===== Crafting: detalji recepta + Craft =====
function renderIngredients(details){
  const lines = [];
  lines.push(`<div class="itemrow"><div><b>${details.recipe.name}</b> <span class="badge">T${details.recipe.tier}</span></div></div>`);
  lines.push(`<div class="itemrow"><div class="muted">Ingredients</div></div>`);
  for(const ing of (details.ingredients||[])){
    const ok = ing.have >= ing.qty;
    lines.push(
      `<div class="itemrow">
         <div>${ing.name} <span class="badge">T${ing.tier}</span></div>
         <div class="${ok?'':'muted'}">${ing.have}/${ing.qty}</div>
       </div>`
    );
  }
  lines.push(
    `<div class="itemrow">
       <button id="btn-craft" class="btn">Craft</button>
       <span class="muted">10% fail → Scrap (server checks ingredients)</span>
     </div>`
  );
  return lines.join("");
}
async function openRecipe(recipeId){
  const box=$("#rec-details"); 
  box.textContent="Loading…";
  try{
    const details = await api(`/api/recipes/ingredients/${recipeId}`);
    box.innerHTML = renderIngredients(details);
    window.CURRENT_RECIPE_ID = details.recipe.id;
    $("#btn-craft").addEventListener("click", async ()=>{
      try{
        const r2 = await api("/api/craft/do",{method:"POST",body:JSON.stringify({recipe_id: details.recipe.id})});
        if (r2.crafted) toast(`Crafted: ${r2.crafted.name} (T${r2.crafted.tier})`);
        else if (r2.scrap) toast("Failed (got Scrap)");
        else toast("Done");
        await loadInventoryPanel(); 
        await loadRecipes(); 
        await loadInventoryFull();
        await openRecipe(details.recipe.id);
      }catch(e){ 
        alert(e.message); 
      }
    });
  }catch(e){ 
    box.textContent=e.message; 
  }
}

// ARTEFACT: učitavanje bonusa + ispravljeno čitanje r.crafted

// helper za učitavanje bonusa
async function refreshArtefactBonus(){
  try{
    const r = await api("/api/items/artefact/bonus");
    const bonus = (typeof r?.bonus_gold === "number") ? r.bonus_gold : (parseInt(r?.bonus_gold,10) || 0);
    const el = document.querySelector("#artefact-bonus");
    if (el) el.textContent = bonus;
  }catch(e){
    console.warn("refreshArtefactBonus failed:", e);
  }
}

// automatski refresh kad se tab prikaže
(() => {
  const craft = document.querySelector("#tab-craft");
  if (!craft) return;
  const obs = new MutationObserver(() => {
    if (!craft.classList.contains("hidden")) refreshArtefactBonus();
  });
  obs.observe(craft, { attributes:true });
})();

// ARTEFACT: Crafting dugme
$("#btn-artefact").addEventListener("click", async ()=> {
  try {
    const r = await api("/api/craft/artefact", { method:"POST", body: JSON.stringify({}) });

    // r.crafted je string (npr. "Artefact")
    const name  = r.crafted || "Artefact";
    const bonus = (typeof r?.bonus_gold === "number") ? r.bonus_gold : (parseInt(r?.bonus_gold,10) || 0);

    // ažuriraj broj i poruku
    $("#artefact-bonus").textContent = bonus;
    $("#artefact-msg").textContent = `Crafted: ${name} (+${bonus} gold)`;

    await loadInventoryPanel();
    await loadInventoryFull();
    await loadRecipes();
  } catch(e) {
    $("#artefact-msg").textContent = e?.message || "Crafting failed.";
  }
});


// ===== Sales: inventar panel za kreiranje listinga =====
async function loadInventoryPanel(){
  const box=$("#inv-list"); if(!box) return;
  box.textContent="Loading…";
  try{
    const r = await api("/api/inventory");
    INVENTORY_CACHE = r;
    const q = $("#inv-search").value?.trim().toLowerCase() || "";
    const items = (r.items||[]).filter(x=>!q||x.name.toLowerCase().includes(q));
    const recipes = (r.recipes||[]).filter(x=>!q||x.name.toLowerCase().includes(q));
    box.innerHTML="";
    const add = (arr,kind)=>{
      for(const it of arr){
        const row=document.createElement("div"); row.className="itemrow";
        row.innerHTML=`<div>${it.name} <span class="badge">T${it.tier}</span> <span class="muted">x${it.qty}</span></div><button class="btn muted">Pick</button>`;
        row.querySelector("button").addEventListener("click", ()=>{
          SEL_INV = { kind, id: it.id, name: it.name };
          $("#list-msg").textContent = "Selected: "+it.name;
        });
        box.appendChild(row);
      }
    };
    add(items,"item");
    add(recipes,"recipe");
    if (!box.children.length) box.textContent="Empty.";
  }catch(e){ box.textContent=e.message; }
}
$("#inv-search")?.addEventListener("input", loadInventoryPanel);

// ===== Sales: kreiraj listing =====
$("#btn-list").addEventListener("click", async ()=>{
  try{
    if(!SEL_INV){ alert("Pick an item/recipe first."); return; }
    const gold=parseInt($("#price-g").value||"0",10)||0;
    const silver=parseInt($("#price-s").value||"0",10)||0;
    const qty=parseInt($("#price-qty").value||"1",10)||1;
    const body = { kind: SEL_INV.kind, id: SEL_INV.id, qty, gold, silver };
    await api("/api/sales/list",{method:"POST",body:JSON.stringify(body)});
    $("#list-msg").textContent="Listed.";
    SEL_INV=null;
    loadMarket(); loadMine(); loadInventoryPanel();
  }catch(e){ alert(e.message); }
});

// ===== Sales: Marketplace (live) =====
async function loadMarket(){
  const box=$("#market"); if(!box) return;
  box.textContent="Loading…";
  try{
    const q=$("#market-q").value?.trim() || "";
    const url = "/api/sales/live" + (q?("?q="+encodeURIComponent(q)):"");
    const r = await api(url);
    const rows = r.listings || [];
    if(!rows.length){ box.textContent="No listings."; return; }
    box.innerHTML="";
    for(const s of rows){
      const g=Math.floor((s.price_s||0)/100), ss=(s.price_s||0)%100;
      const label = (s.name && s.tier) ? `${s.name} <span class="badge">T${s.tier}</span>`
                                       : (s.kind==="item" ? `Item #${s.item_id||"-"}` : `Recipe #${s.recipe_id||"-"}`);
      const row=document.createElement("div"); row.className="itemrow";
      row.innerHTML=`<div>${label} <span class="muted">x${s.qty}</span></div>
                     <div class="row">
                       <span class="badge">${g}g ${ss}s</span>
                       <button class="btn">Buy</button>
                     </div>`;
      row.querySelector("button").addEventListener("click", async ()=>{
        try{
          await api("/api/sales/buy",{method:"POST",body:JSON.stringify({id:s.id})});
          toast("Purchased.");
          loadMarket(); loadMine(); loadInventoryPanel(); loadInventoryFull(); loadMe();
        }catch(e){ alert(e.message); }
      });
      box.appendChild(row);
    }
  }catch(e){ box.textContent=e.message; }
}
$("#market-q")?.addEventListener("input", loadMarket);

// ===== Sales: My listings =====
async function loadMine(){
  const box=$("#mine"); if(!box) return;
  box.textContent="Loading…";
  try{
    const r = await api("/api/sales/mine");
    const rows = r.listings || [];
    if(!rows.length){ box.textContent="No listings."; return; }
    box.innerHTML="";
    for(const s of rows){
      const g=Math.floor((s.price_s||0)/100), ss=(s.price_s||0)%100;
      const label = (s.name && s.tier) ? `${s.name} <span class="badge">T${s.tier}</span>`
                                       : (s.kind==="item" ? `Item #${s.item_id||"-"}` : `Recipe #${s.recipe_id||"-"}`);
      const row=document.createElement("div"); row.className="itemrow";
      row.innerHTML=`<div>${label} <span class="muted">x${s.qty}</span> <span class="badge">${s.status}</span></div>
                     <div class="row">
                       <span class="badge">${g}g ${ss}s</span>
                       ${s.status==='live'?'<button class="btn danger">Cancel</button>':''}
                     </div>`;
      if (s.status==='live'){
        row.querySelector("button").addEventListener("click", async ()=>{
          try{
            await api("/api/sales/cancel",{method:"POST",body:JSON.stringify({id:s.id})});
            loadMarket(); loadMine(); loadInventoryPanel();
          }catch(e){ alert(e.message); }
        });
      }
      box.appendChild(row);
    }
  }catch(e){ box.textContent=e.message; }
}
$("#btn-mine")?.addEventListener("click", loadMine);

// ===== Inventory (puni prikaz) =====
async function loadInventoryFull(){
  const box=$("#inv-full"); if(!box) return;
  box.textContent="Loading…";
  try{
    const r = await api("/api/inventory");
    const lines=[];
    for(const it of (r.items||[])){
      lines.push(`<div class="itemrow"><div>${it.name} <span class="badge">T${it.tier}</span></div><div class="muted">x${it.qty}</div></div>`);
    }
    for(const rc of (r.recipes||[])){
      lines.push(`<div class="itemrow"><div class="muted">[Recipe]</div><div>${rc.name} <span class="badge">T${rc.tier}</span></div><div class="muted">x${rc.qty}</div></div>`);
    }
    box.innerHTML = lines.join("") || "Empty.";
  }catch(e){ box.textContent=e.message; }
}

// ===== Init =====
loadMe();
</script>
</body>
</html>














