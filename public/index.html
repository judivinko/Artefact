<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ARTEFACT</title>
  <link rel="stylesheet" href="/app.css"/>
  <style>
    :root{
      --bg:#0b1220;--card:#0f172a;--muted:#93a3b8;--text:#e2e8f0;--accent:#10b981;--accent2:#22d3ee;
      --danger:#ef4444;--border:#233047;
    }
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:16px auto;padding:0 12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .between{justify-content:space-between}
    .pill{background:#172036;border:1px solid var(--border);padding:6px 10px;border-radius:999px}
    .btn{background:var(--accent);color:#052; border:0;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#1f8b74;color:#051}
    .btn.ghost{background:#1f2937;color:#cbd5e1}
    .btn.danger{background:#9f1239;color:#fee2e2}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .tabs .btn{background:#164e63;color:#c7f9ff}
    .tabs .btn.active{background:var(--accent2);color:#013}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .grid2{display:grid;grid-template-columns:1.1fr 1fr;gap:12px}
    @media (max-width: 900px){.grid2{grid-template-columns:1fr}}
    input,select{background:#0b1220;border:1px solid var(--border);border-radius:8px;color:var(--text);padding:8px}
    input[type=number]{width:90px}
    .muted{color:var(--muted)}
    .list{max-height:380px;overflow:auto;border:1px solid var(--border);border-radius:10px}
    .rowitem{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px dashed #1e293b}
    .rowitem:last-child{border-bottom:0}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .badge{font-size:12px;background:#12203a;border:1px solid var(--border);padding:2px 6px;border-radius:6px;margin-left:6px}
    .ok{color:#34d399}.err{color:#fca5a5}
    .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .h1{font-size:22px;font-weight:800}
    .h2{font-size:16px;font-weight:700;margin-bottom:6px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px dashed #1e293b;padding:8px;text-align:left}
    .right{float:right}
    .spacer{height:8px}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- Header -->
    <div class="head">
      <div class="h1">ARTEFACT</div>
      <div class="row">
        <div id="who" class="pill muted">Not logged in</div>
        <button id="btn-logout" class="btn ghost hidden">Log out</button>
      </div>
    </div>

    <!-- AUTH GATE -->
    <div id="auth" class="card">
      <div class="h2">Welcome — sign up or log in</div>
      <div class="grid2">
        <div class="card">
          <div class="h2">Register</div>
          <div class="row"><input id="r-email" placeholder="email"/></div>
          <div class="row"><input id="r-pass" type="password" placeholder="password (min 6)"/></div>
          <div class="row"><button id="btn-register" class="btn">Create account</button><span id="r-msg" class="muted"></span></div>
        </div>
        <div class="card">
          <div class="h2">Login</div>
          <div class="row"><input id="l-email" placeholder="email"/></div>
          <div class="row"><input id="l-pass" type="password" placeholder="password"/></div>
          <div class="row"><button id="btn-login" class="btn secondary">Log in</button><span id="l-msg" class="muted"></span></div>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">

      <!-- Top bar -->
      <div class="row between card">
        <div class="tabs row">
          <button class="btn" data-tab="shop">Shop</button>
          <button class="btn" data-tab="craft">Crafting</button>
          <button class="btn" data-tab="sales">Sales</button>
          <button class="btn" data-tab="inv">Inventory</button>
        </div>
        <div class="row">
          <div id="balance" class="pill mono">0g 0s</div>
          <div id="next-recipe" class="pill mono muted">Buys to next recipe: —</div>
        </div>
      </div>

      <!-- TAB: SHOP -->
      <section id="tab-shop" class="card" style="margin-top:12px;">
        <div class="h2">Shop (T1 only)</div>
        <p class="muted">Each purchase costs <b>1 gold</b> (100s). You either get a random T1 material or a recipe drop (weighted T2–T5, rare T6).</p>
        <button id="btn-buy-t1" class="btn">Buy T1 Pack (1g)</button>
        <span id="shop-msg" class="muted" style="margin-left:10px"></span>
      </section>

      <!-- TAB: CRAFTING -->
      <section id="tab-craft" class="card hidden" style="margin-top:12px;">
        <div class="grid2">
          <!-- LEFT -->
          <div class="card">
            <div class="row between">
              <div class="h2">Recipes you own</div>
              <div class="row">
                <input id="recipe-filter" placeholder="filter by name…"/>
                <button id="btn-recipe-refresh" class="btn ghost">Refresh</button>
              </div>
            </div>
            <div id="recipes" class="list"></div>
          </div>
          <!-- RIGHT -->
          <div class="card">
            <div class="row between">
              <div class="h2">Details</div>
              <button id="btn-craft-artefact" class="btn secondary">Craft ARTEFACT (10× distinct T5)</button>
            </div>
            <div id="recipe-detail" class="muted">Select a recipe on the left.</div>
          </div>
        </div>
      </section>

      <!-- TAB: SALES (AUCTION BACKEND WITH BUY-NOW) -->
      <section id="tab-sales" class="card hidden" style="margin-top:12px;">
        <div class="grid2">
          <!-- LEFT: create -->
          <div class="card">
            <div class="h2">Create Sale</div>
            <input id="inv-search" placeholder="Search your inventory…"/>
            <div id="inv-list" class="list" style="margin-top:8px"></div>
            <div class="spacer"></div>
            <div class="h2">Price</div>
            <div class="row">
              <input id="price-g" type="number" min="0" step="1" placeholder="Gold"/>
              <input id="price-s" type="number" min="0" max="99" step="1" placeholder="Silver (0–99)"/>
              <input id="sell-qty" type="number" min="1" step="1" value="1" title="Qty"/>
              <button id="btn-list" class="btn">List for sale</button>
              <span id="sell-msg" class="muted"></span>
            </div>
            <div class="muted" style="margin-top:6px">Uses auction endpoints with Buy-Now (fixed price). Start = Buy-Now.</div>
          </div>

          <!-- RIGHT: marketplace -->
          <div class="card">
            <div class="row between">
              <div class="h2">Marketplace</div>
              <input id="live-search" placeholder="Search by name…"/>
            </div>
            <div id="live-list" class="list"></div>

            <div class="card" style="margin-top:12px;">
              <div class="row between">
                <div class="h2">My listings</div>
                <button id="btn-my-refresh" class="btn ghost">Reload</button>
              </div>
              <div id="my-list" class="list"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- TAB: INVENTORY -->
      <section id="tab-inv" class="card hidden" style="margin-top:12px;">
        <div class="h2">Inventory</div>
        <table class="table" id="inv-table">
          <thead><tr><th>Item</th><th>Tier</th><th class="mono">Qty</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

    </div>
  </div>

  <script>
    // -------- tiny helpers
    const $ = s=>document.querySelector(s);
    const el = (tag,opts={})=>{const e=document.createElement(tag); if(opts.class) e.className=opts.class; if(opts.text) e.textContent=opts.text; return e;}
    async function api(path, opts={}){
      const res = await fetch(path,{credentials:"include",headers:{"Content-Type":"application/json"},...opts});
      let data=null; try{ data=await res.json(); }catch{}
      if(!res.ok) throw new Error((data&&data.error)||("HTTP "+res.status));
      return data;
    }
    function money(s){ const g=Math.floor(s/100), c=(s%100); return g+"g "+c+"s"; }
    function showTab(name){
      for(const id of ["shop","craft","sales","inv"]){
        const btn = document.querySelector(`.tabs .btn[data-tab="${id}"]`);
        if(id===name){ btn.classList.add("active"); $(`#tab-${id}`).classList.remove("hidden"); }
        else { btn.classList.remove("active"); $(`#tab-${id}`).classList.add("hidden"); }
      }
    }
    function toast(target, msg, ok=true){ const n=$(target); n.textContent=msg; n.className = ok ? "muted ok" : "muted err"; setTimeout(()=>n.textContent="",3500); }

    // -------- auth
    async function loadMe(){
      try{
        const r = await api("/api/me");
        const u = r.user;
        $("#auth").classList.add("hidden");
        $("#app").classList.remove("hidden");
        $("#who").textContent = `${u.email}`;
        $("#btn-logout").classList.remove("hidden");
        updateBalance(u);
        await Promise.all([loadInventory(), loadRecipes(), loadLive(), loadMine()]);
        showTab("shop");
      }catch{
        $("#auth").classList.remove("hidden");
        $("#app").classList.add("hidden");
        $("#who").textContent = "Not logged in";
        $("#btn-logout").classList.add("hidden");
      }
    }
    function updateBalance(u){
      const bal = (u.balance_silver!=null)?u.balance_silver: (u.gold*100 + (u.silver||0));
      $("#balance").textContent = money(bal);
      const left = (u.buys_to_next==null)?"—":String(u.buys_to_next);
      $("#next-recipe").textContent = "Buys to next recipe: "+left;
    }

    // -------- inventory (for listing + table)
    let INV = []; // {code,name,tier,qty} and recipes as {code,name,tier,qty,isRecipe:true}
    let SELECTED_CODE = null;

    async function loadInventory(){
      try{
        const r = await api("/api/my/inventory");
        const items = (r.items||[]).map(it=>({...it, isRecipe:false}));
        const recs  = (r.recipes||[]).map(rc=>({...rc, isRecipe:true}));
        INV = [...items, ...recs];
        // table
        const tb = $("#inv-table tbody"); tb.innerHTML="";
        INV.slice().sort((a,b)=> a.tier-b.tier || a.name.localeCompare(b.name)).forEach(x=>{
          const tr = el("tr");
          tr.innerHTML = `<td>${x.name} ${x.isRecipe?'<span class="badge">recipe</span>':''}</td><td>T${x.tier}</td><td class="mono">${x.qty}</td>`;
          tb.appendChild(tr);
        });
        // list for sales selector
        paintInvList();
      }catch(e){
        $("#inv-table tbody").innerHTML = `<tr><td colspan="3" class="muted">${e.message}</td></tr>`;
      }
    }
    function paintInvList(){
      const q = ($("#inv-search").value||"").trim().toLowerCase();
      const box = $("#inv-list"); box.innerHTML="";
      const list = INV.filter(x=>x.qty>0 && (!q || x.name.toLowerCase().includes(q)));
      if(!list.length){ box.innerHTML = `<div class="rowitem muted">No items.</div>`; return; }
      list.slice().sort((a,b)=> a.tier-b.tier || a.name.localeCompare(b.name)).forEach(x=>{
        const row = el("div",{class:"rowitem"});
        const left = el("div");
        left.innerHTML = `<b>${x.name}</b> ${x.isRecipe?'<span class="badge">recipe</span>':''} <span class="badge">T${x.tier}</span> <span class="mono muted">x${x.qty}</span>`;
        const pick = el("button",{class:"btn ghost",text:"Pick"});
        pick.onclick = ()=>{ SELECTED_CODE = x.isRecipe ? ("R_"+x.code.replace(/^R_/,"")) : x.code; toast("#sell-msg", `Selected: ${x.name}`, true); };
        row.append(left,pick);
        box.append(row);
      });
    }

    // -------- recipes
    let RECIPES = []; // list i own
    async function loadRecipes(){
      try{
        const r = await api("/api/my/recipes");
        RECIPES = r.recipes||[];
        paintRecipeList();
      }catch(e){
        $("#recipes").innerHTML = `<div class="rowitem err">${e.message}</div>`;
      }
    }
    function paintRecipeList(){
      const box=$("#recipes"); box.innerHTML="";
      const q = ($("#recipe-filter").value||"").trim().toLowerCase();
      const list = (RECIPES||[]).filter(r=>!q || r.name.toLowerCase().includes(q));
      if(!list.length){ box.innerHTML = `<div class="rowitem muted">You have no recipes.</div>`; return; }
      list.sort((a,b)=> a.tier-b.tier || a.name.localeCompare(b.name)).forEach(r=>{
        const row=el("div",{class:"rowitem"});
        row.innerHTML = `<div><b>${r.name}</b> <span class="badge">T${r.tier}</span> <span class="mono muted">x${r.qty}</span></div>`;
        const btn=el("button",{class:"btn ghost",text:"Open"});
        btn.onclick = ()=> openRecipe(r.id);
        row.appendChild(btn);
        box.appendChild(row);
      });
    }
    async function openRecipe(id){
      try{
        const r = await api(`/api/recipes/${id}`);
        const rec = r.recipe, ings = r.ingredients;
        const can = r.can_craft;
        const box=$("#recipe-detail");
        const need = ings.map(x=>`<tr><td>${x.name}</td><td class="mono">${x.have_qty}/${x.need_qty}</td></tr>`).join("");
        box.innerHTML = `
          <div class="h2">${rec.name} <span class="badge">T${rec.tier}</span></div>
          <table class="table"><thead><tr><th>Ingredient</th><th>Have / Need</th></tr></thead><tbody>${need}</tbody></table>
          <div class="row"><button id="btn-do-craft" class="btn" ${can?"":"disabled"}>Craft</button>
            <span class="muted">${can?"":"Missing ingredients"}</span>
          </div>
        `;
        $("#btn-do-craft").onclick = async ()=>{
          try{
            const out = await api(`/api/recipes/${id}/craft`, {method:"POST"});
            if(out.crafted){ alert(`Crafted: ${out.output.name} [T${out.output.tier}]`); }
            else if(out.scrap){ alert(`Craft failed → Scrap received.`); }
            await Promise.all([loadInventory(), loadRecipes()]);
          }catch(e){ alert(e.message); }
        };
      }catch(e){
        $("#recipe-detail").textContent = e.message;
      }
    }

    // special artefact craft
    $("#btn-craft-artefact").onclick = async ()=>{
      try{
        const r = await api("/api/craft/artefact",{method:"POST"});
        if(r && r.ok){ alert("Crafted: Artefact"); }
        await Promise.all([loadInventory(), loadRecipes()]);
      }catch(e){ alert(e.message); }
    };

    // -------- shop
    $("#btn-buy-t1").onclick = async ()=>{
      try{
        $("#btn-buy-t1").disabled=true;
        const r = await api("/api/shop/buy-t1",{method:"POST"});
        if(r.result_type==="RECIPE" && r.grantedRecipe){
          toast("#shop-msg", `Recipe drop: ${r.grantedRecipe.name} [T${r.grantedRecipe.tier}]`, true);
          await loadRecipes();
        }else if(r.addedItem){
          toast("#shop-msg", `Item: ${r.addedItem.name}`, true);
          await loadInventory();
        }
        // refresh balance & next-recipe
        const me = await api("/api/me");
        updateBalance(me.user);
      }catch(e){
        toast("#shop-msg", e.message, false);
      }finally{
        $("#btn-buy-t1").disabled=false;
      }
    };

    // -------- sales via AUCTIONS backend (fixed price = start == buy-now)
    async function loadLive(){
      try{
        const r = await api("/api/auctions/live");
        renderLive(r.auctions||[]);
      }catch(e){
        $("#live-list").innerHTML = `<div class="rowitem err">${e.message}</div>`;
      }
    }
    function renderLive(list){
      const q = ($("#live-search").value||"").trim().toLowerCase();
      const box=$("#live-list"); box.innerHTML="";
      const arr = (list||[]).filter(a=>!q || (a.name||"").toLowerCase().includes(q));
      if(!arr.length){ box.innerHTML = `<div class="rowitem muted">No listings.</div>`; return; }
      arr.forEach(a=>{
        const price = a.buy_now_price_s ?? a.start_price_s;
        const row = el("div",{class:"rowitem"});
        row.innerHTML = `<div><b>${a.name||a.code}</b> <span class="badge">x${a.qty}</span> <span class="badge">TBA</span></div>
                         <div class="row"><span class="mono">${money(price||0)}</span></div>`;
        const buyBtn = el("button",{class:"btn",text:"Buy"});
        buyBtn.onclick = async ()=>{
          try{
            const out = await api(`/api/auctions/${a.id}/buy-now`, {method:"POST"});
            alert(`Bought ${a.name||a.code} x${a.qty} for ${money(out.bought.sold_price_s)}`);
            await Promise.all([loadInventory(), loadLive(), loadMine()]);
            const me = await api("/api/me"); updateBalance(me.user);
          }catch(e){ alert(e.message); }
        };
        // Only show buy if buy-now exists
        if(a.buy_now_price_s){ row.append(buyBtn); }
        box.append(row);
      });
    }

    async function loadMine(){
      try{
        const r = await api("/api/auctions/mine");
        const box=$("#my-list"); box.innerHTML="";
        const arr = r.auctions||[];
        if(!arr.length){ box.innerHTML = `<div class="rowitem muted">No listings.</div>`; return; }
        arr.forEach(a=>{
          const price = a.buy_now_price_s ?? a.start_price_s;
          const row = el("div",{class:"rowitem"});
          row.innerHTML = `<div><b>${a.name||a.code}</b> <span class="badge">x${a.qty}</span></div>
                           <div class="row"><span class="mono">${money(price||0)}</span>
                           <span class="badge">${a.status}</span></div>`;
          if(a.status==="live" && !(a.highest_bid_s>0)){
            const c = el("button",{class:"btn danger",text:"Cancel"});
            c.onclick = async ()=>{
              try{ await api(`/api/auctions/${a.id}/cancel`,{method:"POST"}); await Promise.all([loadInventory(),loadLive(),loadMine()]); }
              catch(e){ alert(e.message); }
            };
            row.append(c);
          }
          box.append(row);
        });
      }catch(e){
        $("#my-list").innerHTML = `<div class="rowitem err">${e.message}</div>`;
      }
    }

    $("#btn-my-refresh").onclick = loadMine;
    $("#live-search").addEventListener("input", loadLive);
    $("#inv-search").addEventListener("input", paintInvList);

    // create listing
    $("#btn-list").onclick = async ()=>{
      try{
        if(!SELECTED_CODE) return toast("#sell-msg","Pick an item from list first.",false);
        const qty = Math.max(1, parseInt($("#sell-qty").value||"1",10));
        let g = parseInt($("#price-g").value||"0",10)||0;
        let s = parseInt($("#price-s").value||"0",10)||0;
        if(s<0||s>99) return toast("#sell-msg","Silver must be 0–99.",false);
        if(g===0 && s===0) return toast("#sell-msg","Set a price.",false);
        // fixed price -> start == buy-now
        const body = {
          code: SELECTED_CODE,
          qty,
          start_gold: g, start_silver: s,
          buy_gold: g, buy_silver: s,
          duration_min: 60
        };
        await api("/api/auctions/create",{method:"POST",body:JSON.stringify(body)});
        toast("#sell-msg","Listed!",true);
        SELECTED_CODE=null; $("#price-g").value=""; $("#price-s").value=""; $("#sell-qty").value="1";
        await Promise.all([loadInventory(), loadLive(), loadMine()]);
      }catch(e){ toast("#sell-msg", e.message, false); }
    };

    // -------- ui wiring
    document.querySelectorAll(".tabs .btn").forEach(b=>{
      b.onclick = ()=>{
        const t = b.getAttribute("data-tab");
        showTab(t);
        if(t==="sales"){ loadLive(); loadMine(); }
        if(t==="inv"){ loadInventory(); }
        if(t==="craft"){ loadRecipes(); }
      };
    });
    $("#recipe-filter").addEventListener("input", paintRecipeList);
    $("#btn-recipe-refresh").onclick = async ()=>{ await loadRecipes(); paintRecipeList(); };

    // auth buttons
    $("#btn-register").onclick = async ()=>{
      try{
        const email = $("#r-email").value.trim(), password=$("#r-pass").value;
        const r = await api("/api/register",{method:"POST",body:JSON.stringify({email,password})});
        $("#r-msg").textContent = r.message || "Registered.";
      }catch(e){ $("#r-msg").textContent = e.message; }
    };
    $("#btn-login").onclick = async ()=>{
      try{
        const email = $("#l-email").value.trim(), password=$("#l-pass").value;
        await api("/api/login",{method:"POST",body:JSON.stringify({email,password})});
        $("#l-msg").textContent = "";
        await loadMe();
      }catch(e){ $("#l-msg").textContent = e.message; }
    };
    $("#btn-logout").onclick = async ()=>{ try{ await api("/api/logout"); }catch{} loadMe(); };

    // init
    loadMe();
  </script>
</body>
</html>
