<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ARTEFACT • Store • Auctions • Recipes • Inventory</title>
  <link rel="stylesheet" href="/app.css" />
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --line:#1f2937; --text:#e2e8f0; --muted:#94a3b8;
      --accent:#2dd4bf; --accent2:#334155;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--card);border-bottom:1px solid var(--line)}
    .brand{font-weight:800;letter-spacing:.3px}
    .container{max-width:1100px;margin:16px auto;padding:0 12px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#0b1220;color:var(--text);cursor:pointer}
    .tab.active{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent) inset}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;margin:16px 0}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--line);padding:8px 10px;text-align:left}
    .table th{color:var(--muted);font-weight:600}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .input{background:#0b1220;border:1px solid #233047;border-radius:8px;color:var(--text);padding:6px 8px}
    .btn{background:#0b1220;border:1px solid var(--accent2);border-radius:10px;color:var(--text);padding:6px 10px;cursor:pointer}
    .btn:hover{border-color:var(--accent)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#1f2937;color:#93c5fd;font-size:12px;margin-left:6px}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{padding:2px 8px;background:#1f2937;border:1px solid #233047;border-radius:999px;font-size:12px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="header">
    <div class="brand">ARTEFACT</div>
    <div class="row">
      <input id="user" class="input" placeholder="Player ID (e.g. overhuman)" />
      <button class="btn" onclick="saveUser()">Save</button>
    </div>
  </div>

  <div class="container">
    <div class="tabs">
      <button class="tab active" data-tab="store" onclick="show('store')">Store</button>
      <button class="tab" data-tab="auctions" onclick="show('auctions')">Auctions</button>
      <button class="tab" data-tab="recipes" onclick="show('recipes')">Recipes</button>
      <button class="tab" data-tab="inventory" onclick="show('inventory')">Inventory</button>
    </div>

    <section id="store" class="card"></section>
    <section id="auctions" class="card" style="display:none"></section>
    <section id="recipes" class="card" style="display:none"></section>
    <section id="inventory" class="card" style="display:none"></section>
  </div>

  <script>
  const $ = (q)=>document.querySelector(q);

  // Basic identity persisted in localStorage
  function currentUser(){ return localStorage.getItem('user') || ''; }
  function saveUser(){
    const v = $('#user').value.trim();
    localStorage.setItem('user', v);
    loadInventory();
    alert('User set: '+v);
  }

  // Tabs
  function show(id){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelector(`.tab[data-tab="${id}"]`).classList.add('active');
    document.querySelectorAll('section.card').forEach(s=>s.style.display='none');
    $('#'+id).style.display='block';

    if(id==='store') loadStore();
    if(id==='auctions') loadAuctions();      // defined in Part 2
    if(id==='recipes') loadRecipes();        // defined in Part 2
    if(id==='inventory') loadInventory();    // defined in Part 2
  }

  // -------- Store --------
  async function loadStore(){
    const res = await fetch('/api/store'); const data = await res.json();
    $('#store').innerHTML = `
      <h2>Store <span class="pill">${data.length} items</span></h2>
      <table class="table">
        <thead><tr><th>Name</th><th>Tier</th><th>Price</th><th>Stock</th><th>Buy</th></tr></thead>
        <tbody>
          ${data.map(r=>`<tr>
            <td>${r.name}</td><td>T${r.tier}</td><td>${r.price}</td><td>${r.stock}</td>
            <td class="row">
              <input type="number" class="input" min="1" max="${r.stock}" value="1" id="buyqty_${r.id}" />
              <button class="btn" onclick="buy(${r.id})">Buy</button>
            </td>
          </tr>`).join('')}
        </tbody>
      </table>`;
  }
  async function buy(id){
    const qty = parseInt($('#buyqty_'+id).value,10)||1;
    const buyer=currentUser(); if(!buyer) return alert('Enter Player ID at the top first!');
    const res=await fetch('/api/store/buy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({buyer,id,qty})});
    const out=await res.json(); if(!res.ok) return alert(out.error||'Error');
    alert(`Purchased x${qty} • ${out.item.name}`);
    loadStore();
    loadInventory(); // defined in Part 2
  }
  </script>
  <!-- Continue with index.html Part 2/2 (Auctions, Recipes, Inventory, init) -->
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ARTEFACT • Store • Auctions • Recipes • Inventory</title>
  <link rel="stylesheet" href="/app.css" />
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --line:#1f2937; --text:#e2e8f0; --muted:#94a3b8;
      --accent:#2dd4bf; --accent2:#334155;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--card);border-bottom:1px solid var(--line)}
    .brand{font-weight:800;letter-spacing:.3px}
    .container{max-width:1100px;margin:16px auto;padding:0 12px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#0b1220;color:var(--text);cursor:pointer}
    .tab.active{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent) inset}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;margin:16px 0}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--line);padding:8px 10px;text-align:left}
    .table th{color:var(--muted);font-weight:600}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .input{background:#0b1220;border:1px solid #233047;border-radius:8px;color:var(--text);padding:6px 8px}
    .btn{background:#0b1220;border:1px solid var(--accent2);border-radius:10px;color:var(--text);padding:6px 10px;cursor:pointer}
    .btn:hover{border-color:var(--accent)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#1f2937;color:#93c5fd;font-size:12px;margin-left:6px}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{padding:2px 8px;background:#1f2937;border:1px solid #233047;border-radius:999px;font-size:12px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="header">
    <div class="brand">ARTEFACT</div>
    <div class="row">
      <input id="user" class="input" placeholder="Player ID (e.g. overhuman)" />
      <button class="btn" onclick="saveUser()">Save</button>
    </div>
  </div>

  <div class="container">
    <div class="tabs">
      <button class="tab active" data-tab="store" onclick="show('store')">Store</button>
      <button class="tab" data-tab="auctions" onclick="show('auctions')">Auctions</button>
      <button class="tab" data-tab="recipes" onclick="show('recipes')">Recipes</button>
      <button class="tab" data-tab="inventory" onclick="show('inventory')">Inventory</button>
    </div>

    <section id="store" class="card"></section>
    <section id="auctions" class="card" style="display:none"></section>
    <section id="recipes" class="card" style="display:none"></section>
    <section id="inventory" class="card" style="display:none"></section>
  </div>

<script>
const $ = (q)=>document.querySelector(q);
function currentUser(){ return localStorage.getItem('user') || ''; }
function saveUser(){ const v=$('#user').value.trim(); localStorage.setItem('user', v); loadInventory(); alert('User set: '+v); }
function show(id){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${id}"]`).classList.add('active');
  document.querySelectorAll('section.card').forEach(s=>s.style.display='none');
  $('#'+id).style.display='block';
  if(id==='store') loadStore();
  if(id==='auctions') loadAuctions();
  if(id==='recipes') loadRecipes();
  if(id==='inventory') loadInventory();
}

// -------- Store --------
async function loadStore(){
  const res = await fetch('/api/store'); const data = await res.json();
  $('#store').innerHTML = `
    <h2>Store <span class="pill">${data.length} items</span></h2>
    <table class="table">
      <thead><tr><th>Name</th><th>Tier</th><th>Price</th><th>Stock</th><th>Buy</th></tr></thead>
      <tbody>
        ${data.map(r=>`<tr>
          <td>${r.name}</td><td>T${r.tier}</td><td>${r.price}</td><td>${r.stock}</td>
          <td class="row">
            <input type="number" class="input" min="1" max="${r.stock}" value="1" id="buyqty_${r.id}" />
            <button class="btn" onclick="buy(${r.id})">Buy</button>
          </td>
        </tr>`).join('')}
      </tbody>
    </table>`;
}
async function buy(id){
  const qty = parseInt($('#buyqty_'+id).value,10)||1;
  const buyer=currentUser(); if(!buyer) return alert('Enter Player ID at the top first!');
  const res=await fetch('/api/store/buy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({buyer,id,qty})});
  const out=await res.json(); if(!res.ok) return alert(out.error||'Error');
  alert(`Purchased x${qty} • ${out.item.name}`); loadStore(); loadInventory();
}

// -------- Auctions --------
async function loadAuctions(){
  const res = await fetch('/api/auctions'); const list = await res.json();
  $('#auctions').innerHTML = `
    <h2>Auctions <span class="pill">${list.length} active</span></h2>

    <div class="row" style="margin-bottom:10px">
      <input id="a_item" class="input" placeholder="Exact item name" />
      <input id="a_tier" class="input" type="number" min="2" max="5" placeholder="Tier (2-5)" />
      <input id="a_qty"  class="input" type="number" min="1" value="1" />
      <input id="a_price" class="input" type="number" min="1" placeholder="Start price" />
      <input id="a_buy" class="input" type="number" min="0" placeholder="Buy-now (optional)" />
    </div>
    <div class="row" style="margin-bottom:16px">
      <button class="btn" onclick="createAuction()">Create Auction</button>
    </div>

    <table class="table">
      <thead><tr><th>Item</th><th>Tier</th><th>Qty</th><th>Start</th><th>Buy-now</th><th>Highest</th><th>Actions</th></tr></thead>
      <tbody>
        ${list.map(a=>`<tr>
          <td>${a.item_name}</td><td>T${a.tier}</td><td>${a.qty}</td>
          <td>${a.start_price}</td><td>${a.buyout_price??'—'}</td><td>${a.highest_bid}</td>
          <td class="row">
            <input id="bid_${a.id}" class="input" type="number" min="${Math.max(a.start_price,a.highest_bid+1)}" placeholder="Bid" />
            <button class="btn" onclick="bid(${a.id})">Bid</button>
            ${a.buyout_price?`<button class="btn" onclick="buyout(${a.id})">Buy now</button>`:''}
            <button class="btn" onclick="cancelAuction(${a.id})">Cancel</button>
          </td>
        </tr>`).join('')}
      </tbody>
    </table>`;
}
async function createAuction(){
  const seller=currentUser(); if(!seller) return alert('Enter Player ID at the top first!');
  const payload={
    seller,
    item_name:$('#a_item').value.trim(),
    tier:parseInt($('#a_tier').value,10),
    qty:parseInt($('#a_qty').value,10),
    start_price:parseInt($('#a_price').value,10),
    buyout_price:$('#a_buy').value?parseInt($('#a_buy').value,10):null
  };
  const res=await fetch('/api/auctions/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  const out=await res.json(); if(!res.ok) return alert(out.error||'Error');
  alert('Auction created. Listing fee (1%): '+out.fee); loadAuctions(); loadInventory();
}
async function bid(id){
  const bidder=currentUser(); if(!bidder) return alert('Enter Player ID at the top first!');
  const amount=parseInt($('#bid_'+id).value,10); if(!amount) return alert('Enter a bid amount');
  const res=await fetch('/api/auctions/bid',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({auction_id:id,bidder,amount})});
  const out=await res.json(); if(!res.ok) return alert(out.error||'Error');
  alert('Highest bid is now: '+out.highest); loadAuctions();
}
async function buyout(id){
  const buyer=currentUser(); if(!buyer) return alert('Enter Player ID at the top first!');
  const res=await fetch('/api/auctions/buyout',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({auction_id:id,buyer})});
  const out=await res.json(); if(!res.ok) return alert(out.error||'Error');
  alert('Buy-now successful.'); loadAuctions(); loadInventory();
}
async function cancelAuction(id){
  const seller=currentUser(); if(!seller) return alert('Enter Player ID at the top first!');
  const res=await fetch('/api/auctions/cancel',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({auction_id:id,seller})});
  const out=await res.json(); if(!res.ok) return alert(out.error||'Error');
  alert('Auction canceled (listing fee is not refunded).'); loadAuctions(); loadInventory();
}

// -------- Recipes (two action rows at top for “buttons in 2 rows”) --------
async function loadRecipes(){
  const res = await fetch('/api/recipes'); const data = await res.json();
  const chips = (list)=>`<div class="chips">${list.map(x=>`<span class="chip">${x}</span>`).join('')}</div>`;
  const section=(title,rows)=>`<div class="card"><h3>${title} <span class="pill">${rows.length}</span></h3>
    <table class="table"><thead><tr><th>Name</th><th>#</th><th>Composition</th></tr></thead>
    <tbody>${rows.map(r=>`<tr><td>${r.name||r}</td><td>${r.parts? r.parts.length : '—'}</td><td>${r.parts?chips(r.parts):''}</td></tr>`).join('')}</tbody>
  </table></div>`;

  // two rows of quick buttons like before
  const actions1 = `
    <div class="row" style="margin-bottom:6px">
      <button class="btn" onclick="copyTier('t2')">Copy T2 names</button>
      <button class="btn" onclick="copyTier('t3')">Copy T3 names</button>
      <button class="btn" onclick="copyTier('t4')">Copy T4 names</button>
      <button class="btn" onclick="copyTier('t5')">Copy T5 names</button>
    </div>`;
  const actions2 = `
    <div class="row" style="margin-bottom:12px">
      <button class="btn" onclick="exportRecipes()">Export JSON</button>
      <button class="btn" onclick="loadRecipes()">Refresh</button>
    </div>`;

  $('#recipes').innerHTML = actions1 + actions2 + [
    section('Materials', data.materials.map(m=>({name:m,parts:null}))),
    section('Tier 2', data.t2),
    section('Tier 3', data.t3),
    section('Tier 4', data.t4),
    section('Tier 5', data.t5),
    `<div class="card"><h3>Tier 6 — Artefact</h3><p>Requires <b>10 distinct T5</b> (1x each).</p></div>`
  ].join('');
  window.__recipes_cache = data;
}
function copyTier(t){
  const data = window.__recipes_cache || {};
  const list = (data[t]||[]).map(x=>x.name).join(", ");
  navigator.clipboard.writeText(list).then(()=> alert(`Copied ${t.toUpperCase()} names`));
}
function exportRecipes(){
  const data = window.__recipes_cache || {};
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'recipes.json'; a.click();
  URL.revokeObjectURL(url);
}

// -------- Inventory --------
async function loadInventory(){
  const u=currentUser(); $('#user').value=u;
  if(!u){ $('#inventory').innerHTML='<p class="muted">Enter Player ID above.</p>'; return; }
  const res = await fetch('/api/inventory/'+encodeURIComponent(u)); const data = await res.json();
  $('#inventory').innerHTML = `
    <h2>Inventory: ${u}</h2>
    <table class="table"><thead><tr><th>Name</th><th>Tier</th><th>Qty</th></tr></thead>
    <tbody>${data.map(r=>`<tr><td>${r.name}</td><td>T${r.tier}</td><td>${r.qty}</td></tr>`).join('')}</tbody></table>`;
}

// init
loadStore();
</script>
</body>
</html>
