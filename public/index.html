<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ARTEFACT</title>
  <link rel="stylesheet" href="/app.css" />
  <style>
    .hidden{display:none}
    .badge{border:1px solid var(--line);padding:4px 8px;border-radius:999px;background:#071021;font-size:12px}
    .itemrow{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid #13223a}
    .itemrow:last-child{border-bottom:0}
    .list{max-height:360px;overflow:auto;border:1px solid var(--line);border-radius:10px}
    .chip{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#0d1b2a;cursor:pointer}
    .chip.active{background:#0e3a2f}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .toast{position:fixed;bottom:16px;right:16px;background:#0d1b2a;border:1px solid #233047;border-radius:8px;padding:10px 12px}
    .btn{cursor:pointer}
    .btn.muted{opacity:.9}
    .btn.secondary{background:#0d2a3a}
    .btn.danger{background:#3a0d14}
    .input{background:#0b1220;border:1px solid #233047;border-radius:8px;padding:8px 10px;color:#e5e7eb}
    .card{background:#0b1220;border:1px solid #233047;border-radius:12px;padding:12px;margin-top:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .tabbar{margin:6px 0 4px}
    .header{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid #233047}
    .brand{font-weight:700}
    .container{max-width:980px;margin:0 auto;padding:12px}
    .label{font-weight:600}
    .muted{opacity:.8}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
    img.icon{width:28px;height:28px;object-fit:contain;border-radius:6px;display:block}
  </style>
</head>
<body>

  <!-- Header (login info, balance, logout) -->
  <header class="header">
    <div class="brand">ARTEFACT</div>
    <div class="row">
      <span id="who" class="badge">–</span>
      <span id="balance" class="badge">0g 0s</span>
      <button id="btn-logout" class="btn muted hidden">Log out</button>
    </div>
  </header>

  <!-- Glavni sadržaj -->
  <main class="container">

    <!-- Auth (Register + Login) -->
    <section id="auth" class="card">
      <div class="label">Login / Register</div>
      <div class="grid">
        <div class="card">
          <div class="label">Register</div>
          <input id="reg-email" class="input" placeholder="email@example.com" />
          <input id="reg-pass" class="input" type="password" placeholder="password (min 6)" style="margin-top:8px"/>
          <button id="btn-register" class="btn" style="margin-top:8px">Register</button>
          <div id="reg-msg" class="muted" style="margin-top:6px"></div>
        </div>
        <div class="card">
          <div class="label">Login</div>
          <input id="log-email" class="input" placeholder="email@example.com" />
          <input id="log-pass" class="input" type="password" placeholder="password" style="margin-top:8px"/>
          <button id="btn-login" class="btn secondary" style="margin-top:8px">Log in</button>
          <div id="log-msg" class="muted" style="margin-top:6px"></div>
        </div>
      </div>
    </section>

    <!-- App (Shop, Crafting, Market, Inventory) -->
    <section id="app" class="hidden">
      <div class="tabbar row">
        <div class="chip active" data-tab="shop">Shop</div>
        <div class="chip" data-tab="craft">Crafting</div>
        <div class="chip" data-tab="market">Market</div>
        <div class="chip" data-tab="inv">Inventory</div>
      </div>

      <!-- SHOP -->
      <div id="tab-shop" class="card">
        <div class="row" style="justify-content:space-between">
          <div class="label">Buy T1 (100s)</div>
          <span id="buysToNext" class="muted">Buys to next recipe: —</span>
        </div>
        <div class="row">
          <button id="btn-buy-t1" class="btn">Buy</button>
          <div id="shop-msg" class="muted"></div>
        </div>
      </div>

      <!-- Crafting -->
      <div id="tab-craft" class="card hidden">
        <div class="row">
          <div class="label">Crafting</div>
          <button id="btn-artefact" class="btn right">
            <img src="/atefakt.png" alt="" style="width:20px;height:20px;object-fit:contain;vertical-align:-3px;margin-right:8px;border-radius:4px"
                 onerror="this.onerror=null;this.style.display='none'">
            Craft ARTEFACT (10× distinct T5)
          </button>
        </div>
        <div style="margin-top:8px">
          Bonus gold: <span id="artefact-bonus">0</span>
        </div>
        <div id="artefact-msg" class="muted" style="margin-top:4px"></div>

        <div class="grid">
          <div class="card">
            <div class="row" style="justify-content:space-between">
              <div class="label">Recipes you own</div>
              <div class="row">
                <input id="filter-recipe" class="input" placeholder="filter by name..." style="width:220px"/>
                <button id="btn-refresh-rec" class="btn muted">Refresh</button>
              </div>
            </div>
            <div id="recipes" class="list">Loading…</div>
          </div>

          <div class="card">
            <div class="label">Details</div>
            <div id="rec-details" class="list">Select a recipe on the left.</div>
          </div>
        </div>
      </div>

      <!-- Market -->
      <div id="tab-market" class="card hidden">
        <div class="label">Marketplace</div>
        <div class="grid">
          <div class="card">
            <div class="label">Create Sale</div>
            <input id="inv-search" class="input" placeholder="Search your inventory..." />
            <div id="inv-list" class="list" style="margin-top:8px;max-height:300px">Loading…</div>
            <div class="row" style="margin-top:8px">
              <input id="price-g" class="input" style="width:100px" placeholder="Gold"/>
              <input id="price-s" class="input" style="width:120px" placeholder="Silver (0–99)"/>
              <input id="price-qty" class="input" style="width:100px" placeholder="Qty"/>
              <button id="btn-list" class="btn">List for sale</button>
            </div>
            <div id="list-msg" class="muted" style="margin-top:6px"></div>
          </div>

          <div class="card">
            <div class="row" style="justify-content:space-between">
              <div class="label">Marketplace</div>
              <input id="market-q" class="input" placeholder="Search by name..." style="width:220px" />
            </div>
            <div id="market" class="list">Loading…</div>

            <div class="row" style="justify-content:space-between;margin-top:12px">
              <div class="label">My listings</div>
              <button id="btn-mine" class="btn muted">Reload</button>
            </div>
            <div id="mine" class="list">Loading…</div>
          </div>
        </div>
      </div>

      <!-- Inventory -->
      <div id="tab-inv" class="card hidden">
        <div class="label">Inventory</div>
        <div id="inv-full" class="list">Loading…</div>
      </div>
    </section>
  </main>

  <!-- Toast + helpers ($,$$,api) -->
  <div id="toast" class="toast hidden"></div>
  <script>
    const $  = (s,root=document)=>root.querySelector(s);
    const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
    function toast(t){ const box=$("#toast"); box.textContent=t; box.classList.remove("hidden"); setTimeout(()=>box.classList.add("hidden"),1800); }
    async function api(p,opts={}){
      const r = await fetch(p,{credentials:"include",headers:{"Content-Type":"application/json"},...opts});
      let data=null; try{data=await r.json()}catch{}
      if(!r.ok) throw new Error((data&&data.error)||("HTTP "+r.status));
      return data;
    }
  </script>

  <!-- Icon utils -->
  <script>
    const RECIPE_ICON = "/recipe.png";
    const FALLBACK_ITEM_ICON = "/t1_bronze.png";
    const esc = s => String(s)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
    function fileNameFromCodeTier(code, tier){
      if(!code) return null;
      const m = String(code).match(/^T([1-6])_(.*)$/);
      if (m) return `t${m[1]}_${m[2].toLowerCase()}.png`;
      if ((tier|0)===1) return `t1_${String(code).toLowerCase()}.png`;
      return null;
    }
    function iconForByCode(code, tier){
      const file = fileNameFromCodeTier(code, tier);
      return file ? `/${file}` : FALLBACK_ITEM_ICON;
    }
  </script>

  <!-- Global state + Tabs -->
  <script>
    let WHO=null;
    let SEL_INV=null;
    let INVENTORY_CACHE={items:[],recipes:[]};
    window.CURRENT_RECIPE_ID=null;

    function setTab(tab){
      $$(".chip").forEach(c=>c.classList.toggle("active", c.dataset.tab===tab));
      $("#tab-shop").classList.toggle("hidden", tab!=="shop");
      $("#tab-craft").classList.toggle("hidden", tab!=="craft");
      $("#tab-market").classList.toggle("hidden", tab!=="market");
      $("#tab-inv").classList.toggle("hidden", tab!=="inv");
    }
    $$(".chip").forEach(c=>c.addEventListener("click",()=>setTab(c.dataset.tab)));
  </script>

  <!-- AUTH (Frontend): loadMe, register, login, logout -->
  <script>
    function renderBalance(){
      const v = WHO?.balance_silver || 0;
      const g = Math.floor(v/100), s = v%100;
      $("#balance") && ($("#balance").textContent = `${g}g ${s}s`);
    }
    function setLoggedInUI(){
      $("#auth")?.classList.add("hidden");
      $("#app")?.classList.remove("hidden");
      $("#btn-logout")?.classList.remove("hidden");
      $("#who") && ($("#who").textContent = WHO?.email || "—");
      renderBalance();
    }
    function setLoggedOutUI(){
      WHO = null;
      $("#auth")?.classList.remove("hidden");
      $("#app")?.classList.add("hidden");
      $("#btn-logout")?.classList.add("hidden");
      $("#who") && ($("#who").textContent = "Not logged in");
      $("#balance") && ($("#balance").textContent = "0g 0s");
    }

    async function loadMe(){
      try{
        const r = await api("/api/me");
        WHO = r.user || null;
        setLoggedInUI();

        const b = $("#buysToNext");
        if (b) {
          b.textContent = (typeof WHO?.buys_to_next === "number")
            ? `Buys to next recipe: ${WHO.buys_to_next}`
            : "Buys to next recipe: —";
        }

        if (typeof loadInventoryPanel === "function") await loadInventoryPanel();
        if (typeof loadRecipes        === "function")        loadRecipes();
        if (typeof loadMarket         === "function")         loadMarket();
        if (typeof loadMine           === "function")           loadMine();
        if (typeof loadInventoryFull  === "function")  loadInventoryFull();

        if (typeof setTab === "function") setTab("shop");
      }catch{
        setLoggedOutUI();
      }
    }

    async function doRegister(){
      const msg = $("#reg-msg");
      try{
        const email = $("#reg-email")?.value.trim();
        const pass  = $("#reg-pass")?.value || "";
        if (!email || !pass) throw new Error("Enter email & password.");
        if (pass.length < 6) throw new Error("Password too short (min 6).");
        msg && (msg.textContent = "…");
        await api("/api/register", { method:"POST", body: JSON.stringify({ email, password: pass }) });
        msg && (msg.textContent = "OK — now log in.");
      }catch(e){
        msg && (msg.textContent = e.message || "Register failed.");
      }
    }
    async function doLogin(){
      const msg = $("#log-msg");
      try{
        const email = $("#log-email")?.value.trim();
        const pass  = $("#log-pass")?.value || "";
        if (!email || !pass) throw new Error("Enter email & password.");
        msg && (msg.textContent = "…");
        await api("/api/login", { method:"POST", body: JSON.stringify({ email, password: pass }) });
        msg && (msg.textContent = "OK");
        await loadMe();
      }catch(e){
        msg && (msg.textContent = e.message || "Login failed.");
      }
    }
    async function doLogout(){
      try { await api("/api/logout"); } catch {}
      setLoggedOutUI();
    }

    document.addEventListener("DOMContentLoaded", () => {
      $("#btn-register")?.addEventListener("click", doRegister);
      $("#btn-login")?.addEventListener("click", doLogin);
      $("#btn-logout")?.addEventListener("click", doLogout);

      $("#reg-email")?.addEventListener("keydown", e=>{ if(e.key==="Enter") doRegister(); });
      $("#reg-pass") ?.addEventListener("keydown", e=>{ if(e.key==="Enter") doRegister(); });
      $("#log-email")?.addEventListener("keydown", e=>{ if(e.key==="Enter") doLogin(); });
      $("#log-pass") ?.addEventListener("keydown", e=>{ if(e.key==="Enter") doLogin(); });

      loadMe();
    });
  </script>

  <!-- SHOP (Buy T1) -->
  <script>
    function renderShopGotItem(obj){
      const msg = $("#shop-msg");
      if(!msg) return;
      const icon = iconForByCode(obj.code, obj.tier);
      msg.innerHTML = `
        <div class="row" style="gap:10px;align-items:center">
          <img class="icon" src="${esc(icon)}" alt="" onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
          <div>Got item: ${esc(obj.name)} <span class="badge">T${obj.tier}</span></div>
        </div>`;
    }

    $("#btn-buy-t1").addEventListener("click", async ()=>{
      try{
        const r = await api("/api/shop/buy-t1",{method:"POST",body:JSON.stringify({})});
        WHO.balance_silver = r.balance_silver;
        renderBalance();
        if (r.gotRecipe){
          $("#shop-msg").textContent = `Got recipe: ${r.gotRecipe.name} (T${r.gotRecipe.tier})`;
        } else if (r.gotItem){
          renderShopGotItem(r.gotItem);
        } else {
          $("#shop-msg").textContent = "OK";
        }
        await loadMe();
        await loadInventoryPanel();
        loadRecipes();
        loadInventoryFull();
      }catch(e){ alert(e.message); }
    });
  </script>

  <!-- Crafting (lista + detalji) -->
  <script>
    function rowRecipe(r){
      return `
        <div class="itemrow">
          <div class="row" style="gap:10px;align-items:center">
            <img class="icon" src="${RECIPE_ICON}" alt="" onerror="this.onerror=null;this.src='${RECIPE_ICON}'">
            <div>
              <div class="label" style="text-transform:none;color:var(--text)">${esc(r.name)}</div>
              <div class="muted">T${r.tier} · x${r.qty}</div>
            </div>
          </div>
          <button class="btn muted" data-open="${esc(r.id)}">Open</button>
        </div>`;
    }

    async function loadRecipes(){
      const box=$("#recipes"); box.textContent="Loading…";
      try{
        const list = await api("/api/recipes/list");
        const q = $("#filter-recipe").value.trim().toLowerCase();
        const rows = (list.recipes||[]).filter(x=>!q||x.name.toLowerCase().includes(q));
        if (!rows.length){ box.textContent="No recipes."; return; }
        box.innerHTML = rows.map(rowRecipe).join("");
        box.querySelectorAll("[data-open]").forEach(btn=>{
          btn.addEventListener("click",()=>openRecipe(btn.getAttribute("data-open")));
        });
      }catch(e){ box.textContent=e.message; }
    }

    function renderIngredients(details){
      const parts = (details.ingredients||[]).map(ing=>{
        const ok = ing.have >= ing.qty;
        const src = iconForByCode(ing.code, ing.tier);
        return `
          <div class="itemrow">
            <div class="row" style="gap:10px;align-items:center">
              <img class="icon" src="${esc(src)}" alt="" onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
              <div>${esc(ing.name)} <span class="badge">T${ing.tier}</span></div>
            </div>
            <div class="${ok?'':'muted'}">${ing.have}/${ing.qty}</div>
          </div>`;
      }).join("");

      return `
        <div class="itemrow"><div><b>${esc(details.recipe.name)}</b> <span class="badge">T${details.recipe.tier}</span></div></div>
        <div class="itemrow"><div class="muted">Ingredients</div></div>
        ${parts}
        <div class="itemrow">
          <button id="btn-craft" class="btn">Craft</button>
          <span class="muted">10% fail → Scrap (server checks ingredients)</span>
        </div>`;
    }

    async function openRecipe(recipeId){
      const box=$("#rec-details"); box.textContent="Loading…";
      try{
        const details = await api(`/api/recipes/ingredients/${recipeId}`);
        box.innerHTML = renderIngredients(details);
        window.CURRENT_RECIPE_ID = details.recipe.id;

        $("#btn-craft").addEventListener("click", async ()=>{
          try{
            const r2 = await api("/api/craft/do",{method:"POST",body:JSON.stringify({recipe_id: details.recipe.id})});
            if (r2.crafted) {
              toast(`Crafted: ${r2.crafted.name} (T${r2.crafted.tier})`);
            } else if (r2.scrap) {
              toast("Failed (got Scrap)");
            } else {
              toast("Done");
            }
            await loadInventoryPanel();
            await loadRecipes();
            await loadInventoryFull();
            await openRecipe(details.recipe.id);
          }catch(e){
            alert(e.message);
          }
        });
      }catch(e){
        box.textContent=e.message;
      }
    }

    async function refreshArtefactBonus(){
      try{
        const r = await api("/api/items/artefact/bonus");
        const bonus = (typeof r?.bonus_gold === "number") ? r.bonus_gold : (parseInt(r?.bonus_gold,10) || 0);
        const el = document.querySelector("#artefact-bonus");
        if (el) el.textContent = bonus;
      }catch(e){
        console.warn("refreshArtefactBonus failed:", e);
      }
    }
    (() => {
      const craft = document.querySelector("#tab-craft");
      if (!craft) return;
      const obs = new MutationObserver(() => {
        if (!craft.classList.contains("hidden")) refreshArtefactBonus();
      });
      obs.observe(craft, { attributes:true });
    })();

    $("#btn-artefact").addEventListener("click", async ()=>{
      try{
        const r = await api("/api/craft/artefact",{method:"POST",body:JSON.stringify({})});
        const name  = r.crafted || "Artefact";
        const bonus = (typeof r?.bonus_gold === "number") ? r.bonus_gold : (parseInt(r?.bonus_gold,10) || 0);
        $("#artefact-bonus").textContent = bonus;
        $("#artefact-msg").textContent = `Crafted: ${name} (+${bonus} gold)`;
        await loadInventoryPanel();
        await loadInventoryFull();
        await loadRecipes();
      }catch(e){
        $("#artefact-msg").textContent = e?.message || "Crafting failed.";
      }
    });
  </script>

  <!-- Market -->
  <script>
    async function loadInventoryPanel(){
      const box=$("#inv-list"); if(!box) return;
      box.textContent="Loading…";
      try{
        const r = await api("/api/inventory");
        INVENTORY_CACHE = r;
        const q = $("#inv-search").value?.trim().toLowerCase() || "";
        const items = (r.items||[]).filter(x=>!q||x.name.toLowerCase().includes(q));
        const recipes = (r.recipes||[]).filter(x=>!q||x.name.toLowerCase().includes(q));
        box.innerHTML="";
        const add = (arr,kind)=>{
          for(const it of arr){
            const icon = (kind==="item") ? iconForByCode(it.code, it.tier) : RECIPE_ICON;
            const row=document.createElement("div"); row.className="itemrow";
            row.innerHTML=`
              <div class="row" style="gap:10px;align-items:center">
                <img class="icon" src="${esc(icon)}" alt="" onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
                <div>${it.name} <span class="badge">T${it.tier}</span> <span class="muted">x${it.qty}</span></div>
              </div>
              <button class="btn muted">Pick</button>`;
            row.querySelector("button").addEventListener("click", ()=>{
              SEL_INV = { kind, id: it.id, name: it.name };
              $("#list-msg").textContent = "Selected: "+it.name;
            });
            box.appendChild(row);
          }
        };
        add(items,"item");
        add(recipes,"recipe");
        if (!box.children.length) box.textContent="Empty.";
      }catch(e){
        box.textContent=e.message;
      }
    }
    $("#inv-search")?.addEventListener("input", loadInventoryPanel);

    async function loadMarket(){
      const box=$("#market"); if(!box) return;
      box.textContent="Loading…";
      try{
        const q=$("#market-q").value?.trim() || "";
        const url = "/api/sales/live" + (q?("?q="+encodeURIComponent(q)):"");
        const r = await api(url);
        const rows = r.listings || [];
        if(!rows.length){ box.textContent="No listings."; return; }
        box.innerHTML="";
        for(const s of rows){
          const g=Math.floor((s.price_s||0)/100), ss=(s.price_s||0)%100;
          const icon = (s.kind==="item") ? iconForByCode(s.code, s.tier) : RECIPE_ICON;
          const row=document.createElement("div"); row.className="itemrow";
          row.innerHTML=`
            <div class="row" style="gap:10px;align-items:center">
              <img class="icon" src="${esc(icon)}" alt="" onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
              <div>${s.name|| (s.kind==="item" ? \`Item #\${s.item_id||"-"}\` : \`Recipe #\${s.recipe_id||"-"}\`)}
                  <span class="badge">T${s.tier||"-"}</span>
                  <span class="muted">x${s.qty}</span></div>
            </div>
            <div class="row">
              <span class="badge">${g}g ${ss}s</span>
              <button class="btn">Buy</button>
            </div>`;
          row.querySelector("button").addEventListener("click", async ()=>{
            try{
              await api("/api/sales/buy",{method:"POST",body:JSON.stringify({id:s.id})});
              toast("Purchased.");
              loadMarket(); loadMine(); loadInventoryPanel(); loadInventoryFull(); loadMe();
            }catch(e){ alert(e.message); }
          });
          box.appendChild(row);
        }
      }catch(e){
        box.textContent=e.message;
      }
    }
    $("#market-q")?.addEventListener("input", loadMarket);

    async function loadMine(){
      const box=$("#mine"); if(!box) return;
      box.textContent="Loading…";
      try{
        const r = await api("/api/sales/mine");
        const rows = r.listings || [];
        if(!rows.length){ box.textContent="No listings."; return; }
        box.innerHTML="";
        for(const s of rows){
          const g=Math.floor((s.price_s||0)/100), ss=(s.price_s||0)%100;
          const icon = (s.kind==="item") ? iconForByCode(s.code, s.tier) : RECIPE_ICON;
          const row=document.createElement("div"); row.className="itemrow";
          row.innerHTML=`
            <div class="row" style="gap:10px;align-items:center">
              <img class="icon" src="${esc(icon)}" alt="" onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
              <div>${s.name|| (s.kind==="item" ? \`Item #\${s.item_id||"-"}\` : \`Recipe #\${s.recipe_id||"-"}\`)}
                  <span class="badge">T${s.tier||"-"}</span>
                  <span class="muted">x${s.qty}</span>
                  <span class="badge">${s.status}</span></div>
            </div>
            <div class="row">
              <span class="badge">${g}g ${ss}s</span>
              ${s.status==='live'?'<button class="btn danger">Cancel</button>':''}
            </div>`;
          if (s.status==='live'){
            row.querySelector("button").addEventListener("click", async ()=>{
              try{
                await api("/api/sales/cancel",{method:"POST",body:JSON.stringify({id:s.id})});
                loadMarket(); loadMine(); loadInventoryPanel();
              }catch(e){ alert(e.message); }
            });
          }
          box.appendChild(row);
        }
      }catch(e){
        box.textContent=e.message;
      }
    }
    $("#btn-mine")?.addEventListener("click", loadMine);

    $("#btn-list").addEventListener("click", async ()=>{
      try{
        if(!SEL_INV){ alert("Pick an item/recipe first."); return; }
        const gold=parseInt($("#price-g").value||"0",10)||0;
        const silver=parseInt($("#price-s").value||"0",10)||0;
        const qty=parseInt($("#price-qty").value||"1",10)||1;
        const body = { kind: SEL_INV.kind, id: SEL_INV.id, qty, gold, silver };
        await api("/api/sales/list",{method:"POST",body:JSON.stringify(body)});
        $("#list-msg").textContent="Listed.";
        SEL_INV=null;
        loadMarket(); loadMine(); loadInventoryPanel();
      }catch(e){
        alert(e.message);
      }
    });
  </script>

  <!-- Inventory (full list) -->
  <script>
    async function loadInventoryFull(){
      const box=$("#inv-full"); if(!box) return;
      box.textContent="Loading…";
      try{
        const r = await api("/api/inventory");
        const lines=[];
        for(const it of (r.items||[])){
          const icon = iconForByCode(it.code, it.tier);
          lines.push(`
            <div class="itemrow">
              <div class="row" style="gap:10px;align-items:center">
                <img class="icon" src="${esc(icon)}" alt="" onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
                <div>${it.name} <span class="badge">T${it.tier}</span></div>
              </div>
              <div class="muted">x${it.qty}</div>
            </div>`);
        }
        for(const rc of (r.recipes||[])){
          lines.push(`
            <div class="itemrow">
              <div class="row" style="gap:10px;align-items:center">
                <img class="icon" src="${RECIPE_ICON}" alt="" onerror="this.onerror=null;this.src='${RECIPE_ICON}'">
                <div>${rc.name} <span class="badge">T${rc.tier}</span></div>
              </div>
              <div class="muted">x${rc.qty}</div>
            </div>`);
        }
        box.innerHTML = lines.join("") || "Empty.";
      }catch(e){
        box.textContent=e.message;
      }
    }
  </script>
</body>
</html>
