<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ARTEFACT</title>

  <style>
    html,body {
      background:#000;
      color:#e5e7eb;
      margin:0;
    }
  </style>

<script>
(async function loadPayPalSDK(){
  try {
    const r = await fetch("/api/paypal/config", { credentials: "include" });
    const j = await r.json().catch(()=>null);

    if (!r.ok || !j?.ok || !j?.client_id) {
      console.warn("PayPal not configured:", j?.error || r.status);
      window.__PAYPAL_DISABLED__ = true;
      return;
    }

    const qs = new URLSearchParams({
      "client-id": j.client_id,
      "currency": j.currency || "USD",
      "intent": "capture",
      "components": "buttons"
    });

    const s = document.createElement("script");
    s.src = `https://www.paypal.com/sdk/js?${qs.toString()}`;
    s.async = true;
    s.onload = () => { window.__PAYPAL_READY__ = true; };
    document.head.appendChild(s);

    window.__PAYPAL_MIN_USD__ = j.min_usd || 1;

  } catch(e) {
    console.warn("PayPal SDK load failed:", e);
    window.__PAYPAL_DISABLED__ = true;
  }
})();
</script>

<link rel="stylesheet" href="/app.css" />
</head>

<body>

<div id="app">

<header class="header no-border" style="padding:14px 20px;">
  <div class="brand" style="font-size:22px; font-weight:700; letter-spacing:1px;">
    ARTEFACT
  </div>

  <div class="row" style="gap:12px; align-items:center;">

    <span id="balance" class="badge hidden"
          style="padding:6px 14px; font-size:16px;
                 background:rgba(255,255,255,0.08);
                 border:1px solid rgba(255,255,255,0.15);
                 backdrop-filter:blur(6px);">
      0g 0s
    </span>

    <span id="balance-dollar" class="badge hidden"
          style="padding:6px 14px; font-size:16px;
                 background:rgba(34,197,94,0.12);
                 border:1px solid rgba(34,197,94,0.25);
                 color:#4ade80;
                 backdrop-filter:blur(6px);">
      $0.00
    </span>

    <button id="btn-open-paypal"   class="btn secondary hidden">PayPal</button>
    <button id="btn-open-register" class="btn secondary">Register</button>
    <button id="btn-open-login"    class="btn">Log in</button>
    <button id="btn-logout"        class="btn muted hidden">Log out</button>

  </div>
</header>

<section id="paypal-panel" class="card hidden">
  <div class="row" style="align-items:center; gap:8px; flex-wrap:wrap">
    <label for="pp-amount" class="label" style="margin:0">Amount (USD)</label>
    <input id="pp-amount" class="input" type="number" min="1" step="1" value="1"
           placeholder="USD" style="width:120px">

    <label for="pp-bonus" class="label" style="margin:0">Bonus code</label>
    <input id="pp-bonus" class="input" type="text" maxlength="32"
           placeholder="optional" style="width:240px">
  </div>

  <div class="row" style="margin-top:10px">
    <div id="paypal-button-container"></div>
  </div>

  <div id="pp-msg" class="muted" style="margin-top:8px"></div>
</section>

<section id="auth" class="card hidden">
  <div id="card-register" class="auth-box hidden">
    <div class="label">Register</div>
    <input id="reg-email" class="input" type="email" placeholder="email@example.com">
    <input id="reg-pass" class="input" type="password" placeholder="password (min 6)">
    <button id="btn-register" class="btn">Register</button>
    <div id="reg-msg" class="muted"></div>
  </div>

  <div id="card-login" class="auth-box hidden">
    <div class="label">Log in</div>
    <input id="log-email" class="input" type="email" placeholder="email@example.com">
    <input id="log-pass" class="input" type="password" placeholder="password">
    <button id="btn-login" class="btn secondary">Log in</button>
    <div id="log-msg" class="muted"></div>
  </div>
</section>

<div class="tabbar row">
  <div class="chip active" data-tab="shop">Shop</div>
  <div class="chip" data-tab="quest">Quest</div>
  <div class="chip" data-tab="craft">Crafting</div>
  <div class="chip" data-tab="market">Market</div>
  <div class="chip" data-tab="inv">Inventory</div>
  <div class="chip" data-tab="bonus">Bonus</div>
  <div class="chip" data-tab="ads">Ads</div>
</div>

<div id="tab-shop" class="tab card">

  <div class="label" style="margin-bottom:12px;">Shop</div>

  <div class="card" style="padding:10px;margin-bottom:16px;">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="label">Buy T1</div>
      <span class="badge">Price: <span id="shop-price-inline">100</span>s</span>
    </div>

    <div class="muted" style="margin-top:6px;">
      Buys to next recipe: <span id="buysToNext">—</span>
    </div>

    <div class="row" style="margin-top:10px; gap:10px; align-items:center;">
      <input id="buy-t1-qty"
             type="number"
             class="input"
             placeholder="qty (1–99999)"
             min="1"
             max="99999"
             style="width:130px;" />
      <button id="btn-buy-t1" class="btn" style="padding-left:24px;padding-right:24px;">
        Buy
      </button>
    </div>

    <div id="shop-msg" class="muted" style="margin-top:8px"></div>
  </div>

  <div style="margin:6px 0;">
    <span id="shop-balance" class="badge hidden">0g 0s</span>
  </div>

  <div id="shop-intro" class="card" style="margin-top:12px">
    <div class="label" style="line-height:1.2;margin-bottom:6px">GAME</div>

    <p class="muted" style="max-width:820px">
      You collect materials, unlock recipes, and craft increasingly powerful items (T2 → T5).
      When you gather <b>10 different T5</b>, you can assemble an <b>ARTEFACT</b> that grants you a gold bonus.
    </p>

    <div class="grid" style="margin-top:12px;">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="label">1) Shop</div>
          <span class="badge">Price: <span id="shop-price-badge">100s</span></span>
        </div>

        <p class="muted">
          In the Shop, you buy <b>T1 materials</b>, and occasionally you also receive <b>recipes</b>.<br>
          Materials are ingredients for crafting, while recipes unlock higher tiers.
        </p>

        <img src="/t1_bronze.png" class="img-landing" />
        <img src="/recipe.png" class="img-landing" />
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <div class="label">2) Crafting</div>
    <p class="muted">
      With a recipe and the required materials, you can craft <b>T2 → T5</b>.
    </p>
    <img src="/t2_golden_ring.png" class="img-landing">
    <img src="/t3_gate_of_might.png" class="img-landing">
    <img src="/t4_engine_core.png" class="img-landing">
    <img src="/t5_ancient_relic.png" class="img-landing">
  </div>

  <div class="card" style="margin-top:16px;">
    <div class="label">3) Market</div>
    <p class="muted">Trade items with other players.</p>
  </div>

  <div class="card" style="margin-top:16px;">
    <div class="label">4) Artefact</div>
    <p class="muted">Craft 10 distinct T5 items to unlock.</p>
    <img src="/artefakt.png" class="img-landing">
  </div>

</div>

<!-- ===== QUEST TAB ===== -->
<div id="tab-quest" class="tab card hidden">

  <div class="label" style="margin-bottom:8px;">Daily Quests</div>
  <div id="quest-list-daily" class="column" style="gap:8px"></div>
  <div id="quest-msg-daily" class="muted" style="margin-top:12px"></div>

  <hr style="border:none;border-top:1px solid #233047;margin:20px 0;" />

  <div class="label" style="margin-bottom:8px;">Lifetime Quests</div>
  <div id="quest-list-lifetime" class="column" style="gap:8px"></div>
  <div id="quest-msg-lifetime" class="muted" style="margin-top:12px"></div>

</div>

<!-- ===== CRAFTING TAB ===== -->
<div id="tab-craft" class="tab card hidden">

  <div class="row">
    <div class="label">Crafting</div>
    <span id="craft-perk" class="badge muted" title="Crafting fail chance">10% fail</span>

    <button id="btn-artefact" class="btn right">
      <img src="/artefakt.png" alt="Artefact" class="img-cell"
           onerror="this.onerror=null;this.style.display='none'">
      Craft ARTEFACT (10× distinct T5)
    </button>
  </div>

  <div class="grid">

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="label">Recipes you own</div>
        <div class="row">
          <input id="filter-recipe" class="input" placeholder="filter by name..." style="width:220px"/>
          <button id="btn-refresh-rec" class="btn muted">Refresh</button>
        </div>
      </div>
      <div id="recipes" class="list">Loading…</div>
    </div>

    <div class="card">
      <div class="label">Details</div>
      <div id="rec-details" class="list">Select a recipe on the left.</div>
    </div>

  </div>

</div>

<!-- ===== MARKET TAB ===== -->
<section id="tab-market" class="card hidden">
  <div class="label">Marketplace</div>

  <div class="grid">

    <div class="card">
      <div class="label">Create Sale</div>

      <input id="inv-search" class="input" placeholder="Search your inventory..." />
      <div id="inv-list" class="list" style="margin-top:8px; max-height:300px">Loading…</div>

      <div class="row" style="margin-top:8px">
        <input id="price-g"   class="input" style="width:100px" placeholder="Gold"/>
        <input id="price-s"   class="input" style="width:120px" placeholder="Silver (0–99)"/>
        <input id="price-qty" class="input" style="width:100px" placeholder="Qty"/>
        <button id="btn-list" class="btn">List for sale</button>
      </div>

      <div class="row muted" style="margin-top:6px; gap:8px">
        <span id="market-fee-inline" class="badge">Fee: 1%</span>
        <span id="market-min-inline" class="badge hidden">Min: 90s</span>
      </div>

      <div id="list-msg" class="muted" style="margin-top:6px"></div>
    </div>

    <div class="card">
      <div class="row" style="gap:10px; align-items:center">
        <div class="label">Marketplace</div>
        <input id="market-q" class="input" placeholder="Search by name..." style="width:240px" />
      </div>

      <div id="market" class="list">Loading…</div>

      <div class="row" style="gap:10px; align-items:center; margin-top:12px">
        <div class="label">My listings</div>
        <input id="mine-q" class="input" placeholder="Search my listings..." style="width:240px" />
        <button id="btn-mine" class="btn muted">Reload</button>
      </div>

      <div id="mine" class="list">Loading…</div>
    </div>

  </div>
</section>

<!-- ===== INVENTORY TAB ===== -->
<section id="tab-inv" class="card hidden">
  <div class="label" style="margin-bottom:12px;">Inventory</div>

  <div class="grid">

    <div class="card">
      <div class="label">Items</div>
      <div id="inv-items" class="list" style="max-height:340px; overflow:auto;">
        Loading…
      </div>
    </div>

    <div class="card">
      <div class="label">Recipes</div>
      <div id="inv-recipes" class="list" style="max-height:340px; overflow:auto;">
        Loading…
      </div>
    </div>

  </div>
</section>

<!-- ===== BONUS TAB ===== -->
<div id="tab-bonus" class="tab card hidden">

  <div class="row" style="justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap">
    <div class="label">Bonus</div>

    <div class="row" style="gap:8px; align-items:center; flex-wrap:wrap">
      <input id="transfer-email" class="input" type="email"
             placeholder="email@example.com" style="min-width:220px">
      <input id="transfer-gold" class="input" type="number" inputmode="numeric"
             placeholder="Gold" style="width:120px">
      <button id="btn-transfer" class="btn">Send</button>
    </div>

    <span id="bonus-lock" class="badge hidden">Locked — craft ARTEFACT to unlock</span>
  </div>

  <div id="bonus-grid" class="grid" style="margin-top:8px">

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="label">T2 Bonus</div>
        <button id="btn-claim-t2" class="btn" disabled>Claim</button>
      </div>
      <div class="muted" style="margin:4px 0 6px">Shop price 98s (was 100s)</div>
      <div id="bonus-t2" class="list" style="max-height:240px">Loading…</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="label">T3 Bonus</div>
        <button id="btn-claim-t3" class="btn" disabled>Claim</button>
      </div>
      <div class="muted" style="margin:4px 0 6px">Market fee 0% (was 1%)</div>
      <div id="bonus-t3" class="list" style="max-height:240px">Loading…</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="label">T4 Bonus</div>
        <button id="btn-claim-t4" class="btn" disabled>Claim</button>
      </div>
      <div class="muted" style="margin:4px 0 6px">Shop price 90s + Craft no-fail</div>
      <div id="bonus-t4" class="list" style="max-height:240px">Loading…</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="label">T5 Bonus</div>
        <button id="btn-claim-t5" class="btn" disabled>Claim</button>
      </div>
      <div class="muted" style="margin:4px 0 6px">
        Shop price 90s + Recipe drops T3 + Craft no-fail
      </div>
      <div id="bonus-t5" class="list" style="max-height:240px">Loading…</div>
    </div>

  </div>

</div>

<script>
(function(){
  const w = window;

  w.$  = w.$  || ((s, root=document) => root.querySelector(s));
  w.$$ = w.$$ || ((s, root=document) => Array.from(root.querySelectorAll(s)));

  w.showToast = w.showToast || function(msg){
    const box = document.getElementById("toast");
    if (!box) return console.warn("TOAST:", msg);

    box.textContent = String(msg || "");
    box.classList.remove("hidden");

    clearTimeout(box._t);
    box._t = setTimeout(() => box.classList.add("hidden"), 2600);
  };

  try { if (typeof w.toast !== "function") w.toast = w.showToast; }
  catch (_) { w.toast = w.showToast; }

  w.api = w.api || (async function api(path, opts={}){
    const method  = (opts.method || "GET").toUpperCase();
    const headers = { ...(opts.headers || {}) };

    const init = {
      credentials: "include",
      ...opts,
      method,
      headers
    };

    if (init.body && typeof init.body === "object" && !(init.body instanceof FormData)) {
      headers["Content-Type"] = headers["Content-Type"] || "application/json";
      init.body = JSON.stringify(init.body);
    }

    let res;
    try {
      res = await fetch(path, init);
    } catch (err) {
      const e = new Error("Network error");
      e.cause = err;
      throw e;
    }

    const text = await res.text().catch(() => null);
    let data = null;

    if (text && text.trim()) {
      try { data = JSON.parse(text); }
      catch { data = { ok:false, error: "Invalid JSON" }; }
    } else {
      data = (res.status === 204) ? { ok:true } : {};
    }

    if (!res.ok) {
      const e = new Error(data.error || ("HTTP " + res.status));
      e.status = res.status;
      e.data   = data;
      throw e;
    }

    return data;
  });

  w.safeCall = w.safeCall || (async function(fnName, ...args){
    const fn = w[fnName];
    if (typeof fn !== "function") return;

    try { return await fn(...args); }
    catch (err) { console.warn(fnName, "failed:", err); }
  });

})();
</script>

<script>
const IMG_PREFIX = "/";
const RECIPE_ICON = IMG_PREFIX + "recipe.png";
const FALLBACK_ITEM_ICON = IMG_PREFIX + "t1_bronze.png";

function esc(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

function fileNameFromCodeTier(code, tier){
  if (!code) return null;
  const str = String(code);
  const m = str.match(/^T([1-6])_(.+)$/i);
  if (m){
    return `t${m[1]}_${m[2].toLowerCase()}.png`;
  }
  if ((tier|0) === 1){
    return `t1_${str.toLowerCase()}.png`;
  }
  return null;
}

function iconForByCode(code, tier){
  const file = fileNameFromCodeTier(code, tier);
  return file ? IMG_PREFIX + file : FALLBACK_ITEM_ICON;
}
</script>

<!-- GLOBAL & REFRESH -->
<script>
let WHO = window.WHO || null;
window.CURRENT_RECIPE_ID = null;
window.refreshMeLight = async () => {
  try{
    const r = await api("/api/me");
    if (r?.user){
      WHO = r.user;
      window.WHO = WHO;
      renderBalance();
    }
    // lightweight refresh (NO DUPLICATE CALLS)
    safeCall("loadInventoryPanel");
    safeCall("loadMarket");
    safeCall("loadMine");
  }catch(e){
    console.warn("refreshMeLight failed:", e);
  }
};

function showApp(){
  const app = document.getElementById("app");
  if (app) app.classList.remove("hidden");
}

function renderBalance(){
  const v = WHO?.balance_silver || 0;
  const g = Math.floor(v/100);
  const s = v % 100;

  const el = document.getElementById("balance");
  if (el){
    el.textContent = `${g}g ${s}s`;
    el.classList.add("pulse");
    setTimeout(()=> el.classList.remove("pulse"), 1300);
  }

  const usd = document.getElementById("balance-dollar");
  if (usd){
    usd.innerText = `$${(g/1000).toFixed(2)}`;
    usd.classList.remove("hidden");
  }
}
</script>

<script>
function applyPerkIndicators(){
  const price = WHO?.perks?.shop_price_s ?? 100;
  $("#shop-price-badge") && ($("#shop-price-badge").textContent = `${price}s`);
  $("#shop-price-inline") && ($("#shop-price-inline").textContent = String(price));

  const noFail = !!WHO?.perks?.craft_no_fail;
  $("#craft-perk") && ($("#craft-perk").textContent = noFail ? "No fail" : "10% fail");

  const fee = WHO?.perks?.auction_fee_bps===0 ? "0%" : "1%";
  $("#market-fee-inline") && ($("#market-fee-inline").textContent = `Fee: ${fee}`);

  const minNote = !!WHO?.perks?.min_list_price_s;
  $("#market-min-inline")?.classList.toggle("hidden", !minNote);
}
</script>

<!-- TABS -->
<script>
async function setTab(tab){
  showApp();

  $$(".chip").forEach(c => c.classList.toggle("active", c.dataset.tab === tab));

  $("#tab-shop")   ?.classList.toggle("hidden", tab !== "shop");
  $("#tab-quest")  ?.classList.toggle("hidden", tab !== "quest");
  $("#tab-craft")  ?.classList.toggle("hidden", tab !== "craft");
  $("#tab-market") ?.classList.toggle("hidden", tab !== "market");
  $("#tab-inv")    ?.classList.toggle("hidden", tab !== "inv");
  $("#tab-bonus")  ?.classList.toggle("hidden", tab !== "bonus");
  $("#tab-ads")    ?.classList.toggle("hidden", tab !== "ads");

  if (tab === "quest"){ window.showQuestTab?.(); window.questTrigger?.("quest-click"); }
  if (tab === "shop") window.questTrigger?.("shop-click");
  if (tab === "craft") window.questTrigger?.("craft-click");
  if (tab === "market"){ loadInventoryPanel(); loadMarket(); loadMine(); }
  if (tab === "inv") loadInventoryFull();
  if (tab === "bonus") loadBonus();
  if (tab === "ads") loadAdsPanel();
}
</script>

<!-- AUTH -->
<script>
async function loadMe(){
  try{
    const r = await api("/api/me");
    if (!r?.user) throw new Error("no session");

    WHO = r.user;
    window.WHO = WHO;

    setLoggedInUI();

    const b = $("#buysToNext");
    if (b) b.textContent = (typeof WHO?.buys_to_next === "number")
      ? WHO.buys_to_next : "—";

    applyPerkIndicators();

    setTab("shop");

  }catch{
    setLoggedOutUI();
    setTab("shop");
  }
}

function openAuth(mode){
  const auth = $("#auth");
  if (!auth) return;

  auth.classList.remove("hidden");

  $("#card-register").style.display = (mode === "register" ? "block" : "none");
  $("#card-login").style.display    = (mode === "login"    ? "block" : "none");

  if (mode === "register") $("#reg-email")?.focus();
  if (mode === "login")    $("#log-email")?.focus();
}

document.addEventListener("DOMContentLoaded", () => {

  const header = document.querySelector("header.header");
  const auth = document.getElementById("auth");

  if (header && auth && auth.previousElementSibling !== header) {
    header.insertAdjacentElement("afterend", auth);
  }

  $("#btn-open-register")?.addEventListener("click", () => openAuth("register"));
  $("#btn-open-login")?.addEventListener("click", () => openAuth("login"));

  $("#btn-register")?.addEventListener("click", doRegister);
  $("#btn-login")?.addEventListener("click", doLogin);
  $("#btn-logout")?.addEventListener("click", doLogout);

  $("#reg-email")?.addEventListener("keydown", e=>{ if(e.key==="Enter") doRegister(); });
  $("#reg-pass") ?.addEventListener("keydown", e=>{ if(e.key==="Enter") doRegister(); });
  $("#log-email")?.addEventListener("keydown", e=>{ if(e.key==="Enter") doLogin(); });
  $("#log-pass") ?.addEventListener("keydown", e=>{ if(e.key==="Enter") doLogin(); });

  $$(".chip").forEach(c => c.addEventListener("click", ()=> setTab(c.dataset.tab)));

  loadMe();
});

<script>
async function doRegister(){
  const msg = $("#reg-msg");
  try{
    const email = $("#reg-email")?.value.trim();
    const pass = $("#reg-pass")?.value || "";
    if (!email || !pass) throw new Error("Enter email & password.");
    if (pass.length < 6) throw new Error("Password too short (min 6).");
    msg.textContent = "…";
    await api("/api/register", { method:"POST", body: { email, password: pass } });
    msg.textContent = "OK — now log in.";
    $("#card-register").style.display="none";
    $("#card-login").style.display="block";
    $("#log-email")?.focus();
  }catch(e){
    msg.textContent = e?.message || "Register failed.";
  }
}

async function doLogin(){
  const msg = $("#log-msg");
  try{
    const email = $("#log-email")?.value.trim();
    const pass = $("#log-pass")?.value || "";
    if (!email || !pass) throw new Error("Enter email & password.");
    msg.textContent = "…";
    await api("/api/login", { method:"POST", body: { email, password: pass } });
    msg.textContent = "OK";
    await loadMe();
  }catch(e){
    msg.textContent = e?.message || "Login failed.";
  }
}

async function doLogout(){
  try { await api("/api/logout"); } catch {}
  setLoggedOutUI();
}
</script>

<!-- SHOP -->
<script>
(function(){
  const $ = sel => document.querySelector(sel);

  async function loadShop(){
    try {
      const r = await api("/api/shop/info");

      $("#shop-price-inline").textContent = r.price_s || 100;
      $("#shop-price-badge").textContent = (r.price_s || 100) + "s";

      $("#buysToNext").textContent = r.buys_to_next ?? "—";

      if (window.WHO){
        const g = Math.floor(WHO.balance_silver / 100);
        const s = WHO.balance_silver % 100;
        const el = $("#shop-balance");
        if (el){
          el.classList.remove("hidden");
          el.textContent = `${g}g ${s}s`;
        }
      }

    } catch(e){
      console.warn("loadShop fail", e);
    }
  }

  async function doBuyT1(){
    const inp = $("#buy-t1-qty");
    let qty = parseInt(inp?.value || "1", 10);
    if (!qty || qty < 1) qty = 1;
    if (qty > 99999) qty = 99999;

    const btn = $("#btn-buy-t1");
    const prev = btn.textContent;

    btn.disabled = true;
    btn.textContent = "Buying…";

    try{
      const r = await api("/api/shop/buy-t1", {
        method:"POST",
        body:{ qty }
      });

      if (r?.balance_silver != null && window.WHO){
        WHO.balance_silver = r.balance_silver | 0;
        renderBalance();
      }

      await loadShop();
      await loadInventoryPanel();

      showToast(`Purchased x${qty}`);
      window.questTrigger?.("buy-mat");

    }catch(e){
      showToast(e?.message || "Buy failed.");
    }finally{
      btn.disabled = false;
      btn.textContent = prev;
      inp.value = "1";
    }
  }

  window.showShopTab = loadShop;
  $("#btn-buy-t1")?.addEventListener("click", doBuyT1);

})();
</script>

<!-- QUEST SYSTEM -->
<script>
(function(){
  const esc = s=>String(s);

  const DAILY_QUESTS = [];

  const LIFETIME_QUESTS = [
    { id:"shop-click",     text:"Klikni na tab Shop",      reward:20 },
    { id:"craft-click",    text:"Klikni na tab Crafting",  reward:20 },
    { id:"market-click",   text:"Klikni na tab Market",    reward:20 },
    { id:"inv-click",      text:"Klikni na tab Inventory", reward:20 },
    { id:"bonus-click",    text:"Klikni na tab Bonus",     reward:20 },
    { id:"ads-click",      text:"Klikni na tab Ads",       reward:20 },

    { id:"craft-t2", text:"Iskraftaj T2 item", reward:20 },
    { id:"craft-t3", text:"Iskraftaj T3 item", reward:30 },
    { id:"craft-t4", text:"Iskraftaj T4 item", reward:40 },
    { id:"craft-t5", text:"Iskraftaj T5 item", reward:50 },

    { id:"sell-t2", text:"Postavi T2 item na aukciju", reward:20 },
    { id:"sell-t3", text:"Postavi T3 item na aukciju", reward:30 },
    { id:"sell-t4", text:"Postavi T4 item na aukciju", reward:40 },
    { id:"sell-t5", text:"Postavi T5 item na aukciju", reward:50 },

    { id:"buy-mat", text:"Kupi bilo koji materijal", reward:10 },

    { id:"rec-t2", text:"Osvoji T2 recept", reward:20 },
    { id:"rec-t3", text:"Osvoji T3 recept", reward:30 },
    { id:"rec-t4", text:"Osvoji T4 recept", reward:40 },
    { id:"rec-t5", text:"Osvoji T5 recept", reward:50 },

    { id:"artifact", text:"Iskraftaj Artefakt", reward:10000 },

    { id:"buy-t2", text:"Kupi T2 item na aukciji", reward:20 },
    { id:"buy-t3", text:"Kupi T3 item na aukciji", reward:30 },
    { id:"buy-t4", text:"Kupi T4 item na aukciji", reward:40 },
    { id:"buy-t5", text:"Kupi T5 item na aukciji", reward:50 },

    { id:"shop-spend", text:"Potroši 100 golda u Shopu", reward:50 },

    { id:"buy-gold-1",  text:"Kupi gold za 1$",   reward:1000 },
    { id:"buy-gold-10", text:"Kupi gold za 10$",  reward:10000 },
    { id:"buy-gold-50", text:"Kupi gold za 50$",  reward:50000 }
  ];

  function dailyResetCheck(){
    const today = new Date().toDateString();
    const last  = localStorage.getItem("quests_day") || "";
    if(today !== last){
      localStorage.setItem("quests_day", today);
      localStorage.setItem("quests_done", JSON.stringify({}));
    }
  }

  function getStatus(){
    return JSON.parse(localStorage.getItem("quests_done") || "{}");
  }

  function saveStatus(status){
    localStorage.setItem("quests_done", JSON.stringify(status));
  }

  window.questTrigger = function(id){
    const status = getStatus();
    if(status[id]) return;
    status[id] = false;
    saveStatus(status);
    renderQuests();
  };

  window.claimQuest = function(id, reward){
    const status = getStatus();
    if(status[id] === true) return;

    status[id] = true;
    saveStatus(status);

    if (window.WHO) {
      WHO.balance_silver += reward * 100;
      renderBalance();
    }

    const msg = document.getElementById("quest-msg-lifetime");
    if (msg) msg.innerText = `Dobio si +${reward} gold!`;

    renderQuests();
  };

  function renderQuests(){
    const listDaily     = document.getElementById("quest-list-daily");
    const msgDaily      = document.getElementById("quest-msg-daily");
    const listLifetime  = document.getElementById("quest-list-lifetime");
    const msgLifetime   = document.getElementById("quest-msg-lifetime");

    if(!listDaily || !listLifetime) return;

    const status = getStatus();

    listDaily.innerHTML = "";
    msgDaily.innerHTML = "";

    DAILY_QUESTS.forEach(q => {
      const done = status[q.id] === true;
      const active = status[q.id] !== undefined;

      const row = document.createElement("div");
      row.className = "card row";
      row.style.justifyContent = "space-between";

      row.innerHTML = `
        <div>
          <div>${q.text}</div>
          <div class="muted" style="font-size:12px">Nagrada: ${q.reward} gold</div>
        </div>

        <button class="btn ${done ? "disabled" : !active ? "muted" : ""}"
          onclick="${done ? "" : active ? `window.claimQuest('${q.id}', ${q.reward})` : ""}">
          ${ done ? "Završeno" : active ? "Claim" : "U tijeku" }
        </button>
      `;
      listDaily.appendChild(row);
    });

    if(DAILY_QUESTS.length === 0)
      msgDaily.innerText = "Nema dnevnih questova.";

    listLifetime.innerHTML = "";
    msgLifetime.innerHTML = "";

    LIFETIME_QUESTS.forEach(q => {
      const done = status[q.id] === true;
      const active = status[q.id] !== undefined;

      const row = document.createElement("div");
      row.className = "card row";
      row.style.justifyContent = "space-between";

      row.innerHTML = `
        <div>
          <div>${q.text}</div>
          <div class="muted" style="font-size:12px">Nagrada: ${q.reward} gold</div>
        </div>

        <button class="btn ${done ? "disabled" : !active ? "muted" : ""}"
          onclick="${done ? "" : active ? `window.claimQuest('${q.id}', ${q.reward})` : ""}">
          ${ done ? "Završeno" : active ? "Claim" : "U tijeku" }
        </button>
      `;
      listLifetime.appendChild(row);
    });
  }

  window.showQuestTab = function(){
    dailyResetCheck();
    renderQuests();
  };

})();
</script>

<!-- CRAFTING -->
<script>
  function rowRecipe(r){
    return `
      <div class="itemrow">
        <div class="row" style="gap:10px;align-items:center">
          <img class="img-cell" src="${RECIPE_ICON}" alt=""
               onerror="this.onerror=null;this.src='${RECIPE_ICON}'">
          <div>
            <div class="label" style="text-transform:none;color:var(--text)">
              ${esc(r.name)}</div>
            <div class="muted">T${r.tier} · x${r.qty}</div>
          </div>
        </div>
        <button class="btn muted" data-open="${esc(r.id)}">Open</button>
      </div>`;
  }

  async function loadRecipes(){
    const box = $("#recipes");
    if (!box) return;
    box.textContent = "Loading…";
    try{
      const list = await api("/api/recipes/list");
      const q = ($("#filter-recipe")?.value || "").trim().toLowerCase();
      const rows = (list?.recipes || []).filter(x => !q || x.name.toLowerCase().includes(q));
      if (!rows.length){ box.textContent = "No recipes."; return; }
      box.innerHTML = rows.map(rowRecipe).join("");
      box.querySelectorAll("[data-open]").forEach(btn=>{
        btn.addEventListener("click",()=>openRecipe(btn.getAttribute("data-open")));
      });
    }catch(e){
      box.textContent = e?.message || "Failed to load recipes.";
    }
  }

  $("#btn-refresh-rec")?.addEventListener("click", loadRecipes);
  $("#filter-recipe")?.addEventListener("input", loadRecipes);

  function renderIngredients(details){
    const parts = (details.ingredients||[]).map(ing=>{
      const ok = (ing.have|0) >= (ing.qty|0);
      const src = iconForByCode(ing.code, ing.tier);
      return `
        <div class="itemrow">
          <div class="row" style="gap:10px;align-items:center">
            <img class="img-cell" src="${esc(src)}" alt=""
                 onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
            <div>${esc(ing.name)} <span class="badge">T${ing.tier}</span></div>
          </div>
          <div class="${ok ? "" : "muted"}">${(ing.have|0)}/${(ing.qty|0)}</div>
        </div>`;
    }).join("");

    const canCraft = (details.ingredients||[]).every(ing => (ing.have|0) >= (ing.qty|0));
    const note = WHO?.perks?.craft_no_fail
      ? "No fail (server checks ingredients)"
      : (canCraft ? "10% fail → Scrap" : "Missing materials");

    return `
      <div class="itemrow"><div><b>${esc(details.recipe.name)}</b>
      <span class="badge">T${details.recipe.tier}</span></div></div>
      <div class="itemrow"><div class="muted">Ingredients</div></div>
      ${parts}
      <div class="itemrow">
        <button id="btn-craft" class="btn" data-can="${canCraft ? "1" : "0"}">
          Craft</button>
        <span class="muted" style="margin-left:8px">${note}</span>
      </div>`;
  }

  async function openRecipe(id){
    const box = $("#rec-details");
    box.textContent = "Loading…";
    try{
      const details = await api(`/api/recipes/ingredients/${encodeURIComponent(id)}`);
      box.innerHTML = renderIngredients(details);
      window.CURRENT_RECIPE_DETAILS = details;
    }catch(e){
      box.textContent = e?.message || "Failed.";
    }
  }

  document.addEventListener("click", async(e)=>{
    if (e.target.id !== "btn-craft") return;

    const d = window.CURRENT_RECIPE_DETAILS;
    if (!d || !d.recipe?.id) return showToast("Open a recipe first.");

    if (e.target.getAttribute("data-can") !== "1"){
      return showToast("Missing materials.");
    }

    const btn = e.target;
    const prev = btn.textContent;

    btn.disabled = true;
    btn.textContent = "Crafting…";

    try{
      const r = await api("/api/craft/do",{method:"POST",body:{recipe_id:d.recipe.id}});
      if (r.crafted) showToast(`Crafted: ${r.crafted.name}`);
      else if (r.scrap) showToast("Failed (Scrap)");
      await loadInventoryPanel();
      await loadInventoryFull();
      await loadRecipes();
      await openRecipe(d.recipe.id);
    }catch(e){
      showToast(e?.message || "Failed.");
    }finally{
      btn.disabled = false;
      btn.textContent = prev;
    }
  });
</script>

<!-- MARKET & INVENTORY -->
<script>
async function safeLoad(sel, fn){
  const box = $(sel);
  if (!box) return;
  try{
    await fn(box);
  }catch(e){
    box.textContent = e?.message || "Failed.";
  }
}

async function getJSON(url){
  return api(url, { method:"GET" });
}

async function postJSON(url, body){
  return api(url, { method:"POST", body });
}

async function loadInventoryPanel(){
  await safeLoad("#inv-list", async (box) => {
    const q = ($("#inv-search")?.value || "").trim().toLowerCase();
    const r = await getJSON("/api/inventory");

    const items = (r.items || [])
      .filter(x => x.code !== "ARTEFACT" && (x.tier|0) < 6)
      .filter(x => !q || (x.name || "").toLowerCase().includes(q));

    const recipes = (r.recipes || [])
      .filter(x => !q || (x.name || "").toLowerCase().includes(q));

    const frag = document.createDocumentFragment();
    const add = (arr, kind) => {
      for (const it of arr){
        const ico = (kind === "item")
          ? (iconForByCode(it.code, it.tier))
          : RECIPE_ICON;

        const row = document.createElement("div");
        row.className = "itemrow";
        row.innerHTML = `
          <div class="row" style="gap:10px;align-items:center">
            <img class="img-cell" src="${esc(ico)}" alt=""
                 onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
            <div>${esc(it.name)} <span class="badge">T${it.tier}</span>
            <span class="muted">x${it.qty}</span></div>
          </div>
          <button class="btn muted">Pick</button>`;

        row.querySelector("button").addEventListener("click", () => {
          window.SEL_INV = { kind, id: it.id, name: it.name };
          $("#list-msg").textContent = "Selected: " + it.name;
          $("#price-g")?.focus();
        });

        frag.appendChild(row);
      }
    };

    add(items, "item");
    add(recipes, "recipe");

    box.innerHTML = frag.childNodes.length ? "" : "Empty.";
    if (frag.childNodes.length) box.appendChild(frag);
  });
}

async function loadMarket(){
  await safeLoad("#market", async (box) => {
    const q = ($("#market-q")?.value || "").trim();
    const url = "/api/sales/live" + (q ? ("?q=" + encodeURIComponent(q)) : "");
    const r = await getJSON(url);

    const rows = (r?.listings || [])
      .filter(Boolean)
      .filter(s => !(s.kind === "item" && (s.code === "ARTEFACT" || (s.tier|0)>=6)));

    if (!rows.length){ box.textContent = "No listings."; return; }

    const frag = document.createDocumentFragment();
    for (const s of rows){
      const priceS = s?.price_s | 0;
      const g = Math.floor(priceS/100), ss = priceS % 100;
      const ico = (s.kind === "item")
        ? iconForByCode(s.code, s.tier)
        : RECIPE_ICON;

      const mine = !!(window.WHO?.id && s?.seller_user_id === window.WHO.id);

      const row = document.createElement("div");
      row.className = "itemrow";
      row.innerHTML = `
        <div class="row" style="gap:10px;align-items:center">
          <img class="img-cell"
           src="${esc(ico)}" alt=""
           onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
          <div>${esc(s.name)}
           <span class="badge">T${s?.tier ?? "-"}</span>
           <span class="muted">x${s?.qty ?? 1}</span></div>
        </div>
        <div class="row">
          <span class="badge">${g}g ${ss}s</span>
          ${mine ? '<button class="btn muted" disabled>My</button>' :
                   '<button class="btn">Buy</button>'}
        </div>`;

      const btn = row.querySelector("button.btn:not(.muted)");
      if (btn) {
        btn.addEventListener("click", async () => {
          if (!window.WHO?.id) return showToast("Please log in first.");
          if (btn.disabled) return;

          const prev = btn.textContent;
          btn.disabled = true;
          btn.textContent = "Buying…";

          try{
            const res = await postJSON("/api/sales/buy", { id: s.id });
            const newBal = res?.buyer_balance_silver ?? res?.balance_silver ?? null;
            if (newBal != null && window.WHO) {
              WHO.balance_silver = newBal|0;
              renderBalance();
            }

            await loadMarket();
            await loadMine();
            await loadInventoryPanel();

            showToast("Purchased.");

          }catch(err){
            showToast(err?.data?.error || err?.message || "Purchase failed.");
          }finally{
            btn.disabled = false;
            btn.textContent = prev;
          }
        });
      }

      frag.appendChild(row);
    }

    box.innerHTML = "";
    box.appendChild(frag);
  });
}

async function loadMine(){
  await safeLoad("#mine", async (box) => {
    const rq = await getJSON("/api/sales/mine");
    const q = ($("#mine-q")?.value || "").trim().toLowerCase();

    let rows = (rq?.listings || [])
      .filter(Boolean)
      .filter(s => s?.status === "live"
        && !(s.kind === "item" && (s.code === "ARTEFACT" || (s.tier|0)>=6)));

    if (q) rows = rows.filter(s => (s?.name || "").toLowerCase().includes(q));

    if (!rows.length){ box.textContent = "No live listings."; return; }

    const frag = document.createDocumentFragment();

    for (const s of rows){
      const priceS = s?.price_s | 0;
      const g = Math.floor(priceS/100), ss = priceS % 100;
      const ico = (s.kind === "item")
        ? iconForByCode(s.code, s.tier)
        : RECIPE_ICON;

      const row = document.createElement("div");
      row.className = "itemrow";
      row.innerHTML = `
        <div class="row" style="gap:10px;align-items:center">
          <img class="img-cell"
           src="${esc(ico)}" alt=""
           onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
          <div>${esc(s.name)}
           <span class="badge">T${s?.tier ?? "-"}</span>
           <span class="muted">x${s?.qty ?? 1}</span></div>
        </div>

        <div class="row">
          <span class="badge">${g}g ${ss}s</span>
          <button class="btn danger">Cancel</button>
        </div>`;

      row.querySelector("button.btn.danger").addEventListener("click", async () => {
        const btn = row.querySelector("button.btn.danger");
        if (!btn || btn.disabled) return;

        const prev = btn.textContent;
        btn.disabled = true;
        btn.textContent = "Cancel…";

        try{
          await postJSON("/api/sales/cancel", { id: s.id });
          await loadMarket();
          await loadMine();
          await loadInventoryPanel();
        }catch(err){
          showToast(err?.message || "Cancel failed.");
        }finally{
          btn.disabled = false;
          btn.textContent = prev;
        }
      });

      frag.appendChild(row);
    }

    box.innerHTML = "";
    box.appendChild(frag);
  });
}

async function handleList(){
  try{
    const sel = window.SEL_INV;
    if (!sel) return showToast("Pick an item/recipe first.");

    const gold = Math.max(0, parseInt($("#price-g")?.value || "0", 10) || 0);
    let silver = Math.max(0, parseInt($("#price-s")?.value || "0", 10) || 0);
    const qty = Math.max(1, parseInt($("#price-qty")?.value || "1", 10) || 1);
    if (silver > 99) silver = 99;

    await postJSON("/api/sales/list", {
      kind: sel.kind,
      id: sel.id,
      qty,
      gold,
      silver
    });

    $("#list-msg").textContent = "Listed.";
    window.SEL_INV = null;

    await loadMarket();
    await loadMine();
    await loadInventoryPanel();

    showToast("Listing created.");

  }catch(e){
    const msg = e?.data?.error || e?.message || "Listing failed.";
    $("#list-msg").textContent = msg;
  }
}

$("#btn-list")?.addEventListener("click", handleList);
</script>

<!-- INVENTORY FULL -->
<script>
async function loadInventoryFull(){
  await safeLoad("#inv-full", async (box) => {
    const r = await getJSON("/api/inventory");
    const items   = Array.isArray(r.items)   ? r.items   : [];
    const recipes = Array.isArray(r.recipes) ? r.recipes : [];

    const out = [];

    for (const it of items){
      const ico = iconForByCode(it.code, it.tier);
      out.push(`
        <div class="itemrow">
          <div class="row" style="gap:10px;align-items:center">
            <img class="img-cell" src="${esc(ico)}" alt=""
              onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
            <div>${esc(it.name)} <span class="badge">T${it.tier}</span></div>
          </div>
          <div class="muted">x${it.qty}</div>
        </div>`);
    }

    for (const rc of recipes){
      out.push(`
        <div class="itemrow">
          <div class="row" style="gap:10px;align-items:center">
            <img class="img-cell" src="${RECIPE_ICON}" alt=""
              onerror="this.onerror=null;this.src='${RECIPE_ICON}'">
            <div>${esc(rc.name)} <span class="badge">T${rc.tier}</span></div>
          </div>
          <div class="muted">x${rc.qty}</div>
        </div>`);
    }

    box.innerHTML = out.join("") || "Empty.";
  });
}

window.loadInventoryFull = loadInventoryFull;

document.addEventListener("DOMContentLoaded", () => {
  const tabInv = $("#tab-inv");
  if (!tabInv) return;

  const obs = new MutationObserver(() => {
    if (!tabInv.classList.contains("hidden")) {
      loadInventoryFull();
    }
  });

  obs.observe(tabInv, { attributes: true });
});
</script>

<!-- BONUS -->
<script>
function withTimeout(promise, ms = 8000){
  return new Promise((resolve, reject)=>{
    const t = setTimeout(()=> reject(new Error("Timeout")), ms);
    promise.then(v => { clearTimeout(t); resolve(v); })
           .catch(e => { clearTimeout(t); reject(e); });
  });
}

function tile(name, code, ok, tier){
  const ico = iconForByCode(code, tier);
  return `
    <div class="tile ${ok ? 'ok' : 'miss'}">
      <img class="img-cell" src="${esc(ico)}" alt=""
        onerror="this.onerror=null;this.src='${FALLBACK_ITEM_ICON}'">
      <div>${esc(name)}</div>
    </div>`;
}

async function loadBonus(){
  const lock = $("#bonus-lock");

  const boxes = {
    2: $("#bonus-t2"),
    3: $("#bonus-t3"),
    4: $("#bonus-t4"),
    5: $("#bonus-t5")
  };

  const btns = {
    2: $("#btn-claim-t2"),
    3: $("#btn-claim-t3"),
    4: $("#btn-claim-t4"),
    5: $("#btn-claim-t5")
  };

  Object.values(btns).forEach(b => {
    if (b){ b.disabled = true; b.classList.add("muted"); }
  });

  Object.values(boxes).forEach(b => {
    if (b) b.textContent = "Loading…";
  });

  let cleared = false;
  setTimeout(() => {
    if (!cleared){
      Object.values(boxes).forEach(b => {
        if (b) b.textContent = "Still loading…";
      });
    }
  }, 3000);

  try{
    const r = await withTimeout(api("/api/bonus/status"), 8000);
    cleared = true;

    const hasArt = !!r?.has_artefact;
    lock?.classList.toggle("hidden", hasArt);

    for (const t of [2,3,4,5]){
      const box = boxes[t];
      if (!box) continue;

      const info = r.tiers?.[t];
      if (!info){
        box.textContent = "No data";
        continue;
      }

      const tiles = [];

      for (const c of (info.owned || [])){
        tiles.push(tile(c.replace(/^T\d_/,""), c, true, t));
      }

      for (const c of (info.missing || [])){
        tiles.push(tile(c.replace(/^T\d_/,""), c, false, t));
      }

      box.innerHTML = tiles.join("") || "Empty.";

      const btn = btns[t];
      if (!btn) continue;

      const canClaim = hasArt &&
                       (info.missing?.length === 0) &&
                       !info.claimed;

      btn.disabled = !canClaim;
      btn.textContent = info.claimed ? "Claimed" : "Claim";

      if (info.claimed) btn.classList.add("muted");
      else btn.classList.remove("muted");

      btn.onclick = async () => {
        if (btn.disabled) return;

        const prev = btn.textContent;
        btn.disabled = true;
        btn.textContent = "Claiming…";

        try{
          await api("/api/bonus/claim", {
            method: "POST",
            body: { tier: t }
          });

          showToast(`T${t} bonus claimed.`);
          await loadBonus();
          await refreshMeLight();

        }catch(e){
          alert(e?.message || "Claim failed.");
        }finally{
          btn.textContent = prev;
        }
      };
    }

  }catch(e){
    cleared = true;
    Object.values(boxes).forEach(b => {
      if (b) b.textContent = e?.message || "Failed.";
    });
  }
}
</script>

<!-- ADS -->
<script>
(function(){
  const $ = s => document.querySelector(s);

  async function loadAdsPanel(){
    const box = $("#ad-output");
    if (!box) return;
    box.textContent = "Loading…";

    try{
      const r = await api("/api/ads/list");
      const rows = Array.isArray(r?.ads) ? r.ads : [];

      if (!rows.length){
        box.textContent = "No ads yet.";
        return;
      }

      box.innerHTML = rows.map(ad => `
        <div class="itemrow">
          <div class="muted" style="word-break:break-all;">
            ${ad.text}</div>
        </div>`).join("");

    }catch(e){
      box.textContent = e?.message || "Failed.";
    }
  }

  async function buyCourse(){
    const btn = $("#btn-buy-course");
    if (!btn || btn.disabled) return;

    btn.disabled = true;
    const prev = btn.textContent;
    btn.textContent = "Processing…";

    try{
      const r = await api("/api/ads/buy-course", { method:"POST" });

      if (typeof r?.balance_silver === "number" && window.WHO){
        WHO.balance_silver = r.balance_silver;
        renderBalance();
      }

      const code = r?.access_code ||
          ("COURSE-" + Math.random().toString(36).slice(2,8).toUpperCase());

      $("#course-msg").innerHTML = `
        <div><b>Course unlocked!</b></div>
        <div>Your code: <b>${code}</b></div>`;

      showToast("Course purchased.");

    }catch(e){
      showToast(e?.message || "Purchase failed.");
    }finally{
      btn.disabled = false;
      btn.textContent = prev;
    }
  }

  async function submitAd(){
    const inp = $("#ad-text");
    const text = inp.value.trim();
    if (!text) return showToast("Enter your text.");

    const btn = $("#btn-post-ad");
    if (!btn || btn.disabled) return;

    btn.disabled = true;
    const prev = btn.textContent;
    btn.textContent = "Posting…";

    try{
      const r = await api("/api/ads/create", {
        method:"POST",
        body:{ text }
      });

      if (typeof r?.balance_silver === "number" && window.WHO){
        WHO.balance_silver = r.balance_silver;
        renderBalance();
      }

      inp.value = "";
      showToast("Advertisement posted.");
      await loadAdsPanel();

    }catch(e){
      showToast(e?.data?.error || e?.message || "Failed.");
    }finally{
      btn.disabled = false;
      btn.textContent = prev;
    }
  }

  window.loadAdsPanel = loadAdsPanel;

  document.addEventListener("click", (e)=>{
    if (e.target.id === "btn-buy-course") buyCourse();
    if (e.target.id === "btn-post-ad")   submitAd();
  });

})();
</script>

</body>
</html>
