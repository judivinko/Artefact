// ===============================
// FILE: public/index.html
// (Login/Register first → then 3 tabs: Shop, Crafting, Auctions)
// Works with your existing server.js API (register/login/me, shop T1, recipes, auctions)
// ===============================

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ARTEFACT</title>
  <link rel="stylesheet" href="/app.css" />
  <style>
    .hide{display:none}
    .auth-card{max-width:520px;margin:40px auto}
    .auth-tabs{display:flex;gap:8px;margin-bottom:10px}
    .auth-tabs .btn{flex:1}

    .header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#111827;border-bottom:1px solid #1f2937}
    .brand{font-weight:800;letter-spacing:.3px}
    .container{max-width:1100px;margin:16px auto;padding:0 12px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:6px 10px;border:1px solid #233047;border-radius:10px;background:#0b1220;color:#e2e8f0;cursor:pointer}
    .tab.active{border-color:#2dd4bf;box-shadow:0 0 0 1px #2dd4bf inset}
    .card{background:#111827;border:1px solid #1f2937;border-radius:12px;padding:16px;margin:16px 0}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #1f2937;padding:8px 10px;text-align:left}
    .table th{color:#94a3b8;font-weight:600}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .input{background:#0b1220;border:1px solid #233047;border-radius:8px;color:#e2e8f0;padding:6px 8px}
    .btn{background:#0b1220;border:1px solid #334155;border-radius:10px;color:#e2e8f0;padding:6px 10px;cursor:pointer}
    .btn:hover{border-color:#2dd4bf}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#1f2937;color:#93c5fd;font-size:12px;margin-left:6px}
    .muted{color:#94a3b8}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 900px){.grid2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header class="header">
    <div class="brand">ARTEFACT</div>
    <div id="userBar" class="row"></div>
  </header>

  <main class="container">
    <!-- AUTH: first screen has only Register/Login -->
    <section id="auth" class="card auth-card">
      <h2>Welcome</h2>
      <div class="auth-tabs">
        <button class="btn" onclick="showAuth('login')">Login</button>
        <button class="btn" onclick="showAuth('register')">Register</button>
      </div>
      <div id="auth-login">
        <div class="row" style="margin-bottom:8px">
          <input id="login-email" class="input" placeholder="email" />
          <input id="login-pass"  class="input" type="password" placeholder="password" />
        </div>
        <button class="btn" onclick="login()">Login</button>
        <div id="login-msg" class="muted" style="margin-top:6px"></div>
      </div>
      <div id="auth-register" class="hide">
        <div class="row" style="margin-bottom:8px">
          <input id="reg-email" class="input" placeholder="email" />
          <input id="reg-pass"  class="input" type="password" placeholder="password (≥6)" />
        </div>
        <button class="btn" onclick="register()">Register</button>
        <div id="reg-msg" class="muted" style="margin-top:6px"></div>
      </div>
    </section>

    <!-- APP: after login, exactly 3 tabs -->
    <section id="app" class="hide">
      <div class="tabs">
        <button class="tab active" data-tab="shop" onclick="showTab('shop')">Shop</button>
        <button class="tab" data-tab="craft" onclick="showTab('craft')">Crafting</button>
        <button class="tab" data-tab="auctions" onclick="showTab('auctions')">Auctions</button>
      </div>

      <section id="shop" class="card"></section>
      <section id="craft" class="card" style="display:none"></section>
      <section id="auctions" class="card" style="display:none"></section>
    </section>
  </main>

<script>
const $ = s => document.querySelector(s);

async function api(path, opts={}){
  const res = await fetch(path, { credentials:"include", headers:{"Content-Type":"application/json"}, ...opts });
  let data=null; try{ data=await res.json(); }catch{}
  if(!res.ok) throw new Error((data&&data.error)||`HTTP ${res.status}`);
  return data;
}

// ---------- AUTH ----------
let ME = null;
function goldText(s){ return `${Math.floor((s||0)/100)}g ${(s||0)%100}s`; }
function setUserBar(){
  const box=$('#userBar');
  if(ME&&ME.user){ const u=ME.user;
    box.innerHTML = `
      <span>${u.email}</span>
      <span class="pill">${u.gold}g ${u.silver}s</span>
      <button class="btn" onclick="logout()">Logout</button>
      <a class="btn" href="/admin">Admin</a>
    `;
  }else{ box.innerHTML = `<span class="muted">Not logged in</span>`; }
}
function showAuth(which){
  $('#auth-login').classList.toggle('hide', which!=='login');
  $('#auth-register').classList.toggle('hide', which!=='register');
}
async function me(){
  try{ ME = await api('/api/me'); }catch{ ME=null; }
  const logged = !!(ME&&ME.ok&&ME.user);
  $('#auth').classList.toggle('hide', logged);
  $('#app').classList.toggle('hide', !logged);
  setUserBar();
  if(logged) showTab('shop');
}
async function login(){
  const email=$('#login-email').value.trim(), password=$('#login-pass').value;
  $('#login-msg').textContent='';
  try{ await api('/api/login',{method:'POST',body:JSON.stringify({email,password})}); await me(); }
  catch(e){ $('#login-msg').textContent=e.message; }
}
async function register(){
  const email=$('#reg-email').value.trim(), password=$('#reg-pass').value;
  $('#reg-msg').textContent='';
  try{ await api('/api/register',{method:'POST',body:JSON.stringify({email,password})});
       await api('/api/login',{method:'POST',body:JSON.stringify({email,password})});
       await me(); }
  catch(e){ $('#reg-msg').textContent=e.message; }
}
async function logout(){ try{ await api('/api/logout'); }catch{} finally{ ME=null; await me(); } }

// ---------- TABS ----------
function showTab(id){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${id}"]`).classList.add('active');
  ['shop','craft','auctions'].forEach(s=>$('#'+s).style.display=(s===id?'block':'none'));
  if(id==='shop') loadShop();
  if(id==='craft') loadCraft();
  if(id==='auctions') loadAuctions();
}

// ---------- SHOP (T1 only, 1g per buy) ----------
async function loadShop(){
  try{
    await me();
    const u = ME && ME.user;
    $('#shop').innerHTML = `
      <h2>Shop (T1 only)</h2>
      <p class="muted">Each purchase costs <b>1 gold</b> (100s). You either get a random T1 material or a recipe drop (T2–T5/T6 weighted).</p>
      <div class="row">
        <button class="btn" onclick="buyT1()">Buy T1 Pack (1g)</button>
        ${u && u.buys_to_next!=null ? `<span class=\"pill\">Next recipe in ${u.buys_to_next}</span>` : ''}
      </div>
      <div id="shop-msg" class="muted" style="margin-top:8px"></div>
    `;
  }catch(e){ $('#shop').innerHTML = `<p class="muted">${e.message}</p>`; }
}
async function buyT1(){
  try{
    const r = await api('/api/shop/buy-t1',{method:'POST',body:JSON.stringify({})});
    const msg = r.result_type==='RECIPE' ? `Recipe gained: [T${r.grantedRecipe.tier}] ${r.grantedRecipe.name}` : `Material gained: ${r.addedItem.name}`;
    $('#shop-msg').textContent = `${msg} • Balance: ${goldText(r.balance_silver)} • Next in ${r.buys_to_next}`;
    await me();
  }catch(e){ $('#shop-msg').textContent = e.message; }
}

// ---------- CRAFTING ----------
async function loadCraft(){
  const r = await api('/api/my/recipes');
  if(!(r.recipes||[]).length){ $('#craft').innerHTML='<p class="muted">No recipes yet. Buy in Shop to get drops.</p>'; return; }
  const cards = r.recipes.map(x=>`<div class=\"card\"><div class=\"row\" style=\"justify-content:space-between\"> <h3>${x.name}</h3> <span class=\"pill\">T${x.tier}</span></div>
    <div class=\"row\"><span class=\"muted\">Owned: x${x.qty}</span><button class=\"btn\" onclick=\"openRecipe(${x.id})\">Open</button></div>
  </div>`).join('');
  $('#craft').innerHTML = `<div class="grid2">${cards}</div><div id="rec-detail" class="card"></div>`;
}
async function openRecipe(id){
  try{
    const r = await api('/api/recipes/'+id);
    const list = r.ingredients.map(x=>`<li>${x.name} ${x.tier?`(T${x.tier})`:''} — need ${x.need_qty} • have ${x.have_qty} ${x.missing?'<span class=bad>(missing)</span>':'<span class=ok>OK</span>'}</li>`).join('');
    $('#rec-detail').innerHTML = `
      <h3>${r.recipe.name} (T${r.recipe.tier})</h3>
      <ul>${list}</ul>
      <button class="btn" ${r.can_craft?'':'disabled'} onclick="craft(${r.recipe.id})">Craft</button>
      ${r.can_craft?'':'<span class="muted"> missing ingredients</span>'}
    `;
  }catch(e){ alert(e.message); }
}
async function craft(id){
  try{ const r=await api('/api/recipes/'+id+'/craft',{method:'POST',body:JSON.stringify({})}); alert((r.crafted?('Crafted: '+r.output.name):'Craft failed (Scrap)')); await me(); loadCraft(); }
  catch(e){ alert(e.message); }
}

// ---------- AUCTIONS ----------
async function loadAuctions(){
  const list=(await api('/api/auctions/live')).auctions||[];
  $('#auctions').innerHTML = `
    <h2>Auctions <span class="pill">${list.length} live</span></h2>
    <div class="card">
      <h3>Create auction</h3>
      <div class="row" style="margin-bottom:10px">
        <input id="ac_code" class="input" placeholder="Code (item or recipe, e.g. R_TOME or BRONZE_PLATE)" />
        <input id="ac_qty" class="input" type="number" min="1" value="1" />
        <input id="ac_sg" class="input" type="number" min="0" placeholder="Start g" />
        <input id="ac_ss" class="input" type="number" min="0" max="99" placeholder="Start s" />
        <input id="ac_bg" class="input" type="number" min="0" placeholder="Buy g (opt)" />
        <input id="ac_bs" class="input" type="number" min="0" max="99" placeholder="Buy s (opt)" />
        <input id="ac_dur" class="input" type="number" min="5" value="60" placeholder="Minutes" />
        <button class="btn" onclick="createAuction()">Create</button>
      </div>
    </div>
    <table class="table">
      <thead><tr><th>Item</th><th>Qty</th><th>Start</th><th>Buy-now</th><th>Highest</th><th>Ends</th><th>Actions</th></tr></thead>
      <tbody>
        ${list.map(a=>`<tr>
          <td>${a.name}</td><td>${a.qty}</td>
          <td>${Math.floor(a.start_price_s/100)}g ${a.start_price_s%100}s</td>
          <td>${a.buy_now_price_s!=null?`${Math.floor(a.buy_now_price_s/100)}g ${a.buy_now_price_s%100}s`:'—'}</td>
          <td>${a.highest_bid_s!=null?`${Math.floor(a.highest_bid_s/100)}g ${a.highest_bid_s%100}s`:'—'}</td>
          <td>${new Date(a.end_time).toLocaleString()}</td>
          <td class="row">
            <input id="bidg_${a.id}" class="input" type="number" min="0" placeholder="g" />
            <input id="bids_${a.id}" class="input" type="number" min="0" max="99" placeholder="s" />
            <button class="btn" onclick="bid(${a.id})">Bid</button>
            ${a.buy_now_price_s!=null?`<button class=\"btn\" onclick=\"buyNow(${a.id})\">Buy now</button>`:''}
            <button class="btn" onclick="cancelAuction(${a.id})">Cancel</button>
          </td>
        </tr>`).join('')}
      </tbody>
    </table>
  `;
}
async function createAuction(){
  const payload={
    code: $('#ac_code').value.trim(),
    qty:  parseInt($('#ac_qty').value||'1',10),
    start_gold: parseInt($('#ac_sg').value||'0',10),
    start_silver: parseInt($('#ac_ss').value||'0',10),
    buy_gold: parseInt($('#ac_bg').value||'0',10),
    buy_silver: parseInt($('#ac_bs').value||'0',10),
    duration_min: parseInt($('#ac_dur').value||'60',10)
  };
  try{ await api('/api/auctions/create',{method:'POST',body:JSON.stringify(payload)}); loadAuctions(); }
  catch(e){ alert(e.message); }
}
async function bid(id){
  const g=parseInt($('#bidg_'+id).value||'0',10), s=parseInt($('#bids_'+id).value||'0',10);
  try{ await api(`/api/auctions/${id}/bid`,{method:'POST',body:JSON.stringify({gold:g,silver:s})}); loadAuctions(); }
  catch(e){ alert(e.message); }
}
async function buyNow(id){ try{ await api(`/api/auctions/${id}/buy-now`,{method:'POST',body:JSON.stringify({})}); loadAuctions(); }catch(e){ alert(e.message); } }
async function cancelAuction(id){ try{ await api(`/api/auctions/${id}/cancel`,{method:'POST',body:JSON.stringify({})}); loadAuctions(); }catch(e){ alert(e.message); } }

// init
showAuth('login');
me();
</script>
</body>
</html>
