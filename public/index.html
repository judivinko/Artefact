<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ARTEFACT</title>
  <link rel="stylesheet" href="/app.css"/>
  <style>
    .tabs{display:flex;gap:8px;margin:8px 0}
    .tab{padding:8px 14px;border-radius:10px;background:#0f172a;border:1px solid #26334a;cursor:pointer}
    .tab.active{background:#0b1220;color:#93c5fd;border-color:#33507a}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}
    .card{background:#0b1220;border:1px solid #26334a;border-radius:12px;padding:12px}
    .list{max-height:420px;overflow:auto;border:1px solid #223049;border-radius:10px}
    .li{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid #182132}
    .li:last-child{border-bottom:0}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .pill{font-size:11px;padding:2px 6px;border-radius:999px;background:#132030;color:#9cc1ff;margin-left:8px}
    .btn{padding:8px 12px;border-radius:10px;background:#16a34a;color:#041018;border:0;cursor:pointer}
    .btn.secondary{background:#0f172a;color:#cbd5e1;border:1px solid #2a3b55}
    .btn.danger{background:#b91c1c;color:#fff}
    .btn.small{padding:6px 10px;font-size:13px}
    .input{padding:8px 10px;border-radius:10px;border:1px solid #26334a;background:#0b1220;color:#e2e8f0}
    .muted{opacity:.85}
    .right{float:right}
    .title{font-weight:700;margin:0 0 8px}
    .hint{font-size:12px;opacity:.85}
    .space{height:8px}
  </style>
</head>
<body>
  <header class="header">
    <div class="brand">ARTEFACT</div>
    <div>
      <span id="who" class="muted">—</span>
      <span id="wallet" class="pill">0g 0s</span>
      <span id="next" class="pill">Buys to next recipe: —</span>
      <button id="btn-logout" class="btn secondary small">Log out</button>
      <a class="btn secondary small" href="/admin" style="margin-left:8px">Admin</a>
    </div>
  </header>

  <main class="container">
    <!-- AUTH -->
    <section id="auth" class="card" style="display:none">
      <div class="title">Login / Register</div>
      <div class="row">
        <input id="auth-email" class="input" placeholder="email"/>
        <input id="auth-pass" class="input" placeholder="password" type="password"/>
        <button id="btn-login" class="btn">Login</button>
        <button id="btn-register" class="btn secondary">Register</button>
      </div>
      <div id="auth-msg" class="muted" style="margin-top:6px"></div>
    </section>

    <!-- NAV -->
    <div class="tabs">
      <button class="tab active" data-tab="shop">Shop</button>
      <button class="tab" data-tab="craft">Crafting</button>
      <button class="tab" data-tab="sales">Sales</button>
      <button class="tab" data-tab="inv">Inventory</button>
    </div>

    <!-- SHOP -->
    <section id="tab-shop" class="card">
      <div class="title">Shop (T1 only)</div>
      <p class="muted">Each purchase costs <b>1 gold</b> (100 silver). You either get a random T1 material or a weighted recipe drop (T2–T5/T6: 800/150/37/12/1 per 1000).</p>
      <button id="btn-buy-t1" class="btn">Buy T1 Pack (1g)</button>
      <div id="shop-msg" class="muted" style="margin-top:8px"></div>
    </section>

    <!-- CRAFTING -->
    <section id="tab-craft" class="grid2" style="display:none">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="title">Recipes you own</div>
          <div class="row">
            <input id="recipes-filter" class="input" style="width:220px" placeholder="filter by name…"/>
            <button id="btn-recipes-refresh" class="btn secondary small">Refresh</button>
          </div>
        </div>
        <div id="recipes" class="list">—</div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div class="title">Details</div>
          <button id="btn-craft-artefact" class="btn small">Craft ARTEFACT (10× distinct T5)</button>
        </div>
        <div id="recipe-details" class="muted">Select a recipe on the left.</div>
      </div>
    </section>

    <!-- SALES -->
    <section id="tab-sales" class="grid2" style="display:none">
      <div class="card">
        <div class="title">Create Sale</div>
        <input id="inv-search" class="input" style="width:100%;margin-bottom:8px" placeholder="Search your inventory…"/>
        <div id="inv-list" class="list">—</div>

        <div class="space"></div>
        <div class="row">
          <input id="price-g" class="input" style="width:120px" placeholder="Gold"/>
          <input id="price-s" class="input" style="width:140px" placeholder="Silver (0–99)"/>
          <input id="price-q" class="input" style="width:80px" placeholder="Qty"/>
          <button id="btn-list-sale" class="btn">List for sale</button>
        </div>
        <div id="sale-msg" class="muted" style="margin-top:8px">Uses fixed-price sales (Buy-Now). Start price = Buy-Now.</div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="title">Marketplace</div>
          <input id="mkt-search" class="input" style="width:260px" placeholder="Search by name…"/>
        </div>
        <div id="mkt-list" class="list">—</div>

        <div class="space"></div>
        <div class="row" style="justify-content:space-between">
          <div class="title">My listings</div>
          <button id="btn-my-reload" class="btn secondary small">Reload</button>
        </div>
        <div id="my-sales" class="list">—</div>
      </div>
    </section>

    <!-- INVENTORY -->
    <section id="tab-inv" class="card" style="display:none">
      <div class="title">Inventory</div>
      <div id="inv-view" class="list">—</div>
    </section>
  </main>

<script>
const $ = s => document.querySelector(s);
const el = s => document.createElement(s);

function setTabs(active){
  document.querySelectorAll('.tab').forEach(t=>{
    const ok = t.dataset.tab===active;
    t.classList.toggle('active', ok);
  });
  ['shop','craft','sales','inv'].forEach(id=>{
    $('#tab-'+id).style.display = (id===active)?'grid':(id==='shop'?'block':'none');
  });
}

async function api(path, opts={}){
  const res = await fetch(path, { credentials:'include', headers:{'Content-Type':'application/json'}, ...opts});
  let data = null; try{ data = await res.json(); }catch{}
  if(!res.ok) throw new Error((data && data.error) || ('HTTP '+res.status));
  return data;
}

function fmtMoney(s){ s = s|0; return `${Math.floor(s/100)}g ${s%100}s`; }

async function loadMe(){
  try{
    const r = await api('/api/me');
    const u = r.user;
    $('#auth').style.display = 'none';
    $('#who').textContent = u.email;
    $('#wallet').textContent = `${u.gold}g ${u.silver}s`;
    $('#next').textContent = 'Buys to next recipe: ' + (u.buys_to_next==null?'—':u.buys_to_next);
  }catch{
    $('#auth').style.display = 'block';
  }
}

/* -------- AUTH -------- */
$('#btn-login').onclick = async()=>{
  try{
    const email=$('#auth-email').value.trim(), password=$('#auth-pass').value;
    await api('/api/login',{method:'POST',body:JSON.stringify({email,password})});
    $('#auth-msg').textContent = 'Logged in.'; await loadMe(); setTabs('shop'); refreshAll();
  }catch(e){ $('#auth-msg').textContent = e.message; }
};
$('#btn-register').onclick = async()=>{
  try{
    const email=$('#auth-email').value.trim(), password=$('#auth-pass').value;
    await api('/api/register',{method:'POST',body:JSON.stringify({email,password})});
    $('#auth-msg').textContent = 'Registered. Now log in.';
  }catch(e){ $('#auth-msg').textContent = e.message; }
};
$('#btn-logout').onclick = async()=>{ try{ await api('/api/logout'); location.reload(); }catch{} };

/* -------- NAV -------- */
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{ setTabs(t.dataset.tab); if(t.dataset.tab==='craft') loadRecipes(); if(t.dataset.tab==='sales'){ loadInventoryForSales(); loadMarketplace(); loadMySales(); } if(t.dataset.tab==='inv') loadInventoryView(); };
});

/* -------- SHOP -------- */
$('#btn-buy-t1').onclick = async()=>{
  try{
    const r = await api('/api/shop/buy-t1',{method:'POST'});
    if(r.result_type==='RECIPE'){
      $('#shop-msg').textContent = `Got recipe: ${r.grantedRecipe.name} [T${r.grantedRecipe.tier}]`;
    }else{
      $('#shop-msg').textContent = `Got item: ${r.addedItem.name}`;
    }
    $('#wallet').textContent = `${r.gold}g ${r.silver}s`;
  }catch(e){ alert(e.message); }
};

/* -------- CRAFTING -------- */
let RECIPES_CACHE = [];
async function loadRecipes(){
  try{
    const r = await api('/api/my/recipes');
    RECIPES_CACHE = r.recipes||[];
    renderRecipes();
  }catch(e){ $('#recipes').textContent = e.message; }
}
function renderRecipes(){
  const q = ($('#recipes-filter').value||'').toLowerCase();
  const box = $('#recipes'); box.innerHTML='';
  const list = RECIPES_CACHE.filter(x=>!q || x.name.toLowerCase().includes(q));
  if(!list.length){ box.textContent='No recipes.'; return; }
  list.forEach(r=>{
    const row = el('div'); row.className='li';
    const left = el('div'); left.textContent = r.name;
    const tag = el('span'); tag.className='pill'; tag.textContent = 'T'+r.tier; left.appendChild(tag);
    const qty = el('span'); qty.className='pill'; qty.textContent = 'x'+(r.qty||0); left.appendChild(qty);
    const btn = el('button'); btn.className='btn small'; btn.textContent='Open';
    btn.onclick = ()=> openRecipe(r.id);
    row.append(left,btn); box.appendChild(row);
  });
}
$('#recipes-filter').oninput = renderRecipes;
$('#btn-recipes-refresh').onclick = loadRecipes;

async function openRecipe(id){
  try{
    const r = await api('/api/recipes/'+id);
    const box = $('#recipe-details'); box.innerHTML='';
    if(!r || !r.recipe){ box.textContent='Recipe not found.'; return; }
    const h = el('div'); h.innerHTML = `<div class="title">${r.recipe.name} <span class="pill">T${r.recipe.tier}</span></div>`;
    const ul = el('div'); ul.className='list';
    (r.ingredients||[]).forEach(ing=>{
      const li = el('div'); li.className='li';
      li.innerHTML = `
        <div>${ing.name || ing.code}<span class="pill">T${ing.tier||'?'}</span></div>
        <div>${ing.have_qty||0} / ${ing.need_qty||1}</div>
      `;
      ul.appendChild(li);
    });
    const craftBtn = el('button'); craftBtn.className='btn'; craftBtn.textContent='Craft';
    craftBtn.onclick = async()=>{
      try{
        const out = await api('/api/recipes/'+id+'/craft',{method:'POST'});
        if(out.crafted){
          alert('Crafted: '+(out.output?.name || r.recipe.name));
          loadInventoryView(); loadRecipes();
        }else if(out.scrap){
          alert('Craft failed → Scrap received.');
          loadInventoryView();
        }
      }catch(e){ alert(e.message); }
    };
    box.append(h, ul, el('div'), craftBtn);
  }catch(e){ alert(e.message); }
}
$('#btn-craft-artefact').onclick = async()=>{
  try{
    const r = await api('/api/craft/artefact',{method:'POST'});
    alert(r.message || 'Crafted ARTEFACT.');
    loadInventoryView();
  }catch(e){ alert(e.message); }
};

/* -------- SALES (fixed price) -------- */
let SALES_PICK = null;
async function loadInventoryForSales(){
  try{
    const r = await api('/api/my/inventory');
    const items=[...(r.items||[]),...((r.recipes||[]).map(x=>({...x, recipe:true}))||[])];
    renderInventoryForSales(items);
  }catch(e){ $('#inv-list').textContent=e.message; }
}
function renderInventoryForSales(items){
  const q = ($('#inv-search').value||'').toLowerCase();
  const box = $('#inv-list'); box.innerHTML='';
  items
    .filter(x=>x.qty>0)
    .filter(x=>!q || x.name.toLowerCase().includes(q))
    .sort((a,b)=> (a.tier-b.tier) || a.name.localeCompare(b.name))
    .forEach(x=>{
      const row = el('div'); row.className='li';
      const left = el('div');
      left.textContent = x.name+' ';
      const t=el('span'); t.className='pill'; t.textContent='T'+x.tier; left.appendChild(t);
      const qx=el('span'); qx.className='pill'; qx.textContent='x'+x.qty; left.appendChild(qx);
      const btn = el('button'); btn.className='btn small'; btn.textContent='Pick';
      btn.onclick=()=>{ SALES_PICK = x; $('#sale-msg').textContent='Selected: '+x.name; };
      row.append(left,btn); box.appendChild(row);
    });
}
$('#inv-search').oninput = ()=> renderInventoryForSales(SALES_PICK?[]:[]); // rerender on input (list is reloaded from API when entering tab)

$('#btn-list-sale').onclick = async()=>{
  try{
    if(!SALES_PICK) throw new Error('Pick an item/recipe first.');
    const gold = parseInt($('#price-g').value||'0',10)|0;
    const silver = parseInt($('#price-s').value||'0',10)|0;
    const qty = Math.max(1, parseInt($('#price-q').value||'1',10)|0);
    if(silver<0 || silver>99) throw new Error('Silver must be 0–99.');
    const body = { code: SALES_PICK.code, qty, gold, silver };
    const r = await api('/api/sales/create',{method:'POST',body:JSON.stringify(body)});
    $('#sale-msg').textContent = 'Listed: '+(r.sale?.name || SALES_PICK.name)+' @ '+fmtMoney(r.sale?.price_s || (gold*100+silver));
    SALES_PICK=null; $('#price-q').value=''; loadMarketplace(); loadMySales(); loadInventoryForSales();
  }catch(e){ alert(e.message); }
};

async function loadMarketplace(){
  const q = ($('#mkt-search').value||'').trim();
  try{
    const r = await api('/api/sales/live'+(q?('?search='+encodeURIComponent(q)):''));
    const box = $('#mkt-list'); box.innerHTML='';
    (r.sales||[]).forEach(s=>{
      const row = el('div'); row.className='li';
      const left = el('div'); left.textContent = s.name || s.code;
      const t=el('span'); t.className='pill'; t.textContent='T'+(s.tier||'?'); left.appendChild(t);
      const p=el('span'); p.className='pill'; p.textContent=fmtMoney(s.price_s||0); left.appendChild(p);
      const btn = el('button'); btn.className='btn small'; btn.textContent='Buy';
      btn.onclick = async()=>{ try{ await api('/api/sales/'+s.id+'/buy',{method:'POST'}); alert('Purchased.'); loadMe(); loadMarketplace(); }catch(e){ alert(e.message); } };
      row.append(left,btn); box.appendChild(row);
    });
    if(!(r.sales||[]).length) box.textContent='No listings.';
  }catch(e){ $('#mkt-list').textContent=e.message; }
}
$('#mkt-search').oninput = ()=> loadMarketplace();

async function loadMySales(){
  try{
    const r = await api('/api/sales/mine');
    const box = $('#my-sales'); box.innerHTML='';
    (r.sales||[]).forEach(s=>{
      const row = el('div'); row.className='li';
      const left = el('div'); left.textContent = (s.name||s.code)+' ';
      const q=el('span'); q.className='pill'; q.textContent='x'+(s.qty||1); left.appendChild(q);
      const p=el('span'); p.className='pill'; p.textContent=fmtMoney(s.price_s||0); left.appendChild(p);
      const st=el('span'); st.className='pill'; st.textContent=s.status; left.appendChild(st);
      const btn = el('button'); btn.className='btn small secondary'; btn.textContent='Cancel';
      btn.disabled = (s.status!=='live');
      btn.onclick = async()=>{ try{ await api('/api/sales/'+s.id+'/cancel',{method:'POST'}); loadMySales(); loadMarketplace(); loadInventoryForSales(); }catch(e){ alert(e.message); }};
      row.append(left,btn); box.appendChild(row);
    });
    if(!(r.sales||[]).length) box.textContent='No listings.';
  }catch(e){ $('#my-sales').textContent=e.message; }
}
$('#btn-my-reload').onclick = loadMySales;

/* -------- INVENTORY VIEW -------- */
async function loadInventoryView(){
  try{
    const r = await api('/api/my/inventory');
    const box = $('#inv-view'); box.innerHTML='';
    const items=[...(r.items||[]),...((r.recipes||[]).map(x=>({...x, recipe:true}))||[])];
    if(!items.length){ box.textContent='(empty)'; return; }
    items.sort((a,b)=> (a.tier-b.tier) || a.name.localeCompare(b.name))
      .forEach(x=>{
        const row = el('div'); row.className='li';
        row.innerHTML = `<div>${x.name}<span class="pill">T${x.tier}</span></div><div>x${x.qty}</div>`;
        box.appendChild(row);
      });
  }catch(e){ $('#inv-view').textContent=e.message; }
}

/* -------- INIT -------- */
function refreshAll(){ loadInventoryView(); loadRecipes(); }
(async()=>{ await loadMe(); refreshAll(); })();
</script>
</body>
</html>
