<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ARTEFACT</title>

  <style>
    html,body {
      background:#000;
      color:#e5e7eb;
      margin:0;
    }
  </style>

  <!-- PAYPAL SDK LOADER (NE DIRAM) -->
  <script>
  (async function loadPayPalSDK(){
    try {
      const r = await fetch("/api/paypal/config", { credentials: "include" });
      const j = await r.json().catch(()=>null);

      if (!r.ok || !j?.ok || !j?.client_id) {
        console.warn("PayPal not configured:", j?.error || r.status);
        window.__PAYPAL_DISABLED__ = true;
        return;
      }

      const qs = new URLSearchParams({
        "client-id": j.client_id,
        "currency": j.currency || "USD",
        "intent": "capture",
        "components": "buttons"
      });

      const s = document.createElement("script");
      s.src = `https://www.paypal.com/sdk/js?${qs.toString()}`;
      s.async = true;
      s.onload = () => { window.__PAYPAL_READY__ = true; };
      document.head.appendChild(s);

      window.__PAYPAL_MIN_USD__ = j.min_usd || 1;

    } catch(e) {
      console.warn("PayPal SDK load failed:", e);
      window.__PAYPAL_DISABLED__ = true;
    }
  })();
  </script>

  <link rel="stylesheet" href="/app.css" />
</head>

<body>

<div id="app">

<!-- HEADER -->
<header class="header no-border" style="padding:14px 20px;">
  <div class="brand" style="font-size:22px; font-weight:700; letter-spacing:1px;">
    ARTEFACT
  </div>

  <div class="row" style="gap:12px; align-items:center;">

    <span id="balance" class="badge hidden"
          style="padding:6px 14px; font-size:16px;
                 background:rgba(255,255,255,0.08);
                 border:1px solid rgba(255,255,255,0.15);
                 backdrop-filter:blur(6px);">
      0g 0s
    </span>

    <span id="balance-dollar" class="badge hidden"
          style="padding:6px 14px; font-size:16px;
                 background:rgba(34,197,94,0.12);
                 border:1px solid rgba(34,197,94,0.25);
                 color:#4ade80;
                 backdrop-filter:blur(6px);">
      $0.00
    </span>

    <button id="btn-open-paypal"   class="btn secondary hidden">PayPal</button>
    <button id="btn-open-register" class="btn secondary">Register</button>
    <button id="btn-open-login"    class="btn">Log in</button>
    <button id="btn-logout"        class="btn muted hidden">Log out</button>

  </div>
</header>

<!-- PAYPAL PANEL -->
<section id="paypal-panel" class="card hidden">
  <div class="row" style="align-items:center; gap:8px; flex-wrap:wrap">
    <label for="pp-amount" class="label" style="margin:0">Amount (USD)</label>
    <input id="pp-amount" class="input" type="number" min="1" step="1" value="1"
           placeholder="USD" style="width:120px">

    <label for="pp-bonus" class="label" style="margin:0">Bonus code</label>
    <input id="pp-bonus" class="input" type="text" maxlength="32"
           placeholder="optional" style="width:240px">
  </div>

  <div class="row" style="margin-top:10px">
    <div id="paypal-button-container"></div>
  </div>

  <div id="pp-msg" class="muted" style="margin-top:8px"></div>
</section>

<!-- AUTH -->
<section id="auth" class="card hidden">
  <div id="card-register" class="auth-box hidden">
    <div class="label">Register</div>
    <input id="reg-email" class="input" type="email" placeholder="email@example.com">
    <input id="reg-pass" class="input" type="password" placeholder="password (min 6)">
    <button id="btn-register" class="btn">Register</button>
    <div id="reg-msg" class="muted"></div>
  </div>

  <div id="card-login" class="auth-box hidden">
    <div class="label">Log in</div>
    <input id="log-email" class="input" type="email" placeholder="email@example.com">
    <input id="log-pass" class="input" type="password" placeholder="password">
    <button id="btn-login" class="btn secondary">Log in</button>
    <div id="log-msg" class="muted"></div>
  </div>
</section>

<!-- TAB BAR -->
<div class="tabbar row">
  <div class="chip active" data-tab="shop">Shop</div>
  <div class="chip" data-tab="quest">Quest</div>
  <div class="chip" data-tab="craft">Crafting</div>
  <div class="chip" data-tab="market">Market</div>
  <div class="chip" data-tab="inv">Inventory</div>
  <div class="chip" data-tab="bonus">Bonus</div>
  <div class="chip" data-tab="ads">Ads</div>
</div>

<!-- SHOP TAB -->
<div id="tab-shop" class="tab card">

  <div class="label" style="margin-bottom:12px;">Shop</div>

  <div class="card" style="padding:10px;margin-bottom:16px;">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="label">Buy T1</div>
      <span class="badge">Price: <span id="shop-price-inline">100</span>s</span>
    </div>

    <div class="muted" style="margin-top:6px;">
      Buys to next recipe: <span id="buysToNext">—</span>
    </div>

    <div class="row" style="margin-top:10px; gap:10px; align-items:center;">
      <input id="buy-t1-qty"
             type="number"
             class="input"
             placeholder="qty (1–99999)"
             min="1"
             max="99999"
             style="width:130px;" />
      <button id="btn-buy-t1" class="btn" style="padding-left:24px;padding-right:24px;">
        Buy
      </button>
    </div>

    <div id="shop-msg" class="muted" style="margin-top:8px"></div>
  </div>

  <div style="margin:6px 0;">
    <span id="shop-balance" class="badge hidden">0g 0s</span>
  </div>

  <div id="shop-intro" class="card" style="margin-top:12px">
    <div class="label" style="line-height:1.2;margin-bottom:6px">GAME</div>

    <p class="muted" style="max-width:820px">
      You collect materials, unlock recipes, and craft increasingly powerful items (T2 → T5).
      When you gather <b>10 different T5</b>, you can assemble an <b>ARTEFACT</b> that grants you a gold bonus.
    </p>

    <div class="grid" style="margin-top:12px;">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="label">1) Shop</div>
          <span class="badge">Price: <span id="shop-price-badge">100s</span></span>
        </div>

        <p class="muted">
          In the Shop, you buy <b>T1 materials</b>, and occasionally you also receive <b>recipes</b>.
          Materials are ingredients for crafting, while recipes unlock higher tiers.
        </p>

        <img src="/t1_bronze.png" class="img-landing" />
        <img src="/recipe.png" class="img-landing" />
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px;">
    <div class="label">2) Crafting</div>
    <p class="muted">With a recipe and the required materials, you can craft <b>T2 → T5</b>.</p>
    <img src="/t2_golden_ring.png" class="img-landing">
    <img src="/t3_gate_of_might.png" class="img-landing">
    <img src="/t4_engine_core.png" class="img-landing">
    <img src="/t5_ancient_relic.png" class="img-landing">
  </div>

  <div class="card" style="margin-top:16px;">
    <div class="label">3) Market</div>
    <p class="muted">Trade items with other players.</p>
  </div>

  <div class="card" style="margin-top:16px;">
    <div class="label">4) Artefact</div>
    <p class="muted">Craft 10 distinct T5 items to unlock.</p>
    <img src="/artefakt.png" class="img-landing">
  </div>

</div>
<!-- ===== QUEST TAB ===== -->
<div id="tab-quest" class="tab card hidden">

  <div class="label" style="margin-bottom:8px;">Daily Quests</div>
  <div id="quest-list-daily" class="column" style="gap:8px"></div>
  <div id="quest-msg-daily" class="muted" style="margin-top:12px"></div>

  <hr style="border:none;border-top:1px solid #233047;margin:20px 0;" />

  <div class="label" style="margin-bottom:8px;">Lifetime Quests</div>
  <div id="quest-list-lifetime" class="column" style="gap:8px"></div>
  <div id="quest-msg-lifetime" class="muted" style="margin-top:12px"></div>

</div>


<!-- ===== CRAFTING TAB ===== -->
<div id="tab-craft" class="tab card hidden">

  <div class="row">
    <div class="label">Crafting</div>
    <span id="craft-perk" class="badge muted" title="Crafting fail chance">10% fail</span>

    <button id="btn-artefact" class="btn right">
      <img src="/artefakt.png" class="img-cell"
           onerror="this.onerror=null;this.style.display='none'">
      Craft ARTEFACT (10× distinct T5)
    </button>
  </div>

  <div class="grid">

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="label">Recipes you own</div>
        <div class="row">
          <input id="filter-recipe" class="input" placeholder="filter by name..." style="width:220px"/>
          <button id="btn-refresh-rec" class="btn muted">Refresh</button>
        </div>
      </div>
      <div id="recipes" class="list">Loading…</div>
    </div>

    <div class="card">
      <div class="label">Details</div>
      <div id="rec-details" class="list">Select a recipe on the left.</div>
    </div>

  </div>

</div>


<!-- ===== MARKET TAB ===== -->
<section id="tab-market" class="card hidden">
  <div class="label">Marketplace</div>

  <div class="grid">

    <div class="card">
      <div class="label">Create Sale</div>

      <input id="inv-search" class="input" placeholder="Search your inventory..." />
      <div id="inv-list" class="list" style="margin-top:8px; max-height:300px">Loading…</div>

      <div class="row" style="margin-top:8px">
        <input id="price-g"   class="input" style="width:100px" placeholder="Gold"/>
        <input id="price-s"   class="input" style="width:120px" placeholder="Silver (0–99)"/>
        <input id="price-qty" class="input" style="width:100px" placeholder="Qty"/>
        <button id="btn-list" class="btn">List for sale</button>
      </div>

      <div class="row muted" style="margin-top:6px; gap:8px">
        <span id="market-fee-inline" class="badge">Fee: 1%</span>
        <span id="market-min-inline" class="badge hidden">Min: 90s</span>
      </div>

      <div id="list-msg" class="muted" style="margin-top:6px"></div>
    </div>

    <div class="card">
      <div class="row" style="gap:10px; align-items:center">
        <div class="label">Marketplace</div>
        <input id="market-q" class="input" placeholder="Search by name..." style="width:240px" />
      </div>

      <div id="market" class="list">Loading…</div>

      <div class="row" style="gap:10px; align-items:center; margin-top:12px">
        <div class="label">My listings</div>
        <input id="mine-q" class="input" placeholder="Search my listings..." style="width:240px" />
        <button id="btn-mine" class="btn muted">Reload</button>
      </div>

      <div id="mine" class="list">Loading…</div>
    </div>

  </div>
</section>


<!-- ===== INVENTORY TAB ===== -->
<section id="tab-inv" class="card hidden">
  <div class="label" style="margin-bottom:12px;">Inventory</div>

  <div class="grid">

    <div class="card">
      <div class="label">Items</div>
      <div id="inv-items" class="list" style="max-height:340px; overflow:auto;">
        Loading…
      </div>
    </div>

    <div class="card">
      <div class="label">Recipes</div>
      <div id="inv-recipes" class="list" style="max-height:340px; overflow:auto;">
        Loading…
      </div>
    </div>

  </div>
</section>


<!-- ===== BONUS TAB ===== -->
<div id="tab-bonus" class="tab card hidden">

  <div class="row" style="justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap">
    <div class="label">Bonus</div>

    <div class="row" style="gap:8px; align-items:center; flex-wrap:wrap">
      <input id="transfer-email" class="input" type="email"
             placeholder="email@example.com" style="min-width:220px">
      <input id="transfer-gold" class="input" type="number" inputmode="numeric"
             placeholder="Gold" style="width:120px">
      <button id="btn-transfer" class="btn">Send</button>
    </div>

    <span id="bonus-lock" class="badge hidden">Locked — craft ARTEFACT to unlock</span>
  </div>

  <div id="bonus-grid" class="grid" style="margin-top:8px">

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="label">T2 Bonus</div>
        <button id="btn-claim-t2" class="btn" disabled>Claim</button>
      </div>
      <div class="muted" style="margin:4px 0 6px">Shop price 98s (was 100s)</div>
      <div id="bonus-t2" class="list" style="max-height:240px">Loading…</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="label">T3 Bonus</div>
        <button id="btn-claim-t3" class="btn" disabled>Claim</button>
      </div>
      <div class="muted" style="margin:4px 0 6px">Market fee 0% (was 1%)</div>
      <div id="bonus-t3" class="list" style="max-height:240px">Loading…</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="label">T4 Bonus</div>
        <button id="btn-claim-t4" class="btn" disabled>Claim</button>
      </div>
      <div class="muted" style="margin:4px 0 6px">Shop price 90s + Craft no-fail</div>
      <div id="bonus-t4" class="list" style="max-height:240px">Loading…</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="label">T5 Bonus</div>
        <button id="btn-claim-t5" class="btn" disabled>Claim</button>
      </div>
      <div class="muted" style="margin:4px 0 6px">
        Shop price 90s + Recipe drops T3 + Craft no-fail
      </div>
      <div id="bonus-t5" class="list" style="max-height:240px">Loading…</div>
    </div>

  </div>

</div>
<!-- ===== GLOBAL UTILITY / API WRAPPER ===== -->
<script>
(function(){
  const W = window;

  // Shortcuts
  W.$  = (s, r=document) => r.querySelector(s);
  W.$$ = (s, r=document) => Array.from(r.querySelectorAll(s));

  // Toast
  W.showToast = function(msg){
    const box = $("#toast");
    if(!box){
      console.warn("TOAST:", msg);
      return;
    }
    box.textContent = String(msg);
    box.classList.remove("hidden");
    clearTimeout(box._t);
    box._t = setTimeout(()=> box.classList.add("hidden"), 2500);
  };

  // Wrapper for all API calls (jedini ostaje)
  W.api = async function(path, opts={}){
    const method  = (opts.method || "GET").toUpperCase();
    const headers = { ...(opts.headers || {}) };

    const init = {
      ...opts,
      method,
      credentials:"include",
      headers
    };

    // Auto-encode JSON body
    if(init.body && typeof init.body==="object" && !(init.body instanceof FormData)){
      headers["Content-Type"] = headers["Content-Type"] || "application/json";
      init.body = JSON.stringify(init.body);
    }

    let res;
    try{
      res = await fetch(path, init);
    }catch(err){
      throw new Error("Network error");
    }

    const text = await res.text().catch(()=>null);
    let data;

    if(text && text.trim()){
      try{ data = JSON.parse(text); }
      catch{ data = { ok:false, error:"Invalid JSON" }; }
    } else {
      data = (res.status===204) ? {ok:true} : {};
    }

    if(!res.ok){
      const e = new Error(data.error || ("HTTP "+res.status));
      e.data = data;
      throw e;
    }

    return data;
  };

})();
</script>


<!-- ===== GLOBAL VARIABLES & REFRESH ===== -->
<script>
let WHO = null;
window.CURRENT_RECIPE_ID = null;

// Minimal light refresh — NE RADI duple pozive
window.refreshMeLight = async function(){
  try{
    const r = await api("/api/me");
    if(r?.user){
      WHO = r.user;
      renderBalance();
    }

    // lagani update — bez petlji
    if(document.querySelector(".chip.active")?.dataset.tab === "market"){
      loadInventoryPanel();
      loadMarket();
      loadMine();
    }

  }catch(e){
    console.warn("refreshMeLight failed:", e);
  }
};

function showApp(){
  $("#app")?.classList.remove("hidden");
}

function renderBalance(){
  const silver = WHO?.balance_silver || 0;
  const g = Math.floor(silver/100);
  const s = silver % 100;

  const bal = $("#balance");
  if(bal){
    bal.classList.remove("hidden");
    bal.textContent = `${g}g ${s}s`;
    bal.classList.add("pulse");
    setTimeout(()=>bal.classList.remove("pulse"), 800);
  }

  const usd = $("#balance-dollar");
  if(usd){
    usd.classList.remove("hidden");
    usd.textContent = `$${(g/1000).toFixed(2)}`;
  }
}

function applyPerkIndicators(){
  const price = WHO?.perks?.shop_price_s ?? 100;
  $("#shop-price-badge").textContent = price+"s";
  $("#shop-price-inline").textContent = price;

  const noFail = !!WHO?.perks?.craft_no_fail;
  $("#craft-perk").textContent = noFail ? "No fail" : "10% fail";

  const fee = WHO?.perks?.auction_fee_bps===0 ? "0%" : "1%";
  $("#market-fee-inline").textContent = `Fee: ${fee}`;

  const hasMin = !!WHO?.perks?.min_list_price_s;
  $("#market-min-inline").classList.toggle("hidden", !hasMin);
}
</script>


<!-- ===== TAB SISTEM ===== -->
<script>
async function setTab(tab){
  showApp();

  // Chip aktivacija
  $$(".chip").forEach(c => c.classList.toggle("active", c.dataset.tab===tab));

  // Prikaz tabova
  ["shop","quest","craft","market","inv","bonus","ads"].forEach(id=>{
    $("#tab-"+id)?.classList.toggle("hidden", id!==tab);
  });

  // Triggers
  if(tab==="quest"){ showQuestTab(); questTrigger("quest-click"); }
  if(tab==="shop")  questTrigger("shop-click");
  if(tab==="craft") questTrigger("craft-click");

  if(tab==="market"){
    loadInventoryPanel();
    loadMarket();
    loadMine();
  }

  if(tab==="inv")   loadInventoryFull();
  if(tab==="bonus") loadBonus();
  if(tab==="ads")   loadAdsPanel();
}
</script>


<!-- ===== AUTH SYSTEM ===== -->
<script>
async function loadMe(){
  try{
    const r = await api("/api/me");
    if(!r?.user) throw 0;

    WHO = r.user;
    renderBalance();
    applyPerkIndicators();

    setLoggedInUI();
    setTab("shop");

  }catch{
    WHO = null;
    setLoggedOutUI();
    setTab("shop");
  }
}

function openAuth(mode){
  const box = $("#auth");
  if(!box) return;

  box.classList.remove("hidden");

  $("#card-login").style.display    = (mode==="login"    ? "block" : "none");
  $("#card-register").style.display = (mode==="register" ? "block" : "none");

  if(mode==="login")    $("#log-email")?.focus();
  if(mode==="register") $("#reg-email")?.focus();
}

async function doRegister(){
  const msg = $("#reg-msg");
  try{
    const email = $("#reg-email").value.trim();
    const pass  = $("#reg-pass").value;

    if(!email || !pass) throw new Error("Enter email & password.");
    if(pass.length < 6)  throw new Error("Password too short.");

    msg.textContent = "…";
    await api("/api/register",{method:"POST",body:{email,password:pass}});
    msg.textContent = "OK — now log in.";

    $("#card-register").style.display="none";
    $("#card-login").style.display="block";
    $("#log-email").focus();

  }catch(e){
    msg.textContent = e.message;
  }
}

async function doLogin(){
  const msg = $("#log-msg");
  try{
    const email = $("#log-email").value.trim();
    const pass  = $("#log-pass").value;

    if(!email || !pass) throw new Error("Enter both fields.");

    msg.textContent = "…";
    await api("/api/login",{method:"POST",body:{email,password:pass}});

    await loadMe();
    msg.textContent = "OK";

  }catch(e){
    msg.textContent = e.message || "Login failed.";
  }
}

async function doLogout(){
  try{ await api("/api/logout"); }catch{}
  WHO = null;
  setLoggedOutUI();
  setTab("shop");
}

function setLoggedInUI(){
  $("#btn-open-register")?.classList.add("hidden");
  $("#btn-open-login")?.classList.add("hidden");
  $("#btn-open-paypal")?.classList.remove("hidden");
  $("#btn-logout")?.classList.remove("hidden");
}

function setLoggedOutUI(){
  $("#btn-open-register")?.classList.remove("hidden");
  $("#btn-open-login")?.classList.remove("hidden");
  $("#btn-open-paypal")?.classList.add("hidden");
  $("#btn-logout")?.classList.add("hidden");
}
</script>


<!-- ===== DOMContentLoaded ===== -->
<script>
document.addEventListener("DOMContentLoaded",()=>{

  // AUTH
  $("#btn-open-login")   ?.addEventListener("click", ()=>openAuth("login"));
  $("#btn-open-register")?.addEventListener("click", ()=>openAuth("register"));
  $("#btn-register")?.addEventListener("click", doRegister);
  $("#btn-login")   ?.addEventListener("click", doLogin);
  $("#btn-logout")  ?.addEventListener("click", doLogout);

  $("#reg-email")?.addEventListener("keydown", e=>e.key==="Enter"&&doRegister());
  $("#reg-pass") ?.addEventListener("keydown", e=>e.key==="Enter"&&doRegister());
  $("#log-email")?.addEventListener("keydown", e=>e.key==="Enter"&&doLogin());
  $("#log-pass") ?.addEventListener("keydown", e=>e.key==="Enter"&&doLogin());

  // Tabs
  $$(".chip").forEach(c=>{
    c.addEventListener("click", ()=> setTab(c.dataset.tab));
  });

  // Load session
  loadMe();
});
</script>
<!-- ===== SHOP ===== -->
<script>
async function loadShop(){
  if(!WHO) return;
  try{
    const r = await api("/api/shop/status");
    $("#buysToNext").textContent = r?.buysToNext ?? "—";
    $("#shop-price-inline").textContent = r?.price_s ?? 100;
    $("#shop-price-badge").textContent  = (r?.price_s ?? 100) + "s";
  }catch(e){
    console.warn("loadShop failed:", e);
  }
}

async function buyT1(){
  const qty = parseInt($("#buy-t1-qty").value)||0;
  const msg = $("#shop-msg");
  msg.textContent = "";

  if(qty<=0){
    msg.textContent = "Enter valid quantity.";
    return;
  }

  try{
    msg.textContent="…";
    await api("/api/shop/buy-t1",{
      method:"POST",
      body:{ qty }
    });
    msg.textContent="OK";
    await refreshMeLight();
    await loadShop();
  }catch(e){
    msg.textContent=e.message;
  }
}

$("#btn-buy-t1")?.addEventListener("click",buyT1);
</script>


<!-- ===== QUEST SYSTEM ===== -->
<script>
const QUESTS=[
  {id:"shop-click",     text:"Klikni na tab Shop",      reward:20},
  {id:"craft-click",    text:"Klikni na tab Crafting",  reward:20},
  {id:"market-click",   text:"Klikni na tab Market",    reward:20},
  {id:"inv-click",      text:"Klikni na tab Inventory", reward:20},
  {id:"bonus-click",    text:"Klikni na tab Bonus",     reward:20},
  {id:"craft-t2", text:"Iskraftaj T2 item", reward:20},
  {id:"craft-t3", text:"Iskraftaj T3 item", reward:20},
  {id:"craft-t4", text:"Iskraftaj T4 item", reward:20},
  {id:"craft-t5", text:"Iskraftaj T5 item", reward:20},
];

async function questTrigger(id){
  try{
    await api("/api/quest/trigger",{method:"POST",body:{id}});
    loadQuests();
  }catch{}
}

async function loadQuests(){
  try{
    const r=await api("/api/quest/status");
    const daily=r?.daily||[];
    const life =r?.lifetime||[];

    renderQuestList("#quest-list-daily",daily);
    renderQuestList("#quest-list-lifetime",life);
  }catch(e){
    console.warn("loadQuests failed:",e);
  }
}

function renderQuestList(sel,list){
  const box=$(sel);
  box.innerHTML="";
  for(const q of list){
    const row=document.createElement("div");
    row.className="row card";
    row.style.justifyContent="space-between";
    row.innerHTML=`
      <div>${q.text}</div>
      <button class="btn ${q.done?"muted":""}" ${q.done?"disabled":""}
        data-q="${q.id}">${q.done?"Done":"+20"}</button>
    `;
    box.appendChild(row);
  }

  box.querySelectorAll("button[data-q]").forEach(b=>{
    b.addEventListener("click",async()=>{
      const id=b.dataset.q;
      try{
        await api("/api/quest/claim",{method:"POST",body:{id}});
        loadQuests();
        refreshMeLight();
      }catch(e){
        showToast(e.message);
      }
    });
  });
}

function showQuestTab(){
  loadQuests();
}
</script>


<!-- ===== CRAFTING ===== -->
<script>
async function loadRecipes(){
  try{
    const r = await api("/api/recipes/list");
    renderRecipeList(r?.rows||[]);
  }catch(e){
    $("#recipes").textContent="Failed to load recipes.";
  }
}

function renderRecipeList(rows){
  const box=$("#recipes");
  const q=$("#filter-recipe").value.trim().toLowerCase();
  box.innerHTML="";

  for(const r of rows){
    if(q && !(r.name||"").toLowerCase().includes(q)) continue;

    const row=document.createElement("div");
    row.className="rowx card";
    row.style.cursor="pointer";
    row.innerHTML=`
      <img src="${r.icon||'/recipe.png'}" class="img-cell" />
      <div class="col">
        <div>${r.name}</div>
        <div class="muted">${r.code}</div>
      </div>
    `;
    row.addEventListener("click",()=>showRecipeDetails(r.id));
    box.appendChild(row);
  }
}

async function showRecipeDetails(id){
  CURRENT_RECIPE_ID=id;
  try{
    const r=await api("/api/recipes/details?recipe_id="+id);
    renderRecipeDetails(r);
  }catch(e){
    $("#rec-details").textContent="Failed.";
  }
}

function renderRecipeDetails(r){
  if(!r){
    $("#rec-details").textContent="Not found.";
    return;
  }

  let need="";
  for(const n of r.needs||[]){
    need+=`<div class="row" style="align-items:center">
      <img src="${n.icon}" class="img-cell"/>
      <span>${n.qty} × ${n.name}</span>
    </div>`;
  }

  $("#rec-details").innerHTML=`
    <div class="label">${r.name}</div>
    <div class="muted">Tier ${r.tier}</div>
    <div style="margin-top:12px">${need}</div>
    <button id="btn-craft" class="btn" style="margin-top:12px">Craft</button>
    <div id="craft-msg" class="muted" style="margin-top:6px"></div>
  `;

  $("#btn-craft")?.addEventListener("click",craftCurrent);
}

async function craftCurrent(){
  if(!CURRENT_RECIPE_ID) return;

  const msg=$("#craft-msg");
  msg.textContent="…";
  try{
    await api("/api/craft",{method:"POST",body:{recipe_id:CURRENT_RECIPE_ID}});
    msg.textContent="OK";
    questTrigger("craft-t2");
    questTrigger("craft-t3");
    questTrigger("craft-t4");
    questTrigger("craft-t5");
    refreshMeLight();
    loadRecipes();
  }catch(e){
    msg.textContent=e.message;
  }
}

$("#filter-recipe")?.addEventListener("input",loadRecipes);
$("#btn-refresh-rec")?.addEventListener("click",loadRecipes);
</script>
<!-- ===== MARKETPLACE ===== -->
<script>
async function loadMarket(){
  const box = $("#market");
  box.textContent = "Loading…";
  try{
    const q = ($("#market-q").value || "").trim();
    const r = await api("/api/sales/live" + (q ? "?q="+encodeURIComponent(q) : ""));
    const rows = r?.listings || [];
    if(!rows.length){ box.textContent="No listings."; return; }

    const frag = document.createDocumentFragment();

    for(const s of rows){
      if(s.code==="ARTEFACT" || (s.tier|0)>=6) continue;

      const ico = s.kind==="item"
        ? iconForByCode(s.code,s.tier)
        : RECIPE_ICON;

      const g = Math.floor((s.price_s|0)/100);
      const ss = (s.price_s|0)%100;

      const row = document.createElement("div");
      row.className="itemrow";

      row.innerHTML=`
        <div class="row" style="gap:10px;align-items:center">
          <img class="img-cell" src="${ico}">
          <div>${esc(s.name)} <span class="badge">T${s.tier}</span> <span class="muted">x${s.qty}</span></div>
        </div>
        <div class="row">
          <span class="badge">${g}g ${ss}s</span>
          ${s.seller_user_id===WHO?.id 
            ? `<button class="btn muted" disabled>My</button>`
            : `<button class="btn" data-buy="${s.id}">Buy</button>`}
        </div>
      `;

      frag.appendChild(row);
    }

    box.innerHTML="";
    box.appendChild(frag);

    box.querySelectorAll("[data-buy]").forEach(btn=>{
      btn.addEventListener("click",()=>buyMarketItem(btn.dataset.buy,btn));
    });

  }catch(e){
    box.textContent = e.message || "Failed.";
  }
}

async function buyMarketItem(id,btn){
  if(!WHO?.id) return showToast("Please log in.");

  const prev = btn.textContent;
  btn.disabled=true;
  btn.textContent="Buying…";

  try{
    const r = await api("/api/sales/buy",{method:"POST",body:{id}});
    if(r?.buyer_balance_silver!=null){
      WHO.balance_silver = r.buyer_balance_silver|0;
      renderBalance();
    }
    loadMarket();
    loadMine();
    loadInventoryPanel();
    showToast("Purchased.");
  }catch(e){
    showToast(e?.data?.error || e.message);
  }finally{
    btn.disabled=false;
    btn.textContent=prev;
  }
}


async function loadMine(){
  const box=$("#mine");
  box.textContent="Loading…";

  try{
    const r=await api("/api/sales/mine");
    let rows=r?.listings||[];
    const q=($("#mine-q").value||"").trim().toLowerCase();
    if(q) rows = rows.filter(x=> (x.name||"").toLowerCase().includes(q));

    rows = rows.filter(s=>s.status==="live");

    if(!rows.length){ box.textContent="No live listings."; return; }

    const frag = document.createDocumentFragment();

    for(const s of rows){
      const ico=s.kind==="item"?iconForByCode(s.code,s.tier):RECIPE_ICON;
      const g=Math.floor(s.price_s/100), ss=s.price_s%100;

      const row=document.createElement("div");
      row.className="itemrow";

      row.innerHTML=`
        <div class="row" style="gap:10px;align-items:center">
          <img src="${ico}" class="img-cell">
          <div>${esc(s.name)} <span class="badge">T${s.tier}</span> <span class="muted">x${s.qty}</span></div>
        </div>
        <div class="row">
          <span class="badge">${g}g ${ss}s</span>
          <button class="btn danger" data-cancel="${s.id}">Cancel</button>
        </div>
      `;

      frag.appendChild(row);
    }

    box.innerHTML="";
    box.appendChild(frag);

    box.querySelectorAll("[data-cancel]").forEach(btn=>{
      btn.addEventListener("click",()=>cancelListing(btn.dataset.cancel,btn));
    });

  }catch(e){
    box.textContent=e.message;
  }
}

async function cancelListing(id,btn){
  const prev=btn.textContent;
  btn.disabled=true;
  btn.textContent="…";

  try{
    await api("/api/sales/cancel",{method:"POST",body:{id}});
    loadMarket();
    loadMine();
    loadInventoryPanel();
  }catch(e){
    showToast(e.message);
  }finally{
    btn.disabled=false;
    btn.textContent=prev;
  }
}

async function handleList(){
  const sel = window.SEL_INV;
  if(!sel) return showToast("Pick item first.");

  let gold = parseInt($("#price-g").value)||0;
  let silver = parseInt($("#price-s").value)||0;
  let qty = parseInt($("#price-qty").value)||1;

  if(silver>99) silver=99;
  if(qty<1) qty=1;

  try{
    await api("/api/sales/list",{
      method:"POST",
      body:{
        kind:sel.kind,
        id:sel.id,
        qty,
        gold,
        silver
      }
    });
    $("#list-msg").textContent="Listed.";
    window.SEL_INV=null;
    loadMarket();
    loadMine();
    loadInventoryPanel();
    showToast("OK");
  }catch(e){
    $("#list-msg").textContent=e.message;
  }
}

$("#btn-list")?.addEventListener("click",handleList);
$("#market-q")?.addEventListener("input",loadMarket);
$("#mine-q")?.addEventListener("input",loadMine);
$("#btn-mine")?.addEventListener("click",loadMine);
</script>


<!-- ===== INVENTORY ===== -->
<script>
async function loadInventoryPanel(){
  const box=$("#inv-list");
  box.textContent="Loading…";

  try{
    const r=await api("/api/inventory");
    const q=($("#inv-search").value||"").trim().toLowerCase();

    const items=(r.items||[])
      .filter(x=>x.code!=="ARTEFACT" && (x.tier|0)<6)
      .filter(x=>!q || (x.name||"").toLowerCase().includes(q));

    const recipes=(r.recipes||[])
      .filter(x=>!q || (x.name||"").toLowerCase().includes(q));

    const frag=document.createDocumentFragment();

    const add=(arr,kind)=>{
      for(const it of arr){
        const ico = kind==="item" ? iconForByCode(it.code,it.tier) : RECIPE_ICON;

        const row=document.createElement("div");
        row.className="itemrow";
        row.innerHTML=`
          <div class="row" style="gap:10px;align-items:center">
            <img class="img-cell" src="${ico}">
            <div>${esc(it.name)} <span class="badge">T${it.tier}</span> <span class="muted">x${it.qty}</span></div>
          </div>
          <button class="btn muted pick-btn">Pick</button>
        `;

        row.querySelector(".pick-btn").addEventListener("click",()=>{
          window.SEL_INV={kind,id:it.id,name:it.name};
          $("#list-msg").textContent="Selected: "+it.name;
        });

        frag.appendChild(row);
      }
    };

    add(items,"item");
    add(recipes,"recipe");

    box.innerHTML = frag.childNodes.length ? "" : "Empty.";
    if(frag.childNodes.length) box.appendChild(frag);

  }catch(e){
    box.textContent=e.message;
  }
}

async function loadInventoryFull(){
  const box=$("#inv-items");
  const boxR=$("#inv-recipes");
  box.textContent="…";
  boxR.textContent="…";

  try{
    const r=await api("/api/inventory");
    box.innerHTML="";
    boxR.innerHTML="";

    for(const it of r.items||[]){
      const ico=iconForByCode(it.code,it.tier);
      box.innerHTML+=`
        <div class="itemrow">
          <div class="row" style="gap:10px;align-items:center">
            <img class="img-cell" src="${ico}">
            <div>${esc(it.name)} <span class="badge">T${it.tier}</span></div>
          </div>
          <div class="muted">x${it.qty}</div>
        </div>`;
    }

    for(const rc of r.recipes||[]){
      boxR.innerHTML+=`
        <div class="itemrow">
          <div class="row" style="gap:10px;align-items:center">
            <img class="img-cell" src="${RECIPE_ICON}">
            <div>${esc(rc.name)} <span class="badge">T${rc.tier}</span></div>
          </div>
          <div class="muted">x${rc.qty}</div>
        </div>`;
    }
  }catch(e){
    box.textContent=e.message;
  }
}

$("#inv-search")?.addEventListener("input",loadInventoryPanel);
</script>
<!-- ===== BONUS ===== -->
<script>
async function loadBonus(){
  const t2 = $("#bonus-t2");
  const t3 = $("#bonus-t3");
  const t4 = $("#bonus-t4");
  const t5 = $("#bonus-t5");
  const lock = $("#bonus-lock");

  t2.textContent="Loading…";
  t3.textContent="Loading…";
  t4.textContent="Loading…";
  t5.textContent="Loading…";

  try{
    const r = await api("/api/bonus/status");
    const hasArt = !!r?.has_artefact;
    lock.classList.toggle("hidden", hasArt);

    renderBonusTier(2, r?.tiers?.[2], t2);
    renderBonusTier(3, r?.tiers?.[3], t3);
    renderBonusTier(4, r?.tiers?.[4], t4);
    renderBonusTier(5, r?.tiers?.[5], t5);
  }catch(e){
    t2.textContent=e.message;
    t3.textContent=e.message;
    t4.textContent=e.message;
    t5.textContent=e.message;
  }
}

function renderBonusTier(tier, info, box){
  if(!info){
    box.textContent="No data.";
    return;
  }

  const tiles = [];

  for(const c of info.owned||[]){
    tiles.push(bonusTile(c,true,tier));
  }
  for(const c of info.missing||[]){
    tiles.push(bonusTile(c,false,tier));
  }

  box.innerHTML = tiles.join("") || "Empty.";

  const btn = $("#btn-claim-t"+tier);
  if(!btn) return;

  const canClaim =
    (info.missing?.length===0) &&
    !info.claimed &&
    (WHO?.has_artefact || false);

  btn.disabled = !canClaim;
  btn.textContent = info.claimed ? "Claimed" : "Claim";

  if(info.claimed) btn.classList.add("muted");
  else btn.classList.remove("muted");

  btn.onclick = async()=>{
    if(btn.disabled) return;

    const prev=btn.textContent;
    btn.disabled=true;
    btn.textContent="…";

    try{
      await api("/api/bonus/claim",{
        method:"POST",
        body:{ tier }
      });
      showToast(`T${tier} bonus claimed.`);
      loadBonus();
      refreshMeLight();
    }catch(e){
      showToast(e.message);
    }finally{
      btn.textContent=prev;
    }
  };
}

function bonusTile(name,ok,tier){
  const code = "T"+tier+"_"+name.toUpperCase();
  const ico = iconForByCode(code,tier);
  return `
    <div class="tile ${ok?'ok':'miss'}">
      <img class="img-cell" src="${ico}">
      <div>${esc(name.replace(/^T\d_/,""))}</div>
    </div>
  `;
}
</script>


<!-- ===== ADS ===== -->
<script>
async function loadAdsPanel(){
  const box = $("#ad-output");
  if(!box) return;
  box.textContent="Loading…";

  try{
    const r = await api("/api/ads/list");
    const rows = r?.ads || [];

    if(!rows.length){
      box.textContent="No ads yet.";
      return;
    }

    box.innerHTML = rows.map(ad=>`
      <div class="itemrow">
        <div class="muted" style="word-break:break-all">${esc(ad.text)}</div>
      </div>
    `).join("");

  }catch(e){
    box.textContent=e.message;
  }
}

async function submitAd(){
  const inp=$("#ad-text");
  const txt=inp.value.trim();
  if(!txt) return showToast("Enter text.");

  const btn=$("#btn-post-ad");
  const prev=btn.textContent;
  btn.disabled=true;
  btn.textContent="Posting…";

  try{
    const r = await api("/api/ads/create",{
      method:"POST",
      body:{ text:txt }
    });

    if(typeof r?.balance_silver==="number" && WHO){
      WHO.balance_silver=r.balance_silver;
      renderBalance();
    }

    inp.value="";
    showToast("Ad posted.");
    loadAdsPanel();
  }catch(e){
    showToast(e?.message || "Failed.");
  }finally{
    btn.disabled=false;
    btn.textContent=prev;
  }
}

async function buyCourse(){
  const btn=$("#btn-buy-course");
  if(!btn || btn.disabled) return;

  const prev=btn.textContent;
  btn.disabled=true;
  btn.textContent="Processing…";

  try{
    const r = await api("/api/ads/buy-course",{method:"POST"});

    if(typeof r?.balance_silver==="number" && WHO){
      WHO.balance_silver=r.balance_silver;
      renderBalance();
    }

    const code = r?.access_code ||
      ("COURSE-"+Math.random().toString(36).substr(2,6).toUpperCase());

    $("#course-msg").innerHTML=`
      <div><b>Course unlocked!</b></div>
      <div>Your code: <b>${code}</b></div>
    `;

    showToast("Course purchased.");
  }catch(e){
    showToast(e?.message || "Failed.");
  }finally{
    btn.disabled=false;
    btn.textContent=prev;
  }
}

document.addEventListener("click",(e)=>{
  if(e.target.id==="btn-post-ad") submitAd();
  if(e.target.id==="btn-buy-course") buyCourse();
});
</script>
</body>
</html>
