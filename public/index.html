<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ARTEFACT</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    :root{
      --bg:#0b1220; --card:#111a2b; --card2:#0e1728;
      --muted:#94a3b8; --text:#e2e8f0; --accent:#10b981;
      --accent-2:#38bdf8; --border:#203049;
      --danger:#ef4444; --warning:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1100px;margin:16px auto;padding:0 12px}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between;margin:6px 0 12px}
    .brand{font-weight:700;letter-spacing:.8px}
    .chip{border:1px solid var(--border);border-radius:12px;padding:4px 8px;font-size:12px;color:var(--muted)}
    .btn{background:var(--accent);color:#001b12;border:none;border-radius:9px;padding:8px 14px;cursor:pointer;font-weight:600}
    .btn.secondary{background:#1f2937;color:#cbd5e1}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn.danger{background:var(--danger);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .tabs{display:flex;gap:8px;margin:10px 0 12px}
    .tab{padding:8px 14px;border-radius:10px;background:#0f172a;border:1px solid var(--border);cursor:pointer}
    .tab.active{background:#10203c;color:#bfeafe;border-color:#35517a}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    input,select{background:var(--card2);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px 10px}
    input::placeholder{color:#7b8aa2}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:900px){.grid2{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #162038}
    th{color:#93c5fd;text-align:left;font-weight:600}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#122036;color:#a5b4fc}
    .right{float:right}
    .hidden{display:none !important}
    .listbox{max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:10px;background:var(--card2)}
    .h6{font-size:13px;color:#9fb2ce;margin:0 0 6px}
    .title{font-size:18px;font-weight:700;margin:4px 0 10px}
    .error{color:#fecaca}
    .ok{color:#bbf7d0}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">ARTEFACT</div>
      <div class="row">
        <span id="buysHint" class="chip hidden">Buys to next recipe: —</span>
        <span id="who" class="chip">Not logged in</span>
        <button id="btnLogout" class="btn secondary hidden">Log out</button>
      </div>
    </header>

    <!-- ============== AUTH FIRST ============== -->
    <section id="auth" class="card">
      <div class="title">Welcome</div>
      <p class="muted" style="margin-top:-6px">Please register or sign in to continue.</p>
      <div class="grid2" style="margin-top:10px">
        <div class="card" style="background:#0f172a">
          <div class="h6">Register</div>
          <div class="row">
            <input id="regEmail" type="email" placeholder="Email" style="min-width:280px">
            <input id="regPass" type="password" placeholder="Password (min 6)">
            <button id="btnRegister" class="btn">Register</button>
          </div>
          <div id="regMsg" class="muted"></div>
        </div>
        <div class="card" style="background:#0f172a">
          <div class="h6">Login</div>
          <div class="row">
            <input id="logEmail" type="email" placeholder="Email" style="min-width:280px">
            <input id="logPass" type="password" placeholder="Password">
            <button id="btnLogin" class="btn">Login</button>
          </div>
          <div id="logMsg" class="muted"></div>
        </div>
      </div>
    </section>

    <!-- ============== APP ============== -->
    <section id="app" class="hidden">
      <div class="tabs">
        <div class="tab active" data-tab="shop">Shop</div>
        <div class="tab" data-tab="craft">Crafting</div>
        <div class="tab" data-tab="sales">Sales (Marketplace)</div>
      </div>

      <!-- SHOP -->
      <div id="tab-shop" class="card">
        <div class="title">Shop (T1 only)</div>
        <p class="muted">Each purchase costs <b>1 gold</b> (100s). You either get a random T1 material or a recipe drop (T2–T5 weighted; rare chance T6).</p>
        <button id="btnBuyT1" class="btn">Buy T1 Pack (1g)</button>
        <div id="shopMsg" class="muted" style="margin-top:10px"></div>
      </div>

      <!-- CRAFTING -->
      <div id="tab-craft" class="card hidden">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="title" style="margin:0">Crafting</div>
          <div class="row">
            <button id="btnCraftRefresh" class="btn ghost">Refresh</button>
          </div>
        </div>
        <div class="grid2" style="margin-top:10px">
          <div>
            <div class="h6">Your recipes</div>
            <div id="recipesList" class="listbox"></div>
          </div>
          <div>
            <div class="h6">Recipe details</div>
            <div id="recipeView" class="card" style="background:#0f172a">Select a recipe on the left →</div>
          </div>
        </div>
      </div>

      <!-- SALES -->
      <div id="tab-sales" class="card hidden">
        <div class="title">Sales (fixed price)</div>
        <div class="grid2">
          <!-- LEFT -->
          <div>
            <div class="h6">Create listing</div>
            <input id="invSearch" placeholder="Search your inventory..." style="width:100%;margin-bottom:8px">
            <div id="invBox" class="listbox"></div>
          </div>
          <!-- RIGHT -->
          <div>
            <div class="h6">Live Listings</div>
            <input id="liveSearch" placeholder="Search by name..." style="width:100%;margin-bottom:8px">
            <div id="liveBox" class="listbox" style="margin-bottom:10px"></div>

            <div class="h6" style="margin-top:10px">My sales</div>
            <div class="row" style="justify-content:flex-end;margin-bottom:6px">
              <button id="btnReloadMine" class="btn ghost">Reload</button>
            </div>
            <div id="mineBox" class="listbox"></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ========= CONFIG / HELPERS =========
    const SALES_MODE = 'auctions'; // hard-force working mode (do NOT auto-detect)
    const $ = s => document.querySelector(s);
    const el = (tag, cls, html) => { const e=document.createElement(tag); if(cls) e.className=cls; if(html!=null) e.innerHTML=html; return e; };
    function fmtMoneyS(s){ const g=Math.floor(s/100), k=s%100; return `${g}g ${k}s`; }
    const notify = (m) => alert(m);
    async function api(path, opts={}){
      const res = await fetch(path, {credentials:'include', headers:{'Content-Type':'application/json'}, ...opts});
      let data=null; try{ data = await res.json(); }catch{}
      if(!res.ok || !data || data.ok===false){
        const msg = (data && (data.error||data.message)) || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data;
    }
    const timeLeft = (iso) => {
      const ms = new Date(iso) - new Date();
      if(ms<=0) return 'ended';
      const m = Math.floor(ms/60000), h=Math.floor(m/60), r=m%60;
      return h?`${h}h ${r}m`:`${m}m`;
    };

    // ========= STATE =========
    let ME = null;
    let RECIPES = [];
    let INV_ITEMS = [];  // {code,name,tier,qty} + recipes

    // ========= AUTH =========
    async function loadMe(){
      try{
        const r = await api('/api/me');
        ME = r.user;
        $('#auth').classList.add('hidden');
        $('#app').classList.remove('hidden');
        $('#btnLogout').classList.remove('hidden');
        $('#who').textContent = `${ME.email} — ${ME.gold}g ${ME.silver}s`;
        if (ME.buys_to_next!=null){
          $('#buysHint').classList.remove('hidden');
          $('#buysHint').textContent = `Buys to next recipe: ${ME.buys_to_next}`;
        }else{
          $('#buysHint').classList.add('hidden');
        }
        // initial data
        await Promise.all([loadRecipes(), loadInventory(), loadLive(), loadMine()]);
      }catch{
        $('#auth').classList.remove('hidden');
        $('#app').classList.add('hidden');
        $('#btnLogout').classList.add('hidden');
        $('#who').textContent = 'Not logged in';
      }
    }

    $('#btnRegister').onclick = async ()=>{
      $('#regMsg').textContent = '';
      try{
        const email = $('#regEmail').value.trim();
        const password = $('#regPass').value;
        await api('/api/register',{method:'POST',body:JSON.stringify({email,password})});
        $('#regMsg').textContent = 'Registered. You can log in now.';
      }catch(e){ $('#regMsg').textContent = e.message; }
    };
    $('#btnLogin').onclick = async ()=>{
      $('#logMsg').textContent = '';
      try{
        const email = $('#logEmail').value.trim();
        const password = $('#logPass').value;
        await api('/api/login',{method:'POST',body:JSON.stringify({email,password})});
        $('#logEmail').value=''; $('#logPass').value='';
        await loadMe();
      }catch(e){ $('#logMsg').textContent = e.message; }
    };
    $('#btnLogout').onclick = async ()=>{
      try{ await api('/api/logout'); }catch{}
      ME=null; await loadMe();
    };

    // ========= TABS =========
    document.querySelectorAll('.tab').forEach(t=>{
      t.onclick = ()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const key=t.dataset.tab;
        ['shop','craft','sales'].forEach(k=>$('#tab-'+k).classList.add('hidden'));
        $('#tab-'+key).classList.remove('hidden');
        if(key==='sales'){ loadLive(); loadMine(); loadInventory(); }
        if(key==='craft'){ loadRecipes(); }
      };
    });

    // ========= SHOP =========
    $('#btnBuyT1').onclick = async ()=>{
      $('#shopMsg').textContent = '';
      try{
        const r = await api('/api/shop/buy-t1',{method:'POST'});
        if(r.result_type==='RECIPE'){
          $('#shopMsg').innerHTML = `Recipe drop: <b>[T${r.grantedRecipe.tier}] ${r.grantedRecipe.name}</b>`;
        }else{
          $('#shopMsg').innerHTML = `Item: <b>${r.addedItem.name}</b>`;
        }
        // update header values + hint
        ME.gold = r.gold; ME.silver=r.silver;
        $('#who').textContent = `${ME.email} — ${ME.gold}g ${ME.silver}s`;
        const buys = r.buys_to_next;
        if (buys!=null){ $('#buysHint').classList.remove('hidden'); $('#buysHint').textContent=`Buys to next recipe: ${buys}`; }
        await Promise.all([loadRecipes(), loadInventory()]);
      }catch(e){ $('#shopMsg').textContent = e.message; }
    };

    // ========= CRAFTING =========
    async function loadRecipes(){
      try{
        const r = await api('/api/my/recipes');
        RECIPES = r.recipes||[];
        renderRecipesList();
      }catch(e){
        $('#recipesList').innerHTML = `<div class="error" style="padding:8px">HTTP error: ${e.message}</div>`;
      }
    }
    function renderRecipesList(){
      const box = $('#recipesList'); box.innerHTML='';
      if(!RECIPES.length){ box.innerHTML = `<div class="muted" style="padding:10px">You don’t own any recipes yet.</div>`; return; }
      for(const rec of RECIPES){
        const row = el('div','row');
        row.style.cssText = 'padding:8px;border-bottom:1px solid #162038;justify-content:space-between';
        row.innerHTML = `
          <div>
            <span class="pill">T${rec.tier}</span>
            <b style="margin-left:6px">${rec.name}</b>
            <span class="muted">x${rec.qty}</span>
          </div>
          <button class="btn ghost">Open</button>`;
        row.querySelector('button').onclick = ()=> openRecipe(rec.id);
        box.appendChild(row);
      }
    }
    async function openRecipe(id){
      try{
        const r = await api(`/api/recipes/${id}`);
        const rec = r.recipe, ing = r.ingredients||[];
        const can = !!r.can_craft;
        const card = el('div');
        const head = el('div','row'); head.style.justifyContent='space-between';
        head.innerHTML = `
          <div><span class="pill">T${rec.tier}</span> <b style="margin-left:6px">${rec.name}</b></div>
          <button id="btnDoCraft" class="btn"${can?'':' disabled'}>Craft</button>`;
        const tbl = ['<table><thead><tr><th>Ingredient</th><th>Have / Need</th></tr></thead><tbody>'];
        for(const x of ing){
          const ok = x.have_qty>=x.need_qty;
          tbl.push(`<tr><td>[T${x.tier}] ${x.name}</td><td>${ok?'<span class="ok">':''}${x.have_qty}/${x.need_qty}${ok?'</span>':''}</td></tr>`);
        }
        tbl.push('</tbody></table>');
        card.appendChild(head);
        card.insertAdjacentHTML('beforeend', tbl.join(''));
        $('#recipeView').innerHTML=''; $('#recipeView').appendChild(card);

        $('#btnDoCraft').onclick = async ()=>{
          try{
            const out = await api(`/api/recipes/${id}/craft`,{method:'POST'});
            if(out.crafted){
              notify(`Crafted: ${out.output.name} [T${out.output.tier}]`);
            }else{
              notify(`Craft failed → Scrap +1`);
            }
            await Promise.all([loadRecipes(), loadInventory()]);
            openRecipe(id);
          }catch(e){ notify(e.message); }
        };
      }catch(e){
        $('#recipeView').innerHTML = `<div class="error">Error: ${e.message}</div>`;
      }
    }
    $('#btnCraftRefresh').onclick = ()=> loadRecipes();

    // ========= INVENTORY (for Sales)
    async function loadInventory(){
      try{
        const r = await api('/api/my/inventory');
        const items = r.items||[], recipes=r.recipes||[];
        // normalize to one list with kind + code
        INV_ITEMS = [
          ...items.map(i=>({kind:'item',code:i.code,name:i.name,tier:i.tier,qty:i.qty})),
          ...recipes.map(rc=>({kind:'recipe',code:rc.code,name:rc.name,tier:rc.tier,qty:rc.qty}))
        ];
        renderInventoryBox();
      }catch(e){
        $('#invBox').innerHTML = `<div class="error" style="padding:8px">HTTP ${e.message}</div>`;
      }
    }
    function renderInventoryBox(){
      const box=$('#invBox'); box.innerHTML='';
      const q = $('#invSearch').value?.toLowerCase()||'';
      const list = INV_ITEMS.filter(x=>x.name.toLowerCase().includes(q) || x.code.toLowerCase().includes(q));
      if(!list.length){ box.innerHTML = `<div class="muted" style="padding:10px">Nothing to list.</div>`; return; }
      for(const it of list){
        const row = el('div','row'); row.style.cssText='padding:8px;border-bottom:1px solid #162038;align-items:center';
        row.innerHTML = `
          <div style="flex:1 1 auto
