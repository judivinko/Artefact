<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ARTEFACT</title>
  <link rel="stylesheet" href="/app.css"/>
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --text:#e2e8f0;
      --accent:#10b981; --border:#233047; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .header{display:flex;gap:12px;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);background:#0b1322}
    .brand{font-weight:800;letter-spacing:.4px}
    .spacer{flex:1}
    .container{max-width:1100px;margin:16px auto;padding:0 12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px}
    .subcard{background:#0d1528;border:1px solid var(--border);border-radius:10px;padding:12px}
    .label{font-weight:700;margin-bottom:6px}
    .muted{color:var(--muted)} .success{color:#22c55e} .danger{color:var(--danger)}
    .hidden{display:none !important}
    .row{display:flex;align-items:center} .space{justify-content:space-between} .gap{gap:8px} .wrap{flex-wrap:wrap}
    input,select,button{background:#0b1220;border:1px solid var(--border);color:var(--text);padding:8px;border-radius:8px}
    button{background:var(--accent);border-color:#0b7a5a;cursor:pointer}
    button.secondary{background:#0e1a31;border-color:var(--border)}
    button.danger{background:var(--danger);border-color:#7f1d1d}
    button:disabled{opacity:.6;cursor:not-allowed}
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#0e1930}
    .tab.active{background:#08364a}
    .chip{background:#11302a;color:#86efac;padding:4px 10px;border-radius:10px}
    .search{width:240px}
    .list{white-space:pre-wrap;padding:12px;background:#0b1220;border:1px solid var(--border);border-radius:10px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){.grid2{grid-template-columns:1fr}.search{width:100%}}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--border);padding:8px;text-align:left}
    .table tbody tr:hover{background:#0c162a}
    .pill{background:#12263a;color:#93c5fd;padding:2px 8px;border-radius:999px;font-size:12px}
    .pointer{cursor:pointer}
  </style>
</head>
<body>
<header class="header">
  <div class="brand">ARTEFACT</div>
  <div class="spacer"></div>
  <div id="userbar" class="row gap hidden">
    <span id="who"></span>
    <span id="bal" class="chip"></span>
    <button id="btn-logout" class="secondary">Logout</button>
    <a id="btn-admin" class="secondary hidden" href="/admin" target="_blank">Admin</a>
  </div>
</header>

<main class="container">
  <!-- AUTH -->
  <section id="auth" class="card">
    <h2>Welcome</h2>
    <p class="muted">Please register or login first.</p>
    <div class="row gap">
      <button id="show-register">Register</button>
      <button id="show-login" class="secondary">Login</button>
    </div>

    <div id="pane-register" class="hidden" style="margin-top:10px">
      <div class="label">Create account</div>
      <div class="row gap wrap">
        <input id="reg-email" type="email" placeholder="Email"/>
        <input id="reg-pass" type="password" placeholder="Password (min 6)"/>
        <button id="btn-register">Register</button>
      </div>
      <div id="reg-msg" class="muted" style="margin-top:6px"></div>
    </div>

    <div id="pane-login" class="hidden" style="margin-top:10px">
      <div class="label">Sign in</div>
      <div class="row gap wrap">
        <input id="log-email" type="email" placeholder="Email"/>
        <input id="log-pass" type="password" placeholder="Password"/>
        <button id="btn-login">Login</button>
      </div>
      <div id="log-msg" class="muted" style="margin-top:6px"></div>
    </div>
  </section>

  <!-- APP -->
  <section id="app" class="hidden">
    <div class="tabs">
      <button data-tab="shop" class="tab active">Shop</button>
      <button data-tab="craft" class="tab">Crafting</button>
      <button data-tab="sales" class="tab">Sales</button>
      <button data-tab="inv" class="tab">Inventory</button>
    </div>

    <!-- SHOP -->
    <section id="tab-shop" class="card">
      <div class="row space">
        <h2>Shop (T1 only)</h2>
        <div class="chip" id="balance"></div>
      </div>
      <p class="muted">Each purchase costs <b>1 gold</b> (100s). You either get a random T1 material or a recipe drop (weighted T2–T6).</p>
      <div class="row gap">
        <button id="btn-buy">Buy T1 Pack (1g)</button>
        <span id="shop-next" class="muted"></span>
      </div>
      <div id="shop-msg" class="muted" style="margin-top:6px"></div>
    </section>

    <!-- CRAFTING -->
    <section id="tab-craft" class="card">
      <div class="row space">
        <h2>Crafting</h2>
        <div class="row gap">
          <button id="btn-recs-refresh" class="secondary">Refresh</button>
          <button id="btn-arte" class="secondary">Craft ARTEFACT (10× T5)</button>
        </div>
      </div>
      <div class="grid2">
        <div>
          <div class="row space">
            <div class="label">Your recipes</div>
            <input id="rec-q" class="search" placeholder="Search…"/>
          </div>
          <div id="rec-list" class="list" style="max-height:380px;overflow:auto;">—</div>
        </div>
        <div>
          <div class="row space">
            <div class="label">Recipe details</div>
            <button id="btn-craft" disabled>Craft</button>
          </div>
          <div id="rec-box" class="list">Select a recipe →</div>
        </div>
      </div>
    </section>

    <!-- SALES -->
    <section id="tab-sales" class="card">
      <div class="row space">
        <h2>Sales (fixed price)</h2>
        <div class="row gap">
          <input id="market-q" class="search" placeholder="Search market by name…"/>
          <button id="btn-market-refresh" class="secondary">Refresh</button>
        </div>
      </div>

      <div class="grid2">
        <div>
          <div class="label">Create listing</div>
          <div class="row gap wrap">
            <select id="list-code" style="min-width:240px"></select>
            <input id="list-qty"  type="number" min="1" step="1" value="1" placeholder="Qty" style="width:90px"/>
            <input id="list-g"    type="number" min="0" step="1" placeholder="Gold" style="width:90px"/>
            <input id="list-s"    type="number" min="0" max="99" step="1" placeholder="Silver (0–99)" style="width:140px"/>
            <button id="btn-list">List for sale</button>
          </div>
          <div id="list-msg" class="muted" style="margin-top:6px"></div>

          <div class="subcard" style="margin-top:12px;">
            <div class="row space">
              <div class="label">Your listings</div>
              <button id="btn-mine-refresh" class="secondary">Reload</button>
            </div>
            <table class="table" id="mine">
              <thead><tr><th>Item</th><th>Qty</th><th>Price</th><th>Status</th><th>Action</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div>
          <div class="label">Marketplace</div>
          <table class="table" id="market">
            <thead><tr><th>Item</th><th>Qty</th><th>Price</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- INVENTORY -->
    <section id="tab-inv" class="card">
      <div class="row space">
        <h2>Inventory</h2>
        <button id="btn-inv-refresh" class="secondary">Refresh</button>
      </div>
      <div class="grid2">
        <div class="subcard">
          <div class="label">Items</div>
          <table class="table" id="inv-items">
            <thead><tr><th>Name</th><th>Tier</th><th>Qty</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="subcard">
          <div class="label">Recipes</div>
          <table class="table" id="inv-rec">
            <thead><tr><th>Name</th><th>Tier</th><th>Qty</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </section>
</main>

<script>
const $ = s => document.querySelector(s);
const el = s => document.createElement(s);
const state = { me:null, recs:[], sel:null, invI:[], invR:[], market:[], mine:[] };

function price(s){ const g=Math.floor(s/100), k=s%100; return `${g}g ${k}s`; }
function ok(elm,t){ const e=$(elm); e.textContent=t; e.className="muted success"; }
function bad(elm,t){ const e=$(elm); e.textContent=t; e.className="muted danger"; }

async function api(path,opts={}){
  const res = await fetch(path,{ credentials:"include", headers:{ "Content-Type":"application/json" }, ...opts });
  let d=null; try{ d=await res.json(); }catch{}
  if(!res.ok) throw new Error((d&&d.error)||`HTTP ${res.status}`);
  return d;
}

// ---------- auth
function showAuth(){ $("#auth").classList.remove("hidden"); $("#app").classList.add("hidden"); $("#userbar").classList.add("hidden"); }
function showApp(){ $("#auth").classList.add("hidden"); $("#app").classList.remove("hidden"); $("#userbar").classList.remove("hidden"); }
function syncTop(){
  const u=state.me?.user;
  $("#who").textContent = u ? u.email : "";
  $("#bal").textContent = u ? `${u.gold}g ${u.silver}s` : "";
  $("#balance").textContent = u ? `${u.gold}g ${u.silver}s` : "";
  $("#btn-admin").classList.toggle("hidden", !(u && u.is_admin));
}
async function loadMe(){ try{ const r=await api("/api/me"); state.me=r; syncTop(); showApp(); await initData(); }catch{ showAuth(); } }

$("#show-register").onclick=()=>{$("#pane-register").classList.remove("hidden");$("#pane-login").classList.add("hidden");};
$("#show-login").onclick=()=>{$("#pane-login").classList.remove("hidden");$("#pane-register").classList.add("hidden");};
$("#btn-register").onclick=async ()=>{
  try{ await api("/api/register",{method:"POST",body:JSON.stringify({email:$("#reg-email").value.trim(),password:$("#reg-pass").value})}); ok("#reg-msg","Registered. Now login."); }
  catch(e){ bad("#reg-msg",e.message); }
};
$("#btn-login").onclick=async ()=>{
  try{ await api("/api/login",{method:"POST",body:JSON.stringify({email:$("#log-email").value.trim(),password:$("#log-pass").value})}); $("#log-msg").textContent=""; await loadMe(); }
  catch(e){ bad("#log-msg",e.message); }
};
$("#btn-logout").onclick=async ()=>{ await api("/api/logout"); state.me=null; showAuth(); };

// ---------- tabs
for(const t of document.querySelectorAll(".tab")){
  t.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const id=t.getAttribute("data-tab");
    for(const sec of ["shop","craft","sales","inv"]) $("#tab-"+sec).style.display = (sec===id)?"block":"none";
  }
}
for(const sec of ["shop","craft","sales","inv"]) $("#tab-"+sec).style.display = (sec==="shop")?"block":"none";

// ---------- shop
$("#btn-buy").onclick=async ()=>{
  try{
    const r=await api("/api/shop/buy-t1",{method:"POST"});
    await loadMe(); await loadInv(); await loadRecs(); renderRecs(); renderInv();
    if(r.result_type==="RECIPE") alert(`Recipe drop: ${r.grantedRecipe.name} [T${r.grantedRecipe.tier}]`);
    else alert(`Received: ${r.addedItem.name}`);
    $("#shop-next").textContent = r.buys_to_next!=null ? `Next recipe in ~${r.buys_to_next} buys` : "";
    $("#shop-msg").textContent = "";
  }catch(e){ bad("#shop-msg",e.message); }
};

// ---------- crafting
async function loadRecs(){ const r=await api("/api/my/recipes"); state.recs=r.recipes||[]; }
function renderRecs(){
  const q=$("#rec-q").value.trim().toLowerCase();
  const box=$("#rec-list"); box.innerHTML="";
  let arr=state.recs.slice();
  if(q) arr=arr.filter(x=>x.name.toLowerCase().includes(q)||x.code.toLowerCase().includes(q));
  if(!arr.length){ box.textContent="No recipes."; return; }
  for(const r of arr){
    const row=el("div"); row.className="row gap pointer"; row.style.padding="6px";
    row.innerHTML=`<div><b>${r.name}</b> <span class="pill">T${r.tier}</span> <span class="muted">x${r.qty}</span></div>`;
    row.onclick=()=>selectRec(r.id);
    box.appendChild(row);
  }
}
async function selectRec(id){
  try{
    const r=await api(`/api/recipes/${id}`);
    state.sel=r;
    const lines=[];
    lines.push(`${r.recipe.name} [${r.recipe.code}] — T${r.recipe.tier}`);
    lines.push(""); lines.push("Ingredients:");
    r.ingredients.forEach(i=> lines.push(` • ${i.name} — have ${i.have_qty}/${i.need_qty}${i.missing>0?` (missing ${i.missing})`:""}`));
    $("#rec-box").textContent=lines.join("\n");
    $("#btn-craft").disabled=!r.can_craft;
  }catch(e){ $("#rec-box").textContent=e.message; $("#btn-craft").disabled=true; }
}
$("#btn-craft").onclick=async ()=>{
  const id=state.sel?.recipe?.id; if(!id) return;
  try{
    const r=await api(`/api/recipes/${id}/craft`,{method:"POST"});
    alert(r.msg||"Done");
    await loadInv(); await loadRecs(); renderRecs(); renderInv();
    if(state.sel) selectRec(state.sel.recipe.id);
  }catch(e){ alert(e.message); }
};
$("#btn-recs-refresh").onclick=async ()=>{ await loadRecs(); renderRecs(); };
$("#btn-arte").onclick=async ()=>{ try{ await api("/api/craft/artefact",{method:"POST"}); alert("Crafted ARTEFACT"); await loadInv(); renderInv(); }catch(e){ alert(e.message); } };
$("#rec-q").oninput=()=>renderRecs();

// ---------- sales
async function loadMarket(){
  const q=encodeURIComponent($("#market-q").value.trim());
  const r=await api(`/api/sales/live${q?`?q=${q}`:""}`); state.market=r.listings||[];
  const tb=$("#market tbody"); tb.innerHTML="";
  for(const s of state.market){
    const tr=el("tr"); tr.innerHTML=`<td>${s.name}</td><td>${s.qty}</td><td>${price(s.price_s)}</td><td></td>`;
    const btn=el("button"); btn.textContent="Buy";
    btn.onclick=async ()=>{ try{ await api(`/api/sales/${s.id}/buy`,{method:"POST"}); await initData(); alert("Purchased!"); }catch(e){ alert(e.message); } };
    tr.lastElementChild.appendChild(btn); tb.appendChild(tr);
  }
}
async function loadMine(){
  const r=await api("/api/sales/mine"); state.mine=r.listings||[];
  const tb=$("#mine tbody"); tb.innerHTML="";
  for(const s of state.mine){
    const tr=el("tr");
    tr.innerHTML=`<td>${s.name}</td><td>${s.qty}</td><td>${price(s.price_s)}</td><td>${s.status}</td><td></td>`;
    if(s.status==="live"){
      const btn=el("button"); btn.textContent="Cancel"; btn.className="danger";
      btn.onclick=async ()=>{ try{ await api(`/api/sales/${s.id}/cancel`,{method:"POST"}); await initData(); }catch(e){ alert(e.message); } };
      tr.lastElementChild.appendChild(btn);
    }else tr.lastElementChild.textContent=s.status;
    tb.appendChild(tr);
  }
}
$("#btn-market-refresh").onclick=loadMarket;
$("#market-q").oninput=()=>{ clearTimeout(window._md); window._md=setTimeout(loadMarket,250); };

$("#btn-list").onclick=async ()=>{
  const body={
    code: $("#list-code").value,
    qty: parseInt($("#list-qty").value||"1",10)||1,
    price_gold: parseInt($("#list-g").value||"0",10)||0,
    price_silver: parseInt($("#list-s").value||"0",10)||0
  };
  try{
    await api("/api/sales/create",{method:"POST",body:JSON.stringify(body)});
    ok("#list-msg","Listed!");
    $("#list-qty").value="1"; $("#list-g").value=""; $("#list-s").value="";
    await initData();
  }catch(e){ bad("#list-msg",e.message); }
};

// ---------- inventory
async function loadInv(){
  const r=await api("/api/my/inventory");
  state.invI=r.items||[]; state.invR=r.recipes||[];
  const sel=$("#list-code"); sel.innerHTML="";
  const g1=el("optgroup"); g1.label="Items";
  state.invI.forEach(i=>{ const o=el("option"); o.value=i.code; o.textContent=`[T${i.tier}] ${i.name} x${i.qty}`; g1.appendChild(o); });
  const g2=el("optgroup"); g2.label="Recipes";
  state.invR.forEach(i=>{ const o=el("option"); o.value=i.code; o.textContent=`[T${i.tier}] ${i.name} x${i.qty}`; g2.appendChild(o); });
  sel.appendChild(g1); sel.appendChild(g2);
}
function renderInv(){
  const tbI=$("#inv-items tbody"); tbI.innerHTML="";
  state.invI.forEach(i=>{ const tr=el("tr"); tr.innerHTML=`<td>${i.name}</td><td>T${i.tier}</td><td>${i.qty}</td>`; tbI.appendChild(tr); });
  const tbR=$("#inv-rec tbody"); tbR.innerHTML="";
  state.invR.forEach(r=>{ const tr=el("tr"); tr.innerHTML=`<td>${r.name}</td><td>T${r.tier}</td><td>${r.qty}</td>`; tbR.appendChild(tr); });
}
$("#btn-inv-refresh").onclick=async ()=>{ await loadInv(); renderInv(); };
$("#btn-mine-refresh").onclick=loadMine;

// ---------- bootstrap
async function initData(){
  await Promise.all([loadInv(), loadRecs(), loadMarket(), loadMine()]);
  renderInv(); renderRecs();
  const u=state.me.user; $("#balance").textContent=`${u.gold}g ${u.silver}s`;
}
loadMe();
</script>
</body>
</html>
