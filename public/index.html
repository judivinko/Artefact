<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ARTEFACT</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --txt:#e2e8f0; --acc:#10b981; --pill:#1f2937;
      --btn:#22c55e; --btn2:#0891b2; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:16px auto;padding:0 12px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .brand{font-weight:800;letter-spacing:.4px}
    .badge{font-size:12px;padding:2px 6px;border-radius:999px;background:#0b2942;color:#93c5fd;margin-left:8px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tabs{display:flex;gap:8px;margin:8px 0}
    .tab{padding:8px 12px;border-radius:10px;background:#0f2e1b;color:#bbf7d0;cursor:pointer}
    .tab.off{background:#1f2937;color:#e5e7eb}
    .card{background:var(--card);border:1px solid #233047;border-radius:12px;padding:14px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width: 900px){.grid2{grid-template-columns:1fr}}
    input,select{background:#0b1220;border:1px solid #233047;color:var(--txt);padding:8px;border-radius:8px}
    button{background:var(--btn);color:#052e16;border:0;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
    button.secondary{background:#0ea5e9;color:#002033}
    button.danger{background:var(--danger);color:#fff}
    button:disabled{opacity:.6;cursor:not-allowed}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #1e293b}
    .muted{color:var(--muted)}
    .right{float:right}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .pill{background:var(--pill);border-radius:999px;padding:2px 8px;font-size:12px}
    .space{height:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">ARTEFACT</div>
      <div class="row" id="authBox">
        <!-- filled by JS -->
      </div>
    </header>

    <div id="gate" class="card" style="display:none">
      <div class="row">
        <strong>Register</strong>
        <input id="r_email" placeholder="email@example.com"/>
        <input id="r_pass" type="password" placeholder="password (min 6)"/>
        <button id="btnRegister">Register</button>
      </div>
      <div class="row" style="margin-top:8px">
        <strong>Login</strong>
        <input id="l_email" placeholder="email@example.com"/>
        <input id="l_pass" type="password" placeholder="password"/>
        <button id="btnLogin" class="secondary">Login</button>
      </div>
      <div id="gateMsg" class="muted"></div>
    </div>

    <div id="app" style="display:none">
      <div class="tabs">
        <div class="tab" id="tabShop">Shop</div>
        <div class="tab off" id="tabCraft">Crafting</div>
        <div class="tab off" id="tabSales">Sales</div>
        <div class="tab off" id="tabInv">Inventory</div>
      </div>

      <!-- SHOP -->
      <section id="viewShop" class="card">
        <h3>Shop (T1 only)</h3>
        <p class="muted">Each purchase costs <strong>1 gold</strong> (100s). You either get a random T1 material or a recipe drop (T2–T6 weighted).</p>
        <button id="btnBuyT1">Buy T1 Pack (1g)</button>
        <span id="shopHint" class="pill muted"></span>
        <div id="shopMsg" class="muted"></div>
      </section>

      <!-- CRAFTING -->
      <section id="viewCraft" class="card" style="display:none">
        <div class="row" style="justify-content:space-between">
          <h3>Crafting</h3>
          <div class="row">
            <button id="btnRefreshRecipes" class="secondary">Refresh</button>
            <button id="btnCraftArtefact" class="secondary">Craft ARTEFACT (10× distinct T5)</button>
          </div>
        </div>
        <div class="grid2">
          <div>
            <div class="row">
              <input id="recipeSearch" placeholder="Search recipe…"/>
            </div>
            <div class="space"></div>
            <table id="tblMyRecipes">
              <thead><tr><th>Recipe</th><th class="right">Qty</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div>
            <div id="recBox" class="muted">Select a recipe on the left →</div>
          </div>
        </div>
      </section>

      <!-- SALES -->
      <section id="viewSales" class="card" style="display:none">
        <h3>Sales (fixed price)</h3>
        <div class="grid2">
          <!-- LEFT: create listing -->
          <div>
            <strong>Create listing</strong>
            <div class="space"></div>
            <div class="row">
              <select id="sellWhat"></select>
              <input id="sellQty" type="number" min="1" step="1" value="1" style="width:90px"/>
            </div>
            <div class="space"></div>
            <div class="row">
              <input id="sellGold" type="number" min="0" step="1" placeholder="Gold" style="width:120px"/>
              <input id="sellSilver" type="number" min="0" max="99" step="1" placeholder="Silver (0–99)" style="width:150px"/>
              <button id="btnCreateSale">List for sale</button>
            </div>
            <div id="sellMsg" class="muted"></div>

            <div class="space"></div><div class="space"></div>
            <strong>Your listings</strong>
            <table id="tblMySales">
              <thead><tr><th>Item</th><th>Qty</th><th>Price</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- RIGHT: marketplace -->
          <div>
            <strong>Marketplace</strong>
            <table id="tblLiveSales">
              <thead><tr><th>Item</th><th>Qty</th><th>Price</th><th></th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- INVENTORY -->
      <section id="viewInv" class="card" style="display:none">
        <h3>Inventory</h3>
        <div class="grid2">
          <div>
            <strong>Items</strong>
            <table id="tblItems"><thead><tr><th>[Tier] Name</th><th class="right">Qty</th></tr></thead><tbody></tbody></table>
          </div>
          <div>
            <strong>Recipes</strong>
            <table id="tblRecipes"><thead><tr><th>[Tier] Name</th><th class="right">Qty</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
const $ = s => document.querySelector(s);
const el = (tag, props={}, ...children) => {
  const x=document.createElement(tag);
  Object.assign(x, props);
  for(const c of children){ x.appendChild(typeof c==="string"?document.createTextNode(c):c); }
  return x;
};

// ---------- Auth box (top-right)
let ME = null;
function setAuthBox(){
  const box = $("#authBox"); box.innerHTML = "";
  if (!ME){
    box.append(
      el("span",{className:"muted"},"Not logged in")
    );
  }else{
    const g = Math.floor((ME.user.balance_silver||0)/100), s = (ME.user.balance_silver||0)%100;
    box.append(el("span",null, ME.user.email));
    box.append(el("span",{className:"badge"}, `${g}g ${s}s`));
    const btn = el("button",{textContent:"Logout"});
    btn.onclick = async ()=>{
      await fetch("/api/logout"); ME=null; await boot();
    };
    box.append(btn);
  }
}

// ---------- Gate (register/login)
async function register(){
  const email=$("#r_email").value.trim(), password=$("#r_pass").value;
  const r=await fetch("/api/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email,password})}).then(r=>r.json());
  $("#gateMsg").textContent = r.ok ? "Registered. Now login." : (r.error||"Error");
}
async function login(){
  const email=$("#l_email").value.trim(), password=$("#l_pass").value;
  const r=await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email,password})}).then(r=>r.json());
  if (r.ok){ await boot(); } else { $("#gateMsg").textContent = r.error||"Error"; }
}
$("#btnRegister").onclick = register;
$("#btnLogin").onclick = login;

// ---------- Tabs
function showTab(tab){
  for(const id of ["Shop","Craft","Sales","Inv"]){
    $("#tab"+id).classList.toggle("off", id!==tab);
    $("#view"+id).style.display = (id===tab)?"block":"none";
  }
}
$("#tabShop").onclick = ()=> showTab("Shop");
$("#tabCraft").onclick = ()=> showTab("Craft");
$("#tabSales").onclick = ()=> { loadSales(); showTab("Sales"); };
$("#tabInv").onclick = ()=> { loadInv(); showTab("Inv"); };

// ---------- Shop
$("#btnBuyT1").onclick = async ()=>{
  const r = await fetch("/api/shop/buy-t1",{method:"POST"}).then(r=>r.json());
  if(!r.ok){ $("#shopMsg").textContent=r.error||"Error"; return; }
  const g=r.gold, s=r.silver;
  $("#shopHint").textContent = r.buys_to_next==null? "" : `Next recipe in ~${r.buys_to_next} buys`;
  if (r.result_type==="ITEM"){
    $("#shopMsg").textContent = `+1 ${r.addedItem.name} (T1). Balance: ${g}g ${s}s.`;
  }else{
    $("#shopMsg").textContent = `Recipe drop: [T${r.grantedRecipe.tier}] ${r.grantedRecipe.name}. Balance: ${g}g ${s}s.`;
  }
  await refreshMe();
};

// ---------- Crafting
async function loadMyRecipes(){
  const q = ($("#recipeSearch").value||"").toLowerCase();
  const r = await fetch("/api/my/recipes").then(r=>r.json());
  const tb = $("#tblMyRecipes tbody"); tb.innerHTML = "";
  (r.recipes||[]).filter(x=>!q || x.name.toLowerCase().includes(q) || x.code.toLowerCase().includes(q))
    .forEach(rc=>{
      const tr = el("tr");
      tr.append(el("td",null, `[T${rc.tier}] ${rc.name}`));
      tr.append(el("td",{className:"right"}, String(rc.qty)));
      tr.onclick = ()=> openRecipe(rc.id);
      tb.append(tr);
    });
}
async function openRecipe(id){
  const r = await fetch(`/api/recipes/${id}`).then(r=>r.json());
  if(!r.ok){ $("#recBox").textContent=r.error||"Error"; return; }
  const b = $("#recBox"); b.innerHTML = "";
  b.append(el("div",null, el("strong",null, `[T${r.recipe.tier}] ${r.recipe.name}`)));
  const list = el("table"); list.append(el("thead",null, el("tr",null, el("th",null,"Ingredient"), el("th",{className:"right"},"Have / Need"))));
  const tb = el("tbody");
  for(const ing of r.ingredients){
    const tr = el("tr");
    tr.append(el("td",null, `[T${ing.tier}] ${ing.name}`));
    tr.append(el("td",{className:"right"}, `${ing.have_qty}/${ing.need_qty}`));
    tb.append(tr);
  }
  list.append(tb);
  b.append(list);
  const craftBtn = el("button",{textContent:"Craft"});
  craftBtn.disabled = !r.can_craft;
  craftBtn.onclick = async ()=>{
    const c = await fetch(`/api/recipes/${id}/craft`,{method:"POST"}).then(r=>r.json());
    if(!c.ok){ alert(c.error||"Craft failed"); return; }
    if(c.crafted){
      alert(`Crafted: ${c.output.name} [T${c.output.tier}]`);
    }else{
      alert("Failed → Scrap +1");
    }
    await loadMyRecipes();
    await loadInv();
  };
  b.append(el("div",{className:"space"}));
  b.append(craftBtn);
}
$("#btnRefreshRecipes").onclick = loadMyRecipes;
$("#recipeSearch").oninput = loadMyRecipes;
$("#btnCraftArtefact").onclick = async ()=>{
  const r = await fetch("/api/craft/artefact",{method:"POST"}).then(r=>r.json());
  alert(r.ok ? "ARTEFACT crafted!" : (r.error||"Error"));
  await loadInv();
  await loadMyRecipes();
};

// ---------- Sales
async function loadSales(){
  // fill "what can I sell"
  const inv = await fetch("/api/my/inventory").then(r=>r.json());
  const sel = $("#sellWhat"); sel.innerHTML="";
  (inv.items||[]).forEach(it=> sel.append(el("option",{value:it.code}, `[T${it.tier}] ${it.name} x${it.qty}`)));
  (inv.recipes||[]).forEach(rc=> sel.append(el("option",{value:rc.code}, `Recipe: [T${rc.tier}] ${rc.name} x${rc.qty}`)));

  // my sales
  const mine = await fetch("/api/sales/mine").then(r=>r.json());
  const tbMine=$("#tblMySales tbody"); tbMine.innerHTML="";
  (mine.sales||[]).forEach(a=>{
    const tr=el("tr");
    tr.append(el("td",null, a.name));
    tr.append(el("td",null, String(a.qty)));
    tr.append(el("td",null, `${Math.floor(a.buy_now_price_s/100)}g ${a.buy_now_price_s%100}s`));
    const btn = el("button",{textContent:"Cancel", className:"danger"});
    btn.onclick = async ()=>{ const r = await fetch(`/api/sales/${a.id}/cancel`,{method:"POST"}).then(r=>r.json()); if(!r.ok) alert(r.error); else loadSales(); };
    tr.append(el("td",null, btn));
    tbMine.append(tr);
  });

  // live sales
  const live = await fetch("/api/sales/live").then(r=>r.json());
  const tb=$("#tblLiveSales tbody"); tb.innerHTML="";
  (live.sales||[]).forEach(a=>{
    const tr=el("tr");
    tr.append(el("td",null, a.name));
    tr.append(el("td",null, String(a.qty)));
    tr.append(el("td",null, `${Math.floor(a.buy_now_price_s/100)}g ${a.buy_now_price_s%100}s`));
    const btn = el("button",{textContent:"Buy"});
    btn.onclick = async ()=>{ const r = await fetch(`/api/sales/${a.id}/buy`,{method:"POST"}).then(r=>r.json()); if(!r.ok) alert(r.error); else { alert("Bought!"); await refreshMe(); loadSales(); } };
    tr.append(el("td",null, btn));
    tb.append(tr);
  });
}
$("#btnCreateSale").onclick = async ()=>{
  const code = $("#sellWhat").value;
  const qty = parseInt($("#sellQty").value||"1",10);
  const gold = parseInt($("#sellGold").value||"0",10);
  const silver = parseInt($("#sellSilver").value||"0",10);
  const r = await fetch("/api/sales/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code,qty,price_gold:gold,price_silver:silver})}).then(r=>r.json());
  $("#sellMsg").textContent = r.ok ? "Listed." : (r.error||"Error");
  if (r.ok){ $("#sellGold").value=""; $("#sellSilver").value=""; loadSales(); }
};

// ---------- Inventory
async function loadInv(){
  const r = await fetch("/api/my/inventory").then(r=>r.json());
  const t1=$("#tblItems tbody"); t1.innerHTML="";
  (r.items||[]).forEach(it=>{
    const tr=el("tr");
    tr.append(el("td",null, `[T${it.tier}] ${it.name}`));
    tr.append(el("td",{className:"right"}, String(it.qty)));
    t1.append(tr);
  });
  const t2=$("#tblRecipes tbody"); t2.innerHTML="";
  (r.recipes||[]).forEach(rc=>{
    const tr=el("tr");
    tr.append(el("td",null, `[T${rc.tier}] ${rc.name}`));
    tr.append(el("td",{className:"right"}, String(rc.qty)));
    t2.append(tr);
  });
}

// ---------- Boot
async function refreshMe(){
  const me = await fetch("/api/me").then(r=>r.ok?r.json():null).catch(()=>null);
  ME = me && me.ok ? me : null;
  setAuthBox();
}
async function boot(){
  await refreshMe();
  if (!ME){
    $("#gate").style.display="block";
    $("#app").style.display="none";
  }else{
    $("#gate").style.display="none";
    $("#app").style.display="block";
    showTab("Shop");
    await loadMyRecipes();
    await loadInv();
  }
}
boot();
</script>
</body>
</html>
