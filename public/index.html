<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ARTEFACT</title>
<link rel="stylesheet" href="/app.css" />
<style>
:root{--bg:#0b1220;--card:#0f172a;--muted:#93a3b8;--fg:#e5eefc;--teal:#10b981;--danger:#ef4444;--line:#233047}
*{box-sizing:border-box;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif}
body{margin:0;background:var(--bg);color:var(--fg)}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;max-width:1100px;margin:16px auto}
.brand{font-weight:800;letter-spacing:.5px}
.badge{border:1px solid var(--line);padding:4px 8px;border-radius:999px;background:#071021;font-size:12px}
.btn{padding:8px 12px;border-radius:10px;background:#16a34a;color:white;border:0;cursor:pointer}
.btn.secondary{background:#0b5bd1}
.btn.muted{background:#1f2937}
.btn.danger{background:#b91c1c}
.btn:disabled{opacity:.6;cursor:not-allowed}
.tabbar{display:flex;gap:10px}
.tabbar .chip{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#0d1b2a;cursor:pointer}
.tabbar .chip.active{background:#0e3a2f}
.container{max-width:1100px;margin:0 auto;padding:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin-top:12px}
.label{opacity:.8;font-size:13px;margin-bottom:6px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--fg)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.list{max-height:360px;overflow:auto;border:1px solid var(--line);border-radius:10px}
.itemrow{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid #13223a}
.itemrow:last-child{border-bottom:0}
.kv{display:grid;grid-template-columns:1fr auto;gap:6px}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
.muted{color:var(--muted)}
.right{margin-left:auto}
.toast{position:fixed;right:12px;bottom:12px;background:#0b5bd1;color:#fff;padding:10px 12px;border-radius:10px}
.hidden{display:none}
</style>
</head>
<body>
  <header class="header">
    <div class="brand">ARTEFACT</div>
    <div class="row">
      <span id="who" class="badge">–</span>
      <button id="btn-logout" class="btn muted hidden">Log out</button>
    </div>
  </header>

  <main class="container">
    <!-- Auth -->
    <section id="auth" class="card">
      <div class="label">Login / Register</div>
      <div class="grid">
        <div class="card">
          <div class="label">Register</div>
          <input id="reg-email" class="input" placeholder="email@example.com" />
          <input id="reg-pass" class="input" type="password" placeholder="password (min 6)" style="margin-top:8px"/>
          <button id="btn-register" class="btn" style="margin-top:8px">Register</button>
          <div id="reg-msg" class="muted" style="margin-top:6px"></div>
        </div>
        <div class="card">
          <div class="label">Login</div>
          <input id="log-email" class="input" placeholder="email@example.com" />
          <input id="log-pass" class="input" type="password" placeholder="password" style="margin-top:8px"/>
          <button id="btn-login" class="btn secondary" style="margin-top:8px">Log in</button>
          <div id="log-msg" class="muted" style="margin-top:6px"></div>
        </div>
      </div>
    </section>

    <!-- App -->
    <section id="app" class="hidden">
      <div class="tabbar">
        <div class="chip active" data-tab="shop">Shop</div>
        <div class="chip" data-tab="craft">Crafting</div>
        <div class="chip" data-tab="sales">Sales</div>
        <div class="chip" data-tab="inv">Inventory</div>
      </div>

      <!-- Shop -->
      <div id="tab-shop" class="card">
        <div class="row">
          <div class="label">Shop (T1 only)</div>
          <span id="balance" class="badge right">0g 0s</span>
          <span id="buysToNext" class="badge">Buys to next recipe: –</span>
        </div>
        <p class="muted">Each purchase costs <b>1 gold</b> (100 silver). You either get a random T1 material or a weighted recipe drop (T2–T5: 800/150/37/13 per 1000).</p>
        <button id="btn-buy-t1" class="btn">Buy T1 Pack (1g)</button>
        <div id="shop-msg" class="muted" style="margin-top:6px"></div>
      </div>

      <!-- Crafting -->
      <div id="tab-craft" class="card hidden">
        <div class="row">
          <div class="label">Crafting</div>
          <button id="btn-artefact" class="btn right">Craft ARTEFACT (10× distinct T5)</button>
        </div>
        <div class="grid">
          <div class="card">
            <div class="row" style="justify-content:space-between">
              <div class="label">Recipes you own</div>
              <div class="row">
                <input id="filter-recipe" class="input" placeholder="filter by name..." style="width:220px"/>
                <button id="btn-refresh-rec" class="btn muted">Refresh</button>
              </div>
            </div>
            <div id="recipes" class="list">Loading…</div>
          </div>
          <div class="card">
            <div class="label">Details</div>
            <div id="rec-details" class="list">Select a recipe on the left.</div>
          </div>
        </div>
      </div>

      <!-- Sales -->
      <div id="tab-sales" class="card hidden">
        <div class="label">Sales (Marketplace)</div>
        <div class="grid">
          <div class="card">
            <div class="label">Create Sale</div>
            <input id="inv-search" class="input" placeholder="Search your inventory..." />
            <div id="inv-list" class="list" style="margin-top:8px;max-height:300px">Loading…</div>
            <div class="row" style="margin-top:8px">
              <input id="price-g" class="input" style="width:100px" placeholder="Gold"/>
              <input id="price-s" class="input" style="width:120px" placeholder="Silver (0–99)"/>
              <input id="price-qty" class="input" style="width:100px" placeholder="Qty"/>
              <button id="btn-list" class="btn">List for sale</button>
            </div>
            <div id="list-msg" class="muted" style="margin-top:6px"></div>
          </div>

          <div class="card">
            <div class="row" style="justify-content:space-between">
              <div class="label">Marketplace</div>
              <input id="market-q" class="input" placeholder="Search by name..." style="width:220px" />
            </div>
            <div id="market" class="list">Loading…</div>

            <div class="row" style="justify-content:space-between;margin-top:12px">
              <div class="label">My listings</div>
              <button id="btn-mine" class="btn muted">Reload</button>
            </div>
            <div id="mine" class="list">Loading…</div>
          </div>
        </div>
      </div>

      <!-- Inventory -->
      <div id="tab-inv" class="card hidden">
        <div class="label">Inventory</div>
        <div id="inv-full" class="list">Loading…</div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast hidden"></div>

<script>
const $ = s=>document.querySelector(s); const $$ = s=>Array.from(document.querySelectorAll(s));
const api = async (p,opts={})=>{
  const r = await fetch(p,{credentials:"include",headers:{"Content-Type":"application/json"},...opts});
  let data=null; try{data=await r.json()}catch{}
  if(!r.ok) throw new Error((data&&data.error)||("HTTP "+r.status));
  return data;
};
function toast(t){ const box=$("#toast"); box.textContent=t; box.classList.remove("hidden"); setTimeout(()=>box.classList.add("hidden"),1800); }

let WHO=null; let SEL_INV=null; // selected item/recipe to list

function setTab(tab){
  $$(".chip").forEach(c=>c.classList.toggle("active", c.dataset.tab===tab));
  $("#tab-shop").classList.toggle("hidden", tab!=="shop");
  $("#tab-craft").classList.toggle("hidden", tab!=="craft");
  $("#tab-sales").classList.toggle("hidden", tab!=="sales");
  $("#tab-inv").classList.toggle("hidden", tab!=="inv");
}
$$(".chip").forEach(c=>c.addEventListener("click",()=>setTab(c.dataset.tab)));

async function loadMe(){
  try{
    const r = await fetch("/api/me",{credentials:"include"}).then(x=>x.json()).catch(()=>null);
    if(!r||!r.ok){ $("#auth").classList.remove("hidden"); $("#app").classList.add("hidden"); $("#who").textContent="Not logged in"; $("#btn-logout").classList.add("hidden"); return; }
    WHO = r.user; $("#auth").classList.add("hidden"); $("#app").classList.remove("hidden");
    $("#who").textContent = WHO.email;
    $("#btn-logout").classList.remove("hidden");
    renderBalance();
    if (typeof WHO.buys_to_next==="number") $("#buysToNext").textContent = "Buys to next recipe: "+WHO.buys_to_next; else $("#buysToNext").textContent = "Buys to next recipe: —";
    // initial loads
    loadRecipes(); loadInventoryPanel(); loadMarket(); loadMine(); loadInventoryFull();
  }catch{ $("#auth").classList.remove("hidden"); $("#app").classList.add("hidden"); }
}
function renderBalance(){
  if(!WHO) return;
  $("#balance").textContent = `${Math.floor(WHO.balance_silver/100)}g ${WHO.balance_silver%100}s`;
}

// --- Auth events
$("#btn-register").addEventListener("click", async ()=>{
  $("#reg-msg").textContent="…";
  try{
    const email=$("#reg-email").value.trim(), password=$("#reg-pass").value;
    const r = await api("/api/register",{method:"POST",body:JSON.stringify({email,password})});
    $("#reg-msg").textContent = r.message || "Registered";
  }catch(e){ $("#reg-msg").textContent = e.message; }
});
$("#btn-login").addEventListener("click", async ()=>{
  $("#log-msg").textContent="…";
  try{
    const email=$("#log-email").value.trim(), password=$("#log-pass").value;
    await api("/api/login",{method:"POST",body:JSON.stringify({email,password})});
    $("#log-msg").textContent="OK";
    loadMe();
  }catch(e){ $("#log-msg").textContent=e.message; }
});
$("#btn-logout").addEventListener("click", async ()=>{
  await api("/api/logout"); WHO=null; loadMe();
});

// -------- SHOP
$("#btn-buy-t1").addEventListener("click", async ()=>{
  try{
    const r = await api("/api/shop/buy-t1",{method:"POST",body:JSON.stringify({})});
    WHO.balance_silver = r.balance_silver;
    renderBalance();
    $("#shop-msg").textContent = r.got==="item" ? ("Got item: "+r.name) : ("Got recipe: "+r.name);
    if (typeof r.buys_to_next==="number") $("#buysToNext").textContent = "Buys to next recipe: "+r.buys_to_next;
    loadInventoryPanel(); loadRecipes(); loadInventoryFull();
  }catch(e){ alert(e.message); }
});

// -------- CRAFTING
async function loadRecipes(){
  const box=$("#recipes"); box.textContent="Loading…";
  try{
    const r = await api("/api/recipes/list");
    const q = $("#filter-recipe").value.trim().toLowerCase();
    const rows = (r.recipes||[]).filter(x=>!q||x.name.toLowerCase().includes(q));
    if (!rows.length){ box.textContent="No recipes."; return; }
    box.innerHTML="";
    for (const rec of rows){
      const row=document.createElement("div"); row.className="itemrow";
      row.innerHTML = `<div><b>${rec.name}</b> <span class="badge">T${rec.tier}</span> <span class="muted">x${rec.qty}</span></div>
                       <button class="btn muted">Open</button>`;
      row.querySelector("button").addEventListener("click",()=>openRecipe(rec.id));
      box.appendChild(row);
    }
  }catch(e){ box.textContent=e.message; }
}
$("#btn-refresh-rec").addEventListener("click", loadRecipes);
$("#filter-recipe").addEventListener("input", loadRecipes);

async function openRecipe(id){
  const box=$("#rec-details"); box.textContent="Loading…";
  try{
    const r = await api("/api/recipes/ingredients/"+id);
    if (!r || !r.recipe){ box.textContent="Recipe not found."; return; }
    const lines=[];
    lines.push(`<div class="itemrow"><div><b>${r.recipe.name}</b> <span class="badge">T${r.recipe.tier}</span></div></div>`);
    for(const ing of (r.ingredients||[])){
      lines.push(`<div class="itemrow"><div>${ing.name}</div><div class="muted">${ing.have}/${ing.qty}</div></div>`);
    }
    lines.push(`<div class="itemrow"><button id="btn-craft" class="btn">Craft</button><span class="muted">10% fail → Scrap</span></div>`);
    box.innerHTML = lines.join("");
    $("#btn-craft").addEventListener("click", async ()=>{
      try{
        const r2 = await api("/api/craft/do",{method:"POST",body:JSON.stringify({recipe_id:id})});
        toast(r2.result==="success" ? ("Crafted: "+(r.recipe.name||"item")) : "Failed (got Scrap)");
        loadInventoryPanel(); loadRecipes(); loadInventoryFull();
      }catch(e){ alert(e.message); }
    });
  }catch(e){ box.textContent=e.message; }
}

$("#btn-artefact").addEventListener("click", async ()=>{
  try{
    const r = await api("/api/craft/artefact",{method:"POST",body:JSON.stringify({})});
    alert("Crafted: "+(r.crafted||"Artefact"));
    loadInventoryPanel(); loadInventoryFull();
  }catch(e){ alert(e.message); }
});

// -------- Inventory panel (for Sales create)
async function loadInventoryPanel(){
  const box=$("#inv-list"); box.textContent="Loading…";
  try{
    const r = await api("/api/inventory");
    const q = $("#inv-search").value.trim().toLowerCase();
    const items = (r.items||[]).filter(x=>!q||x.name.toLowerCase().includes(q));
    const recipes = (r.recipes||[]).filter(x=>!q||x.name.toLowerCase().includes(q));
    box.innerHTML="";
    const add = (arr,kind)=>{
      for(const it of arr){
        const row=document.createElement("div"); row.className="itemrow";
        row.innerHTML=`<div>${it.name} <span class="badge">T${it.tier}</span> <span class="muted">x${it.qty}</span></div><button class="btn muted">Pick</button>`;
        row.querySelector("button").addEventListener("click", ()=>{
          SEL_INV = { kind, code: it.code, recipe_code: it.code, qty:1, name:it.name };
          $("#list-msg").textContent = "Selected: "+it.name;
        });
        box.appendChild(row);
      }
    };
    add(items,"item"); add(recipes,"recipe");
    if (!box.children.length) box.textContent="Empty.";
  }catch(e){ box.textContent=e.message; }
}
$("#inv-search").addEventListener("input", loadInventoryPanel);

// Create sale
$("#btn-list").addEventListener("click", async ()=>{
  try{
    if(!SEL_INV){ alert("Pick an item/recipe first."); return; }
    const gold=parseInt($("#price-g").value||"0",10)||0;
    const silver=parseInt($("#price-s").value||"0",10)||0;
    const qty=parseInt($("#price-qty").value||"1",10)||1;
    const body = { kind: SEL_INV.kind, qty, gold, silver };
    if (SEL_INV.kind==="item") body.code = SEL_INV.code; else body.recipe_code = SEL_INV.recipe_code;
    await api("/api/sales/create",{method:"POST",body:JSON.stringify(body)});
    $("#list-msg").textContent="Listed.";
    SEL_INV=null; loadMarket(); loadMine(); loadInventoryPanel();
  }catch(e){ alert(e.message); }
});

// Market & Mine
async function loadMarket(){
  const box=$("#market"); box.textContent="Loading…";
  try{
    const q=$("#market-q").value.trim();
    const r = await api("/api/sales/market"+(q?("?q="+encodeURIComponent(q)):""));
    const rows=r.sales||[];
    if(!rows.length){ box.textContent="No listings."; return; }
    box.innerHTML="";
    for(const s of rows){
      const g=Math.floor(s.price_s/100), ss=s.price_s%100;
      const row=document.createElement("div"); row.className="itemrow";
      row.innerHTML=`<div>${s.name} <span class="muted">x${s.qty}</span></div>
                     <div class="row">
                       <span class="badge">${g}g ${ss}s</span>
                       <button class="btn">Buy</button>
                     </div>`;
      row.querySelector("button").addEventListener("click", async ()=>{
        try{
          await api("/api/sales/buy",{method:"POST",body:JSON.stringify({id:s.id})});
          toast("Purchased.");
          loadMarket(); loadMine(); loadInventoryPanel(); loadInventoryFull(); loadMe();
        }catch(e){ alert(e.message); }
      });
      box.appendChild(row);
    }
  }catch(e){ box.textContent=e.message; }
}
$("#market-q").addEventListener("input", loadMarket);

async function loadMine(){
  const box=$("#mine"); box.textContent="Loading…";
  try{
    const r = await api("/api/sales/mine");
    const rows=r.sales||[];
    if(!rows.length){ box.textContent="No listings."; return; }
    box.innerHTML="";
    for(const s of rows){
      const g=Math.floor(s.price_s/100), ss=s.price_s%100;
      const row=document.createElement("div"); row.className="itemrow";
      row.innerHTML=`<div>${s.name} <span class="muted">x${s.qty}</span> <span class="badge">${s.status}</span></div>
                     <div class="row">
                       <span class="badge">${g}g ${ss}s</span>
                       ${s.status==='live'?'<button class="btn danger">Cancel</button>':''}
                     </div>`;
      if (s.status==='live'){
        row.querySelector("button").addEventListener("click", async ()=>{
          try{
            await api("/api/sales/cancel",{method:"POST",body:JSON.stringify({id:s.id})});
            loadMarket(); loadMine(); loadInventoryPanel();
          }catch(e){ alert(e.message); }
        });
      }
      box.appendChild(row);
    }
  }catch(e){ box.textContent=e.message; }
}
$("#btn-mine").addEventListener("click", loadMine);

// Full Inventory tab
async function loadInventoryFull(){
  const box=$("#inv-full"); box.textContent="Loading…";
  try{
    const r = await api("/api/inventory");
    const lines=[];
    for(const it of (r.items||[])){
      lines.push(`<div class="itemrow"><div>${it.name} <span class="badge">T${it.tier}</span></div><div class="muted">x${it.qty}</div></div>`);
    }
    for(const rc of (r.recipes||[])){
      lines.push(`<div class="itemrow"><div class="muted">[Recipe]</div><div>${rc.name} <span class="badge">T${rc.tier}</span></div><div class="muted">x${rc.qty}</div></div>`);
    }
    box.innerHTML = lines.join("") || "Empty.";
  }catch(e){ box.textContent=e.message; }
}

// Init
loadMe();
</script>
</body>
</html>
