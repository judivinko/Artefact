<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel</title>
  <link rel="stylesheet" href="/app.css" />
  <style>
    .grid2 { display:grid; grid-template-columns: 1fr 2fr; gap:12px; }
    @media (max-width: 900px){ .grid2{ grid-template-columns:1fr; } }
    .muted { opacity:.8; }
    .success { color:#22c55e; }
    .danger { color:#ef4444; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#1f2937; font-size:12px; color:#93c5fd; }
    .rowx { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .list { background:#0b1220; border:1px solid #233047; border-radius:10px; padding:12px; white-space:pre-wrap; }
    .user-row { display:flex; gap:10px; align-items:center; justify-content:space-between; padding:6px 8px; border-bottom:1px solid #1f2a3b; cursor:pointer; }
    .user-row:hover { background:#0f1624; }
    .user-row.active { background:#102133; outline:1px solid #2dd4bf; }
    .nowrap{ white-space:nowrap; }
    .w100{ width:100px; } .w120{ width:120px; }
  </style>
</head>
<body>
  <header class="header">
    <div class="brand">ECONOMY • Admin</div>
    <div id="who" class="muted">Status: unknown</div>
  </header>

  <main class="container">
    <!-- Admin Key -->
    <section class="card">
      <div class="label">Admin Key</div>
      <div class="rowx">
        <input id="admin-key" type="password" placeholder="x-admin-key (dev-admin-key)" class="w120" />
        <button id="btn-save-key">Set</button>
        <button id="btn-clear-key" class="secondary">Clear</button>
        <label class="rowx" style="gap:6px;">
          <input type="checkbox" id="ck-store-key" />
          <span>Remember in this browser</span>
        </label>
      </div>
      <div id="key-msg" class="muted"></div>
    </section>

    <section class="grid2">
      <!-- LEFT: controls -->
      <section class="card" style="margin:0;">
        <div class="label">Controls</div>

        <div class="rowx">
          <div>Selected user:</div>
          <div id="sel-email" class="pill">—</div>
        </div>

        <div class="rowx" style="margin-top:8px;">
          <input id="gold-amount" type="number" step="1" class="w100" placeholder="Gold amount" />
          <button id="btn-give" title="Add gold">+ Give</button>
          <button id="btn-take" class="secondary" title="Remove gold">− Take</button>
        </div>
        <div class="muted">Tip: amount is in <b>gold</b> (1g = 100s).</div>
        <div id="gold-msg" class="muted"></div>

        <hr style="opacity:.2;" />

        <div class="rowx">
          <button id="btn-disable" class="danger">Disable account</button>
          <button id="btn-enable" class="secondary">Enable account</button>
        </div>
        <div id="disable-msg" class="muted"></div>
      </section>
<!-- Crafting -->
<div id="tab-craft" class="card hidden">
  <div class="row">
    <div class="label">Crafting</div>
    <button id="btn-artefact" class="btn right">Craft ARTEFACT (10× distinct T5)</button>
  </div>
  <div class="grid">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="label">Recipes you own</div>
        <div class="row">
          <input id="filter-recipe" class="input" placeholder="filter by name..." style="width:220px"/>
          <button id="btn-refresh-rec" class="btn muted">Refresh</button>
        </div>
      </div>
      <div id="recipes" class="list">Loading…</div>
    </div>
    <div class="card">
      <div class="label">Details</div>
      <div id="rec-details" class="list">Select a recipe on the left.</div>
    </div>
  </div>
</div>

<!-- Sales -->
<div id="tab-sales" class="card hidden">
  <div class="label">Sales (Marketplace)</div>
  <div class="grid">
    <div class="card">
      <div class="label">Create Sale</div>
      <input id="inv-search" class="input" placeholder="Search your inventory..." />
      <div id="inv-list" class="list" style="margin-top:8px;max-height:300px">Loading…</div>
      <div class="row" style="margin-top:8px">
        <input id="price-g" class="input" style="width:100px" placeholder="Gold"/>
        <input id="price-s" class="input" style="width:120px" placeholder="Silver (0–99)"/>
        <input id="price-qty" class="input" style="width:100px" placeholder="Qty"/>
        <button id="btn-list" class="btn">List for sale</button>
      </div>
      <div id="list-msg" class="muted" style="margin-top:6px"></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="label">Marketplace</div>
        <input id="market-q" class="input" placeholder="Search by name..." style="width:220px" />
      </div>
      <div id="market" class="list">Loading…</div>

      <div class="row" style="justify-content:space-between;margin-top:12px">
        <div class="label">My listings</div>
        <button id="btn-mine" class="btn muted">Reload</button>
      </div>
      <div id="mine" class="list">Loading…</div>
    </div>
  </div>
</div>

      <!-- RIGHT: users & inventory -->
      <section class="card" style="margin:0;">
        <div class="rowx" style="justify-content:space-between;">
          <div class="label">Users</div>
          <input id="user-search" placeholder="Search email..." class="w120" />
        </div>

        <div id="users-list" class="list" style="margin-top:8px; max-height:420px; overflow:auto;">Loading…</div>
        <div id="users-msg" class="muted" style="margin-top:6px;"></div>

        <div class="card" style="margin-top:12px;">
          <div class="label">Inventory of selected user</div>
          <div id="inv-box" class="list">Select a user from the list →</div>
        </div>
      </section>
    </section>
  </main>

  <script>
    const $ = s => document.querySelector(s);
    let ADMIN_KEY = "";
    let USERS = [];
    let SELECTED = null; // { id, email, ... }

    function setWho(text){ $("#who").textContent = text; }
    function msg(id, text, ok=true){ const el=$(id); el.textContent=text; el.className = ok ? "muted success" : "muted danger"; }

    function useHeaders(useKey=false){
      const h = { "Content-Type":"application/json" };
      if (useKey && ADMIN_KEY) h["x-admin-key"] = ADMIN_KEY;
      return h;
    }
    async function api(path, opts={}, useKey=false){
      const res = await fetch(path, { credentials:"include", ...opts, headers: { ...useHeaders(useKey), ...(opts.headers||{}) } });
      let data=null; try{ data = await res.json(); }catch{}
      if (!res.ok) throw new Error((data&&data.error)||`HTTP ${res.status}`);
      return data;
    }

    // Auth status
    async function refreshMe(){
      try{
        const r = await api("/api/me");
        setWho(`${r.user.email} • ${r.user.is_admin ? "ADMIN" : "USER"} • ${r.user.gold}g ${r.user.silver}s`);
      }catch{
        setWho("Not logged in (you can use Admin Key).");
      }
    }

    // Admin key
    function loadKey(){
      const stored = localStorage.getItem("ADMIN_KEY_V1");
      if (stored){ ADMIN_KEY = stored; $("#admin-key").value = stored; $("#ck-store-key").checked = true; }
    }
    $("#btn-save-key").addEventListener("click", ()=>{
      ADMIN_KEY = $("#admin-key").value.trim();
      if ($("#ck-store-key").checked) localStorage.setItem("ADMIN_KEY_V1", ADMIN_KEY);
      msg("#key-msg", ADMIN_KEY ? "Admin Key set." : "Admin Key cleared.");
    });
    $("#btn-clear-key").addEventListener("click", ()=>{
      ADMIN_KEY = ""; $("#admin-key").value = ""; localStorage.removeItem("ADMIN_KEY_V1");
      msg("#key-msg", "Admin Key cleared.");
    });

    // Users
    function sortUsers(arr){
      // active (is_disabled=false) first; then alphabetical by email
      return [...arr].sort((a,b)=>{
        if (a.is_disabled !== b.is_disabled) return a.is_disabled ? 1 : -1;
        return a.email.localeCompare(b.email);
      });
    }
    function renderUsers(){
      const q = ($("#user-search").value||"").trim().toLowerCase();
      const box = $("#users-list"); box.innerHTML = "";
      const filtered = sortUsers(USERS).filter(u => u.email.toLowerCase().includes(q));
      if (!filtered.length){ box.textContent = "No users."; $("#users-msg").textContent=""; return; }
      for (const u of filtered){
        const row = document.createElement("div");
        row.className = "user-row" + (SELECTED && SELECTED.id===u.id ? " active" : "");
        row.innerHTML = `
          <div class="nowrap">
            <span class="pill">${u.is_disabled ? "inactive" : "active"}</span>
          </div>
          <div style="flex:1; padding:0 6px;">${u.email}</div>
          <div class="nowrap muted">${u.gold}g ${u.silver}s</div>
        `;
        row.addEventListener("click", ()=> selectUser(u));
        box.appendChild(row);
      }
      $("#users-msg").textContent = `Shown: ${filtered.length} • Total: ${USERS.length}`;
    }
    async function loadUsers(){
      try{
        const r = await api("/api/admin/users", {}, true);
        USERS = r.users || [];
        renderUsers();
      }catch(e){
        $("#users-list").textContent = e.message;
      }
    }

    async function selectUser(u){
      SELECTED = u;
      $("#sel-email").textContent = u.email;
      renderUsers(); // refresh highlight
      await loadInventory(u);
    }
// ===== KRAFTING =====

// dedicated /api/recipes/* i craft na /api/craft/do
window.CURRENT_RECIPE_ID = null;

async function loadRecipes(){
  const box=$("#recipes"); box.textContent="Loading…";
  try{
    const list = await api("/api/recipes/list");
    const q = $("#filter-recipe").value.trim().toLowerCase();
    const rows = (list.recipes||[]).filter(x=>!q||x.name.toLowerCase().includes(q));
    if (!rows.length){ box.textContent="No recipes."; return; }
    box.innerHTML="";
    for (const rec of rows){
      const row=document.createElement("div"); row.className="itemrow";
      row.innerHTML = `<div><b>${rec.name}</b> <span class="badge">T${rec.tier}</span> <span class="muted">x${rec.qty}</span></div>
                       <button class="btn muted">Open</button>`;
      row.querySelector("button").addEventListener("click",()=>openRecipe(rec.id));
      box.appendChild(row);
    }
  }catch(e){ box.textContent=e.message; }
}
$("#btn-refresh-rec").addEventListener("click", async () => {
  try{
    await loadRecipes();
    await loadInventoryPanel?.();
    await loadInventoryFull?.();
    if (window.CURRENT_RECIPE_ID) await openRecipe(window.CURRENT_RECIPE_ID);
  }catch(e){ alert(e.message||"Refresh failed"); }
});
$("#filter-recipe").addEventListener("input", loadRecipes);

function renderIngredients(details){
  const lines = [];
  lines.push(`<div class="itemrow"><div><b>${details.recipe.name}</b> <span class="badge">T${details.recipe.tier}</span></div></div>`);
  lines.push(`<div class="itemrow"><div class="muted">Ingredients</div></div>`);
  for(const ing of (details.ingredients||[])){
    const ok = ing.have >= ing.qty;
    lines.push(
      `<div class="itemrow">
         <div>${ing.name} <span class="badge">T${ing.tier}</span></div>
         <div class="${ok?'':'muted'}">${ing.have}/${ing.qty}</div>
       </div>`
    );
  }
  lines.push(
    `<div class="itemrow">
       <button id="btn-craft" class="btn">Craft</button>
       <span class="muted">10% fail → Scrap (server checks ingredients)</span>
     </div>`
  );
  return lines.join("");
}

async function openRecipe(recipeId){
  const box=$("#rec-details"); box.textContent="Loading…";
  try{
    const details = await api(`/api/recipes/ingredients/${recipeId}`);
    box.innerHTML = renderIngredients(details);
    window.CURRENT_RECIPE_ID = details.recipe.id; // za refresh “Details”
    $("#btn-craft").addEventListener("click", async ()=>{
      try{
        const r2 = await api("/api/ccraft/do",{method:"POST",body:JSON.stringify({recipe_id: details.recipe.id})});
        if (r2.crafted) toast?.(`Crafted: ${r2.crafted.name} (T${r2.crafted.tier})`);
        else if (r2.scrap) toast?.("Failed (got Scrap)") || alert("Failed (got Scrap)");
        else toast?.("Done");
        await loadInventoryPanel?.(); await loadRecipes(); await loadInventoryFull?.();
        await openRecipe(details.recipe.id); // ažuriraj “have/qty”
      }catch(e){ alert(e.message); }
    });
  }catch(e){ box.textContent=e.message; }
}

// ARTEFACT (10× T5 distinct) + bonus prikaz
$("#btn-artefact").addEventListener("click", async ()=>{
  try{
    const r = await api("/api/craft/artefact",{method:"POST",body:JSON.stringify({})});

    // podrži oba oblika odgovora: { ok, bonus_gold, crafted } ILI { ok, result:{ bonus_gold, crafted } }
    const payload   = r.result ? r.result : r;
    const crafted   = payload.crafted;
    const name      = (crafted && crafted.name) ? crafted.name : "Artefact";
    const bonus     = Number(payload.bonus_gold || 0);

    const bonusEl = document.querySelector("#artefact-bonus");
    if (bonusEl) bonusEl.textContent = bonus;
    const msgEl = document.querySelector("#artefact-msg");
    if (msgEl) msgEl.textContent = `Crafted: ${name} (+${bonus} gold)`;

    alert("Crafted: "+ name);
    await loadInventoryPanel?.(); await loadInventoryFull?.(); await loadRecipes();
  }catch(e){
    const msgEl = document.querySelector("#artefact-msg");
    if (msgEl) msgEl.textContent = e.message;
    else alert(e.message);
  }
});

// učitaj bonus na load (ako postoji prikaz u DOM-u)
async function loadArtefactBonus(){
  try{
    const res = await fetch("/api/items/artefact/bonus",{credentials:"include"});
    const j = await res.json();
    const g = (j.ok && Number.isFinite(j.bonus_gold)) ? j.bonus_gold : 0;
    const bonusEl = document.querySelector("#artefact-bonus");
    if (bonusEl) bonusEl.textContent = g;
  }catch{}
}
loadArtefactBonus();

// -------- SALES
async function loadInventoryPanel(){
  const box=$("#inv-list"); if(!box) return;
  box.textContent="Loading…";
  try{
    const r = await api("/api/inventory");
    INVENTORY_CACHE = r;
    const q = $("#inv-search").value?.trim().toLowerCase() || "";
    const items = (r.items||[]).filter(x=>!q||x.name.toLowerCase().includes(q));
    const recipes = (r.recipes||[]).filter(x=>!q||x.name.toLowerCase().includes(q));
    box.innerHTML="";
    const add = (arr,kind)=>{
      for(const it of arr){
        const row=document.createElement("div"); row.className="itemrow";
        row.innerHTML=`<div>${it.name} <span class="badge">T${it.tier}</span> <span class="muted">x${it.qty}</span></div><button class="btn muted">Pick</button>`;
        row.querySelector("button").addEventListener("click", ()=>{
          SEL_INV = { kind, id: it.id, name: it.name };
          $("#list-msg").textContent = "Selected: "+it.name;
        });
        box.appendChild(row);
      }
    };
    add(items,"item");
    add(recipes,"recipe");
    if (!box.children.length) box.textContent="Empty.";
  }catch(e){ box.textContent=e.message; }
}
$("#inv-search")?.addEventListener("input", loadInventoryPanel);

// Create sale
$("#btn-list").addEventListener("click", async ()=>{
  try{
    if(!SEL_INV){ alert("Pick an item/recipe first."); return; }
    const gold=parseInt($("#price-g").value||"0",10)||0;
    const silver=parseInt($("#price-s").value||"0",10)||0;
    const qty=parseInt($("#price-qty").value||"1",10)||1;
    const body = { kind: SEL_INV.kind, id: SEL_INV.id, qty, gold, silver };
    await api("/api/sales/list",{method:"POST",body:JSON.stringify(body)});
    $("#list-msg").textContent="Listed.";
    SEL_INV=null;
    loadMarket(); loadMine(); loadInventoryPanel();
  }catch(e){ alert(e.message); }
});

// Market
async function loadMarket(){
  const box=$("#market"); if(!box) return;
  box.textContent="Loading…";
  try{
    const q=$("#market-q").value?.trim() || "";
    const url = "/api/sales/live" + (q?("?q="+encodeURIComponent(q)):"");
    const r = await api(url);
    const rows = r.listings || [];
    if(!rows.length){ box.textContent="No listings."; return; }
    box.innerHTML="";
    for(const s of rows){
      const g=Math.floor((s.price_s||0)/100), ss=(s.price_s||0)%100;
      const label = (s.name && s.tier) ? `${s.name} <span class="badge">T${s.tier}</span>`
                                       : (s.kind==="item" ? `Item #${s.item_id||"-"}` : `Recipe #${s.recipe_id||"-"}`);
      const row=document.createElement("div"); row.className="itemrow";
      row.innerHTML=`<div>${label} <span class="muted">x${s.qty}</span></div>
                     <div class="row">
                       <span class="badge">${g}g ${ss}s</span>
                       <button class="btn">Buy</button>
                     </div>`;
      row.querySelector("button").addEventListener("click", async ()=>{
        try{
          await api("/api/sales/buy",{method:"POST",body:JSON.stringify({id:s.id})});
          toast("Purchased.");
          loadMarket(); loadMine(); loadInventoryPanel(); loadInventoryFull(); loadMe();
        }catch(e){ alert(e.message); }
      });
      box.appendChild(row);
    }
  }catch(e){ box.textContent=e.message; }
}
$("#market-q")?.addEventListener("input", loadMarket);

// My listings
async function loadMine(){
  const box=$("#mine"); if(!box) return;
  box.textContent="Loading…";
  try{
    const r = await api("/api/sales/mine");
    const rows = r.listings || [];
    if(!rows.length){ box.textContent="No listings."; return; }
    box.innerHTML="";
    for(const s of rows){
      const g=Math.floor((s.price_s||0)/100), ss=(s.price_s||0)%100;
      const label = (s.name && s.tier) ? `${s.name} <span class="badge">T${s.tier}</span>`
                                       : (s.kind==="item" ? `Item #${s.item_id||"-"}` : `Recipe #${s.recipe_id||"-"}`);
      const row=document.createElement("div"); row.className="itemrow";
      row.innerHTML=`<div>${label} <span class="muted">x${s.qty}</span> <span class="badge">${s.status}</span></div>
                     <div class="row">
                       <span class="badge">${g}g ${ss}s</span>
                       ${s.status==='live'?'<button class="btn danger">Cancel</button>':''}
                     </div>`;
      if (s.status==='live'){
        row.querySelector("button").addEventListener("click", async ()=>{
          try{
            await api("/api/sales/cancel",{method:"POST",body:JSON.stringify({id:s.id})});
            loadMarket(); loadMine(); loadInventoryPanel();
          }catch(e){ alert(e.message); }
        });
      }
      box.appendChild(row);
    }
  }catch(e){ box.textContent=e.message; }
}
$("#btn-mine")?.addEventListener("click", loadMine);

    // Inventory for selected user
    async function loadInventory(u){
      $("#inv-box").textContent = "Loading…";
      try{
        const r = await api(`/api/admin/user-inventory?user_id=${encodeURIComponent(u.id)}`, {}, true);
        const parts = [];
        const items = r.items || [];
        const recipes = r.recipes || [];
        parts.push("ITEMS:");
        if (!items.length) parts.push(" (none)");
        for (const it of items){
          parts.push(` • [T${it.tier}] ${it.code} — ${it.name} x${it.qty}`);
        }
        parts.push("");
        parts.push("RECIPES:");
        if (!recipes.length) parts.push(" (none)");
        for (const rc of recipes){
          parts.push(` • [T${rc.tier}] ${rc.code} — ${rc.name} x${rc.qty}`);
        }
        $("#inv-box").textContent = parts.join("\n");
      }catch(e){
        $("#inv-box").textContent = e.message;
      }
    }

    // Gold +/- for selected user
    async function applyGold(sign){
      if (!SELECTED){ msg("#gold-msg","Select a user first.", false); return; }
      const val = parseInt($("#gold-amount").value || "0", 10) || 0;
      if (val<=0){ msg("#gold-msg","Enter a positive gold amount.", false); return; }
      const gold = sign>0 ? val : -val;
      try{
        const r = await api("/api/admin/adjust-balance", {
          method:"POST",
          body: JSON.stringify({ email: SELECTED.email, gold })
        }, true);
        msg("#gold-msg", `OK • New balance: ${Math.floor(r.balance_silver/100)}g ${r.balance_silver%100}s`);
        await loadUsers(); // refresh list numbers
        const nu = USERS.find(x=>x.email===SELECTED.email); if(nu){ SELECTED = nu; renderUsers(); }
      }catch(e){
        msg("#gold-msg", e.message, false);
      }
    }
    $("#btn-give").addEventListener("click", ()=> applyGold(+1));
    $("#btn-take").addEventListener("click", ()=> applyGold(-1));

    // Disable / Enable
    async function setDisabled(flag){
      if (!SELECTED){ msg("#disable-msg","Select a user first.", false); return; }
      try{
        await api("/api/admin/disable-user", {
          method:"POST",
          body: JSON.stringify({ email: SELECTED.email, disabled: !!flag })
        }, true);
        msg("#disable-msg", flag ? "Account disabled." : "Account enabled.");
        await loadUsers();
        const nu = USERS.find(x=>x.email===SELECTED.email); if(nu){ SELECTED = nu; renderUsers(); }
      }catch(e){
        msg("#disable-msg", e.message, false);
      }
    }
    $("#btn-disable").addEventListener("click", ()=> setDisabled(true));
    $("#btn-enable").addEventListener("click", ()=> setDisabled(false));

    // Search
    $("#user-search").addEventListener("input", renderUsers);

    // init
    (function init(){
      const stored = localStorage.getItem("ADMIN_KEY_V1");
      if (stored){ ADMIN_KEY = stored; $("#admin-key").value = stored; $("#ck-store-key").checked = true; }
      refreshMe();
      loadUsers();
    })();
  </script>
</body>
</html>




